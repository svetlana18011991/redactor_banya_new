<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ë–∞—à–Ω—è ‚Äî Editor + Game (–æ–¥–∏–Ω —Ñ–∞–π–ª) [v13-20260210-054618]</title>

  <style>
    html, body{height:100%}

    :root{
      --text:#eaf0ff;
      --muted:#a9b6e6;
      --border: rgba(255,255,255,.10);
      --shadow2: 0 12px 34px rgba(0,0,0,.40);
      --radius: 18px;
      --radius2: 22px;

      --neon:#d6b14a;
      --neon2:#f2d37a;
      --danger:#ff4d4d;
      --ok:#2dd27d;
    }

    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    body{
      margin:0;color:var(--text);
      background:
        radial-gradient(1100px 700px at 12% 18%, rgba(35,82,200,.28) 0%, rgba(5,8,22,0) 58%),
        radial-gradient(900px 640px at 88% 16%, rgba(20,160,255,.18) 0%, rgba(5,8,22,0) 62%),
        radial-gradient(1000px 780px at 55% 112%, rgba(214,177,74,.14) 0%, rgba(5,8,22,0) 58%),
        linear-gradient(180deg, rgba(4,10,32,.92), rgba(3,6,18,1));
      min-height:100vh;
    }
    body.gameOnly{background:transparent}

    .app{
      display:grid;
      grid-template-columns: 460px 1fr;
      gap:14px;
      padding:14px;
      max-width: 1540px;
      margin: 0 auto;
    }
    @media (max-width: 1020px){
      .app{grid-template-columns:1fr}
    }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid var(--border);
      border-radius:var(--radius2);
      box-shadow:var(--shadow2);
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
    }

    .panel-header{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .panel-header .h{font-weight:950;letter-spacing:.2px}
    .panel-body{padding:14px}

    .settings{
      height: calc(100vh - 28px);
      display:flex;
      flex-direction:column;
      min-height: 560px;
    }
    .settings .panel-body{
      overflow:auto;
      padding:14px;
    }

    [data-section="timer"]{display:none !important}
    [data-hide="blocks"]{display:none !important}

    .section{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      margin-bottom:12px;
    }
    .section .title{
      font-weight:950;
      font-size:13.5px;
      margin-bottom:10px;
      color:rgba(255,255,255,.92);
      display:flex;align-items:center;justify-content:space-between;gap:8px;
    }

    .muted{color:var(--muted); font-size:12.5px; line-height:1.35}

    label{
      display:block;
      font-size:12.5px;
      color:rgba(255,255,255,.86);
      margin:10px 0 6px
    }

    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      border-radius:14px;
      padding:10px 11px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:84px; resize:vertical}

    input[type="file"]{
      width:100%;
      border-radius:14px;
      padding:10px 11px;
      border:1px dashed rgba(255,255,255,.22);
      background:rgba(0,0,0,.18);
      color:var(--muted);
    }

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1; min-width:170px}

    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      margin-top:8px;
    }
    .toggle input{width:18px; height:18px}

    .btn{
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-weight:950;
      font-size:14px;
      transition:transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .2s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.24)}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.45; cursor:not-allowed}

    .btn.primary{
      background:linear-gradient(90deg, rgba(214,177,74,.35), rgba(242,211,122,.22));
      border-color:rgba(214,177,74,.40);
      box-shadow: 0 10px 26px rgba(214,177,74,.18);
    }
    .btn.danger{border-color:rgba(255,77,77,.35); background:rgba(255,77,77,.08)}
    .btn.small{padding:8px 10px; font-size:12.5px; border-radius:12px}

    .q-list{display:flex; flex-direction:column; gap:10px;}
    .q-item{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .q-item .meta{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
      padding-top:3px;
    }
    .q-item .meta .t{
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis
    }
    .q-item .meta .s{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(255,255,255,.92);
    }

    .preview{
      min-height: calc(100vh - 28px);
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:0;
      overflow:hidden;
    }
    .preview-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
    }
    .preview-top .name{font-weight:950; letter-spacing:.2px}
    .preview-top .hint{color:var(--muted); font-size:12.5px}

    .preview-stage{
      position:relative;
      border-radius:var(--radius2);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      min-height: 720px; height: calc(100vh - 120px);
      background:rgba(0,0,0,.18);
      box-shadow: var(--shadow2);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      z-index:999999;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px)
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999998;
      padding:14px;
    }

    .modal{
      width:min(820px, 100%);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal-head{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modal-head .h{font-weight:950}
    .modal-body{padding:14px}
    .modal-foot{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .choiceBlock{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.14);
      border-radius:14px;
      padding:10px;
      margin-top:10px;
    }

    .answerRow{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:8px;
    }
    .answerRow input[type="text"]{flex:1; min-width:0}

    .radio{
      width:18px;
      height:18px;
      accent-color: var(--neon);
      flex:0 0 auto;
    }

    .errbar{
      display:none;
      margin:12px 14px 0;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,77,77,.35);
      background:rgba(255,77,77,.10);
      color:#ffd6d6;
      font-size:13px;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .errbar.show{display:block}

    /* ===== GAME styles (scoped by .gameHost) ===== */
    .gameHost{
      width:100%;
      height:100%;
      min-height:0;
    }
    .gameHost *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .stage{
      position:relative;
      width:100%;
      height:100%;
      min-height:720px;
      overflow:hidden;
      border-radius:18px;
      background:
        radial-gradient(1100px 700px at 12% 18%, rgba(106,164,255,.18) 0%, rgba(5,8,22,0) 58%),
        radial-gradient(900px 640px at 88% 16%, rgba(155,123,255,.14) 0%, rgba(5,8,22,0) 62%),
        radial-gradient(1000px 780px at 55% 112%, rgba(45,210,125,.12) 0%, rgba(5,8,22,0) 58%),
        linear-gradient(180deg, rgba(10,14,40,.60), rgba(5,8,22,1));
      color:var(--text);
    }
    .bg{
      position:absolute; inset:0;
      background-position:center;
      background-size:cover;
      opacity: .92;
      transform: scale(1.02);
      filter: saturate(1.05) contrast(1.02);
      pointer-events:none;
      display:none;
    }
    .overlay{
      position:absolute; inset:0;
      background: radial-gradient(900px 620px at 50% 35%, rgba(0,0,0,0) 0%, rgba(0,0,0,.40) 70%);
      pointer-events:none;
    }
    .topbar{
      position:absolute;
      left:12px; right:12px; top:12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
      z-index:30;
    }
    .leftPack{display:flex; flex-direction:column; gap:2px; min-width:220px}
    .title{font-weight:950; letter-spacing:.2px}
    .sub{color:rgba(255,255,255,.78); font-size:12px}
    .rightPack{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}

    .pillGame{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(255,255,255,.92);
      font-weight:900;
      font-size:12px;
      user-select:none;
    }
    .timerBadge{
      border-color: rgba(57,255,118,.22);
      box-shadow: 0 0 18px rgba(57,255,118,.14);
    }
    .progressWrap{
      width:260px; max-width:60vw;
      height:12px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
    }
    .progressBar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(57,255,118,.35), rgba(57,255,118,.95));
      box-shadow: 0 0 14px rgba(57,255,118,.35);
      transition: width .25s ease;
    }

    .towerArea{
      position:absolute;
      left:0; right:0; top:0; bottom:0;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      z-index:10;
      padding-bottom: 64px;
    }
    .tower{
      position:relative;
      width:min(320px, 70vw);
      height: calc(100% - 170px);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      pointer-events:none;
    }

    .cssBlock{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      width:min(280px, 64vw);
      height:78px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(260px 100px at 30% 30%, rgba(255,255,255,.10), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, rgba(57,255,118,.12), rgba(0,0,0,.18));
      box-shadow: 0 22px 34px rgba(0,0,0,.35);
      overflow:hidden;
      filter: drop-shadow(0 14px 16px rgba(0,0,0,.30));
    }
    .cssBlock::after{
      content:"";
      position:absolute; inset:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      opacity:.9;
    }

    .imgBlock{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      will-change: transform, top, opacity, filter;
      filter: drop-shadow(0 18px 20px rgba(0,0,0,.35));
    }

    .burning{
      filter: grayscale(.15) brightness(.72) contrast(1.1) sepia(.28) saturate(1.15) !important;
      opacity:.96;
    }

    .nextWrap{
      position:absolute;
      left:0; right:0;
      bottom: 22px;
      display:flex;
      justify-content:center;
      z-index:35;
      pointer-events:auto;
    }
    .hintUnder{
      position:absolute;
      left:0; right:0;
      bottom: 66px;
      display:flex;
      justify-content:center;
      z-index:35;
      pointer-events:none;
    }
    .hintBubble{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      backdrop-filter: blur(10px);
      font-size:12px;
      color:rgba(255,255,255,.9);
      max-width:min(760px, 92vw);
      text-align:center;
      box-shadow: 0 18px 50px rgba(0,0,0,.20);
    }

    .btnGame{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.95);
      cursor:pointer;
      font-weight:950;
      font-size:14px;
      transition:transform .08s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btnGame:hover{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.24)}
    .btnGame:active{transform:translateY(1px)}
    .btnGame:disabled{opacity:.45; cursor:not-allowed}
    .btnGame.primary{
      background: linear-gradient(90deg, rgba(57,255,118,.22), rgba(0,255,179,.18));
      border-color: rgba(57,255,118,.30);
      box-shadow: 0 12px 30px rgba(57,255,118,.10);
    }

    .cardBack{
      position:absolute; inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
      padding:14px;
    }
    .card{
      width:min(760px, 96vw);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      overflow:hidden;
      transform: translateY(12px) scale(.985);
      opacity:0;
      animation: cardIn .32s ease-out forwards;
    }
    @keyframes cardIn{ to{ transform:none; opacity:1; } }

    .cardHead{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .cardHead .h{font-weight:950}
    .cardBody{padding:14px}
    .cardFoot{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .block{
      padding:12px 12px;
      border-radius:16px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
    }
    .block .label{font-size:12px;color:rgba(255,255,255,.70);margin-bottom:8px;font-weight:900}
    .qText{white-space:pre-wrap; font-size:16px; line-height:1.35}

    .answers{display:flex; flex-wrap:wrap; gap:8px}
    .pillBtn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(255,255,255,.92);
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition:transform .08s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
    }
    .pillBtn:hover{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.24)}
    .pillBtn:active{transform:translateY(1px)}

    .inputRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .inp{
      flex:1; min-width:220px;
      border-radius:14px;
      padding:10px 11px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:rgba(255,255,255,.92);
      outline:none;
    }

    .floatPlus{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      color: rgba(57,255,118,.96);
      font-weight:1000;
      text-shadow: 0 0 10px rgba(57,255,118,.35);
      pointer-events:none;
      z-index:45;
      animation: plusFly .9s ease-out forwards;
    }
    @keyframes plusFly{
      0%{opacity:0; transform:translateX(-50%) translateY(10px) scale(.98)}
      20%{opacity:1}
      100%{opacity:0; transform:translateX(-50%) translateY(-70px) scale(1.05)}
    }

    .spark{
      position:absolute;
      width:6px;height:6px;
      border-radius:999px;
      background: rgba(255,220,120,.95);
      box-shadow: 0 0 10px rgba(255,200,80,.35);
      pointer-events:none;
      z-index:44;
      animation: sparkFly .7s ease-out forwards;
    }
    @keyframes sparkFly{
      to{
        opacity:0;
        transform: translate(var(--dx), var(--dy)) scale(.4);
        filter: blur(0.2px);
      }
    }

    .smoke{
      position:absolute;
      width:18px;height:18px;
      border-radius:999px;
      background: rgba(120,120,120,.35);
      filter: blur(1px);
      pointer-events:none;
      z-index:43;
      animation: smokeFly 1.0s ease-out forwards;
    }
    @keyframes smokeFly{
      0%{opacity:0; transform: translate(0,0) scale(.8)}
      20%{opacity:1}
      100%{opacity:0; transform: translate(var(--dx), var(--dy)) scale(1.6)}
    }

    .finish{
      position:absolute; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:60;
      padding:14px;
    }
    .finishCard{
      width:min(820px, 96vw);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 36px 110px rgba(0,0,0,.60);
      overflow:hidden;
    }
    .finishHead{
      padding:14px 16px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .finishHead .h{font-weight:1000; font-size:18px}
    .finishBody{padding:14px 16px}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:720px){ .grid{grid-template-columns:1fr} }
    .stat{
      padding:12px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
    }
    .stat .k{color:rgba(255,255,255,.75); font-size:12px; font-weight:900}
    .stat .v{font-size:22px; font-weight:1000; margin-top:4px}
    .bigMsg{
      margin-top:12px;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(57,255,118,.25);
      background:rgba(57,255,118,.08);
    }
    .bigMsg .h{font-weight:1000; font-size:18px}
    .bigMsg .p{color:rgba(255,255,255,.85); margin-top:6px; line-height:1.35}
  
    /* ===== Premium gold/blue polish (v12) ===== */
    .panel{
      border-color: rgba(214,177,74,.22);
      box-shadow: 0 18px 60px rgba(0,0,0,.50);
    }
    .panel::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(242,211,122,.08), rgba(0,0,0,0) 60%),
        radial-gradient(700px 520px at 80% 20%, rgba(20,160,255,.10), rgba(0,0,0,0) 55%),
        repeating-linear-gradient(135deg, rgba(214,177,74,.06) 0 2px, rgba(0,0,0,0) 2px 14px);
      opacity:.45;
      pointer-events:none;
      mix-blend-mode: overlay;
    }
    .panel > *{position:relative; z-index:1}
    .section{
      border-color: rgba(214,177,74,.18);
      background: rgba(0,0,0,.18);
    }
    input[type="text"], input[type="number"], textarea, select{
      border-color: rgba(214,177,74,.20);
      background: rgba(0,0,0,.28);
    }
    input[type="file"]{
      border-color: rgba(214,177,74,.25);
    }
    .btn{
      border-color: rgba(214,177,74,.22);
    }
    .btn.primary{
      background: linear-gradient(90deg, rgba(214,177,74,.42), rgba(242,211,122,.20));
      border-color: rgba(242,211,122,.38);
      box-shadow: 0 14px 34px rgba(214,177,74,.18);
    }
    .btn.primary:hover{
      box-shadow: 0 18px 44px rgba(214,177,74,.22);
    }
    .pill{
      border-color: rgba(242,211,122,.30);
      background: rgba(0,0,0,.24);
    }

  
    /* ===== Question modal: prettier media icons + neon orange accents ===== */
    .promptWithIcons{
      display:flex;
      gap:10px;
      align-items:stretch;
    }
    .promptWithIcons textarea{flex:1; min-height:110px}
    .qSideIcons{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding-top:2px;
    }
    .qIconBtn{
      width:44px;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(255,150,0,.38);
      background:linear-gradient(180deg, rgba(255,170,0,.18), rgba(255,170,0,.06));
      box-shadow:
        0 0 0 1px rgba(0,0,0,.25) inset,
        0 8px 22px rgba(0,0,0,.45),
        0 0 18px rgba(255,140,0,.20);
      color:#fff;
      font-size:20px;
      line-height:1;
      cursor:pointer;
      transition:transform .15s ease, box-shadow .2s ease, border-color .2s ease, filter .2s ease;
      user-select:none;
    }
    .qIconBtn:hover{
      transform:translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(0,0,0,.22) inset,
        0 10px 26px rgba(0,0,0,.50),
        0 0 26px rgba(255,140,0,.30);
      border-color:rgba(255,170,0,.55);
      filter:saturate(1.12);
    }
    .qIconBtn:active{transform:translateY(0)}
    .hiddenFile{display:none !important;}

    /* Neon orange accents for the whole question modal window */
    .modal{
      box-shadow:
        0 30px 80px rgba(0,0,0,.55),
        0 0 0 1px rgba(255,150,0,.22),
        0 0 32px rgba(255,130,0,.14);
    }
    .modal .choiceBlock{
      border:1px solid rgba(255,150,0,.18);
      box-shadow: 0 0 18px rgba(255,130,0,.10) inset;
    }
    .modal input:focus, .modal textarea:focus, .modal select:focus{
      outline:none;
      border-color: rgba(255,170,0,.55) !important;
      box-shadow: 0 0 0 3px rgba(255,150,0,.18) !important;
    }


/* version badge */
.version-badge{
  position:fixed;
  right:14px;
  bottom:14px;
  z-index:999999;
  padding:6px 10px;
  font:600 12px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  letter-spacing:.6px;
  color:#f5d58a;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(245,213,138,.35);
  border-radius:10px;
  box-shadow:0 0 18px rgba(255,166,0,.18);
  user-select:none;
  pointer-events:none;
}

</style>
</head>

<body>
  <div class="app" id="editorRoot">
    <div class="panel settings">
      <div class="panel-header">
        <div class="h">–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ë–∞—à–Ω—è¬ª <span class="pill" title="–≤–µ—Ä—Å–∏—è —Ñ–∞–π–ª–∞">v13-20260210-054618</span></div>
        <div class="row" style="margin:0">
          <button class="btn primary" id="btnCopyCode" type="button">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ (iframe)</button>
        </div>
      </div>

      <div class="errbar" id="errbar"></div>

      <div class="panel-body">

        <div class="section">
          <div class="title">–ù–∞–∑–≤–∞–Ω–∏–µ</div>

          <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∏–≥—Ä–µ</label>
          <input id="inpTitle" type="text" value="–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π" />
        </div>

        <div class="section">
          <div class="title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</div>
<label>–í—ã–±—Ä–∞—Ç—å —Å–≤–æ–π —Ñ–æ–Ω</label>
          <div class="row" style="gap:10px; align-items:center; margin-top:6px">
            <input id="fileBg" type="file" accept="image/*" />
            <button id="btnResetBg" type="button" class="btn small">‚Ü© –°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ–Ω</button>
          </div>

          <div class="toggle" data-hide="blocks">
            <input id="chkUseImages" type="checkbox" checked />
            <div>
              <div style="font-weight:900">–ë–ª–æ–∫–∏: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ</div>
              <div class="muted"></div>
            </div>
          </div>
        </div>

        <div class="section" data-section="timer">
          <div class="title">–¢–∞–π–º–µ—Ä</div>

          <div class="toggle">
            <input id="chkTimer" type="checkbox" />
            <div>
              <div style="font-weight:900">–í–∫–ª—é—á–∏—Ç—å —Ç–∞–π–º–µ—Ä</div>
              <div class="muted">–ï—Å–ª–∏ –≤—Ä–µ–º—è –≤—ã—à–ª–æ ‚Äî –æ—Ç–≤–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π, –±–ª–æ–∫ —Å–≥–æ—Ä–∞–µ—Ç.</div>
            </div>
          </div>

          <label>–°–µ–∫—É–Ω–¥ –Ω–∞ –≤–æ–ø—Ä–æ—Å</label>
          <input id="inpSeconds" type="number" min="5" max="600" step="1" value="30" />
        </div>

        <div class="section">
          <div class="title">–í–æ–ø—Ä–æ—Å—ã <span class="pill" id="pillCount">0 / 9</span></div>

          <div class="row">
            <button class="btn primary" id="btnAddQ" type="button">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="btn" id="btnClearQs" type="button">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>

          <div class="q-list" id="qList" style="margin-top:12px"></div>

          <div class="muted" style="margin-top:10px">
            –°—Ç—Ä–æ–≥–æ <b>9 –≤–æ–ø—Ä–æ—Å–æ–≤</b>. –ú–æ–∂–Ω–æ: <b>–≤—ã–±–æ—Ä</b> –∏–ª–∏ <b>–≤–≤–æ–¥</b> (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤).
          </div>
        </div>

        <div class="section">
          <div class="title" data-hide="exportTitle">–≠–∫—Å–ø–æ—Ä—Ç –≤ Genially</div>
          <div class="muted">
            –ù–∞–∂–º–∏ <b>¬´üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe¬ª</b> ‚Äî –≤ –±—É—Ñ–µ—Ä–µ –±—É–¥–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–¥ –≤–∏–¥–∞:
            <div style="margin-top:8px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; color:rgba(255,255,255,.86)">
              .../index.html?game=...
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="panel preview">
      <div class="preview-top">
        <div>
          <div class="name">–ü—Ä–æ—Å–º–æ—Ç—Ä</div>
          <div class="hint">–ñ–∏–≤–æ–µ –ø—Ä–µ–≤—å—é (–∏–≥—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∫ –≤ Genially)</div>
        </div>
        <div class="muted">–ë–∞—à–Ω—è + –∫–∞—Ä—Ç–æ—á–∫–∏ + —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω</div>
      </div>

      <div class="panel-body">
        <div class="preview-stage">
          <iframe id="livePreview" title="Preview" style="width:100%;height:100%;min-height:720px;border:0;background:transparent;border-radius:18px;overflow:hidden" allow="autoplay; fullscreen" allowfullscreen></iframe>
        </div>
      
      </div>

      <div class="panel-body" style="padding-top:0;border-top:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.10)">
        <div class="row" id="stickyBar" style="padding:12px 0;gap:10px;margin:0">
          <button class="btn primary" id="btnCopyCode2" type="button" style="flex:1">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ (iframe)</button>
          <button class="btn" id="btnOpenGame" type="button" style="flex:1">‚ñ∂ –û—Ç–∫—Ä—ã—Ç—å –∏–≥—Ä—É</button>
        </div>
        <div class="muted">–ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–∞–≤–µ—Ä—Ö—É –Ω–µ –≤–∏–¥–Ω–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏.</div>
      </div>
    </div>
  </div>

  <!-- GAME ONLY ROOT (–∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç–æ –ø–æ #game=...) -->
  <div id="gameRoot" style="display:none"></div>

  <!-- MODAL -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div class="h" id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</div>
        <button class="btn small danger" id="btnCloseModal" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div class="modal-body">
        <label>–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞</label>
        <select id="selType">
          <option value="choice" selected>–° –≤—ã–±–æ—Ä–æ–º –æ—Ç–≤–µ—Ç–∞</option>
          <option value="text">–° –≤–≤–æ–¥–æ–º –æ—Ç–≤–µ—Ç–∞</option>
        </select>

        <label>–í–æ–ø—Ä–æ—Å</label>
        <div class="promptWithIcons">
          <textarea id="inpPrompt" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å..."></textarea>
          <div class="qSideIcons" aria-label="–ú–µ–¥–∏–∞ –∫ –≤–æ–ø—Ä–æ—Å—É">
            <button class="qIconBtn" id="btnPickQImage" type="button" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É">üñº</button>
            <button class="qIconBtn" id="btnPickQAudio" type="button" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–ª–æ–¥–∏—é/–∑–≤—É–∫">üéµ</button>
          </div>
        </div>

        <div class="choiceBlock" style="margin-top:10px">
          <div style="font-weight:900">–ú–µ–¥–∏–∞ –∏ —Ç–∞–π–º–µ—Ä (–¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞)</div>
          <div class="muted">–ú–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –≤—Ä–µ–º—è –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞, –∞ —Ç–∞–∫–∂–µ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–ª–∏ –º–µ–ª–æ–¥–∏—é.</div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>–°–µ–∫—É–Ω–¥ –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å (–ø—É—Å—Ç–æ = –±–µ–∑ —Ç–∞–π–º–µ—Ä–∞)</label>
              <input id="inpQSeconds" type="number" min="3" max="600" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 20" />
            </div>
            <div>
              <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ –∫ –≤–æ–ø—Ä–æ—Å—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
              <input id="fileQImage" class="hiddenFile" type="file" accept="image/*" />
              <div class="muted" style="margin-top:6px">–ù–∞–∂–º–∏ üñº —Ä—è–¥–æ–º —Å –≤–æ–ø—Ä–æ—Å–æ–º, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª.</div>
            </div>
          </div>

          <label>–ú–µ–ª–æ–¥–∏—è/–∑–≤—É–∫ –∫ –≤–æ–ø—Ä–æ—Å—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <input id="fileQAudio" class="hiddenFile" type="file" accept="audio/*" />
          <div class="muted" style="margin-top:6px">–ù–∞–∂–º–∏ üéµ —Ä—è–¥–æ–º —Å –≤–æ–ø—Ä–æ—Å–æ–º, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª.</div>

          <div id="qMediaPreview" class="muted" style="margin-top:10px"></div>
        </div>


        <div id="choiceWrap" class="choiceBlock">
          <div style="font-weight:900">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞</div>
          <div class="muted">–ú–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞. –û—Ç–º–µ—Ç—å –≤–µ—Ä–Ω—ã–π —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–æ–π.</div>
          <div id="choiceList"></div>
          <button class="btn small" id="btnAddChoice" type="button" style="margin-top:10px">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
        </div>

        <div id="textWrap" class="choiceBlock" style="display:none">
          <div style="font-weight:900">–í–µ—Ä–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–≤–≤–æ–¥)</div>
          <div class="muted">–ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –ª—é–±–æ–π.</div>
          <div id="textList"></div>
          <button class="btn small" id="btnAddText" type="button" style="margin-top:10px">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn" id="btnPreviewDraft" type="button">üëÅ –ü–æ–∫–∞–∑–∞—Ç—å –≤ –ø—Ä–µ–≤—å—é</button>
        <button class="btn primary" id="btnSaveQ" type="button">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  
  <div class="modal-backdrop" id="codeBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="codeTitle">
      <div class="modal-head">
        <div class="h" id="codeTitle">–°—Å—ã–ª–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã</div>
        <button class="btn small danger" id="btnCloseCode" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modal-body">
        <div class="muted" style="margin-bottom:8px">–≠—Ç–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–≥—Ä—É. –ï—ë –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å –≤ Genially (—á–µ—Ä–µ–∑ iframe) –∏ –∫—É–¥–∞ —É–≥–æ–¥–Ω–æ.</div>
        <label style="margin-top:0">–°—Å—ã–ª–∫–∞</label>
<textarea id="taIframe" spellcheck="false" style="min-height:90px;font-family: ui-monospace, SFMono-Regular, Menlo, monospace;"></textarea>
<label>iframe (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)</label>
<textarea id="taIframe2" spellcheck="false" style="min-height:120px;font-family: ui-monospace, SFMono-Regular, Menlo, monospace;"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnCopyFromModal" type="button">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
          <button class="btn" id="btnCopyIframe" type="button">üìé –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe</button>
          <button class="btn" id="btnDownloadGame" type="button">‚¨á –°–∫–∞—á–∞—Ç—å –∏–≥—Ä—É (HTML)</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ</div>


<script>
(() => {
  "use strict";

  // ===== errors =====
  const errbar = document.getElementById("errbar");
  function showErr(msg){
    if (!errbar) return;
    errbar.classList.add("show");
    errbar.textContent = "–û—à–∏–±–∫–∞ JS:\\n" + msg;
  }
  window.addEventListener("error", (e) => {
    const m = e?.error?.stack || e?.message || String(e);
    showErr(m);
  });
  window.addEventListener("unhandledrejection", (e) => {
    const m = e?.reason?.stack || e?.reason?.message || String(e?.reason || e);
    showErr(m);
  });

  const $ = (id)=>document.getElementById(id);

  const __GAME_CSS__ = "\n    :root{\n      --hud-bg: rgba(10, 12, 18, .55);\n      --panel-bg: rgba(20, 22, 30, .78);\n      --panel-stroke: rgba(255,255,255,.12);\n      --text: rgba(255,255,255,.92);\n      --muted: rgba(255,255,255,.72);\n      --good: rgba(120, 255, 170, .95);\n      --bad: rgba(255, 120, 140, .95);\n      --shadow: 0 18px 60px rgba(0,0,0,.35);\n    }\n    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);overflow:hidden;background:#000;}\n    #wrap{position:relative;width:100%;height:100%;}\n    canvas{width:100%;height:100%;display:block;}\n\n    #hud{\n      position:absolute; left:12px; right:12px; top:12px;\n      display:flex; gap:12px; align-items:center;\n      pointer-events:none;\n      z-index: 3;\n    }\n    .pill{\n      background:var(--hud-bg);\n      border:1px solid rgba(255,255,255,.10);\n      border-radius:999px;\n      padding:10px 14px;\n      box-shadow:var(--shadow);\n      backdrop-filter: blur(10px);\n      display:flex; gap:10px; align-items:center;\n      white-space:nowrap;\n    }\n    #progressWrap{\n      flex:1;\n      background:var(--hud-bg);\n      border:1px solid rgba(255,255,255,.10);\n      border-radius:999px;\n      padding:10px 14px;\n      box-shadow:var(--shadow);\n      backdrop-filter: blur(10px);\n      display:flex; align-items:center; gap:10px;\n      min-width:160px;\n      pointer-events:none;\n    }\n    #bar{\n      height:10px; flex:1;\n      background:rgba(255,255,255,.12);\n      border-radius:999px;\n      overflow:hidden;\n      border:1px solid rgba(255,255,255,.10);\n    }\n    #bar>div{\n      height:100%; width:0%;\n      background: linear-gradient(90deg, rgba(120,190,255,.9), rgba(120,255,170,.85));\n      border-radius:999px;\n    }\n\n    #scorePill{ margin-left:auto; }\n    #scoreNum{ font-weight:900; letter-spacing:.2px; }\n    #leftPill{ gap:12px; }\n    #remainNum{ font-weight:900; }\n\n    #nextBtn{\n      position:absolute;\n      left:50%;\n      bottom:88px;\n      transform: translateX(160px);\n      pointer-events:auto;\n      border-radius:16px;\n      padding:12px 14px;\n      border:1px solid rgba(120,190,255,.35);\n      background: rgba(120,190,255,.22);\n      color: var(--text);\n      font-weight: 900;\n      cursor:pointer;\n      box-shadow: var(--shadow);\n      backdrop-filter: blur(10px);\n      transition: transform .08s ease, filter .12s ease, opacity .12s ease;\n      user-select:none;\n      z-index: 4;\n    }\n    #nextBtn:active{ transform: translateX(160px) scale(.99); }\n    #nextBtn[disabled]{ opacity:.45; cursor:not-allowed; filter:saturate(.7); }\n\n    #overlay{\n      position:absolute; inset:0;\n      display:none; align-items:center; justify-content:center;\n      background: rgba(0,0,0,.25);\n      backdrop-filter: blur(6px);\n      z-index: 5;\n    }\n    #card{\n      width:min(640px, calc(100% - 24px));\n      background:var(--panel-bg);\n      border:1px solid var(--panel-stroke);\n      border-radius:18px;\n      box-shadow:var(--shadow);\n      padding:18px 18px 14px;\n\n      transform: translateY(10px) scale(.96);\n      opacity: 0;\n      transition: transform .18s ease, opacity .18s ease;\n      will-change: transform, opacity;\n    }\n    #overlay.show #card{\n      transform: translateY(0) scale(1);\n      opacity: 1;\n    }\n\n    #cardHeader{\n      display:flex; align-items:flex-start; justify-content:space-between;\n      gap:12px; margin-bottom:12px;\n    }\n    #title{ font-size:16px; color:var(--muted); letter-spacing:.2px; }\n    #q{ font-size:20px; line-height:1.25; margin-top:6px; }\n    #badge{\n      border-radius:999px; padding:6px 10px;\n      border:1px solid rgba(255,255,255,.12);\n      color:var(--muted); font-size:12px; white-space:nowrap;\n    }\n    #answers{ display:flex; flex-direction:column; gap:10px; margin-top:14px; }\n    .btn{\n      width:100%; text-align:left;\n      background:rgba(255,255,255,.08);\n      border:1px solid rgba(255,255,255,.12);\n      border-radius:14px;\n      padding:12px 12px;\n      color:var(--text);\n      cursor:pointer;\n      transition: transform .08s ease, background .12s ease;\n    }\n    .btn:hover{ background:rgba(255,255,255,.11); }\n    .btn:active{ transform:scale(.99); }\n\n    #inputRow{ display:none; gap:10px; align-items:center; margin-top:12px; }\n    #ansInput{\n      flex:1;\n      background:rgba(255,255,255,.07);\n      border:1px solid rgba(255,255,255,.14);\n      border-radius:14px;\n      padding:12px 12px;\n      color:var(--text);\n      outline:none;\n      font-size:16px;\n    }\n    #submit{\n      background:rgba(120,190,255,.20);\n      border:1px solid rgba(120,190,255,.35);\n      border-radius:14px;\n      padding:12px 14px;\n      cursor:pointer;\n      color:var(--text);\n      font-weight:800;\n    }\n    #submit:hover{ background:rgba(120,190,255,.26); }\n\n    #msg{ margin-top:12px; min-height:18px; font-size:14px; color:var(--muted); }\n    #hint{ margin-top:10px; font-size:12px; color:rgba(255,255,255,.55); }\n\n    #start{\n      position:absolute; inset:0;\n      display:flex; align-items:center; justify-content:center;\n      background: radial-gradient(1200px 800px at 50% 45%, rgba(0,0,0,.15), rgba(0,0,0,.55));\n      backdrop-filter: blur(3px);\n      z-index: 6;\n    }\n    #startCard{\n      width:min(700px, calc(100% - 24px));\n      background: rgba(20, 22, 30, .75);\n      border: 1px solid rgba(255,255,255,.12);\n      border-radius: 18px;\n      box-shadow: var(--shadow);\n      padding: 18px;\n    }\n    #startCard h1{ margin:0 0 8px 0; font-size:24px; }\n    #startCard p{ margin:0 0 14px 0; color: var(--muted); line-height:1.35; }\n    #play{\n      display:inline-flex; gap:10px; align-items:center;\n      padding:12px 14px;\n      border-radius:14px;\n      border:1px solid rgba(120,190,255,.35);\n      background: rgba(120,190,255,.22);\n      color: var(--text);\n      font-weight:900;\n      cursor:pointer;\n    }\n    #play:hover{ background: rgba(120,190,255,.28); }\n\n    #err{\n      display:none;\n      margin-top:12px;\n      padding:12px;\n      border-radius:14px;\n      border:1px solid rgba(255,120,140,.35);\n      background: rgba(255,120,140,.12);\n      color: rgba(255,235,238,.95);\n      font-size:13px;\n      line-height:1.35;\n    }\n    #err ul{ margin:8px 0 0 18px; }\n    code{background:rgba(255,255,255,.08); padding:2px 6px; border-radius:8px; border:1px solid rgba(255,255,255,.12);}\n\n    #finish{\n      position:absolute; inset:0;\n      display:none; align-items:center; justify-content:center;\n      background: rgba(0,0,0,.35);\n      backdrop-filter: blur(8px);\n      z-index: 7;\n    }\n    #finishCard{\n      width:min(720px, calc(100% - 24px));\n      border-radius:20px;\n      border:1px solid rgba(255,255,255,.14);\n      background: rgba(18, 20, 28, .75);\n      box-shadow: var(--shadow);\n      padding: 18px 18px 16px;\n      text-align:center;\n    }\n    #finishTitle{\n      font-size:30px; font-weight:1000; letter-spacing:.3px;\n      margin: 4px 0 8px;\n      background: linear-gradient(90deg, rgba(120,190,255,.95), rgba(120,255,170,.95));\n      -webkit-background-clip:text;\n      background-clip:text;\n      color:transparent;\n    }\n    #finishText{\n      color: rgba(255,255,255,.82);\n      font-size:18px;\n      margin: 0 0 10px;\n    }\n    #stats{\n      display:flex;\n      justify-content:center;\n      gap:12px;\n      flex-wrap:wrap;\n      margin: 10px 0 14px;\n    }\n    .stat{\n      background: rgba(255,255,255,.07);\n      border: 1px solid rgba(255,255,255,.12);\n      border-radius: 14px;\n      padding: 10px 12px;\n      min-width: 160px;\n      text-align:left;\n    }\n    .stat b{ font-size:18px; }\n    .stat div{ color: rgba(255,255,255,.70); font-size:12px; margin-top:4px; }\n    #restart{\n      display:inline-flex; gap:10px; align-items:center;\n      padding:12px 14px;\n      border-radius:14px;\n      border:1px solid rgba(120,190,255,.35);\n      background: rgba(120,190,255,.22);\n      color: var(--text);\n      font-weight:900;\n      cursor:pointer;\n    }\n    #restart:hover{ background: rgba(120,190,255,.28); }\n  \n/* per-question timer badge */\n.qTimer{\n  padding:8px 10px;\n  border-radius:999px;\n  border:1px solid rgba(242,211,122,.35);\n  background: rgba(0,0,0,.35);\n  color: rgba(255,255,255,.95);\n  font-weight:900;\n  font-size:12px;\n  box-shadow: 0 10px 30px rgba(0,0,0,.35);\n  backdrop-filter: blur(10px);\n}\n";
    function __b64ToUtf8__(b64){
    const bin = atob(b64);
    const bytes = new Uint8Array(bin.length);
    for (let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
    return new TextDecoder('utf-8').decode(bytes);
  }

  const __GAME_HTML_B64__ = "PGRpdiBpZD0id3JhcCI+CiAgPGNhbnZhcyBpZD0iYyI+PC9jYW52YXM+CgogIDxkaXYgaWQ9Imh1ZCI+CiAgICA8ZGl2IGNsYXNzPSJwaWxsIiBpZD0ibGVmdFBpbGwiPgogICAgICDQkdCw0YjQvdGPOiA8YiBpZD0iaGVpZ2h0VHh0Ij4wPC9iPgogICAgICA8c3BhbiBzdHlsZT0ib3BhY2l0eTouNSI+fDwvc3Bhbj4KICAgICAg0J7RgdGC0LDQu9C+0YHRjDogPGIgaWQ9InJlbWFpbk51bSI+OTwvYj4KICAgIDwvZGl2PgoKICAgIDxkaXYgaWQ9InByb2dyZXNzV3JhcCI+CiAgICAgINCf0YDQvtCz0YDQtdGB0YEKICAgICAgPGRpdiBpZD0iYmFyIj48ZGl2PjwvZGl2PjwvZGl2PgogICAgICA8c3BhbiBpZD0icGN0Ij4wJTwvc3Bhbj4KICAgIDwvZGl2PgoKICAgIDxkaXYgY2xhc3M9InBpbGwiIGlkPSJzY29yZVBpbGwiPtCh0YfRkdGCOiA8YiBpZD0ic2NvcmVOdW0iPjA8L2I+PC9kaXY+CiAgPC9kaXY+CgogIDxidXR0b24gaWQ9Im5leHRCdG4iIGRpc2FibGVkPtCU0LDQu9C10LUg4oaSPC9idXR0b24+CgogIDxkaXYgaWQ9Im92ZXJsYXkiIHJvbGU9ImRpYWxvZyIgYXJpYS1tb2RhbD0idHJ1ZSI+CiAgICA8ZGl2IGlkPSJjYXJkIj4KICAgICAgPGRpdiBpZD0iY2FyZEhlYWRlciI+CiAgICAgICAgPGRpdj4KICAgICAgICAgIDxkaXYgaWQ9InRpdGxlIj7QktC+0L/RgNC+0YE8L2Rpdj4KICAgICAgICAgIDxkaXYgaWQ9InEiPi4uLjwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgc3R5bGU9ImRpc3BsYXk6ZmxleDtmbGV4LWRpcmVjdGlvbjpjb2x1bW47YWxpZ24taXRlbXM6ZmxleC1lbmQ7Z2FwOjhweCI+CiAgICAgICAgICA8ZGl2IGlkPSJiYWRnZSI+MSAvIDk8L2Rpdj4KICAgICAgICAgIDxkaXYgaWQ9InFUaW1lckJhZGdlIiBjbGFzcz0icVRpbWVyIiBzdHlsZT0iZGlzcGxheTpub25lIj7ij7MgMTA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CgogICAgICA8ZGl2IGlkPSJhbnN3ZXJzIj48L2Rpdj4KCiAgICAgIDxkaXYgaWQ9ImlucHV0Um93Ij4KICAgICAgICA8aW5wdXQgaWQ9ImFuc0lucHV0IiB0eXBlPSJ0ZXh0IiBwbGFjZWhvbGRlcj0i0JLQstC10LTQuNGC0LUg0L7RgtCy0LXRgi4uLiIgYXV0b2NvbXBsZXRlPSJvZmYiIC8+CiAgICAgICAgPGJ1dHRvbiBpZD0ic3VibWl0Ij7QntCaPC9idXR0b24+CiAgICAgIDwvZGl2PgoKICAgICAgPGRpdiBpZD0ibXNnIj48L2Rpdj4KICAgICAgPGRpdiBpZD0iaGludCI+0JLQtdGA0L3QviDihpIg0LHQu9C+0Log0L7Qv9GD0YHQutCw0LXRgtGB0Y8g0Lgg0YHRgtCw0L3QvtCy0LjRgtGB0Y8g0Y3RgtCw0LbQvtC8ICgrMTAwKS4g0J3QtdCy0LXRgNC90L4g4oaSINC+0LHRg9Cz0LvQuNCy0LDQvdC40LUsINCy0LfRgNGL0LIg0Lgg0LjRgdGH0LXQt9Cw0LXRgi48L2Rpdj4KICAgIDwvZGl2PgogIDwvZGl2PgoKICA8ZGl2IGlkPSJzdGFydCI+CiAgICA8ZGl2IGlkPSJzdGFydENhcmQiPgogICAgICA8aDE+0JHQsNGI0L3RjyDQt9C90LDQvdC40Lk8L2gxPgogICAgICA8cD4KICAgICAgICDQn9C10YDQstGL0Lkg0LHQu9C+0Log0L/QsNC00LDQtdGCINGB0LDQvC4g0JTQsNC70YzRiNC1IOKAlCDQvdCw0LbQuNC80LDQuSA8Yj7QlNCw0LvQtdC1PC9iPi4KICAgICAgICDQmtC+0LPQtNCwINCx0LvQvtC6INC+0YHRgtCw0L3QvtCy0LjRgtGB0Y8g4oCUINC+0YLQstC10YLRjCDQvdCwINCy0L7Qv9GA0L7RgS4KICAgICAgICA8YnIvPtCS0LXRgNC90L4g4oaSINCx0LvQvtC6INC+0L/Rg9GB0LrQsNC10YLRgdGPINC4INGB0YLQsNC90L7QstC40YLRgdGPINGN0YLQsNC20L7QvCAoKzEwMCkuCiAgICAgICAgPGJyLz7QndC10LLQtdGA0L3QviDihpIg0LHQu9C+0Log0L7QsdGD0LPQu9C40LLQsNC10YLRgdGPLCDQstC30YDRi9Cy0LDQtdGC0YHRjyDQuCDQuNGB0YfQtdC30LDQtdGCLgogICAgICA8L3A+CiAgICAgIDxidXR0b24gaWQ9InBsYXkiPuKWtiDQndCw0YfQsNGC0Yw8L2J1dHRvbj4KICAgICAgPGRpdiBpZD0iZXJyIj4KICAgICAgICA8Yj7QndC1INC/0L7Qu9GD0YfQuNC70L7RgdGMINC30LDQs9GA0YPQt9C40YLRjCDRhNCw0LnQu9GLLjwvYj4g0KPQsdC10LTQuNGB0YwsINGH0YLQviDQvtC90Lgg0LvQtdC20LDRgiDRgNGP0LTQvtC8INGBIDxjb2RlPmluZGV4Lmh0bWw8L2NvZGU+INC4INC40LzQtdC90LAg0YHQvtCy0L/QsNC00LDRjtGCLgogICAgICAgIDx1bCBpZD0iZXJyTGlzdCI+PC91bD4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICA8L2Rpdj4KCiAgPGRpdiBpZD0iZmluaXNoIj4KICAgIDxkaXYgaWQ9ImZpbmlzaENhcmQiPgogICAgICA8ZGl2IGlkPSJmaW5pc2hUaXRsZSI+0JzQvtC70L7QtNC10YYhPC9kaXY+CiAgICAgIDxkaXYgaWQ9ImZpbmlzaFRleHQiPtCi0L7QsdC+0Lkg0LfQsNGA0LDQsdC+0YLQsNC90L46IDxiIGlkPSJmaW5pc2hTY29yZSI+MDwvYj4g0LHQsNC70LvQvtCyPC9kaXY+CgogICAgICA8ZGl2IGlkPSJzdGF0cyI+CiAgICAgICAgPGRpdiBjbGFzcz0ic3RhdCI+PGIgaWQ9InN0Q29ycmVjdCI+MDwvYj48ZGl2PtC/0YDQsNCy0LjQu9GM0L3Ri9GFINC+0YLQstC10YLQvtCyPC9kaXY+PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0ic3RhdCI+PGIgaWQ9InN0V3JvbmciPjA8L2I+PGRpdj7QvdC10L/RgNCw0LLQuNC70YzQvdGL0YUg0L7RgtCy0LXRgtC+0LI8L2Rpdj48L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJzdGF0Ij48YiBpZD0ic3RIZWlnaHQiPjA8L2I+PGRpdj7QsdC70L7QutC+0LIg0LIg0LHQsNGI0L3QtTwvZGl2PjwvZGl2PgogICAgICA8L2Rpdj4KCiAgICAgIDxidXR0b24gaWQ9InJlc3RhcnQiPuKGuyDQodGL0LPRgNCw0YLRjCDQtdGJ0ZEg0YDQsNC3PC9idXR0b24+CiAgICA8L2Rpdj4KICA8L2Rpdj4KPC9kaXY+";
  const __GAME_JS_B64__ = "ZnVuY3Rpb24gdGh1ZFNvdW5kKCl7dHJ5e2NvbnN0IGN0eD13aW5kb3cuX19hdWRpb0N0eHx8KHdpbmRvdy5fX2F1ZGlvQ3R4PW5ldyAod2luZG93LkF1ZGlvQ29udGV4dHx8d2luZG93LndlYmtpdEF1ZGlvQ29udGV4dCkoKSk7Y29uc3Qgbz1jdHguY3JlYXRlT3NjaWxsYXRvcigpO2NvbnN0IGc9Y3R4LmNyZWF0ZUdhaW4oKTtvLnR5cGU9J3NpbmUnO28uZnJlcXVlbmN5LnNldFZhbHVlQXRUaW1lKDEyMCxjdHguY3VycmVudFRpbWUpO28uZnJlcXVlbmN5LmV4cG9uZW50aWFsUmFtcFRvVmFsdWVBdFRpbWUoNTUsY3R4LmN1cnJlbnRUaW1lKzAuMTApO2cuZ2Fpbi5zZXRWYWx1ZUF0VGltZSgwLjAwMDEsY3R4LmN1cnJlbnRUaW1lKTtnLmdhaW4uZXhwb25lbnRpYWxSYW1wVG9WYWx1ZUF0VGltZSgwLjIyLGN0eC5jdXJyZW50VGltZSswLjAxNSk7Zy5nYWluLmV4cG9uZW50aWFsUmFtcFRvVmFsdWVBdFRpbWUoMC4wMDAxLGN0eC5jdXJyZW50VGltZSswLjE4KTtvLmNvbm5lY3QoZyk7Zy5jb25uZWN0KGN0eC5kZXN0aW5hdGlvbik7by5zdGFydCgpO28uc3RvcChjdHguY3VycmVudFRpbWUrMC4yMCk7fWNhdGNoKGUpe319CgovKiog0KTQkNCZ0JvQqyAqLwpjb25zdCBCR19GSUxFID0gIjEucG5nIjsKY29uc3QgQkxPQ0tfRklMRVMgPSBbIjMucG5nIiwiNC5wbmciLCI1LnBuZyIsIjYucG5nIiwiNy5wbmciLCI4LnBuZyIsIjkucG5nIiwiMTAucG5nIiwiMTEucG5nIl07CgovKiog0J7Qp9Ca0JggKi8KY29uc3QgU0NPUkVfUEVSX0JMT0NLID0gMTAwOwoKLyogUVVFU1RJT05TIGluamVjdGVkIGZyb20gY2ZnICovCmxldCBRVUVTVElPTlMgPSBbXTsKCi8qKiDQlNC40L3QsNC80LjQutCwICovCmNvbnN0IEZBTExfU1BFRUQgPSA2MjA7CmNvbnN0IERST1BfU1BFRUQgPSA5MDA7CgovKiog0K3RhNGE0LXQutGC0YsgKi8KY29uc3QgU0hBS0VfT05fQk9PTSA9IDE4Owpjb25zdCBTSEFLRV9PTl9MQU5EID0gNzsKCi8qKiDQn9GA0L7Qs9GA0LXRgdGBICovCmNvbnN0IFRBUkdFVF9CTE9DS1NfRk9SXzEwMCA9IDk7CgovKiog0JLQu9C10LfQsNC90LjQtSAqLwpjb25zdCBTQUZFX1RPUF9NQVJHSU4gPSA4NjsKY29uc3QgU0FGRV9CT1RUT01fTUFSR0lOID0gMTAwOwpjb25zdCBERVNJUkVEX1RPV0VSX1dJRFRIID0gKCkgPT4gTWF0aC5taW4od2luZG93LmlubmVyV2lkdGggKiAwLjM4LCAzNjApOwoKLyoqIFRSSU0vUFJPRklMRSAqLwpjb25zdCBUUklNX0FMUEhBX01JTiA9IDM0Owpjb25zdCBQUk9GSUxFX0FMUEhBX01JTiA9IDIyOwpjb25zdCBDRU5UUk9JRF9BTFBIQV9NSU4gPSAyNDsKCi8qKiDQn9GA0YPQttC40L3Rj9GJ0LjQuSDigJxib3VuY2XigJ0g0L/RgNC4INC/0YDQuNC30LXQvNC70LXQvdC40LggKi8KY29uc3QgTEFORF9CT1VOQ0VfVVAgPSAxMDsgICAgICAvLyBweCDQstCy0LXRgNGFINC/0LXRgNC10LQg0YTQuNC90LDQu9GM0L3Ri9C8INC/0YDQuNC20LDRgtC40LXQvApjb25zdCBMQU5EX0JPVU5DRV9USU1FID0gMC4xMDsgIC8vINGB0LXQugoKY29uc3QgY2FudmFzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImMiKTsKY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoIjJkIik7Cgpjb25zdCBvdmVybGF5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm92ZXJsYXkiKTsKY29uc3QgcUVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInEiKTsKY29uc3QgYmFkZ2VFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJiYWRnZSIpOwpjb25zdCBhbnN3ZXJzRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYW5zd2VycyIpOwpjb25zdCBpbnB1dFJvdyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJpbnB1dFJvdyIpOwpjb25zdCBhbnNJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJhbnNJbnB1dCIpOwpjb25zdCBzdWJtaXRCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic3VibWl0Iik7CmNvbnN0IG1zZ0VsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm1zZyIpOwoKY29uc3Qgc3RhcnRMYXllciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzdGFydCIpOwpjb25zdCBwbGF5QnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInBsYXkiKTsKCmNvbnN0IGZpbmlzaExheWVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZpbmlzaCIpOwpjb25zdCBmaW5pc2hTY29yZUVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImZpbmlzaFNjb3JlIik7CmNvbnN0IHN0Q29ycmVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzdENvcnJlY3QiKTsKY29uc3Qgc3RXcm9uZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzdFdyb25nIik7CmNvbnN0IHN0SGVpZ2h0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInN0SGVpZ2h0Iik7CmNvbnN0IHJlc3RhcnRCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicmVzdGFydCIpOwoKY29uc3QgZXJyQm94ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImVyciIpOwpjb25zdCBlcnJMaXN0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImVyckxpc3QiKTsKCmNvbnN0IGhlaWdodFR4dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJoZWlnaHRUeHQiKTsKY29uc3QgcmVtYWluTnVtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInJlbWFpbk51bSIpOwpjb25zdCBwY3RUeHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicGN0Iik7CmNvbnN0IGJhckZpbGwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIjYmFyID4gZGl2Iik7Cgpjb25zdCBzY29yZU51bSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzY29yZU51bSIpOwpjb25zdCBuZXh0QnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm5leHRCdG4iKTsKCmxldCBXPTAsSD0wLERQUj0xOwpmdW5jdGlvbiByZXNpemUoKXsKICBEUFIgPSBNYXRoLm1heCgxLCBNYXRoLmZsb29yKHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvIHx8IDEpKTsKICBXID0gTWF0aC5mbG9vcih3aW5kb3cuaW5uZXJXaWR0aCk7CiAgSCA9IE1hdGguZmxvb3Iod2luZG93LmlubmVySGVpZ2h0KTsKICBjYW52YXMud2lkdGggPSBXICogRFBSOwogIGNhbnZhcy5oZWlnaHQgPSBIICogRFBSOwogIGN0eC5zZXRUcmFuc2Zvcm0oRFBSLDAsMCxEUFIsMCwwKTsKfQp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicmVzaXplIiwgcmVzaXplKTsKcmVzaXplKCk7CgovKiogQXVkaW8gKi8KbGV0IGF1ZGlvQ3R4PW51bGw7CmZ1bmN0aW9uIGVuc3VyZUF1ZGlvKCl7IGlmKCFhdWRpb0N0eCkgYXVkaW9DdHggPSBuZXcgKHdpbmRvdy5BdWRpb0NvbnRleHQgfHwgd2luZG93LndlYmtpdEF1ZGlvQ29udGV4dCkoKTsgfQpmdW5jdGlvbiBwbGF5Qm9vbSgpewogIGVuc3VyZUF1ZGlvKCk7CiAgY29uc3QgdCA9IGF1ZGlvQ3R4LmN1cnJlbnRUaW1lOwoKICBjb25zdCBvc2MgPSBhdWRpb0N0eC5jcmVhdGVPc2NpbGxhdG9yKCk7CiAgY29uc3QgZ2FpbiA9IGF1ZGlvQ3R4LmNyZWF0ZUdhaW4oKTsKICBvc2MudHlwZT0ic2F3dG9vdGgiOwogIG9zYy5mcmVxdWVuY3kuc2V0VmFsdWVBdFRpbWUoMTIwLHQpOwogIG9zYy5mcmVxdWVuY3kuZXhwb25lbnRpYWxSYW1wVG9WYWx1ZUF0VGltZSgzOCx0KzAuMjIpOwogIGdhaW4uZ2Fpbi5zZXRWYWx1ZUF0VGltZSgwLjAwMDEsdCk7CiAgZ2Fpbi5nYWluLmV4cG9uZW50aWFsUmFtcFRvVmFsdWVBdFRpbWUoMC41MCx0KzAuMDIpOwogIGdhaW4uZ2Fpbi5leHBvbmVudGlhbFJhbXBUb1ZhbHVlQXRUaW1lKDAuMDAwMSx0KzAuMzQpOwoKICBjb25zdCBub2lzZUJ1ZiA9IGF1ZGlvQ3R4LmNyZWF0ZUJ1ZmZlcigxLCBhdWRpb0N0eC5zYW1wbGVSYXRlKjAuMzAsIGF1ZGlvQ3R4LnNhbXBsZVJhdGUpOwogIGNvbnN0IGRhdGEgPSBub2lzZUJ1Zi5nZXRDaGFubmVsRGF0YSgwKTsKICBmb3IobGV0IGk9MDtpPGRhdGEubGVuZ3RoO2krKykgZGF0YVtpXT0oTWF0aC5yYW5kb20oKSoyLTEpKjAuOTU7CiAgY29uc3Qgbm9pc2UgPSBhdWRpb0N0eC5jcmVhdGVCdWZmZXJTb3VyY2UoKTsgbm9pc2UuYnVmZmVyPW5vaXNlQnVmOwogIGNvbnN0IG5HYWluID0gYXVkaW9DdHguY3JlYXRlR2FpbigpOwogIG5HYWluLmdhaW4uc2V0VmFsdWVBdFRpbWUoMC4wMDAxLHQpOwogIG5HYWluLmdhaW4uZXhwb25lbnRpYWxSYW1wVG9WYWx1ZUF0VGltZSgwLjQwLHQrMC4wMSk7CiAgbkdhaW4uZ2Fpbi5leHBvbmVudGlhbFJhbXBUb1ZhbHVlQXRUaW1lKDAuMDAwMSx0KzAuMzApOwoKICBjb25zdCBmaWx0ZXIgPSBhdWRpb0N0eC5jcmVhdGVCaXF1YWRGaWx0ZXIoKTsKICBmaWx0ZXIudHlwZT0ibG93cGFzcyI7CiAgZmlsdGVyLmZyZXF1ZW5jeS5zZXRWYWx1ZUF0VGltZSgxNzAwLHQpOwogIGZpbHRlci5mcmVxdWVuY3kuZXhwb25lbnRpYWxSYW1wVG9WYWx1ZUF0VGltZSgzMjAsdCswLjI2KTsKCiAgb3NjLmNvbm5lY3QoZ2FpbikuY29ubmVjdChhdWRpb0N0eC5kZXN0aW5hdGlvbik7CiAgbm9pc2UuY29ubmVjdChmaWx0ZXIpLmNvbm5lY3QobkdhaW4pLmNvbm5lY3QoYXVkaW9DdHguZGVzdGluYXRpb24pOwoKICBvc2Muc3RhcnQodCk7IG9zYy5zdG9wKHQrMC4zNik7CiAgbm9pc2Uuc3RhcnQodCk7IG5vaXNlLnN0b3AodCswLjMyKTsKfQpmdW5jdGlvbiBwbGF5R29vZCgpewogIGVuc3VyZUF1ZGlvKCk7CiAgY29uc3QgdCA9IGF1ZGlvQ3R4LmN1cnJlbnRUaW1lOwogIGNvbnN0IG9zYyA9IGF1ZGlvQ3R4LmNyZWF0ZU9zY2lsbGF0b3IoKTsKICBjb25zdCBnYWluID0gYXVkaW9DdHguY3JlYXRlR2FpbigpOwogIG9zYy50eXBlPSJ0cmlhbmdsZSI7CiAgb3NjLmZyZXF1ZW5jeS5zZXRWYWx1ZUF0VGltZSg0MjAsdCk7CiAgb3NjLmZyZXF1ZW5jeS5leHBvbmVudGlhbFJhbXBUb1ZhbHVlQXRUaW1lKDc4MCx0KzAuMTIpOwogIGdhaW4uZ2Fpbi5zZXRWYWx1ZUF0VGltZSgwLjAwMDEsdCk7CiAgZ2Fpbi5nYWluLmV4cG9uZW50aWFsUmFtcFRvVmFsdWVBdFRpbWUoMC4yMCx0KzAuMDIpOwogIGdhaW4uZ2Fpbi5leHBvbmVudGlhbFJhbXBUb1ZhbHVlQXRUaW1lKDAuMDAwMSx0KzAuMTgpOwogIG9zYy5jb25uZWN0KGdhaW4pLmNvbm5lY3QoYXVkaW9DdHguZGVzdGluYXRpb24pOwogIG9zYy5zdGFydCh0KTsgb3NjLnN0b3AodCswLjIpOwp9CgovKiogQXNzZXRzICovCmZ1bmN0aW9uIGFzc2V0VXJsKGZpbGUpeyByZXR1cm4gbmV3IFVSTChmaWxlLCBuZXcgVVJMKCIuIiwgd2luZG93LmxvY2F0aW9uLmhyZWYpKS50b1N0cmluZygpOyB9CmZ1bmN0aW9uIGxvYWRJbWFnZSh1cmwpewogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KT0+ewogICAgY29uc3QgaW1nPW5ldyBJbWFnZSgpOwogICAgaW1nLm9ubG9hZD0oKT0+cmVzb2x2ZShpbWcpOwogICAgaW1nLm9uZXJyb3I9KCk9PnJlamVjdChuZXcgRXJyb3IodXJsKSk7CiAgICBpbWcuc3JjPXVybDsKICB9KTsKfQoKLyoqINCf0YDQvtGE0LjQu9C4ICovCmZ1bmN0aW9uIGJ1aWxkVG9wQm90dG9tUHJvZmlsZXMoaW1hZ2VEYXRhLCB3LCBoKXsKICBjb25zdCBkID0gaW1hZ2VEYXRhLmRhdGE7CiAgY29uc3QgdG9wID0gbmV3IEFycmF5KHcpLmZpbGwoaCk7CiAgY29uc3QgYm90dG9tID0gbmV3IEFycmF5KHcpLmZpbGwoLTEpOwoKICBmb3IobGV0IHg9MDt4PHc7eCsrKXsKICAgIGZvcihsZXQgeT0wO3k8aDt5KyspewogICAgICBjb25zdCBhID0gZFsoeSp3ICsgeCkqNCArIDNdOwogICAgICBpZihhID49IFBST0ZJTEVfQUxQSEFfTUlOKXsgdG9wW3hdPXk7IGJyZWFrOyB9CiAgICB9CiAgICBmb3IobGV0IHk9aC0xO3k+PTA7eS0tKXsKICAgICAgY29uc3QgYSA9IGRbKHkqdyArIHgpKjQgKyAzXTsKICAgICAgaWYoYSA+PSBQUk9GSUxFX0FMUEhBX01JTil7IGJvdHRvbVt4XT15OyBicmVhazsgfQogICAgfQogICAgaWYoYm90dG9tW3hdIDwgMCl7IGJvdHRvbVt4XSA9IGgtMTsgfQogICAgaWYodG9wW3hdID49IGgpeyB0b3BbeF0gPSAwOyB9CiAgfQogIHJldHVybiB7IHRvcCwgYm90dG9tIH07Cn0KCmZ1bmN0aW9uIHRyaW1BbmRDZW50cm9pZEFuZFByb2ZpbGVzKGltZyl7CiAgY29uc3QgYz1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICBjLndpZHRoPWltZy53aWR0aDsgYy5oZWlnaHQ9aW1nLmhlaWdodDsKICBjb25zdCBnPWMuZ2V0Q29udGV4dCgiMmQiKTsKICBnLmRyYXdJbWFnZShpbWcsMCwwKTsKCiAgY29uc3QgaW09Zy5nZXRJbWFnZURhdGEoMCwwLGMud2lkdGgsYy5oZWlnaHQpOwogIGNvbnN0IGQ9aW0uZGF0YTsKCiAgbGV0IG1pblg9Yy53aWR0aCwgbWluWT1jLmhlaWdodCwgbWF4WD0tMSwgbWF4WT0tMTsKICBsZXQgc3VtQT0wLCBzdW1YPTAsIHN1bVk9MDsKCiAgZm9yKGxldCB5PTA7eTxjLmhlaWdodDt5KyspewogICAgZm9yKGxldCB4PTA7eDxjLndpZHRoO3grKyl7CiAgICAgIGNvbnN0IGEgPSBkWyh5KmMud2lkdGggKyB4KSo0ICsgM107CiAgICAgIGlmKGEgPj0gVFJJTV9BTFBIQV9NSU4pewogICAgICAgIGlmKHg8bWluWCkgbWluWD14OwogICAgICAgIGlmKHk8bWluWSkgbWluWT15OwogICAgICAgIGlmKHg+bWF4WCkgbWF4WD14OwogICAgICAgIGlmKHk+bWF4WSkgbWF4WT15OwogICAgICB9CiAgICAgIGlmKGEgPj0gQ0VOVFJPSURfQUxQSEFfTUlOKXsKICAgICAgICBjb25zdCB3Z3Q9YTsKICAgICAgICBzdW1BICs9IHdndDsKICAgICAgICBzdW1YICs9IHgqd2d0OwogICAgICAgIHN1bVkgKz0geSp3Z3Q7CiAgICAgIH0KICAgIH0KICB9CgogIGlmKG1heFg8MCB8fCBtYXhZPDApewogICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IGltZywgdzogaW1nLndpZHRoLCBoOiBpbWcuaGVpZ2h0LCBjeDogaW1nLndpZHRoLzIsIGN5OiBpbWcuaGVpZ2h0LzIsIHRvcDpudWxsLCBib3R0b206bnVsbCB9KTsKICB9CgogIGNvbnN0IHcgPSAobWF4WC1taW5YKzEpOwogIGNvbnN0IGggPSAobWF4WS1taW5ZKzEpOwoKICBjb25zdCBvdXRDPWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpOwogIG91dEMud2lkdGg9dzsgb3V0Qy5oZWlnaHQ9aDsKICBjb25zdCBvZz1vdXRDLmdldENvbnRleHQoIjJkIik7CiAgb2cuZHJhd0ltYWdlKGMsIG1pblgsIG1pblksIHcsIGgsIDAsIDAsIHcsIGgpOwoKICBjb25zdCBjcm9wcGVkID0gb2cuZ2V0SW1hZ2VEYXRhKDAsMCx3LGgpOwogIGNvbnN0IHsgdG9wLCBib3R0b20gfSA9IGJ1aWxkVG9wQm90dG9tUHJvZmlsZXMoY3JvcHBlZCwgdywgaCk7CgogIGxldCBjeD13LzIsIGN5PWgvMjsKICBpZihzdW1BPjApewogICAgY3ggPSAoc3VtWC9zdW1BKSAtIG1pblg7CiAgICBjeSA9IChzdW1ZL3N1bUEpIC0gbWluWTsKICB9CgogIGNvbnN0IG91dD1uZXcgSW1hZ2UoKTsKICBvdXQuc3JjPW91dEMudG9EYXRhVVJMKCJpbWFnZS9wbmciKTsKICByZXR1cm4gbmV3IFByb21pc2UoKHJlcyxyZWopPT57CiAgICBvdXQub25sb2FkPSgpPT5yZXMoeyBpbWc6IG91dCwgdywgaCwgY3gsIGN5LCB0b3AsIGJvdHRvbSB9KTsKICAgIG91dC5vbmVycm9yPXJlajsKICB9KTsKfQoKLyoqIFN0YXRlICovCmNvbnN0IHN0YXRlID0gewogIHJ1bm5pbmc6ZmFsc2UsCiAgYmc6bnVsbCwKICBibG9ja3M6W10sCiAgdG93ZXJTY2FsZToxLAoKICB0b3dlcjpbXSwKICBjdXJyZW50Om51bGwsCgogIHBhcnRpY2xlczpbXSwKICBzbW9rZXM6W10sCiAgcmluZ3M6W10sCiAgc3BhcmtzOltdLAogIGZsYXNoOjAsCgogIGNhbWVyYVNoYWtlOjAsCiAgY2FtZXJhWDowLCBjYW1lcmFZOjAsCgogIHRvd2VyT2Zmc2V0WTowLAogIHRvd2VyT2Zmc2V0VjowLAoKICBxdWVzdGlvbkluZGV4OjAsCiAgd2FpdGluZ0Fuc3dlcjpmYWxzZSwKICBkcm9wcGluZzpmYWxzZSwKCiAgYmxvY2tJbmRleDowLAogIHJlYWR5Rm9yTmV4dDpmYWxzZSwKCiAgZmluaXNoZWQ6ZmFsc2UsCgogIHNjb3JlOjAsCiAgc2NvcmVGbG9hdHM6W10sCgogIGNvcnJlY3Q6MCwKICB3cm9uZzowLAoKICAvLyBib3VuY2Ugc3RhdGUKICBsYW5kaW5nQm91bmNlOiBudWxsLCAvLyB7ZnJvbVksdG9ZLGFnZSxkdXJ9Cn07CgovKiogSFVEIGhlbHBlcnMgKi8KZnVuY3Rpb24gc2V0TmV4dEVuYWJsZWQob24pewogIHN0YXRlLnJlYWR5Rm9yTmV4dCA9IG9uOwogIG5leHRCdG4uZGlzYWJsZWQgPSAhb247Cn0KZnVuY3Rpb24gdXBkYXRlUmVtYWluKCl7CiAgY29uc3QgcmVtYWluID0gTWF0aC5tYXgoMCwgOSAtIHN0YXRlLnF1ZXN0aW9uSW5kZXgpOwogIHJlbWFpbk51bS50ZXh0Q29udGVudCA9IFN0cmluZyhyZW1haW4pOwp9CgpmdW5jdGlvbiBncm91bmRZKCl7CiAgcmV0dXJuIEggLSA3MCArIHN0YXRlLnRvd2VyT2Zmc2V0WTsKfQpmdW5jdGlvbiBhbGlnbmVkWEZvcklkeChpZHgpewogIGNvbnN0IGIgPSBzdGF0ZS5ibG9ja3NbaWR4XTsKICBjb25zdCBjeFNjYWxlZCA9IGIuY3ggKiBzdGF0ZS50b3dlclNjYWxlOwogIHJldHVybiAoVy8yKSAtIGN4U2NhbGVkOwp9CmZ1bmN0aW9uIGJsb2NrU2l6ZShpZHgpewogIGNvbnN0IGIgPSBzdGF0ZS5ibG9ja3NbaWR4XTsKICByZXR1cm4geyB3OiBiLncqc3RhdGUudG93ZXJTY2FsZSwgaDogYi5oKnN0YXRlLnRvd2VyU2NhbGUgfTsKfQpmdW5jdGlvbiBjb21wdXRlVG93ZXJTY2FsZShibG9ja3MpewogIGNvbnN0IG1heFcgPSBNYXRoLm1heCguLi5ibG9ja3MubWFwKGIgPT4gYi53KSk7CiAgY29uc3QgdG90YWxIID0gYmxvY2tzLnJlZHVjZSgocyxiKT0+cytiLmgsMCk7CiAgY29uc3Qgc2NhbGVCeVdpZHRoID0gREVTSVJFRF9UT1dFUl9XSURUSCgpIC8gbWF4VzsKICBjb25zdCBhdmFpbGFibGVIID0gTWF0aC5tYXgoMjIwLCBIIC0gU0FGRV9UT1BfTUFSR0lOIC0gU0FGRV9CT1RUT01fTUFSR0lOKTsKICBjb25zdCBzY2FsZUJ5SGVpZ2h0ID0gYXZhaWxhYmxlSCAvIHRvdGFsSDsKICByZXR1cm4gTWF0aC5taW4oc2NhbGVCeVdpZHRoLCBzY2FsZUJ5SGVpZ2h0KTsKfQoKLyoqINCf0LjQutGB0LXQu9GM0L3QviDRgtC+0YfQvdGL0Lkg0YHRgtC10LogKi8KZnVuY3Rpb24gY29tcHV0ZVN0YWNrWSh1cHBlciwgbG93ZXIpewogIGNvbnN0IHN1ID0gc3RhdGUudG93ZXJTY2FsZTsKICBjb25zdCB1cHBlck1ldGEgPSBzdGF0ZS5ibG9ja3NbdXBwZXIuaWR4XTsKICBjb25zdCBsb3dlck1ldGEgPSBzdGF0ZS5ibG9ja3NbbG93ZXIuaWR4XTsKCiAgY29uc3Qgb3ZlcmxhcExlZnQgPSBNYXRoLm1heCh1cHBlci54LCBsb3dlci54KTsKICBjb25zdCBvdmVybGFwUmlnaHQgPSBNYXRoLm1pbih1cHBlci54ICsgdXBwZXIudywgbG93ZXIueCArIGxvd2VyLncpOwoKICBpZihvdmVybGFwUmlnaHQgPD0gb3ZlcmxhcExlZnQgKyAyKXsKICAgIHJldHVybiBNYXRoLnJvdW5kKGxvd2VyLnkgLSB1cHBlci5oKTsKICB9CgogIGxldCB5TWF4QWxsb3dlZCA9IEluZmluaXR5OwogIGNvbnN0IHN0ZXAgPSAyOwoKICBmb3IobGV0IHd4ID0gb3ZlcmxhcExlZnQ7IHd4IDw9IG92ZXJsYXBSaWdodDsgd3ggKz0gc3RlcCl7CiAgICBjb25zdCB4dSA9IE1hdGguZmxvb3IoKHd4IC0gdXBwZXIueCkgLyBzdSk7CiAgICBjb25zdCB4bCA9IE1hdGguZmxvb3IoKHd4IC0gbG93ZXIueCkgLyBzdSk7CiAgICBpZih4dSA8IDAgfHwgeHUgPj0gdXBwZXJNZXRhLncpIGNvbnRpbnVlOwogICAgaWYoeGwgPCAwIHx8IHhsID49IGxvd2VyTWV0YS53KSBjb250aW51ZTsKCiAgICBjb25zdCBidSA9IHVwcGVyTWV0YS5ib3R0b21beHVdOwogICAgY29uc3QgdGwgPSBsb3dlck1ldGEudG9wW3hsXTsKCiAgICBjb25zdCBhbGxvd2VkID0gbG93ZXIueSArIHRsKnN1IC0gYnUqc3U7CiAgICBpZihhbGxvd2VkIDwgeU1heEFsbG93ZWQpIHlNYXhBbGxvd2VkID0gYWxsb3dlZDsKICB9CiAgLy8g0L/Qu9C+0YLQvdC10LUg0LHQtdC3INGJ0LXQu9C10LkKICByZXR1cm4gTWF0aC5yb3VuZCh5TWF4QWxsb3dlZCkgLSAxOwp9CgovKiogc3Bhd24gKi8KZnVuY3Rpb24gc3Bhd25CbG9jaygpewogIGlmKHN0YXRlLmZpbmlzaGVkKSByZXR1cm47CiAgaWYoc3RhdGUuYmxvY2tJbmRleCA+PSA5KXsgZmluaXNoR2FtZSgpOyByZXR1cm47IH0KCiAgY29uc3QgaWR4ID0gc3RhdGUuYmxvY2tJbmRleDsKICBjb25zdCB7dyxofSA9IGJsb2NrU2l6ZShpZHgpOwoKICBzdGF0ZS5jdXJyZW50ID0geyBpZHgsIHcsaCwgeDogYWxpZ25lZFhGb3JJZHgoaWR4KSwgeTogLWggLSAzMCwgY2hhcjowIH07CiAgc3RhdGUuZHJvcHBpbmc9ZmFsc2U7CiAgc3RhdGUud2FpdGluZ0Fuc3dlcj1mYWxzZTsKICBzdGF0ZS5sYW5kaW5nQm91bmNlPW51bGw7CiAgc2V0TmV4dEVuYWJsZWQoZmFsc2UpOwp9CgovKiogc2NvcmUgcG9wICovCmZ1bmN0aW9uIGFkZFNjb3JlUG9wKHgseSwgdGV4dCl7CiAgc3RhdGUuc2NvcmVGbG9hdHMucHVzaCh7CiAgICB4LCB5LAogICAgdng6IChNYXRoLnJhbmRvbSgpKjItMSkqMzAsCiAgICB2eTogLTE2MCAtIE1hdGgucmFuZG9tKCkqNjAsCiAgICBsaWZlOiAwLjg1LAogICAgYWdlOiAwLAogICAgdGV4dAogIH0pOwp9CgovKiogc3BhcmtzIGF0IHNlYW0gKi8KZnVuY3Rpb24gc3BhcmtzQXRTZWFtKHgsIHkpewogIGZvcihsZXQgaT0wO2k8MTg7aSsrKXsKICAgIGNvbnN0IGEgPSAoLU1hdGguUEkvMikgKyAoTWF0aC5yYW5kb20oKSpNYXRoLlBJKjAuOSAtIE1hdGguUEkqMC40NSk7CiAgICBjb25zdCBzcCA9IDIyMCArIE1hdGgucmFuZG9tKCkqMzYwOwogICAgc3RhdGUuc3BhcmtzLnB1c2goewogICAgICB4OiB4ICsgKE1hdGgucmFuZG9tKCkqNDAgLSAyMCksCiAgICAgIHk6IHkgKyAoTWF0aC5yYW5kb20oKSo2IC0gMyksCiAgICAgIHZ4OiBNYXRoLmNvcyhhKSpzcCwKICAgICAgdnk6IE1hdGguc2luKGEpKnNwIC0gKDQwK01hdGgucmFuZG9tKCkqNjApLAogICAgICBsaWZlOiAwLjQ1ICsgTWF0aC5yYW5kb20oKSowLjIsCiAgICAgIGFnZTogMAogICAgfSk7CiAgfQp9CgovKiogc21va2UvZHVzdCAqLwpmdW5jdGlvbiBkdXN0QXQoeCx5KXsKICBmb3IobGV0IGk9MDtpPDEwO2krKyl7CiAgICBjb25zdCBhPU1hdGgucmFuZG9tKCkqTWF0aC5QSSoyOwogICAgY29uc3Qgc3A9MzArTWF0aC5yYW5kb20oKSoxMTA7CiAgICBzdGF0ZS5zbW9rZXMucHVzaCh7CiAgICAgIHg6eCArIChNYXRoLnJhbmRvbSgpKjE4LTkpLAogICAgICB5OnkgKyAoTWF0aC5yYW5kb20oKSoxMC01KSwKICAgICAgdng6TWF0aC5jb3MoYSkqc3AsCiAgICAgIHZ5Ok1hdGguc2luKGEpKnNwIC0gKDMwK01hdGgucmFuZG9tKCkqNDApLAogICAgICBsaWZlOjAuNTUrTWF0aC5yYW5kb20oKSowLjM1LAogICAgICBhZ2U6MCwKICAgICAgcmFkOiAxMCtNYXRoLnJhbmRvbSgpKjE0CiAgICB9KTsKICB9Cn0KCi8qKiBzZXR0bGUgd2l0aCBib3VuY2UgKi8KZnVuY3Rpb24gc2V0dGxlQ3VycmVudEJsb2NrKCl7CiAgY29uc3QgYiA9IHN0YXRlLmN1cnJlbnQ7CgogIGxldCB5RmluYWw7CiAgaWYoc3RhdGUudG93ZXIubGVuZ3RoPT09MCl7CiAgICB5RmluYWwgPSBNYXRoLnJvdW5kKGdyb3VuZFkoKSAtIGIuaCk7CiAgfSBlbHNlIHsKICAgIGNvbnN0IGxvd2VyID0gc3RhdGUudG93ZXJbc3RhdGUudG93ZXIubGVuZ3RoIC0gMV07CiAgICB5RmluYWwgPSBjb21wdXRlU3RhY2tZKGIsIGxvd2VyKTsKICB9CgogIC8vIGJvdW5jZTog0YHQvdCw0YfQsNC70LAg0YfRg9GC0Ywg0LLRi9GI0LUsINC/0L7RgtC+0Lwg0LLQvdC40Lcg0LIg0YTQuNC90LDQuwogIGNvbnN0IHlVcCA9IE1hdGgubWF4KC0yMDAsIHlGaW5hbCAtIExBTkRfQk9VTkNFX1VQKTsKICBzdGF0ZS5sYW5kaW5nQm91bmNlID0geyBmcm9tWTogeVVwLCB0b1k6IHlGaW5hbCwgYWdlOiAwLCBkdXI6IExBTkRfQk9VTkNFX1RJTUUgfTsKCiAgYi54ID0gTWF0aC5yb3VuZChiLngpOwogIGIueSA9IHlVcDsKCiAgLy8g0JfQsNC/0L7QvNC90LjQvCDQstGA0LXQvNC10L3QvdC+IOKAnNGB0L7QsdC40YDQsNC10LzRi9C54oCdINCx0LvQvtC6LCDQtNC+0LHQsNCy0LjQvCDQsiDQsdCw0YjQvdGOINGC0L7Qu9GM0LrQviDQv9C+0YHQu9C1IGJvdW5jZQp9CgovKiogZmluYWxpemUgbGFuZCAqLwpmdW5jdGlvbiBmaW5hbGl6ZUxhbmQoKXsKICB0cnl7IHRodWRTb3VuZCgpOyB9Y2F0Y2goZSl7fQoKICBjb25zdCBiID0gc3RhdGUuY3VycmVudDsKICBpZighYikgcmV0dXJuOwoKICAvLyDQuNGB0LrRgNGLINC40Lcg0YjQstCwICh4INC/0L4g0YbQtdC90YLRgNGDINCx0LDRiNC90LgsIHkg0L3QsCDRgdGC0YvQutC1KQogIGNvbnN0IHNlYW1ZID0gYi55ICsgYi5oOwogIHNwYXJrc0F0U2VhbShXLzIsIHNlYW1ZKTsKCiAgc3RhdGUudG93ZXIucHVzaCh7CiAgICB4OiBNYXRoLnJvdW5kKGIueCksCiAgICB5OiBNYXRoLnJvdW5kKGIueSksCiAgICB3OiBiLncsIGg6IGIuaCwgaWR4OiBiLmlkeCwKICAgIHNxdWFzaDoxLjAsIHNxdWFzaFY6MC4wCiAgfSk7CgogIC8vINC+0YfQutC4CiAgc3RhdGUuc2NvcmUgKz0gU0NPUkVfUEVSX0JMT0NLOwogIHNjb3JlTnVtLnRleHRDb250ZW50ID0gU3RyaW5nKHN0YXRlLnNjb3JlKTsKICBhZGRTY29yZVBvcChXLzIgKyA3MCwgYi55ICsgMzAsIGArJHtTQ09SRV9QRVJfQkxPQ0t9YCk7CgogIGR1c3RBdChXLzIsIHNlYW1ZKTsKICBzdGF0ZS5jYW1lcmFTaGFrZSA9IE1hdGgubWF4KHN0YXRlLmNhbWVyYVNoYWtlLCBTSEFLRV9PTl9MQU5EKTsKICBzdGF0ZS50b3dlck9mZnNldFYgLT0gMTIwOwoKICBzdGF0ZS5jdXJyZW50ID0gbnVsbDsKfQoKLyoqIGJvb20gKyBzY29yY2ggKi8KZnVuY3Rpb24gYm9vbUF0KGJsb2NrKXsKICBjb25zdCBjeCA9IGJsb2NrLnggKyBibG9jay53LzI7CiAgY29uc3QgY3kgPSBibG9jay55ICsgYmxvY2suaC8yOwoKICBzdGF0ZS5mbGFzaCA9IE1hdGgubWluKDEsIHN0YXRlLmZsYXNoICsgMC45NSk7CiAgc3RhdGUucmluZ3MucHVzaCh7IHg6Y3gsIHk6Y3ksIHI6MTAsIHZyOiA5MDAsIGxpZmU6MC40NSwgYWdlOjAgfSk7CgogIGZvcihsZXQgaT0wO2k8NDQ7aSsrKXsKICAgIGNvbnN0IGE9TWF0aC5yYW5kb20oKSpNYXRoLlBJKjI7CiAgICBjb25zdCBzcD0xNjArTWF0aC5yYW5kb20oKSo3MjA7CiAgICBzdGF0ZS5wYXJ0aWNsZXMucHVzaCh7CiAgICAgIHg6Y3gseTpjeSwKICAgICAgdng6TWF0aC5jb3MoYSkqc3AsCiAgICAgIHZ5Ok1hdGguc2luKGEpKnNwLSgyNjArTWF0aC5yYW5kb20oKSozNjApLAogICAgICBsaWZlOjAuNTUrTWF0aC5yYW5kb20oKSowLjM1LAogICAgICBhZ2U6MCwKICAgICAgcjoyK01hdGgucmFuZG9tKCkqNAogICAgfSk7CiAgfQoKICBmb3IobGV0IGk9MDtpPDE0O2krKyl7CiAgICBjb25zdCBhPU1hdGgucmFuZG9tKCkqTWF0aC5QSSoyOwogICAgY29uc3Qgc3A9NTArTWF0aC5yYW5kb20oKSoyMTA7CiAgICBzdGF0ZS5zbW9rZXMucHVzaCh7CiAgICAgIHg6Y3gseTpjeSwKICAgICAgdng6TWF0aC5jb3MoYSkqc3AsCiAgICAgIHZ5Ok1hdGguc2luKGEpKnNwLSg5MCtNYXRoLnJhbmRvbSgpKjEyMCksCiAgICAgIGxpZmU6MS4xK01hdGgucmFuZG9tKCkqMC44LAogICAgICBhZ2U6MCwKICAgICAgcmFkOiAyMitNYXRoLnJhbmRvbSgpKjI2CiAgICB9KTsKICB9CgogIHN0YXRlLmNhbWVyYVNoYWtlID0gTWF0aC5tYXgoc3RhdGUuY2FtZXJhU2hha2UsIFNIQUtFX09OX0JPT00pOwogIHBsYXlCb29tKCk7Cn0KCi8qKiBmaW5pc2ggKi8KZnVuY3Rpb24gZmluaXNoR2FtZSgpewogIHN0YXRlLmZpbmlzaGVkID0gdHJ1ZTsKICBzZXROZXh0RW5hYmxlZChmYWxzZSk7CgogIGZpbmlzaFNjb3JlRWwudGV4dENvbnRlbnQgPSBTdHJpbmcoc3RhdGUuc2NvcmUpOwogIHN0Q29ycmVjdC50ZXh0Q29udGVudCA9IFN0cmluZyhzdGF0ZS5jb3JyZWN0KTsKICBzdFdyb25nLnRleHRDb250ZW50ID0gU3RyaW5nKHN0YXRlLndyb25nKTsKICBzdEhlaWdodC50ZXh0Q29udGVudCA9IFN0cmluZyhzdGF0ZS50b3dlci5sZW5ndGgpOwoKICBmaW5pc2hMYXllci5zdHlsZS5kaXNwbGF5PSJmbGV4IjsKfQoKLyoqIHJlc3RhcnQgKi8KcmVzdGFydEJ0bi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIGFzeW5jICgpPT57CiAgZmluaXNoTGF5ZXIuc3R5bGUuZGlzcGxheT0ibm9uZSI7CiAgc3RhcnRMYXllci5zdHlsZS5kaXNwbGF5PSJmbGV4IjsKfSk7CgovKiogY2FyZCBzaG93L2hpZGUgd2l0aCBhbmltYXRpb24gKi8KZnVuY3Rpb24gc2hvd092ZXJsYXlBbmltYXRlZCgpewogIG92ZXJsYXkuc3R5bGUuZGlzcGxheT0iZmxleCI7CiAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpPT4gb3ZlcmxheS5jbGFzc0xpc3QuYWRkKCJzaG93IikpOwp9CmZ1bmN0aW9uIGhpZGVPdmVybGF5QW5pbWF0ZWQoKXsKICBvdmVybGF5LmNsYXNzTGlzdC5yZW1vdmUoInNob3ciKTsKICBzZXRUaW1lb3V0KCgpPT57IG92ZXJsYXkuc3R5bGUuZGlzcGxheT0ibm9uZSI7IH0sIDE0MCk7Cn0KCi8qKiBVcGRhdGUgKi8KZnVuY3Rpb24gdXBkYXRlKGR0KXsKICBpZighc3RhdGUucnVubmluZykgcmV0dXJuOwoKICAvLyByZW1haW4KICB1cGRhdGVSZW1haW4oKTsKCiAgLy8gY2FtZXJhIHNoYWtlCiAgaWYoc3RhdGUuY2FtZXJhU2hha2U+MCl7CiAgICBzdGF0ZS5jYW1lcmFTaGFrZT1NYXRoLm1heCgwLCBzdGF0ZS5jYW1lcmFTaGFrZSAtIGR0KjIyKTsKICAgIGNvbnN0IHM9c3RhdGUuY2FtZXJhU2hha2U7CiAgICBzdGF0ZS5jYW1lcmFYPShNYXRoLnJhbmRvbSgpKjItMSkqczsKICAgIHN0YXRlLmNhbWVyYVk9KE1hdGgucmFuZG9tKCkqMi0xKSpzOwogIH0gZWxzZSB7CiAgICBzdGF0ZS5jYW1lcmFYPTA7IHN0YXRlLmNhbWVyYVk9MDsKICB9CgogIHN0YXRlLmZsYXNoID0gTWF0aC5tYXgoMCwgc3RhdGUuZmxhc2ggLSBkdCozLjgpOwoKICAvLyBncm91bmQgc3ByaW5nCiAgewogICAgY29uc3Qgaz01NSwgZGFtcD0xMDsKICAgIGNvbnN0IGEgPSAtayooc3RhdGUudG93ZXJPZmZzZXRZKSAtIGRhbXAqc3RhdGUudG93ZXJPZmZzZXRWOwogICAgc3RhdGUudG93ZXJPZmZzZXRWICs9IGEqZHQ7CiAgICBzdGF0ZS50b3dlck9mZnNldFkgKz0gc3RhdGUudG93ZXJPZmZzZXRWKmR0OwogICAgc3RhdGUudG93ZXJPZmZzZXRZID0gTWF0aC5tYXgoLTEwLCBNYXRoLm1pbigxMCwgc3RhdGUudG93ZXJPZmZzZXRZKSk7CiAgfQoKICAvLyB0b3dlciBzcXVhc2gKICBmb3IoY29uc3QgYiBvZiBzdGF0ZS50b3dlcil7CiAgICBjb25zdCBrPTQwLCBkYW1wPTg7CiAgICBjb25zdCBhPS1rKihiLnNxdWFzaC0xKS1kYW1wKmIuc3F1YXNoVjsKICAgIGIuc3F1YXNoViArPSBhKmR0OwogICAgYi5zcXVhc2ggICs9IGIuc3F1YXNoVipkdDsKICAgIGIuc3F1YXNoID0gTWF0aC5tYXgoMC44OCwgTWF0aC5taW4oMS4wOCwgYi5zcXVhc2gpKTsKICB9CgogIC8vIHBhcnRpY2xlcwogIGZvcihjb25zdCBwIG9mIHN0YXRlLnBhcnRpY2xlcyl7CiAgICBwLmFnZSArPSBkdDsgcC52eSArPSA5ODAqZHQ7IHAueCArPSBwLnZ4KmR0OyBwLnkgKz0gcC52eSpkdDsKICB9CiAgc3RhdGUucGFydGljbGVzID0gc3RhdGUucGFydGljbGVzLmZpbHRlcihwID0+IHAuYWdlIDwgcC5saWZlKTsKCiAgLy8gc21va2UKICBmb3IoY29uc3QgcyBvZiBzdGF0ZS5zbW9rZXMpewogICAgcy5hZ2UgKz0gZHQ7IHMudnkgKz0gMTIwKmR0OyBzLnggKz0gcy52eCpkdDsgcy55ICs9IHMudnkqZHQ7CiAgfQogIHN0YXRlLnNtb2tlcyA9IHN0YXRlLnNtb2tlcy5maWx0ZXIocyA9PiBzLmFnZSA8IHMubGlmZSk7CgogIC8vIHJpbmcKICBmb3IoY29uc3QgciBvZiBzdGF0ZS5yaW5ncyl7CiAgICByLmFnZSArPSBkdDsgci5yICs9IHIudnIqZHQ7CiAgfQogIHN0YXRlLnJpbmdzID0gc3RhdGUucmluZ3MuZmlsdGVyKHIgPT4gci5hZ2UgPCByLmxpZmUpOwoKICAvLyBzcGFya3MKICBmb3IoY29uc3Qgc3Agb2Ygc3RhdGUuc3BhcmtzKXsKICAgIHNwLmFnZSArPSBkdDsKICAgIHNwLnZ5ICs9IDk4MCpkdDsKICAgIHNwLnggKz0gc3AudngqZHQ7CiAgICBzcC55ICs9IHNwLnZ5KmR0OwogICAgc3AudnggKj0gKDEgLSBkdCoxLjgpOwogIH0KICBzdGF0ZS5zcGFya3MgPSBzdGF0ZS5zcGFya3MuZmlsdGVyKHMgPT4gcy5hZ2UgPCBzLmxpZmUpOwoKICAvLyBzY29yZSBmbG9hdHMKICBmb3IoY29uc3QgZiBvZiBzdGF0ZS5zY29yZUZsb2F0cyl7CiAgICBmLmFnZSArPSBkdDsgZi52eSArPSAyNjAqZHQ7IGYueCArPSBmLnZ4KmR0OyBmLnkgKz0gZi52eSpkdDsKICB9CiAgc3RhdGUuc2NvcmVGbG9hdHMgPSBzdGF0ZS5zY29yZUZsb2F0cy5maWx0ZXIoZiA9PiBmLmFnZSA8IGYubGlmZSk7CgogIC8vIGJvdW5jZSBzdGVwCiAgaWYoc3RhdGUubGFuZGluZ0JvdW5jZSAmJiBzdGF0ZS5jdXJyZW50KXsKICAgIGNvbnN0IGJiID0gc3RhdGUubGFuZGluZ0JvdW5jZTsKICAgIGJiLmFnZSArPSBkdDsKICAgIGNvbnN0IHQgPSBNYXRoLm1pbigxLCBiYi5hZ2UgLyBiYi5kdXIpOwogICAgLy8gZWFzaW5nCiAgICBjb25zdCBlYXNlID0gMSAtIE1hdGgucG93KDEgLSB0LCAzKTsKICAgIHN0YXRlLmN1cnJlbnQueSA9IE1hdGgucm91bmQoYmIuZnJvbVkgKyAoYmIudG9ZIC0gYmIuZnJvbVkpKmVhc2UpOwoKICAgIC8vINGH0YPRgtGMIOKAnNGB0LbQsNGC0LjQteKAnSDQvdC40LbQvdC10LPQviDQsdC70L7QutCwCiAgICBpZihzdGF0ZS50b3dlci5sZW5ndGg+MCl7CiAgICAgIGNvbnN0IGxhc3QgPSBzdGF0ZS50b3dlcltzdGF0ZS50b3dlci5sZW5ndGgtMV07CiAgICAgIGxhc3Quc3F1YXNoViArPSAxNCAqIGR0OwogICAgfQoKICAgIGlmKHQgPj0gMSl7CiAgICAgIHN0YXRlLmxhbmRpbmdCb3VuY2UgPSBudWxsOwogICAgICAvLyDRhNC40L3QsNC70YzQvdGL0LkgeSDRg9C20LUg0YHRgtC+0LjRgiwg0YTQuNC60YHQuNGA0YPQtdC8INCx0LvQvtC6INC60LDQuiDRjdGC0LDQtgogICAgICBmaW5hbGl6ZUxhbmQoKTsKICAgICAgc2V0TmV4dEVuYWJsZWQodHJ1ZSk7CiAgICB9CiAgfQoKICAvLyBjdXJyZW50IGJsb2NrIG1vdmVtZW50CiAgaWYoc3RhdGUuY3VycmVudCAmJiAhc3RhdGUubGFuZGluZ0JvdW5jZSl7CiAgICBjb25zdCBiID0gc3RhdGUuY3VycmVudDsKCiAgICBpZihzdGF0ZS53YWl0aW5nQW5zd2VyKXsKICAgICAgLy8gd2FpdAogICAgfSBlbHNlIGlmKHN0YXRlLmRyb3BwaW5nKXsKICAgICAgbGV0IHlUYXJnZXQ7CiAgICAgIGlmKHN0YXRlLnRvd2VyLmxlbmd0aD09PTApewogICAgICAgIHlUYXJnZXQgPSBncm91bmRZKCkgLSBiLmg7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgbG93ZXIgPSBzdGF0ZS50b3dlcltzdGF0ZS50b3dlci5sZW5ndGggLSAxXTsKICAgICAgICB5VGFyZ2V0ID0gY29tcHV0ZVN0YWNrWShiLCBsb3dlcik7CiAgICAgIH0KCiAgICAgIGIueSArPSBEUk9QX1NQRUVEKmR0OwogICAgICBpZihiLnkgPj0geVRhcmdldCl7CiAgICAgICAgYi55ID0geVRhcmdldDsKICAgICAgICAvLyDQvdCw0YfQuNC90LDQtdC8IGJvdW5jZQogICAgICAgIHNldHRsZUN1cnJlbnRCbG9jaygpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBzdG9wIGJlZm9yZSBxdWVzdGlvbgogICAgICBjb25zdCB0b3BZID0gKHN0YXRlLnRvd2VyLmxlbmd0aD09PTAgPyBncm91bmRZKCkgOiBzdGF0ZS50b3dlcltzdGF0ZS50b3dlci5sZW5ndGgtMV0ueSk7CiAgICAgIGNvbnN0IHN0b3BZID0gTWF0aC5tYXgoODAsIHRvcFkgLSBiLmggLSAxOCk7CiAgICAgIGIueSArPSBGQUxMX1NQRUVEKmR0OwogICAgICBpZihiLnk+PXN0b3BZKXsKICAgICAgICBiLnk9c3RvcFk7CiAgICAgICAgc3RhdGUud2FpdGluZ0Fuc3dlcj10cnVlOwogICAgICAgIHNob3dRdWVzdGlvbigpOwogICAgICB9CiAgICB9CiAgfQoKICAvLyBodWQgcHJvZ3Jlc3MKICBoZWlnaHRUeHQudGV4dENvbnRlbnQgPSBTdHJpbmcoc3RhdGUudG93ZXIubGVuZ3RoKTsKICBjb25zdCBwY3QgPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxMDAsIE1hdGgucm91bmQoKHN0YXRlLnRvd2VyLmxlbmd0aCAvIFRBUkdFVF9CTE9DS1NfRk9SXzEwMCkqMTAwKSkpOwogIHBjdFR4dC50ZXh0Q29udGVudCA9IHBjdCArICIlIjsKICBiYXJGaWxsLnN0eWxlLndpZHRoID0gcGN0ICsgIiUiOwp9CgovKiogRHJhdyAqLwpmdW5jdGlvbiBkcmF3QmFja2dyb3VuZCgpewogIGlmKHN0YXRlLmJnKXsKICAgIGNvbnN0IGltZz1zdGF0ZS5iZzsKICAgIGNvbnN0IHNjYWxlPU1hdGgubWF4KFcvaW1nLndpZHRoLEgvaW1nLmhlaWdodCk7CiAgICBjb25zdCBkdz1pbWcud2lkdGgqc2NhbGUsIGRoPWltZy5oZWlnaHQqc2NhbGU7CiAgICBjdHguZHJhd0ltYWdlKGltZywoVy1kdykvMiwoSC1kaCkvMixkdyxkaCk7CiAgfSBlbHNlIHsKICAgIGN0eC5maWxsU3R5bGU9IiMwYjBmMTgiOyBjdHguZmlsbFJlY3QoMCwwLFcsSCk7CiAgfQogIGNvbnN0IGdyZD1jdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoVyowLjUsSCowLjQ1LDYwLCBXKjAuNSxIKjAuNSwgTWF0aC5tYXgoVyxIKSowLjcpOwogIGdyZC5hZGRDb2xvclN0b3AoMCwicmdiYSgwLDAsMCwwKSIpOwogIGdyZC5hZGRDb2xvclN0b3AoMSwicmdiYSgwLDAsMCwwLjQ1KSIpOwogIGN0eC5maWxsU3R5bGU9Z3JkOyBjdHguZmlsbFJlY3QoMCwwLFcsSCk7CgogIGN0eC5maWxsU3R5bGU9InJnYmEoMCwwLDAsLjM1KSI7CiAgY3R4LmZpbGxSZWN0KDAsSC03MCxXLDcwKTsKfQoKZnVuY3Rpb24gZHJhd0Jsb2NrKG8sIGdsb3c9ZmFsc2UsIHNxdWFzaD0xLjAsIGNoYXI9MCl7CiAgY29uc3QgaW1nID0gc3RhdGUuYmxvY2tzW28uaWR4XS5pbWc7CgogIGN0eC5zYXZlKCk7CiAgY3R4LnNoYWRvd0NvbG9yID0gZ2xvdyA/ICJyZ2JhKDEyMCwxOTAsMjU1LC4zNSkiIDogInJnYmEoMCwwLDAsLjQ1KSI7CiAgY3R4LnNoYWRvd0JsdXIgID0gZ2xvdyA/IDE4IDogMTQ7CgogIGNvbnN0IGN4ID0gby54ICsgby53LzI7CiAgY29uc3QgY3kgPSBvLnkgKyBvLmg7CiAgY29uc3Qgc3ggPSAxICsgKDEgLSBzcXVhc2gpICogMC4zNTsKICBjb25zdCBzeSA9IHNxdWFzaDsKCiAgY3R4LnRyYW5zbGF0ZShjeCwgY3kpOwogIGN0eC5zY2FsZShzeCwgc3kpOwogIGN0eC50cmFuc2xhdGUoLWN4LCAtY3kpOwoKICBjdHguZHJhd0ltYWdlKGltZywgby54LCBvLnksIG8udywgby5oKTsKCiAgLy8g0Y3RhNGE0LXQutGCINC+0LHRg9Cz0LvQuNCy0LDQvdC40Y8gKNGH0LXRgNC90LDRjyDQv9C+0LvRg9C/0YDQvtC30YDQsNGH0L3QsNGPINC80LDRgdC60LApCiAgaWYoY2hhciA+IDApewogICAgY3R4Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiA9ICJzb3VyY2UtYXRvcCI7CiAgICBjdHguZmlsbFN0eWxlID0gYHJnYmEoMCwwLDAsJHswLjcwKmNoYXJ9KWA7CiAgICBjdHguZmlsbFJlY3Qoby54LTIsIG8ueS0yLCBvLncrNCwgby5oKzQpOwoKICAgIC8vINGH0YPRgtGMINC60YDQsNGB0L3QvtCy0LDRgtC+0LPQviDigJzQttCw0YDQsOKAnQogICAgY3R4Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiA9ICJzY3JlZW4iOwogICAgY3R4LmZpbGxTdHlsZSA9IGByZ2JhKDI1NSwxMjAsNjAsJHswLjEwKmNoYXJ9KWA7CiAgICBjdHguZmlsbFJlY3Qoby54LTIsIG8ueS0yLCBvLncrNCwgby5oKzQpOwoKICAgIGN0eC5nbG9iYWxDb21wb3NpdGVPcGVyYXRpb24gPSAic291cmNlLW92ZXIiOwogIH0KCiAgY3R4LnJlc3RvcmUoKTsKfQoKZnVuY3Rpb24gZHJhd1Njb3JlUG9wcygpewogIGZvcihjb25zdCBmIG9mIHN0YXRlLnNjb3JlRmxvYXRzKXsKICAgIGNvbnN0IHQgPSBmLmFnZSAvIGYubGlmZTsKICAgIGNvbnN0IGEgPSBNYXRoLm1heCgwLCAxIC0gdCk7CiAgICBjb25zdCBzID0gMSArICgxIC0gYSkgKiAwLjE1OwoKICAgIGN0eC5zYXZlKCk7CiAgICBjdHguZ2xvYmFsQWxwaGEgPSBhOwogICAgY3R4LnRyYW5zbGF0ZShmLngsIGYueSk7CiAgICBjdHguc2NhbGUocywgcyk7CgogICAgY3R4LmZvbnQgPSAiOTAwIDIycHggc3lzdGVtLXVpLCAtYXBwbGUtc3lzdGVtLCBTZWdvZSBVSSwgUm9ib3RvLCBBcmlhbCI7CiAgICBjdHgubGluZVdpZHRoID0gNTsKICAgIGN0eC5zdHJva2VTdHlsZSA9ICJyZ2JhKDAsMCwwLC4zNSkiOwogICAgY3R4LnN0cm9rZVRleHQoZi50ZXh0LCAwLCAwKTsKICAgIGN0eC5maWxsU3R5bGUgPSAicmdiYSgxMjAsMjU1LDE3MCwuOTUpIjsKICAgIGN0eC5maWxsVGV4dChmLnRleHQsIDAsIDApOwoKICAgIGN0eC5yZXN0b3JlKCk7CiAgfQp9CgpmdW5jdGlvbiBkcmF3KCl7CiAgY3R4LmNsZWFyUmVjdCgwLDAsVyxIKTsKCiAgY3R4LnNhdmUoKTsKICBjdHgudHJhbnNsYXRlKHN0YXRlLmNhbWVyYVgsIHN0YXRlLmNhbWVyYVkpOwoKICBkcmF3QmFja2dyb3VuZCgpOwoKICBmb3IoY29uc3QgYiBvZiBzdGF0ZS50b3dlcil7CiAgICBkcmF3QmxvY2soYiwgZmFsc2UsIGIuc3F1YXNoLCAwKTsKICB9CgogIGlmKHN0YXRlLmN1cnJlbnQpewogICAgZHJhd0Jsb2NrKHN0YXRlLmN1cnJlbnQsIHRydWUsIDEuMCwgc3RhdGUuY3VycmVudC5jaGFyIHx8IDApOwogIH0KCiAgLy8gc21va2UKICBmb3IoY29uc3QgcyBvZiBzdGF0ZS5zbW9rZXMpewogICAgY29uc3QgdCA9IHMuYWdlIC8gcy5saWZlOwogICAgY29uc3QgYSA9ICgxIC0gdCkgKiAwLjM1OwogICAgY29uc3QgciA9IHMucmFkICogKDEgKyB0KjEuMjUpOwogICAgY3R4LmZpbGxTdHlsZSA9IGByZ2JhKDIwLDIwLDIwLCR7YX0pYDsKICAgIGN0eC5iZWdpblBhdGgoKTsKICAgIGN0eC5hcmMocy54LCBzLnksIHIsIDAsIE1hdGguUEkqMik7CiAgICBjdHguZmlsbCgpOwogIH0KCiAgLy8gcmluZwogIGZvcihjb25zdCByIG9mIHN0YXRlLnJpbmdzKXsKICAgIGNvbnN0IHQgPSByLmFnZSAvIHIubGlmZTsKICAgIGNvbnN0IGEgPSAoMSAtIHQpICogMC41NTsKICAgIGN0eC5zdHJva2VTdHlsZSA9IGByZ2JhKDI1NSwyNTUsMjU1LCR7YX0pYDsKICAgIGN0eC5saW5lV2lkdGggPSAzOwogICAgY3R4LmJlZ2luUGF0aCgpOwogICAgY3R4LmFyYyhyLngsIHIueSwgci5yLCAwLCBNYXRoLlBJKjIpOwogICAgY3R4LnN0cm9rZSgpOwogIH0KCiAgLy8gc3BhcmtzCiAgZm9yKGNvbnN0IHNwIG9mIHN0YXRlLnNwYXJrcyl7CiAgICBjb25zdCB0ID0gc3AuYWdlIC8gc3AubGlmZTsKICAgIGNvbnN0IGEgPSBNYXRoLm1heCgwLCAxIC0gdCk7CiAgICBjdHguc3Ryb2tlU3R5bGUgPSBgcmdiYSgyNTUsIDIyMCwgMTQwLCAkezAuOSphfSlgOwogICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICBjdHguYmVnaW5QYXRoKCk7CiAgICBjdHgubW92ZVRvKHNwLngsIHNwLnkpOwogICAgY3R4LmxpbmVUbyhzcC54IC0gc3AudngqMC4wMTIsIHNwLnkgLSBzcC52eSowLjAxMik7CiAgICBjdHguc3Ryb2tlKCk7CiAgfQoKICAvLyBwYXJ0aWNsZXMKICBmb3IoY29uc3QgcCBvZiBzdGF0ZS5wYXJ0aWNsZXMpewogICAgY29uc3QgYSA9IDEgLSAocC5hZ2UvcC5saWZlKTsKICAgIGN0eC5maWxsU3R5bGUgPSBgcmdiYSgyNTUsIDIwMCwgMTIwLCAkezAuNzgqYX0pYDsKICAgIGN0eC5iZWdpblBhdGgoKTsKICAgIGN0eC5hcmMocC54LCBwLnksIHAuciwgMCwgTWF0aC5QSSoyKTsKICAgIGN0eC5maWxsKCk7CiAgfQoKICBkcmF3U2NvcmVQb3BzKCk7CgogIGlmKHN0YXRlLmZsYXNoPjApewogICAgY3R4LmZpbGxTdHlsZSA9IGByZ2JhKDI1NSwyNTUsMjU1LCR7c3RhdGUuZmxhc2gqMC4yMn0pYDsKICAgIGN0eC5maWxsUmVjdCgwLDAsVyxIKTsKICB9CgogIGN0eC5yZXN0b3JlKCk7CiAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGRyYXcpOwp9CgpsZXQgbGFzdFQ9MDsKZnVuY3Rpb24gbG9vcCh0KXsKICBpZighbGFzdFQpIGxhc3RUPXQ7CiAgY29uc3QgZHQ9TWF0aC5taW4oMC4wMzMsKHQtbGFzdFQpLzEwMDApOwogIGxhc3RUPXQ7CiAgdXBkYXRlKGR0KTsKICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUobG9vcCk7Cn0KCi8qKiBRdWVzdGlvbnMgKi8KZnVuY3Rpb24gbm9ybWFsaXplQW5zd2VyKHMpeyByZXR1cm4gU3RyaW5nKHM/PyIiKS50cmltKCkudG9Mb3dlckNhc2UoKTsgfQoKZnVuY3Rpb24gX19nZXRRdWVzdGlvbl9fKHFpKXsKICB0cnl7CiAgICBjb25zdCBhcnIgPSBBcnJheS5pc0FycmF5KFFVRVNUSU9OUykgPyBRVUVTVElPTlMgOiBbXTsKICAgIGlmKGFyci5sZW5ndGg9PT0wKSByZXR1cm4gbnVsbDsKICAgIGNvbnN0IGlkeCA9IE1hdGgubWF4KDAsIE1hdGgubWluKGFyci5sZW5ndGgtMSwgTnVtYmVyKHFpKXx8MCkpOwogICAgcmV0dXJuIGFycltpZHhdOwogIH1jYXRjaChlKXsgcmV0dXJuIG51bGw7IH0KfQoKZnVuY3Rpb24gc2hvd1F1ZXN0aW9uKCl7CiAgc3RhdGUuX19hbnN3ZXJlZCA9IGZhbHNlOwogIGNvbnN0IHFpID0gc3RhdGUucXVlc3Rpb25JbmRleDsKICBjb25zdCBxID0gX19nZXRRdWVzdGlvbl9fKHFpKSB8fCB7dHlwZToiY2hvaWNlIiwgcToiIiwgb3B0aW9uczpbIk9LIl0sIGFuc3dlcjoiT0sifTsKCiAgLy8gLS0tIHBlci1xdWVzdGlvbiBtZWRpYSAoaW1hZ2UvYXVkaW8pIC0tLQogIHRyeXsKICAgIGxldCBtZWRpYUJveCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJxTWVkaWFCb3giKTsKICAgIGlmKCFtZWRpYUJveCl7CiAgICAgIG1lZGlhQm94ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIG1lZGlhQm94LmlkID0gInFNZWRpYUJveCI7CiAgICAgIG1lZGlhQm94LnN0eWxlLm1hcmdpblRvcCA9ICIxMHB4IjsKICAgICAgbWVkaWFCb3guc3R5bGUuZGlzcGxheSA9ICJmbGV4IjsKICAgICAgbWVkaWFCb3guc3R5bGUuZmxleERpcmVjdGlvbiA9ICJjb2x1bW4iOwogICAgICBtZWRpYUJveC5zdHlsZS5nYXAgPSAiMTBweCI7CiAgICAgIC8vIGF0dGFjaCBpbnNpZGUgcXVlc3Rpb24gY2FyZCAocmVsaWFibGUpCiAgICAgIGNvbnN0IGNhcmQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiY2FyZCIpIHx8IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiNvdmVybGF5ICNjYXJkIik7CiAgICAgIGNvbnN0IHFOb2RlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInEiKTsKICAgICAgY29uc3QgaGVhZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImNhcmRIZWFkZXIiKTsKICAgICAgbWVkaWFCb3guc3R5bGUud2lkdGggPSAiMTAwJSI7CiAgICAgIG1lZGlhQm94LnN0eWxlLnBhZGRpbmcgPSAiOHB4IDAgMCI7CiAgICAgIG1lZGlhQm94LnN0eWxlLmFsaWduSXRlbXMgPSAiY2VudGVyIjsKICAgICAgaWYocU5vZGUgJiYgcU5vZGUucGFyZW50RWxlbWVudCl7CiAgICAgICAgcU5vZGUucGFyZW50RWxlbWVudC5hcHBlbmRDaGlsZChtZWRpYUJveCk7CiAgICAgIH0gZWxzZSBpZihoZWFkZXIpewogICAgICAgIGhlYWRlci5hcHBlbmRDaGlsZChtZWRpYUJveCk7CiAgICAgIH0gZWxzZSBpZihjYXJkKXsKICAgICAgICBjYXJkLmluc2VydEJlZm9yZShtZWRpYUJveCwgY2FyZC5jaGlsZHJlblsxXSB8fCBudWxsKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKG1lZGlhQm94KTsKICAgICAgfQogICAgfQogICAgbWVkaWFCb3guaW5uZXJIVE1MID0gIiI7CiAgICBpZihxLmltZ0RhdGFVcmwpewogICAgICBjb25zdCBpbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbWciKTsKICAgICAgaW1nLnNyYyA9IHEuaW1nRGF0YVVybDsKICAgICAgaW1nLmFsdCA9ICJxdWVzdGlvbiBpbWFnZSI7CiAgICAgIGltZy5zdHlsZS5tYXhXaWR0aCA9ICIxMDAlIjsKICAgICAgaW1nLnN0eWxlLm1heEhlaWdodCA9ICIyMjBweCI7CiAgICAgIGltZy5zdHlsZS5vYmplY3RGaXQgPSAiY29udGFpbiI7CiAgICAgIGltZy5zdHlsZS5ib3JkZXJSYWRpdXMgPSAiMTRweCI7CiAgICAgIGltZy5zdHlsZS5ib3JkZXIgPSAiMXB4IHNvbGlkIHJnYmEoMjU1LDI1NSwyNTUsLjE4KSI7CiAgICAgIG1lZGlhQm94LmFwcGVuZENoaWxkKGltZyk7CiAgICB9CiAgICBpZihxLmF1ZGlvRGF0YVVybCl7CiAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhdWRpbyIpOwogICAgICBhLnNyYyA9IHEuYXVkaW9EYXRhVXJsOwogICAgICBhLmNvbnRyb2xzID0gdHJ1ZTsKICAgICAgYS5wcmVsb2FkID0gImF1dG8iOwogICAgICBtZWRpYUJveC5hcHBlbmRDaGlsZChhKTsKICAgICAgYS5wbGF5KCkuY2F0Y2goKCk9Pnt9KTsKICAgIH0KICB9Y2F0Y2goZSl7fQoKCiAgbXNnRWwudGV4dENvbnRlbnQ9IiI7CiAgYW5zd2Vyc0VsLmlubmVySFRNTD0iIjsKICBpbnB1dFJvdy5zdHlsZS5kaXNwbGF5PSJub25lIjsKICBhbnN3ZXJzRWwuc3R5bGUuZGlzcGxheT0iZmxleCI7CgogIHFFbC50ZXh0Q29udGVudD1xLnE7CiAgYmFkZ2VFbC50ZXh0Q29udGVudD1gJHtxaSsxfSAvIDlgOwoKICBpZihxLnR5cGU9PT0iY2hvaWNlIil7CiAgICBmb3IoY29uc3Qgb3B0IG9mIHEub3B0aW9ucyl7CiAgICAgIGNvbnN0IGJ0bj1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJidXR0b24iKTsKICAgICAgYnRuLmNsYXNzTmFtZT0iYnRuIjsKICAgICAgYnRuLnRleHRDb250ZW50PW9wdDsKICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgKCk9PmNoZWNrQW5zd2VyKG9wdCkpOwogICAgICBhbnN3ZXJzRWwuYXBwZW5kQ2hpbGQoYnRuKTsKICAgIH0KICB9IGVsc2UgewogICAgYW5zd2Vyc0VsLnN0eWxlLmRpc3BsYXk9Im5vbmUiOwogICAgaW5wdXRSb3cuc3R5bGUuZGlzcGxheT0iZmxleCI7CiAgICBhbnNJbnB1dC52YWx1ZT0iIjsKICB9CgogIHNob3dPdmVybGF5QW5pbWF0ZWQoKTsKICBzZXRUaW1lb3V0KCgpPT57IGlmKHEudHlwZT09PSJpbnB1dCIpIGFuc0lucHV0LmZvY3VzKCk7IH0sIDUwKTsKICAvLyAtLS0gcGVyLXF1ZXN0aW9uIHRpbWVyIC0tLQogIHRyeXsKICAgIGlmKHdpbmRvdy5fX3FUaW1lcklkKXsgY2xlYXJJbnRlcnZhbCh3aW5kb3cuX19xVGltZXJJZCk7IHdpbmRvdy5fX3FUaW1lcklkPW51bGw7IH0KICAgIGNvbnN0IHNlY3MgPSAocS5zZWNvbmRzIT1udWxsKSA/IE51bWJlcihxLnNlY29uZHMpIDogKCAoR0FNRSAmJiBHQU1FLnRpbWVyICYmIEdBTUUudGltZXIuZW5hYmxlZCkgPyBOdW1iZXIoR0FNRS50aW1lci5zZWNvbmRzfHwwKSA6IG51bGwgKTsKICAgIGNvbnN0IHRpbWVyRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgicVRpbWVyQmFkZ2UiKSB8fCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIudGltZXIiKSB8fCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCJbZGF0YS1yb2xlPSdwaWxsVGltZXInXSIpOwogICAgY29uc3QgdHh0RWwgPSB0aW1lckVsID8gKHRpbWVyRWwucXVlcnlTZWxlY3RvcigiLnFUaW1lclRleHQiKSB8fCB0aW1lckVsLnF1ZXJ5U2VsZWN0b3IoIltkYXRhLXJvbGU9J3RpbWVyVGV4dCddIikpIDogbnVsbDsKICAgIGNvbnN0IHByb2dFbCA9IHRpbWVyRWwgPyAodGltZXJFbC5xdWVyeVNlbGVjdG9yKCIucVRpbWVyUHJvZyIpIHx8IHRpbWVyRWwucXVlcnlTZWxlY3RvcigiY2lyY2xlLnFUaW1lclByb2ciKSkgOiBudWxsOwogICAgY29uc3QgUiA9IDE2OwogICAgY29uc3QgQyA9IDIgKiBNYXRoLlBJICogUjsKICAgIGlmKHByb2dFbCl7CiAgICAgIHByb2dFbC5zdHlsZS5zdHJva2VEYXNoYXJyYXkgPSBTdHJpbmcoQyk7CiAgICAgIHByb2dFbC5zdHlsZS5zdHJva2VEYXNob2Zmc2V0ID0gU3RyaW5nKEMpOwogICAgfQogICAgaWYoTnVtYmVyLmlzRmluaXRlKHNlY3MpICYmIHNlY3M+MCl7CiAgICAgIGNvbnN0IHRvdGFsID0gTWF0aC5tYXgoMSwgTWF0aC5yb3VuZChzZWNzKSk7CiAgICAgIGxldCBsZWZ0ID0gdG90YWw7CgogICAgICBjb25zdCBwYWludCA9ICgpPT57CiAgICAgICAgY29uc3QgcCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIGxlZnQgLyB0b3RhbCkpOwogICAgICAgIGNvbnN0IGh1ZSA9IDQ1ICogcDsgLy8gNDU9Z29sZCAtPiAwPXJlZAogICAgICAgIGlmKHRpbWVyRWwpewogICAgICAgICAgdGltZXJFbC5zdHlsZS5kaXNwbGF5ID0gIiI7CiAgICAgICAgICB0aW1lckVsLnN0eWxlLnNldFByb3BlcnR5KCItLXAiLCBTdHJpbmcocCkpOwogICAgICAgICAgdGltZXJFbC5zdHlsZS5zZXRQcm9wZXJ0eSgiLS1oIiwgU3RyaW5nKGh1ZSkpOwogICAgICAgICAgaWYobGVmdCA8PSA1KSB0aW1lckVsLmNsYXNzTGlzdC5hZGQoInFQdWxzZSIpOyBlbHNlIHRpbWVyRWwuY2xhc3NMaXN0LnJlbW92ZSgicVB1bHNlIik7CiAgICAgICAgfQogICAgICAgIGlmKHR4dEVsKXsgdHh0RWwudGV4dENvbnRlbnQgPSBTdHJpbmcobGVmdCk7IH0KICAgICAgICBlbHNlIGlmKHRpbWVyRWwpeyB0aW1lckVsLnRleHRDb250ZW50ID0gIuKPsyAiICsgU3RyaW5nKGxlZnQpOyB9CiAgICAgICAgaWYocHJvZ0VsKXsgcHJvZ0VsLnN0eWxlLnN0cm9rZURhc2hvZmZzZXQgPSBTdHJpbmcoQyAqICgxIC0gcCkpOyB9CiAgICAgIH07CgogICAgICBwYWludCgpOwogICAgICB3aW5kb3cuX19xVGltZXJJZCA9IHNldEludGVydmFsKCgpPT57CiAgICAgICAgbGVmdC0tOwogICAgICAgIHBhaW50KCk7CiAgICAgICAgaWYobGVmdDw9MCl7CiAgICAgICAgICBjbGVhckludGVydmFsKHdpbmRvdy5fX3FUaW1lcklkKTsgd2luZG93Ll9fcVRpbWVySWQ9bnVsbDsKICAgICAgICAgIHRyeXsKICAgICAgICAgICAgaWYodHlwZW9mIGNoZWNrQW5zd2VyID09PSAiZnVuY3Rpb24iKXsgY2hlY2tBbnN3ZXIoIl9fVElNRU9VVF9fIik7IH0KICAgICAgICAgIH1jYXRjaChlKXt9CiAgICAgICAgfQogICAgICB9LDEwMDApOwogICAgfSBlbHNlIHsKICAgICAgaWYodGltZXJFbCl7CiAgICAgICAgdGltZXJFbC5zdHlsZS5kaXNwbGF5PSJub25lIjsKICAgICAgICB0aW1lckVsLmNsYXNzTGlzdC5yZW1vdmUoInFQdWxzZSIpOwogICAgICAgIGlmKHR4dEVsKSB0eHRFbC50ZXh0Q29udGVudD0iIjsKICAgICAgICBlbHNlIHRpbWVyRWwudGV4dENvbnRlbnQ9IiI7CiAgICAgICAgaWYocHJvZ0VsKSBwcm9nRWwuc3R5bGUuc3Ryb2tlRGFzaG9mZnNldCA9IFN0cmluZyhDKTsKICAgICAgfQogICAgfQogIH1jYXRjaChlKXt9Cgp9CgoKZnVuY3Rpb24gX19hcHBseVRpdGxlX18odGl0bGUpewogIGNvbnN0IHQgPSBTdHJpbmcodGl0bGUgfHwgItCR0LDRiNC90Y8g0LfQvdCw0L3QuNC5Iik7CiAgZG9jdW1lbnQudGl0bGUgPSB0OwogIGNvbnN0IGgxID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI3N0YXJ0Q2FyZCBoMSIpOwogIGlmKGgxKSBoMS50ZXh0Q29udGVudCA9IHQ7Cn0K";
  const __GAME_HTML__ = __b64ToUtf8__(__GAME_HTML_B64__);
  const __GAME_JS__   = __b64ToUtf8__(__GAME_JS_B64__);


function __buildQuestionsFromCfg__(cfg){
  const src = Array.isArray(cfg?.questions) ? cfg.questions : [];
  if(src.length === 0){
    return Array.from({length:9}, (_,i)=>({
      type:"choice",
      q:`(–≤–æ–ø—Ä–æ—Å ${i+1})`,
      options:["OK","..."],
      answer:"OK",
      seconds:null,
      imgDataUrl:"",
      audioDataUrl:""
    }));
  }
  return src.map((q,i)=>{
    // "text" in editor == free input in game
    if(q && (q.type==="text" || q.type==="input")){
      const acc = Array.isArray(q.accepts) ? q.accepts.map(String).filter(s=>s.trim()) : [];
      const first = String(acc[0] || "");
      return {
        type:"input",
        q:String(q.prompt||q.q||""),
        accepts: acc.length ? acc : (first ? [first] : []),
        answer: first,
        seconds: (q.seconds ?? null),
        imgDataUrl: (q.imgDataUrl || ""),
        audioDataUrl: (q.audioDataUrl || "")
      };
    }

    const opts = Array.isArray(q?.options) ? q.options.map(String).filter(s=>s.trim()) : [];
    const ci = Number.isFinite(q?.correctIndex) ? q.correctIndex : 0;
    const ans = String((opts[ci] ?? opts[0] ?? "OK"));
    return {
      type:"choice",
      q:String(q?.prompt||q?.q||""),
      options: opts.length ? opts : ["OK","..."],
      answer: ans,
      seconds: (q?.seconds ?? null),
      imgDataUrl: (q?.imgDataUrl || ""),
      audioDataUrl: (q?.audioDataUrl || "")
    };
  });
}

function checkAnswer(userValue){
  // prevent double submit
  if(state.__answered) return;
  state.__answered = true;

  try{ if(window.__qTimerId){ clearInterval(window.__qTimerId); window.__qTimerId=null; } }catch(e){}

  const qi = state.questionIndex;
  const q = __getQuestion__(qi) || {type:"choice", q:"", options:["OK"], answer:"OK"};

  // timeout is always wrong
  const isTimeout = (userValue === "__TIMEOUT__");

  let ok = false;
  try{
    if(!isTimeout){
      if(q.type==="input"){
        const acc = (q.accepts && q.accepts.length) ? q.accepts : [q.answer];
        ok = acc.map(normalizeAnswer).includes(normalizeAnswer(userValue));
      } else {
        ok = normalizeAnswer(userValue) === normalizeAnswer(q.answer);
      }
    }
  }catch(e){ ok=false; }

  const waitingBlock = state.current;

  // advance question index no matter what
  state.questionIndex++;
  // no wrapping –Ω–∞–∑–∞–¥
  if(state.questionIndex > 9) state.questionIndex = 9;

  try{
    if(ok){
      state.correct++;
      msgEl.innerHTML = `<span style="color: var(--good); font-weight:900;">–í–µ—Ä–Ω–æ!</span> –ë–ª–æ–∫ –æ–ø—É—Å–∫–∞–µ—Ç—Å—è (+100).`;
      playGood();
      state.dropping = false;

      setTimeout(()=>{
        hideOverlayAnimated();
        state.waitingAnswer = false;
        if(state.current) state.dropping = true;
        else setNextEnabled(true);
        if(state.questionIndex >= 9){ finishGame(); }
      }, 220);

    } else {
      state.wrong++;
      msgEl.innerHTML = isTimeout
        ? `<span style="color: var(--bad); font-weight:900;">–í—Ä–µ–º—è –≤—ã—à–ª–æ!</span> –ë–ª–æ–∫ —Å–≥–æ—Ä–∞–µ—Ç –∏ –∏—Å—á–µ–∑–∞–µ—Ç.`
        : `<span style="color: var(--bad); font-weight:900;">–ù–µ–≤–µ—Ä–Ω–æ!</span> –ë–ª–æ–∫ –æ–±—É–≥–ª–∏–≤–∞–µ—Ç—Å—è –∏ –∏—Å—á–µ–∑–∞–µ—Ç.`;

      state.dropping = false;

      const scorchDur = 0.35;
      let elapsed = 0;
      function scorchStep(){
        if(!state.current || state.current !== waitingBlock) return;
        elapsed += 1/60;
        state.current.char = Math.min(1, elapsed / scorchDur);
        if(Math.random() < 0.25){
          state.smokes.push({
            x: waitingBlock.x + waitingBlock.w/2 + (Math.random()*30-15),
            y: waitingBlock.y + waitingBlock.h/2 + (Math.random()*20-10),
            vx: (Math.random()*2-1)*40,
            vy: -80 - Math.random()*80,
            life:0.6+Math.random()*0.4,
            age:0,
            rad: 14+Math.random()*18
          });
        }
        if(elapsed < scorchDur){
          requestAnimationFrame(scorchStep);
        }
      }
      requestAnimationFrame(scorchStep);

      setTimeout(()=>{
        hideOverlayAnimated();
        state.waitingAnswer = false;
        if(waitingBlock && waitingBlock === state.current){
          boomAt(waitingBlock);
        }
        state.current = null;
        setNextEnabled(true);
        if(state.questionIndex >= 9){ finishGame(); }
      }, 520);
    }
  }catch(e){
    // fail-safe: don't get stuck
    try{ console && console.error && console.error(e); }catch(_){}
    try{ hideOverlayAnimated(); }catch(_){}
    state.waitingAnswer = false;
    state.current = null;
    setNextEnabled(true);
    if(state.questionIndex >= 9){ try{ finishGame(); }catch(_){} }
  }

  state.blockIndex++;
}


submitBtn.addEventListener(\"click\", ()=>checkAnswer(ansInput.value));\nansInput.addEventListener(\"keydown\",(e)=>{ if(e.key===\"Enter\") checkAnswer(ansInput.value); });\ndocument.addEventListener(\"keydown\",(e)=>{\n  if(overlay.style.display===\"flex\" && e.key===\"Enter\"){\n    const qi=state.questionIndex;\n    const __q = __getQuestion__(qi);\n    if(__q && __q.type===\"input\") checkAnswer(ansInput.value);\n  }\n});\n\n/** Next */\nnextBtn.addEventListener(\"click\", ()=>{\n  if(nextBtn.disabled) return;\n  spawnBlock();\n});\n\n/** Start / Load */\nasync function startGame(){\n  try{\n    if(typeof __applyTitle__ === \"function\") __applyTitle__(window.__CFG?.title || \"\u0411\u0430\u0448\u043d\u044f \u0437\u043d\u0430\u043d\u0438\u0439\");\n    if(typeof __buildQuestionsFromCfg__ === \"function\") QUESTIONS = __buildQuestionsFromCfg__(window.__CFG || {});\n    if(!Array.isArray(QUESTIONS) || QUESTIONS.length===0){\n      QUESTIONS = Array.from({length:9}, (_,i)=>({type:\"choice\", q:`(\u0432\u043e\u043f\u0440\u043e\u0441 ${i+1})`, options:[\"OK\",\"...\"], answer:\"OK\"}));\n    }\n    // ensure exactly 9 questions (no wrapping)\n    if(Array.isArray(QUESTIONS)){\n      if(QUESTIONS.length < 9){\n        for(let i=QUESTIONS.length;i<9;i++){\n          QUESTIONS.push({type:\"choice\", q:`(–≤–æ–ø—Ä–æ—Å ${i+1})`, options:[\"OK\",\"...\"], answer:\"OK\"});\n        }\n      }\n    }\n\n  }catch(e){}\n\n  errBox.style.display=\"none\";\n  errList.innerHTML=\"\";\n\n  ensureAudio();\n  if(audioCtx.state===\"suspended\"){ try{ await audioCtx.resume(); }catch{} }\n\n  Object.assign(state, {\n    running:false, bg:null, blocks:[], towerScale:1,\n    tower:[], current:null,\n    particles:[], smokes:[], rings:[], sparks:[], flash:0,\n    cameraShake:0, cameraX:0, cameraY:0,\n    towerOffsetY:0, towerOffsetV:0,\n    questionIndex:0, waitingAnswer:false, dropping:false,\n    blockIndex:0, readyForNext:false,\n    finished:false,\n    score:0,\n    scoreFloats:[],\n    correct:0,\n    wrong:0,\n    landingBounce:null,\n  });\n  scoreNum.textContent = \"0\";\n  setNextEnabled(false);\n  updateRemain();\n\n  const missing=[];\n\n  try{ state.bg = await loadImage(assetUrl(BG_FILE)); }\n  catch{ missing.push(BG_FILE); }\n\n  const blocks=[];\n  for(const f of BLOCK_FILES){\n    try{\n      const raw = await loadImage(assetUrl(f));\n      const t = await trimAndCentroidAndProfiles(raw);\n      blocks.push({ file:f, img:t.img, w:t.w, h:t.h, cx:t.cx, cy:t.cy, top:t.top, bottom:t.bottom });\n    } catch {\n      missing.push(f);\n    }\n  }\n\n  if(missing.length){\n    errBox.style.display=\"block\";\n    for(const f of missing){\n      const li=document.createElement(\"li\");\n      li.textContent = f + \" (\u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d/\u043d\u0435 \u0437\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u0442\u0441\u044f)\";\n      errList.appendChild(li);\n    }\n    return;\n  }\n\n  state.towerScale = computeTowerScale(blocks);\n  state.blocks = blocks;\n\n  state.running = true;\n\n  spawnBlock(); // \u043f\u0435\u0440\u0432\u044b\u0439 \u0431\u043b\u043e\u043a \u0441\u0430\u043c\n}\n\nplayBtn.addEventListener(\"click\", async ()=>{\n  startLayer.style.display=\"none\";\n  await startGame();\n});\n\nrequestAnimationFrame(loop);\nrequestAnimationFrame(draw);\n\n// auto-start in preview mode\ntry{\n  const __qp = new URLSearchParams(location.search);\n  if(__qp.get(\"preview\")===\"1\"){\n    const startLayer = document.getElementById(\"startLayer\");\n    if(startLayer) startLayer.style.display=\"none\";\n    setTimeout(()=>{\n      const playBtn = document.getElementById(\"playBtn\");\n      if(playBtn) playBtn.click();\n    }, 60);\n  }\n}catch(e){}\n";

  function injectCanvasGame(cfg){
    // 1) mount HTML
    const root = $("gameRoot");
    root.innerHTML = __GAME_HTML__;

    // 2) inject css (scoped by original ids/classes inside gameRoot)
    let st = document.getElementById("__tower_game_style");
    if(!st){
      st = document.createElement("style");
      st.id="__tower_game_style";
      st.textContent = __GAME_CSS__;
      document.head.appendChild(st);
    }

    // 2b) upgrade per-question timer badge UI (ring + smooth color)
    try{
      const qb = root.querySelector("#qTimerBadge");
      if(qb){
        qb.classList.add("qTimer");
        qb.innerHTML = `
          <svg class="qTimerRing" viewBox="0 0 40 40" aria-hidden="true">
            <circle class="qTimerTrack" cx="20" cy="20" r="16"></circle>
            <circle class="qTimerProg"  cx="20" cy="20" r="16"></circle>
          </svg>
          <span class="qTimerText"></span>
        `;
        qb.style.display = "none";
      }

      let st2 = document.getElementById("__tower_timer_style");
      if(!st2){
        st2 = document.createElement("style");
        st2.id="__tower_timer_style";
        st2.textContent = `
#gameRoot #card{ position:relative; }

#gameRoot #qTimerBadge.qTimer{
  --p: 1;
  --h: 45; /* 45=gold -> 0=red */
  position:absolute;
  top:-40px;
  left:50%;
  transform: translateX(-50%);
  display:flex;
  align-items:center;
  gap:12px;
  padding:10px 14px;
  border-radius:999px;
  color: rgba(255,255,255,.96);

  background: linear-gradient(180deg, rgba(18,22,34,.78), rgba(8,10,16,.62));
  border: 1px solid rgba(255,255,255,.16);
  box-shadow:
    0 18px 55px rgba(0,0,0,.45),
    inset 0 1px 0 rgba(255,255,255,.10);
  backdrop-filter: blur(12px);
}

#gameRoot #qTimerBadge.qTimer::after{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius:999px;
  pointer-events:none;
  opacity:.55;
  background: radial-gradient(60% 120% at 50% 0%,
      hsla(var(--h), 92%, 62%, .38),
      transparent 70%);
}

#gameRoot #qTimerBadge .qTimerRing{
  width:38px;
  height:38px;
  transform: rotate(-90deg);
  filter: drop-shadow(0 6px 10px rgba(0,0,0,.35));
}

#gameRoot #qTimerBadge .qTimerTrack{
  fill:none;
  stroke: rgba(255,255,255,.10);
  stroke-width:4;
}

#gameRoot #qTimerBadge .qTimerProg{
  fill:none;
  stroke-width:4;
  stroke-linecap:round;
  stroke: hsl(var(--h) 90% 60% / .95);
  stroke-dasharray: 100.53;
  stroke-dashoffset: calc(100.53 * (1 - var(--p)));
  transition: stroke .25s linear, stroke-dashoffset .25s linear;
}

#gameRoot #qTimerBadge .qTimerText{
  font-weight:900;
  font-size:16px;
  color: rgba(255,255,255,.94);
  letter-spacing:.2px;
  min-width: 2ch;
  text-align:right;
}

#gameRoot #qTimerBadge.qPulse{
  animation: qPulseAnim .85s ease-in-out infinite;
}

@keyframes qPulseAnim{
  0%,100%{
    transform: translateX(-50%) scale(1);
    filter: drop-shadow(0 10px 22px rgba(0,0,0,.35));
  }
  50%{
    transform: translateX(-50%) scale(1.06);
    filter: drop-shadow(0 14px 30px hsla(var(--h), 92%, 60%, .38));
  }
}
  50%{ transform: translateX(-50%) scale(1.06); }
}
`;
        document.head.appendChild(st2);
      }
    }catch(e){}

    // 3) provide cfg globally for the original code
    window.__CFG = { title: cfg.title || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π", questions: cfg.questions || [] };
    // Auto-start if this is preview iframe
    try{
      const qp = new URLSearchParams(location.search);
      if(qp.get("preview")==="1"){
        const startLayer = document.getElementById("startLayer");
        const playBtn = document.getElementById("playBtn");
        if(startLayer) startLayer.style.display="none";
        if(playBtn) setTimeout(()=>playBtn.click(), 80);
      }
    }catch(e){}

    // 4) run original JS once per load
    if(!window.__TOWER_GAME_RAN__){
      window.__TOWER_GAME_RAN__ = true;
      try{
        // eslint-disable-next-line no-eval
        eval(__GAME_JS__);
      }catch(e){
        showErr(e?.stack || e?.message || String(e));
      }
    } else {
      // If already ran, try restart by reloading page (safe in iframe); but keep simple:
      try{
        const playBtn = document.getElementById("playBtn");
        const startLayer = document.getElementById("startLayer");
        if(startLayer) startLayer.style.display="";
        if(playBtn) playBtn.click();
      }catch(e){}
    }
  }


  function uid(){
    return "q_" + Math.random().toString(36).slice(2,9) + "_" + Date.now().toString(36);
  }
  function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

  function toast(msg){
    const t = $("toast");
    if (!t) return;
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1400);
  }

  function fileToDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=>resolve(String(r.result || ""));
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  async function copyToClipboard(text){
    try{
      if (navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch(e){}
    try{
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.setAttribute("readonly", "");
      ta.style.position = "fixed";
      ta.style.left = "0";
      ta.style.top = "0";
      ta.style.opacity = "0";
      ta.style.width = "1px";
      ta.style.height = "1px";
      ta.style.pointerEvents = "none";
      ta.style.zIndex = "-1";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      ta.setSelectionRange(0, ta.value.length);
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }catch(e){
      return false;
    }
  }

  // ===== base urls in repo (works on GitHub Pages) =====
  function basePath(){
    // https://user.github.io/repo/index.html -> https://user.github.io/repo/
    const p = location.pathname;
    return location.origin + p.replace(/\/[^\/]*$/, "/");
  }
  const BASE = basePath();
  function selfPageUrl(){
    // Works even if the file name is not index.html (e.g. index_v5.html)
    let p = location.pathname || "/";
    if(p.endsWith("/")) p += "index.html";
    return location.origin + p;
  }

  const repoBgUrl = BASE + "1.png";
  const blockUrls = Array.from({length:9}, (_,i)=> BASE + (i+3) + ".png"); // 3..11


  // ===== query params (for Genially iframe) =====
  function parseQueryParams(){
    const q = {};
    const s = window.location.search.replace(/^\?/, "");
    s.split("&").filter(Boolean).forEach(pair=>{
      const [k,v] = pair.split("=");
      if(!k) return;
      q[decodeURIComponent(k)] = decodeURIComponent(v||"");
    });
    return q;
  }

  // ===== hash params (legacy) =====

  function parseHashParams(){
    const h = (location.hash || "").replace(/^#/, "");
    // allow both: #game=... or #game=...&x=y
    const out = {};
    h.split("&").filter(Boolean).forEach(pair=>{
      const [k,v] = pair.split("=");
      if(!k) return;
      out[decodeURIComponent(k)] = decodeURIComponent(v || "");
    });
    return out;
  }

  function b64urlEncode(str){
    const b64 = btoa(unescape(encodeURIComponent(str)));
    return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
  }
  function b64urlDecode(b64url){
    let s = String(b64url||"").replaceAll("-","+").replaceAll("_","/");
    while(s.length % 4) s += "=";
    return decodeURIComponent(escape(atob(s)));
  }

  // ===== GAME renderer =====
  function gameMarkup(){
    return `
<div class="stage" data-role="stage">
  <div class="bg" data-role="bg"></div>
  <div class="overlay"></div>

  <div class="topbar">
    <div class="leftPack">
      <div class="title" data-role="tTitle">–ë–∞—à–Ω—è</div>
      <div class="sub">–û—Ç–≤–µ—á–∞–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî —Å—Ç—Ä–æ–π –±–∞—à–Ω—é!</div>
    </div>

    <div class="rightPack">
      <div class="pillGame" data-role="pillRemain">–û—Å—Ç–∞–ª–æ—Å—å: 9</div>
      <div class="pillGame timerBadge" data-role="pillTimer" style="display:none">‚è≥ 00:30</div>
      <div class="pillGame" data-role="pillScore">üíé –°—á—ë—Ç: 0</div>
      <div class="progressWrap"><div class="progressBar" data-role="bar"></div></div>
    </div>
  </div>

  <div class="towerArea">
    <div class="tower" data-role="tower"></div>
  </div>

  <div class="hintUnder">
    <div class="hintBubble" data-role="hint">–ü–µ—Ä–≤—ã–π –±–ª–æ–∫ —É–∂–µ –ª–µ—Ç–∏—Ç‚Ä¶</div>
  </div>

  <div class="nextWrap">
    <button class="btnGame primary" data-role="btnNext" type="button" disabled>–î–∞–ª–µ–µ ‚Üí</button>
  </div>

  <div class="cardBack" data-role="cardBack" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true">
      <div class="cardHead">
        <div class="h" data-role="cardTitle">–í–æ–ø—Ä–æ—Å</div>
        <div class="pillGame" data-role="cardType">–¢–∏–ø</div>
      </div>

      <div class="cardBody">
        <div class="block">
          <div class="label">–í–æ–ø—Ä–æ—Å</div>
          <div class="qText" data-role="qText"></div>
        </div>

        <div style="height:10px"></div>

        <div class="block">
          <div class="label">–û—Ç–≤–µ—Ç</div>
          <div class="answers" data-role="answers"></div>
        </div>

        <div style="height:8px"></div>
        <div class="sub" data-role="miniHint" style="color:rgba(255,255,255,.80)"></div>
      </div>

      <div class="cardFoot">
        <button class="btnGame" data-role="btnNoClose" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="finish" data-role="finish">
    <div class="finishCard">
      <div class="finishHead">
        <div class="h">–ú–æ–ª–æ–¥–µ—Ü! üéâ</div>
        <button class="btnGame" data-role="btnRestart" type="button">–°—ã–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑</button>
      </div>
      <div class="finishBody">
        <div class="grid">
          <div class="stat"><div class="k">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö</div><div class="v" data-role="finCorrect">0</div></div>
          <div class="stat"><div class="k">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö</div><div class="v" data-role="finWrong">0</div></div>
          <div class="stat"><div class="k">–ë–∞–ª–ª—ã</div><div class="v" data-role="finScore">0</div></div>
          <div class="stat"><div class="k">–ë–∞—à–Ω—è (–±–ª–æ–∫–æ–≤)</div><div class="v" data-role="finHeight">0</div></div>
        </div>

        <div class="bigMsg">
          <div class="h">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å: <span style="color:rgba(57,255,118,.95)">–º–æ–ª–æ–¥–µ—Ü</span> üíö</div>
          <div class="p" data-role="finText">–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ –∏ —Å–æ–±–µ—Ä–∏ –±–∞—à–Ω—é –ø–æ–ª–Ω–æ—Å—Ç—å—é.</div>
        </div>
      </div>
    </div>
  </div>
</div>`;
  }

  function mountGame(hostEl, cfg){
    hostEl.innerHTML = gameMarkup();
    const q = (role)=>hostEl.querySelector(`[data-role="${role}"]`);

    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
    function normStr(s){ return String(s ?? "").trim().toLowerCase(); }
    function fmt(s){
      const m = Math.floor(s/60);
      const ss = s%60;
      return String(m).padStart(2,"0")+":"+String(ss).padStart(2,"0");
    }

    function beep(type="ok"){
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        const now = ctx.currentTime;
        g.gain.setValueAtTime(0.001, now);

        if(type==="ok"){
          o.type="sine";
          o.frequency.setValueAtTime(740, now);
          g.gain.exponentialRampToValueAtTime(0.18, now+0.02);
          g.gain.exponentialRampToValueAtTime(0.001, now+0.16);
          o.start(now); o.stop(now+0.18);
        } else {
          o.type="square";
          o.frequency.setValueAtTime(180, now);
          g.gain.exponentialRampToValueAtTime(0.22, now+0.02);
          o.frequency.exponentialRampToValueAtTime(90, now+0.12);
          g.gain.exponentialRampToValueAtTime(0.001, now+0.22);
          o.start(now); o.stop(now+0.24);
        }
      }catch(e){}
    }

    function makeSparks(x,y, count=14){
      const stage = q("stage");
      for(let i=0;i<count;i++){
        const s = document.createElement("div");
        s.className = "spark";
        const a = Math.random()*Math.PI*2;
        const r = 40 + Math.random()*70;
        const dx = Math.cos(a)*r;
        const dy = Math.sin(a)*r - (20+Math.random()*40);
        s.style.left = x + "px";
        s.style.top = y + "px";
        s.style.setProperty("--dx", dx+"px");
        s.style.setProperty("--dy", dy+"px");
        stage.appendChild(s);
        setTimeout(()=>s.remove(), 800);
      }
      for(let i=0;i<8;i++){
        const m = document.createElement("div");
        m.className = "smoke";
        const a = Math.random()*Math.PI*2;
        const r = 30 + Math.random()*60;
        const dx = Math.cos(a)*r;
        const dy = Math.sin(a)*r - (40+Math.random()*40);
        m.style.left = x + "px";
        m.style.top = y + "px";
        m.style.setProperty("--dx", dx+"px");
        m.style.setProperty("--dy", dy+"px");
        stage.appendChild(m);
        setTimeout(()=>m.remove(), 1100);
      }
    }

    function floatPlus(x,y, text){
      const stage = q("stage");
      const p = document.createElement("div");
      p.className = "floatPlus";
      p.textContent = text;
      p.style.left = x+"px";
      p.style.top = y+"px";
      stage.appendChild(p);
      setTimeout(()=>p.remove(), 1000);
    }

    function towerCenter(){
      const stage = q("stage");
      const tower = q("tower");
      const rs = stage.getBoundingClientRect();
      const rt = tower.getBoundingClientRect();
      return {
        x: rt.left + rt.width/2 - rs.left,
        yTop: rt.top - rs.top,
        h: rt.height
      };
    }

    function isImageMode(){
      return !!cfg.useImages;
    }

    function createBlockEl(i, width){
      const tower = q("tower");

      if(isImageMode() && cfg.blockUrls && cfg.blockUrls[i]){
        const img = document.createElement("img");
        img.className = "imgBlock";
        img.src = cfg.blockUrls[i];
        img.alt = "block";
        img.style.width = width + "px";
        tower.appendChild(img);
        return { el: img, kind:"img" };
      }

      const b = document.createElement("div");
      b.className = "cssBlock";
      b.style.width = width + "px";
      tower.appendChild(b);
      return { el: b, kind:"css" };
    }

    const bg = q("bg");
    const tTitle = q("tTitle");
    const pillRemain = q("pillRemain");
    const pillTimer = q("pillTimer");
    const pillScore = q("pillScore");
    const bar = q("bar");
    const hint = q("hint");
    const btnNext = q("btnNext");

    const cardBack = q("cardBack");
    const qText = q("qText");
    const answers = q("answers");
    const miniHint = q("miniHint");
    const cardType = q("cardType");
    const btnNoClose = q("btnNoClose");

    const finish = q("finish");
    const btnRestart = q("btnRestart");
    const finCorrect = q("finCorrect");
    const finWrong = q("finWrong");
    const finScore = q("finScore");
    const finHeight = q("finHeight");
    const finText = q("finText");

    const questions = (cfg.questions || []).slice(0,9);
    while(questions.length < 9){
      questions.push({type:"choice", prompt:"(–ø—É—Å—Ç–æ–π –≤–æ–ø—Ä–æ—Å)", options:["OK","..."], correctIndex:0});
    }

    tTitle.textContent = cfg.title || "–ë–∞—à–Ω—è";

    // background:
    // 1) if bgDataUrl set (uploaded), use it
    // 2) else if useRepoBg -> 1.png
    if(cfg.bgDataUrl){
      bg.style.display = "block";
      bg.style.backgroundImage = 'url("' + cfg.bgDataUrl + '")';
    } else if(cfg.useRepoBg){
      bg.style.display = "block";
      bg.style.backgroundImage = 'url("' + repoBgUrl + '")';
    }

    let timerEnabled = !!cfg.timer?.enabled;
    let timerSeconds = clamp(Number(cfg.timer?.seconds || 30), 5, 600);
    let timerLeft = timerSeconds;
    let timerId = null;

    let qIndex = 0;
    let correct = 0;
    let wrong = 0;
    let score = 0;

    let stack = [];
    let falling = null;

    const baseW = Math.min(380, Math.max(240, Math.floor(Math.min(window.innerWidth, hostEl.clientWidth || window.innerWidth) * 0.55)));
    function widthForIndex(i){
      // i=0 bottom (widest), i=8 top (narrowest)
      const t = i / 8;
      const w = baseW * (1 - 0.45 * t); // 45% taper total
      return Math.round(w);
    }
    const cssBlockH = 78;
    const overlap = 10;

    function stackHeight(){
      let h=0;
      for(let i=0;i<stack.length;i++){
        h += stack[i].h;
        if(i>0) h -= overlap;
      }
      return h;
    }

    function baseY(){ return q("tower").clientHeight; }

    function placeStackInstant(){
      let y = baseY();
      for(let i=0;i<stack.length;i++){
        y -= stack[i].h;
        stack[i].y = y;
        stack[i].el.style.top = y + "px";
        if(i < stack.length-1) y += overlap;
      }
    }

    function updateTopUI(){
      const remain = 9 - qIndex;
      pillRemain.textContent = "–û—Å—Ç–∞–ª–æ—Å—å: " + remain;
      pillScore.textContent = "üíé –°—á—ë—Ç: " + score;
      bar.style.width = (qIndex/9*100) + "%";
    }

    function stopTimer(){
      if(timerId){ clearInterval(timerId); timerId = null; }
    }
    function startTimer(){
      stopTimer();
      if(!timerEnabled){ pillTimer.style.display="none"; return; }
      timerLeft = timerSeconds;
      pillTimer.style.display="";
      pillTimer.textContent = "‚è≥ " + fmt(timerLeft);
      timerId = setInterval(()=>{
        timerLeft--;
        pillTimer.textContent = "‚è≥ " + fmt(timerLeft);
        if(timerLeft <= 0){
          stopTimer();
          if(falling && falling.state === "waitAnswer"){
            resolveAnswer(false, true);
          }
        }
      }, 1000);
    }

    function showCard(qobj){
      answers.innerHTML = "";
      qText.textContent = qobj.prompt || "";
      cardType.textContent = (qobj.type === "choice") ? "–° –≤—ã–±–æ—Ä–æ–º" : "–° –≤–≤–æ–¥–æ–º";
      miniHint.textContent = (qobj.type === "choice")
        ? "–í—ã–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç."
        : "–í–≤–µ–¥–∏ –æ—Ç–≤–µ—Ç –∏ –Ω–∞–∂–º–∏ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å¬ª –∏–ª–∏ Enter.";

      cardBack.style.display="flex";
      cardBack.setAttribute("aria-hidden","false");
      btnNext.disabled = true;

      // per-question timer override (qobj.seconds). Falls back to global cfg.timer
      {
        const per = (qobj && qobj.seconds != null) ? Number(qobj.seconds) : null;
        if(Number.isFinite(per) && per > 0){
          timerEnabled = true;
          timerSeconds = clamp(per, 3, 600);
        } else {
          timerEnabled = !!cfg.timer?.enabled;
          timerSeconds = clamp(Number(cfg.timer?.seconds || 30), 5, 600);
        }
      }
      startTimer();

      if(qobj.type === "choice"){
        (qobj.options || []).forEach((opt, i)=>{
          const b = document.createElement("div");
          b.className = "pillBtn";
          b.textContent = opt || ("–í–∞—Ä–∏–∞–Ω—Ç " + (i+1));
          b.onclick = ()=>{
            const ok = (i === Number(qobj.correctIndex||0));
            resolveAnswer(ok, false);
          };
          answers.appendChild(b);
        });
      } else {
        const wrap = document.createElement("div");
        wrap.className = "inputRow";

        const inp = document.createElement("input");
        inp.className = "inp";
        inp.type = "text";
        inp.placeholder = "–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç‚Ä¶";

        const btn = document.createElement("button");
        btn.className = "btnGame primary";
        btn.type = "button";
        btn.textContent = "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å";

        function check(){
          const v = normStr(inp.value);
          if(!v) return;
          const acc = (qobj.accepts || []).map(normStr).filter(Boolean);
          resolveAnswer(acc.includes(v), false);
        }

        btn.onclick = check;
        inp.addEventListener("keydown",(e)=>{ if(e.key==="Enter") check(); });

        wrap.appendChild(inp);
        wrap.appendChild(btn);
        answers.appendChild(wrap);
      }
    }

    function hideCard(){
      stopTimer();
      cardBack.style.display="none";
      cardBack.setAttribute("aria-hidden","true");
    }

    btnNoClose.onclick = () => {
      hint.textContent = "–°–Ω–∞—á–∞–ª–∞ –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å üôÇ";
    };

    function spawnBlock(i){
      const w = widthForIndex(i);
      const b = createBlockEl(i, w);

      let h = cssBlockH;
      if(b.kind==="img"){
        h = 90;
        b.el.onload = ()=>{
          const ratio = (b.el.naturalHeight||90) / Math.max(1,(b.el.naturalWidth||w));
          const realH = Math.round(w * ratio);
          b.el.style.height = realH + "px";
          if(falling && falling.el === b.el){
            falling.h = realH;
            falling.targetY = baseY() - stackHeight() - realH + overlap;
          }
          placeStackInstant();
        };
      } else {
        b.el.style.height = h + "px";
      }

      const yStart = -h - 60;
      const targetY = baseY() - stackHeight() - h + overlap;

      falling = {
        el: b.el,
        y: yStart,
        targetY,
        vel: 0,
        h,
        state: "fall",
        springT: 0,
        idx: i
      };
      b.el.style.top = yStart + "px";
    }

    function scorchAndVanish(){
      if(!falling) return;
      const el = falling.el;
      el.classList.add("burning");

      const c = towerCenter();
      const y = c.yTop + clamp(falling.y + falling.h/2, 80, c.h-60);
      makeSparks(c.x, y, 18);

      el.style.transition = "opacity .35s ease, transform .35s ease, filter .35s ease";
      el.style.opacity = "0";
      el.style.transform = "translateX(-50%) scale(1.02)";
      setTimeout(()=>{ el.remove(); }, 380);

      falling = null;
    }

    function landWithSpring(){
      if(!falling) return;
      falling.state = "spring";
      falling.springT = 0;

      const c = towerCenter();
      const y = c.yTop + clamp(falling.targetY + falling.h - 18, 90, c.h-50);
      makeSparks(c.x, y, 12);
    }

    function finalizeLand(){
      if(!falling) return;
      const item = { el: falling.el, h: falling.h, y: falling.targetY };
      stack.push(item);
      falling = null;
      placeStackInstant();
      btnNext.disabled = false;

      if(qIndex >= 9){
        hint.textContent = "–ì–æ—Ç–æ–≤–æ! –ù–∞–∂–º–∏ ¬´–î–∞–ª–µ–µ¬ª, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.";
      } else {
        hint.textContent = "–ù–∞–∂–º–∏ ¬´–î–∞–ª–µ–µ¬ª, —á—Ç–æ–±—ã –≤—ã–∑–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫.";
      }
    }

    function resolveAnswer(ok, fromTimer){
      hideCard();

      if(!falling || falling.state !== "waitAnswer"){
        return;
      }

      if(ok){
        correct++;
        score += 100;
        beep("ok");

        const c = towerCenter();
        floatPlus(c.x, c.yTop + clamp(falling.targetY + 14, 90, c.h-120), "+100");

        hint.textContent = "–í–µ—Ä–Ω–æ ‚úÖ –ë–ª–æ–∫ –∑–∞–∫—Ä–µ–ø–∏–ª—Å—è! –ù–∞–∂–º–∏ ¬´–î–∞–ª–µ–µ¬ª.";
        landWithSpring();
      } else {
        wrong++;
        beep("bad");

        hint.textContent = fromTimer
          ? "–í—Ä–µ–º—è –≤—ã—à–ª–æ ‚è± –ë–ª–æ–∫ —Å–≥–æ—Ä–µ–ª. –ù–∞–∂–º–∏ ¬´–î–∞–ª–µ–µ¬ª."
          : "–ù–µ–≤–µ—Ä–Ω–æ ‚ùå –ë–ª–æ–∫ —Å–≥–æ—Ä–µ–ª. –ù–∞–∂–º–∏ ¬´–î–∞–ª–µ–µ¬ª.";
        scorchAndVanish();
        btnNext.disabled = false;
      }

      updateTopUI();
    }

    function finishGame(){
      btnNext.disabled = true;
      finCorrect.textContent = String(correct);
      finWrong.textContent = String(wrong);
      finScore.textContent = String(score);
      finHeight.textContent = String(stack.length);

      if(correct === 9){
        finText.textContent = "–ò–¥–µ–∞–ª—å–Ω–æ! –¢—ã —Å–æ–±—Ä–∞–ª(–∞) –≤—Å—é –±–∞—à–Ω—é –±–µ–∑ –æ—à–∏–±–æ–∫ üî•";
      } else if(correct >= 6){
        finText.textContent = "–û—á–µ–Ω—å –∫—Ä—É—Ç–æ! –ë–∞—à–Ω—è –≤—ã—Å–æ–∫–∞—è. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ –∏ –¥–æ–±–µ—Ä–∏ –¥–æ 9 üíö";
      } else {
        finText.textContent = "–•–æ—Ä–æ—à–µ–µ –Ω–∞—á–∞–ª–æ! –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ ‚Äî –∏ –±–∞—à–Ω—è —Å—Ç–∞–Ω–µ—Ç –≤—ã—à–µ üòä";
      }

      finish.style.display = "flex";
    }

    btnRestart.onclick = ()=>{
      finish.style.display = "none";
      stack.forEach(x=>x.el.remove());
      stack = [];
      if(falling?.el) falling.el.remove();
      falling = null;

      qIndex = 0;
      correct = 0;
      wrong = 0;
      score = 0;

      updateTopUI();
      hint.textContent = "–ü–µ—Ä–≤—ã–π –±–ª–æ–∫ —É–∂–µ –ª–µ—Ç–∏—Ç‚Ä¶";
      btnNext.disabled = true;

      setTimeout(()=> spawnNext(), 320);
    };

    btnNext.onclick = ()=>{
      if(falling) return;
      if(qIndex >= 9){
        finishGame();
        return;
      }
      spawnNext();
    };

    function spawnNext(){
      if(qIndex >= 9){
        finishGame();
        return;
      }

      spawnBlock(qIndex);
      hint.textContent = "–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å, —á—Ç–æ–±—ã –±–ª–æ–∫ –∑–∞–∫—Ä–µ–ø–∏–ª—Å—è.";
      updateTopUI();

      setTimeout(()=>{
        if(!falling) return;
        falling.state = "waitAnswer";
        showCard(questions[qIndex]);
        qIndex++;
        updateTopUI();
      }, 260);
    }

    updateTopUI();
    setTimeout(()=> spawnNext(), 320);

    function loop(){
      if(falling){
        if(falling.state === "fall"){
          falling.vel += 0.55;
          falling.y += falling.vel;
          if(falling.y >= falling.targetY){
            falling.y = falling.targetY;
            falling.vel = 0;
            falling.state = "waitAnswer";
          }
          falling.el.style.top = falling.y + "px";
        }
        else if(falling.state === "spring"){
          falling.springT++;
          const t = Math.min(1, falling.springT/18);
          const amp = 10;
          const offset = Math.sin(t*Math.PI) * amp;
          falling.el.style.top = (falling.targetY + offset) + "px";

          if(falling.springT >= 18){
            falling.el.style.top = falling.targetY + "px";
            finalizeLand();
          }
        }
      }
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    // responsive recalculation on resize
    window.addEventListener("resize", ()=>{ placeStackInstant(); });
  }

  // ===== config =====
  function normalizeCfg(raw){
    const cfg = raw && typeof raw === "object" ? raw : {};
    const title = String(cfg.title || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π");
    const useRepoBg = !!cfg.useRepoBg;
    const bgDataUrl = String(cfg.bgDataUrl || "");
    const useImages = !!cfg.useImages;

    const timerEnabled = !!cfg.timer?.enabled;
    const timerSeconds = Math.max(5, Math.min(600, Number(cfg.timer?.seconds || 30)));

    let questions = Array.isArray(cfg.questions) ? cfg.questions.slice(0,9) : [];
    // sanitize
    questions = questions.map(q=>{
      const rawSecs = (q && ("seconds" in q)) ? q.seconds : null;
      const nSecs = (rawSecs==null || rawSecs==="") ? null : Number(rawSecs);
      const seconds = (Number.isFinite(nSecs) && nSecs>0) ? Math.max(1, Math.min(600, Math.round(nSecs))) : null;
      const imgDataUrl = String(q?.imgDataUrl || "");
      const audioDataUrl = String(q?.audioDataUrl || "");
      if(q?.type === "text"){
        return {
          type:"text",
          prompt:String(q.prompt||""),
          accepts:(Array.isArray(q.accepts)?q.accepts:[]).map(x=>String(x||"")),
          seconds,
          imgDataUrl,
          audioDataUrl
        };
      }
      return {
        type:"choice",
        prompt:String(q?.prompt||""),
        options:(Array.isArray(q?.options)?q.options:[]).map(x=>String(x||"")),
        correctIndex:Number(q?.correctIndex||0),
        seconds,
        imgDataUrl,
        audioDataUrl
      };
    });

    // –º–æ–∂–Ω–æ –º–µ–Ω—å—à–µ 9 ‚Äî –∏–≥—Ä–∞ –∑–∞—Ü–∏–∫–ª–∏—Ç –≤–æ–ø—Ä–æ—Å—ã


    return {
      title,
      useRepoBg,
      bgDataUrl,
      timer: { enabled: timerEnabled, seconds: timerSeconds },
      useImages,
      blockUrls: blockUrls,
      questions
    };
  }

  // ===== Editor =====
  const Editor = {
    title: "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π",
    useRepoBg: true,
    bgDataUrl: "",
    timer: { enabled:false, seconds: 30 },
    useImages: true,
    questions: [],
    draft: null,
    editingId: null
  };

  function setCountPill(){
    $("pillCount").textContent = Editor.questions.length + " / 9";
    $("btnAddQ").disabled = (Editor.questions.length >= 9);
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function qSummary(q){
    const p = String(q.prompt || "").trim();
    const short = p.length > 50 ? p.slice(0,50)+"‚Ä¶" : p;
    const type = (q.type==="choice") ? "–í—ã–±–æ—Ä" : "–í–≤–æ–¥";
    return { title: short || "(–ø—É—Å—Ç–æ)", sub: type };
  }

  function renderList(){
    const list = $("qList");
    list.innerHTML = "";
    setCountPill();

    if(Editor.questions.length === 0){
      const d = document.createElement("div");
      d.className = "muted";
      d.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤. –ù–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ 9 –≤–æ–ø—Ä–æ—Å–æ–≤.";
      list.appendChild(d);
      return;
    }

    Editor.questions.forEach((q,i)=>{
      const wrap = document.createElement("div");
      wrap.className = "q-item";

      const meta = document.createElement("div");
      meta.className = "meta";
      const s = qSummary(q);
      meta.innerHTML = `<div class="t">${escapeHtml(String(i+1)+". "+s.title)}</div>
                        <div class="s">${escapeHtml(s.sub)}</div>`;

      const btns = document.createElement("div");
      btns.style.display="flex";
      btns.style.gap="8px";
      btns.style.flexWrap="wrap";
      btns.style.justifyContent="flex-end";

      const bPrev = document.createElement("button");
      bPrev.className = "btn small";
      bPrev.type="button";
      bPrev.textContent = "üëÅ";
      bPrev.title = "–ü–æ–∫–∞–∑–∞—Ç—å –≤ –ø—Ä–µ–≤—å—é (–ø–µ—Ä–≤—ã–º –≤–æ–ø—Ä–æ—Å–æ–º)";
      bPrev.onclick = ()=>{
        Editor.draft = deepClone(q);
        updatePreview(true);
        toast("–ü–æ–∫–∞–∑–∞–Ω–æ –≤ –ø—Ä–µ–≤—å—é");
      };

      const bEdit = document.createElement("button");
      bEdit.className = "btn small";
      bEdit.type="button";
      bEdit.textContent = "‚úèÔ∏è";
      bEdit.title = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
      bEdit.onclick = ()=> openModal(q);

      const bDel = document.createElement("button");
      bDel.className = "btn small danger";
      bDel.type="button";
      bDel.textContent = "üóë";
      bDel.title = "–£–¥–∞–ª–∏—Ç—å";
      bDel.onclick = ()=>{
        Editor.questions = Editor.questions.filter(x=>x.id!==q.id);
        renderList();
        updatePreview(false);
        toast("–£–¥–∞–ª–µ–Ω–æ");
      };

      btns.appendChild(bPrev);
      btns.appendChild(bEdit);
      btns.appendChild(bDel);

      wrap.appendChild(meta);
      wrap.appendChild(btns);
      list.appendChild(wrap);
    });
  }

  function showModal(){
    $("modalBackdrop").style.display = "flex";
    $("modalBackdrop").setAttribute("aria-hidden","false");
  }
  function hideModal(){
    $("modalBackdrop").style.display = "none";
    $("modalBackdrop").setAttribute("aria-hidden","true");
  }

  function syncModalType(){
    const t = $("selType").value;
    $("choiceWrap").style.display = (t==="choice") ? "block" : "none";
    $("textWrap").style.display = (t==="text") ? "block" : "none";
  }

  function renderChoiceUI(){
    const list = $("choiceList");
    list.innerHTML = "";
    const q = Editor.draft;
    if(!q) return;

    q.options = q.options || ["",""];
    if(typeof q.correctIndex !== "number") q.correctIndex = 0;

    q.options.forEach((val, idx)=>{
      const row = document.createElement("div");
      row.className = "answerRow";

      const r = document.createElement("input");
      r.className="radio";
      r.type="radio";
      r.name="correctChoice";
      r.checked = (q.correctIndex === idx);
      r.onchange = ()=>{ q.correctIndex = idx; renderChoiceUI(); };

      const inp = document.createElement("input");
      inp.type="text";
      inp.value = val || "";
      inp.placeholder = (idx === q.correctIndex) ? "‚úÖ –í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç" : ("–í–∞—Ä–∏–∞–Ω—Ç " + (idx+1));
      inp.oninput = ()=>{ q.options[idx] = inp.value; };

      const del = document.createElement("button");
      del.className="btn small danger";
      del.type="button";
      del.textContent="‚úñ";
      del.onclick = ()=>{
        q.options.splice(idx,1);
        if(q.options.length < 2) q.options.push("");
        if(q.correctIndex >= q.options.length) q.correctIndex = q.options.length-1;
        renderChoiceUI();
      };

      row.appendChild(r);
      row.appendChild(inp);
      row.appendChild(del);
      list.appendChild(row);
    });
  }

  function renderTextUI(){
    const list = $("textList");
    list.innerHTML = "";
    const q = Editor.draft;
    if(!q) return;

    q.accepts = q.accepts || [""];

    q.accepts.forEach((val, idx)=>{
      const row = document.createElement("div");
      row.className = "answerRow";

      const inp = document.createElement("input");
      inp.type="text";
      inp.value = val || "";
      inp.placeholder = (idx===0) ? "‚úÖ –í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç" : ("–í–µ—Ä–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç " + (idx+1));
      inp.oninput = ()=>{ q.accepts[idx] = inp.value; };

      const del = document.createElement("button");
      del.className="btn small danger";
      del.type="button";
      del.textContent="‚úñ";
      del.onclick = ()=>{
        q.accepts.splice(idx,1);
        if(q.accepts.length === 0) q.accepts.push("");
        renderTextUI();
      };

      row.appendChild(inp);
      row.appendChild(del);
      list.appendChild(row);
    });
  }

  function openModal(existing=null){
    if(existing){
      Editor.draft = deepClone(existing);
      Editor.editingId = existing.id;
      $("modalTitle").textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å";
    } else {
      Editor.draft = {
        id: uid(),
        type: "choice",
        prompt: "",
        options: ["",""],
        correctIndex: 0,
        seconds: null,
        imgDataUrl: "",
        audioDataUrl: ""
      };
      Editor.editingId = null;
      $("modalTitle").textContent = "–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å";
    }

    $("selType").value = Editor.draft.type || "choice";
    $("inpPrompt").value = Editor.draft.prompt || "";
    if(!("seconds" in Editor.draft)) Editor.draft.seconds = null;
    if(!("imgDataUrl" in Editor.draft)) Editor.draft.imgDataUrl = "";
    if(!("audioDataUrl" in Editor.draft)) Editor.draft.audioDataUrl = "";
    if($("inpQSeconds")) $("inpQSeconds").value = (Editor.draft.seconds ?? "");
    if($("qMediaPreview")) {
      const parts=[];
      if(Editor.draft.imgDataUrl) parts.push("üñº –∫–∞—Ä—Ç–∏–Ω–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞");
      if(Editor.draft.audioDataUrl) parts.push("üéµ –∑–≤—É–∫ –¥–æ–±–∞–≤–ª–µ–Ω");
      $("qMediaPreview").textContent = parts.length? parts.join(" ‚Ä¢ "): "–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ.";
    }
    syncModalType();
    if($("selType").value === "choice") renderChoiceUI();
    else renderTextUI();

    showModal();
    setTimeout(()=>$("inpPrompt").focus(), 40);
  }

  function getDraftFromModal(){
    const q = Editor.draft;
    if(!q) return null;

    q.type = $("selType").value;
    q.prompt = $("inpPrompt").value || "";

    q.seconds = ($("inpQSeconds") && $("inpQSeconds").value !== "") ? Number($("inpQSeconds").value) : null;
    if(q.seconds != null){
      const s = Number(q.seconds);
      if(!Number.isFinite(s) || s < 3 || s > 600) return "–¢–∞–π–º–µ—Ä –≤–æ–ø—Ä–æ—Å–∞: 3‚Äì600 —Å–µ–∫—É–Ω–¥";
      q.seconds = Math.round(s);
    }

    if(q.type === "choice"){
      q.options = (q.options || []).map(x=>String(x||""));
      q.correctIndex = Number.isFinite(q.correctIndex) ? q.correctIndex : 0;
    } else {
      q.accepts = (q.accepts || [""]).map(x=>String(x||""));
    }
    return q;
  }

  function validateQuestion(q){
    if(!q) return "–ü—É—Å—Ç–æ–π –≤–æ–ø—Ä–æ—Å";
    if(!(q.prompt||"").trim()) return "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞";

    if(q.type === "choice"){
      const opts = (q.options||[]).map(x=>String(x||"").trim()).filter(Boolean);
      if(opts.length < 2) return "–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞";
      q.options = opts;
      if(!Number.isFinite(q.correctIndex)) q.correctIndex = 0;
      if(q.correctIndex >= q.options.length) q.correctIndex = 0;
      return "";
    }

    const acc = (q.accepts||[]).map(x=>String(x||"").trim()).filter(Boolean);
    if(acc.length === 0) return "–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç";
    q.accepts = acc;
    return "";
  }

  function buildPayload(previewWithDraft){
    let questions = Editor.questions.map(q=>{
      if(q.type === "choice"){
        return { type:"choice", prompt:q.prompt||"", options:(q.options||[]).slice(), correctIndex:Number(q.correctIndex||0), seconds:(q.seconds??null), imgDataUrl:(q.imgDataUrl||""), audioDataUrl:(q.audioDataUrl||"") };
      }
      return { type:"text", prompt:q.prompt||"", accepts:(q.accepts||[]).slice(), seconds:(q.seconds??null), imgDataUrl:(q.imgDataUrl||""), audioDataUrl:(q.audioDataUrl||"") };
    });

    if(previewWithDraft && Editor.draft){
      const d = deepClone(Editor.draft);
      questions = questions.slice();
      if(d.type === "choice"){
        const mapped = {
        type:"choice",
        prompt:d.prompt||"",
        options:(d.options||[]).slice(),
        correctIndex:Number(d.correctIndex||0),
        seconds: (d.seconds==null || d.seconds==="") ? null : Number(d.seconds),
        imgDataUrl: d.imgDataUrl||"",
        audioDataUrl: d.audioDataUrl||""
      };
        if(questions.length === 0) questions.push(mapped);
        else questions[0] = mapped;
      } else {
        const mapped = {
        type:"text",
        prompt:d.prompt||"",
        accepts:(d.accepts||[]).slice(),
        seconds: (d.seconds==null || d.seconds==="") ? null : Number(d.seconds),
        imgDataUrl: d.imgDataUrl||"",
        audioDataUrl: d.audioDataUrl||""
      };
        if(questions.length === 0) questions.push(mapped);
        else questions[0] = mapped;
      }
    }

    // –º–æ–∂–Ω–æ –º–µ–Ω—å—à–µ 9 ‚Äî –∏–≥—Ä–∞ –∑–∞—Ü–∏–∫–ª–∏—Ç –≤–æ–ø—Ä–æ—Å—ã


    return normalizeCfg({
      title: Editor.title || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π",
      useRepoBg: true,
      bgDataUrl: Editor.bgDataUrl || "",
      timer: { enabled: !!Editor.timer.enabled, seconds: Number(Editor.timer.seconds || 30) },
      useImages: !!Editor.useImages,
      questions
    });
  }

  function buildGameUrl(payload){
    const data = b64urlEncode(JSON.stringify(payload));
    return selfPageUrl() + "?game=" + data + "#game=" + data;
  }
  function buildIframeFromUrl(src){
    return `<iframe src="${src}" style="width:100%;height:100%;min-height:720px;border:0;border-radius:18px;overflow:hidden;background:transparent" allow="autoplay; fullscreen" allowfullscreen loading="lazy"></iframe>`;
  }

  
  // ===== preview payload store (avoid URI Too Long) =====
  const PREVIEW_CFGKEY = "__tower_preview_cfg__";
  function cfgHasMedia(cfg){
    try{
      return (cfg?.questions || []).some(q => (q && (q.imgDataUrl || q.audioDataUrl)));
    }catch(e){ return false; }
  }
  function storePreviewCfg(cfg){
    try{
      localStorage.setItem(PREVIEW_CFGKEY, JSON.stringify(cfg));
      return PREVIEW_CFGKEY;
    }catch(e){
      // if storage fails (quota), fallback to in-memory key (will still try ?game)
      return "";
    }
  }

  function updatePreview(previewWithDraft){
    const payload = buildPayload(previewWithDraft);
    // Use short cfgkey when payload is big or contains media
    const jsonStr = JSON.stringify(payload);
    const useKey = cfgHasMedia(payload) || jsonStr.length > 1800;
    if(useKey){
      const key = storePreviewCfg(payload);
      if(key){
        const src = selfPageUrl() + "?cfgkey=" + encodeURIComponent(key) + "&preview=1#cfgkey=" + encodeURIComponent(key);
        $("livePreview").src = src;
        return;
      }
    }
    // fallback legacy
    const data = b64urlEncode(jsonStr);
    const src = selfPageUrl() + "?game=" + data + "&preview=1#game=" + data;
    $("livePreview").src = src;
  }

  // ==== bindings ====
  $("inpTitle").addEventListener("input", ()=>{
    Editor.title = $("inpTitle").value || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π";
    updatePreview(false);
  });
$("fileBg").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    Editor.bgDataUrl = await fileToDataUrl(f);
    toast("–§–æ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω");
    updatePreview(false);
  });

  
  $("btnResetBg").addEventListener("click", ()=>{
    Editor.bgDataUrl = "";
    $("fileBg").value = "";
    updatePreview(false);
  });
$("chkUseImages").addEventListener("change", ()=>{
    Editor.useImages = true; if($("chkUseImages")) $("chkUseImages").checked = true;
    updatePreview(false);
  });

  $("chkTimer").addEventListener("change", ()=>{
    Editor.timer.enabled = $("chkTimer").checked;
    updatePreview(false);
  });

  $("inpSeconds").addEventListener("input", ()=>{
    Editor.timer.seconds = Number($("inpSeconds").value || 30);
    updatePreview(false);
  });

  $("btnAddQ").addEventListener("click", ()=>{
    if(Editor.questions.length >= 9){
      toast("–í–æ–ø—Ä–æ—Å–æ–≤ —É–∂–µ 9 üôÇ");
      return;
    }
    openModal(null);
  });

  $("btnClearQs").addEventListener("click", ()=>{
    Editor.questions = [];
    renderList();
    updatePreview(false);
    toast("–û—á–∏—â–µ–Ω–æ");
  });

  $("btnCloseModal").addEventListener("click", ()=>{
    Editor.draft=null; Editor.editingId=null; hideModal();
  });

  $("modalBackdrop").addEventListener("click", (e)=>{
    if(e.target === $("modalBackdrop")){
      Editor.draft=null; Editor.editingId=null; hideModal();
    }
  });

  $("selType").addEventListener("change", ()=>{
    const q = Editor.draft;
    if(!q) return;
    q.type = $("selType").value;
    syncModalType();
    if(q.type === "choice"){
      q.options = q.options || ["",""];
      if(typeof q.correctIndex !== "number") q.correctIndex = 0;
      renderChoiceUI();
    } else {
      q.accepts = q.accepts || [""];
      renderTextUI();
    }
  });

  $("btnAddChoice").addEventListener("click", ()=>{
    const q = Editor.draft;
    if(!q) return;
    q.options = q.options || ["",""];
    q.options.push("");
    renderChoiceUI();
  });

  $("btnAddText").addEventListener("click", ()=>{
    const q = Editor.draft;
    if(!q) return;
    q.accepts = q.accepts || [""];
    q.accepts.push("");
    renderTextUI();
  });

  
  // per-question media uploads
  
  // Media icon buttons (beside the question text)
  if ($("btnPickQImage") && $("fileQImage")) {
    $("btnPickQImage").addEventListener("click", ()=> $("fileQImage").click());
  }
  if ($("btnPickQAudio") && $("fileQAudio")) {
    $("btnPickQAudio").addEventListener("click", ()=> $("fileQAudio").click());
  }

if ($("fileQImage")) {
    $("fileQImage").addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      try{
        Editor.draft = Editor.draft || {};
        Editor.draft.imgDataUrl = await fileToDataUrl(f);
        if($("qMediaPreview")){
          const parts=[];
          if(Editor.draft.imgDataUrl) parts.push("üñº –∫–∞—Ä—Ç–∏–Ω–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞");
          if(Editor.draft.audioDataUrl) parts.push("üéµ –∑–≤—É–∫ –¥–æ–±–∞–≤–ª–µ–Ω");
          $("qMediaPreview").textContent = parts.length? parts.join(" ‚Ä¢ "): "–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ.";
        }
        toast("–ö–∞—Ä—Ç–∏–Ω–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞");
      }catch(err){ toast("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É"); }
    });
  }
  if ($("fileQAudio")) {
    $("fileQAudio").addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      try{
        Editor.draft = Editor.draft || {};
        Editor.draft.audioDataUrl = await fileToDataUrl(f);
        if($("qMediaPreview")){
          const parts=[];
          if(Editor.draft.imgDataUrl) parts.push("üñº –∫–∞—Ä—Ç–∏–Ω–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞");
          if(Editor.draft.audioDataUrl) parts.push("üéµ –∑–≤—É–∫ –¥–æ–±–∞–≤–ª–µ–Ω");
          $("qMediaPreview").textContent = parts.length? parts.join(" ‚Ä¢ "): "–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ.";
        }
        toast("–ó–≤—É–∫ –¥–æ–±–∞–≤–ª–µ–Ω");
      }catch(err){ toast("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–≤—É–∫"); }
    });
  }

$("btnPreviewDraft").addEventListener("click", ()=>{
    getDraftFromModal();
    updatePreview(true);
    toast("–ß–µ—Ä–Ω–æ–≤–∏–∫ –ø–æ–∫–∞–∑–∞–Ω –≤ –ø—Ä–µ–≤—å—é");
  });

  $("btnSaveQ").addEventListener("click", ()=>{
    const q = getDraftFromModal();
    const err = validateQuestion(q);
    if(err){ toast(err); return; }

    if(Editor.editingId){
      const idx = Editor.questions.findIndex(x=>x.id === Editor.editingId);
      if(idx >= 0){
        q.id = Editor.editingId;
        Editor.questions[idx] = q;
        toast("–í–æ–ø—Ä–æ—Å –æ–±–Ω–æ–≤–ª—ë–Ω");
      } else {
        Editor.questions.push(q);
        toast("–í–æ–ø—Ä–æ—Å –¥–æ–±–∞–≤–ª–µ–Ω");
      }
    } else {
      Editor.questions.push(q);
      toast("–í–æ–ø—Ä–æ—Å –¥–æ–±–∞–≤–ª–µ–Ω");
    }

    Editor.draft=null; Editor.editingId=null;
    hideModal();
    renderList();
    updatePreview(false);
  });

  $("btnCopyCode").addEventListener("click", async ()=>{
    const payload = buildPayload(false);
    const url = buildGameUrl(payload);
    const iframeCode = buildIframeFromUrl(url);

    const ok = await copyToClipboard(iframeCode);
    toast(ok ? "iframe —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω ‚úÖ" : "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
  });

  
  // iframe code modal
  function hideCodeModal(){
    if(!$("codeBackdrop")) return;
    $("codeBackdrop").style.display = "none";
    $("codeBackdrop").setAttribute("aria-hidden","true");
  }
  if ($("btnCloseCode")) $("btnCloseCode").addEventListener("click", hideCodeModal);
  if ($("codeBackdrop")) {
    $("codeBackdrop").addEventListener("click", (e)=>{
      if(e.target === $("codeBackdrop")) hideCodeModal();
    });
  }
  if ($("btnCopyFromModal")) {
    $("btnCopyFromModal").addEventListener("click", async ()=>{
      const text = ($("taIframe")?.value || "").trim();
      if(!text){ toast("–ü—É—Å—Ç–æ"); return; }
      const ok = await copyToClipboard(text);
      toast(ok ? "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ" : "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
    });
  
  if ($("btnCopyIframe")) {
    $("btnCopyIframe").addEventListener("click", async ()=>{
      const text = ($("taIframe2")?.value || "").trim();
      if(!text){ toast("–ü—É—Å—Ç–æ"); return; }
      const ok = await copyToClipboard(text);
      toast(ok ? "iframe —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω ‚úÖ" : "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
    });
  }
}


  // ===== download standalone game (HTML with embedded config + media) =====
  if ($("btnDownloadGame")) {
    $("btnDownloadGame").addEventListener("click", ()=>{
      try{
        const payload = buildPayload(true); // include draft so user gets what sees
        const safeJson = JSON.stringify(payload).replace(/</g, "\\u003c");
        const embed = `<script>window.__EMBEDDED_CFG__=${safeJson};<\/script>\n`;

        // Embed before the main script IIFE (first <script>)
        const full = "<!doctype html>\n" + document.documentElement.outerHTML;
        const out = full.replace("<script>\n(() => {", embed + "<script>\n(() => {");

        const blob = new Blob([out], {type:"text/html;charset=utf-8"});
        const a = document.createElement("a");
        const ts = new Date();
        const pad = (n)=> String(n).padStart(2,"0");
        const name = `tower_game_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}.html`;
        a.href = URL.createObjectURL(blob);
        a.download = name;
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
        toast("–ò–≥—Ä–∞ —Å–∫–∞—á–∞–Ω–∞ ‚úÖ");
      }catch(e){
        showErr(e?.stack || e?.message || String(e));
        toast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å üòï");
      }
    });
  }

// ===== game-only mode =====
  function bootGameOnly(cfg){
    document.body.setAttribute("data-mode","game");
    document.body.classList.add("gameOnly");
    $("editorRoot").style.display = "none";
    $("modalBackdrop").style.display = "none";
    if($("codeBackdrop")) $("codeBackdrop").style.display = "none";
    $("gameRoot").style.display = "block";
    injectCanvasGame(cfg);
  }

  // init (decide mode by hash)
  const qp = parseQueryParams();
  const hp = parseHashParams();
  const gameParam = qp.game || hp.game;
  const cfgKeyParam = qp.cfgkey || hp.cfgkey;

  // 0) embedded export (standalone HTML)
  if (window.__EMBEDDED_CFG__) {
    try{
      bootGameOnly(normalizeCfg(window.__EMBEDDED_CFG__));
    }catch(e){
      const host = $("gameHost");
      $("editorRoot").style.display = "none";
      $("gameRoot").style.display = "block";
      host.innerHTML = `<div style="padding:16px;color:#ffd6d6;font-weight:900">–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ üòï</div>`;
    }
    return;
  }

  // 1) legacy URL param: ?game=... or #game=...
  if(gameParam){
    try{
      const raw = JSON.parse(b64urlDecode(gameParam));
      bootGameOnly(normalizeCfg(raw));
    }catch(e){
      const host = $("gameHost");
      $("editorRoot").style.display = "none";
      $("gameRoot").style.display = "block";
      host.innerHTML = `<div style="padding:16px;color:#ffd6d6;font-weight:900">–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ –∏–∑ iframe üòï</div>`;
    }
    return;
  }

  // 2) preview/local mode: ?cfgkey=... or #cfgkey=...
  if(cfgKeyParam){
    try{
      const rawStr = localStorage.getItem(cfgKeyParam) || sessionStorage.getItem(cfgKeyParam);
      if(!rawStr) throw new Error("cfgkey not found in storage");
      const raw = JSON.parse(rawStr);
      bootGameOnly(normalizeCfg(raw));
    }catch(e){
      const host = $("gameHost");
      $("editorRoot").style.display = "none";
      $("gameRoot").style.display = "block";
      host.innerHTML = `<div style="padding:16px;color:#ffd6d6;font-weight:900">–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ (cfgkey) üòï</div>`;
    }
    return;
  }

  // editor init
  Editor.title = $("inpTitle").value || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π";
  Editor.timer.enabled = $("chkTimer").checked;
  Editor.timer.seconds = Number($("inpSeconds").value || 30);
  Editor.useImages = true; if($("chkUseImages")) $("chkUseImages").checked = true;
  Editor.useRepoBg = true;

  renderList();
  updatePreview(false);

  // Hide export section (we copy iframe from top button; no need to show this block)
  try{
    const titles = Array.from(document.querySelectorAll(".section .title"));
    const t = titles.find(x=>x.textContent.trim()==="–≠–∫—Å–ø–æ—Ä—Ç –≤ Genially");
    if(t){
      const sec = t.closest(".section");
      if(sec) sec.style.display="none";
    }
  }catch(e){}

})();
</script>

  <div class="version-badge">V18</div>
</body>
</html>
