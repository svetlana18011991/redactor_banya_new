<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–†–µ–¥–∞–∫—Ç–æ—Ä ‚Üí –≠–∫—Å–ø–æ—Ä—Ç self-contained –∏–≥—Ä—ã (Genially iframe)</title>
  <style>
    :root{--bg:#0b1220;--card:#111a2d;--card2:#0f172a;--text:#e9eefc;--muted:#aab4d6;--line:rgba(255,255,255,.12);--accent:#f2d37a;--accent2:#d6b14a;--bad:#ff5c5c;--ok:#2dd27d}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    body{margin:0;background:radial-gradient(900px 620px at 12% 20%, rgba(35,82,200,.20), transparent 60%),
                      radial-gradient(900px 620px at 88% 15%, rgba(20,160,255,.14), transparent 60%),
                      radial-gradient(900px 620px at 55% 112%, rgba(214,177,74,.14), transparent 60%),
                      linear-gradient(180deg,#0a1024,#070b16);
         color:var(--text);min-height:100vh}
    .wrap{max-width:1200px;margin:0 auto;padding:14px;display:grid;grid-template-columns:420px 1fr;gap:14px}
    @media(max-width:980px){.wrap{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
          border:1px solid var(--line);border-radius:18px;box-shadow:0 12px 34px rgba(0,0,0,.35);overflow:hidden}
    .head{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .head b{font-weight:900}
    .body{padding:14px}
    label{display:block;font-size:12.5px;color:rgba(255,255,255,.86);margin:10px 0 6px}
    input[type="text"], textarea{width:100%;padding:10px 11px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.22);color:var(--text);outline:none}
    textarea{min-height:84px;resize:vertical}
    input[type="file"]{width:100%;padding:10px 11px;border-radius:14px;border:1px dashed rgba(255,255,255,.22);background:rgba(0,0,0,.16);color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1;min-width:170px}
    .btn{cursor:pointer;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--text);
         padding:11px 12px;font-weight:900;display:inline-flex;align-items:center;gap:8px;justify-content:center;user-select:none}
    .btn:hover{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.24)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(90deg, rgba(214,177,74,.35), rgba(242,211,122,.20));border-color:rgba(214,177,74,.45)}
    .btn.danger{border-color:rgba(255,92,92,.38);background:rgba(255,92,92,.10)}
    .btn.small{padding:8px 10px;border-radius:12px;font-size:12.5px}
    .muted{color:var(--muted);font-size:12.5px;line-height:1.35}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .item{display:flex;align-items:center;justify-content:space-between;gap:10px;
          padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04)}
    .item .meta{min-width:0}
    .item .meta .t{font-weight:900;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item .meta .s{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .previewBox{border:1px solid rgba(255,255,255,.12);border-radius:16px;background:rgba(0,0,0,.18);padding:12px}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);font-size:12px;color:var(--muted)}
    img{max-width:100%;border-radius:14px;border:1px solid rgba(255,255,255,.10)}
    audio{width:100%}
    .game{min-height:520px;display:flex;flex-direction:column;gap:12px}
    .qTitle{font-weight:950;font-size:18px;line-height:1.2}
    .qText{color:rgba(255,255,255,.86);line-height:1.45}
    .bar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .score{font-weight:900}
    .toast{padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.24);color:var(--muted);display:none}
    .toast.show{display:block}
    .corner-version{
      position:fixed; right:10px; bottom:10px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.28);
      color:rgba(233,238,252,.85);
      font-size:12px; font-weight:800;
      z-index:9999;
      user-select:none;
      backdrop-filter: blur(6px);
    }
  </style>
</head>

<body>
  <div class="corner-version">–≤–µ—Ä—Å–∏—è 1</div>

  <div class="wrap">
    <!-- LEFT: EDITOR -->
    <section class="card">
      <div class="head">
        <b>–†–µ–¥–∞–∫—Ç–æ—Ä</b>
        <span class="pill">–≠–∫—Å–ø–æ—Ä—Ç ‚Üí game.html –¥–ª—è Genially iframe</span>
      </div>
      <div class="body">
        <div class="row">
          <button class="btn primary" id="btnNew">+ –ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å</button>
          <button class="btn" id="btnExport">‚¨á –≠–∫—Å–ø–æ—Ä—Ç –∏–≥—Ä—ã (HTML)</button>
          <button class="btn" id="btnCopyIframe">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe</button>
        </div>

        <div class="muted" style="margin-top:10px">
          URL –¥–ª—è iframe (Genially):
          <input id="gameUrl" type="text" readonly
                 style="margin-top:6px;width:100%;padding:10px 11px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.22);color:#e9eefc;outline:none">
          <div style="margin-top:8px">
            ‚ö†Ô∏è –í–∞–∂–Ω–æ: —Å–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ ¬´–≠–∫—Å–ø–æ—Ä—Ç –∏–≥—Ä—ã¬ª, –ø–æ–ª—É—á–∏ <b>game.html</b> –∏ –∑–∞–∫–æ–º–º–∏—Ç—å –µ–≥–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π GitHub Pages.
            –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ iframe –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —É–∂–µ <b>—Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—É—é –∏–≥—Ä—É</b> (—Å –≤—à–∏—Ç—ã–º –º–µ–¥–∏–∞) –Ω–∞ –ª—é–±–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ.
          </div>
          <div style="margin-top:6px">–ö–∞—Ä—Ç–∏–Ω–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∂–∏–º–∞—é—Ç—Å—è –≤ WebP (–º–∞–∫—Å. 1280px), —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–¥—É–≤–∞—Ç—å –∏–≥—Ä—É.</div>
        </div>

        <div class="hr"></div>

        <div id="editBox" class="previewBox" style="display:none">
          <div class="bar">
            <b id="editTitle">–í–æ–ø—Ä–æ—Å</b>
            <div class="row" style="flex-wrap:nowrap;gap:8px">
              <button class="btn small" id="btnSave">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button class="btn small danger" id="btnCancel">‚úï</button>
            </div>
          </div>

          <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</label>
          <textarea id="inpQ" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ß—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ?"></textarea>

          <div class="row">
            <div>
              <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ (jpg/png) ‚Äî –±—É–¥–µ—Ç —Å–∂–∞—Ç–∞ –≤ WebP</label>
              <input type="file" id="inpImg" accept="image/*">
            </div>
            <div>
              <label>–ó–≤—É–∫ (mp3/ogg/wav) ‚Äî –≤—à–∏–≤–∞–µ—Ç—Å—è base64 (—Å–ª–µ–¥–∏ –∑–∞ —Ä–∞–∑–º–µ—Ä–æ–º)</label>
              <input type="file" id="inpAud" accept="audio/*">
            </div>
          </div>

          <div class="row">
            <div>
              <label>–û—Ç–≤–µ—Ç (–ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç)</label>
              <input type="text" id="inpA" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–∞–Ω—è">
            </div>
          </div>

          <div class="hr"></div>
          <div class="muted">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ</div>
          <div id="mediaPrev" style="margin-top:8px"></div>
        </div>

        <div class="hr"></div>
        <b>–°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤</b>
        <div id="qList" class="list"></div>

        <div class="toast" id="toast"></div>
      </div>
    </section>

    <!-- RIGHT: PREVIEW GAME -->
    <section class="card">
      <div class="head">
        <b>–ü—Ä–µ–≤—å—é –∏–≥—Ä—ã</b>
        <div class="row" style="flex-wrap:nowrap;gap:8px">
          <button class="btn small" id="btnRestart">‚Üª –° –Ω–∞—á–∞–ª–∞</button>
        </div>
      </div>
      <div class="body">
        <div id="game" class="game"></div>
      </div>
    </section>
  </div>

<script>
/** =========================
 *  UTIL
 *  ========================= */
const $ = (sel) => document.querySelector(sel);
const el = (tag, attrs = {}, children = []) => {
  const node = document.createElement(tag);
  for (const [k, v] of Object.entries(attrs)) {
    if (k === "class") node.className = v;
    else if (k === "html") node.innerHTML = v;
    else if (k.startsWith("on") && typeof v === "function") node.addEventListener(k.slice(2), v);
    else node.setAttribute(k, v);
  }
  children.forEach(c => node.appendChild(c));
  return node;
};

function toast(msg, ok=true){
  const t = $("#toast");
  t.textContent = msg;
  t.style.borderColor = ok ? "rgba(45,210,125,.35)" : "rgba(255,92,92,.35)";
  t.style.color = ok ? "rgba(233,238,252,.92)" : "rgba(255,190,190,.92)";
  t.classList.add("show");
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>t.classList.remove("show"), 2600);
}

function uuid(){
  return (crypto?.randomUUID?.() || ("id-"+Math.random().toString(16).slice(2)+"-"+Date.now()));
}

function readAsDataURL(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(String(r.result || ""));
    r.onerror = ()=>reject(new Error("FileReader error"));
    r.readAsDataURL(file);
  });
}

/** –°–∂–∞—Ç–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ ‚Üí WebP, max side 1280 */
async function compressImageToWebP(file, maxSide=1280, quality=0.82){
  const dataUrl = await readAsDataURL(file);
  const img = new Image();
  img.src = dataUrl;
  await new Promise((res, rej)=>{
    img.onload = res; img.onerror = ()=>rej(new Error("Image load error"));
  });
  let w = img.naturalWidth, h = img.naturalHeight;
  const scale = Math.min(1, maxSide / Math.max(w, h));
  w = Math.round(w * scale);
  h = Math.round(h * scale);

  const canvas = document.createElement("canvas");
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0, w, h);

  return canvas.toDataURL("image/webp", quality);
}

/** Clipboard */
async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch(_){
    // fallback
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    const ok = document.execCommand("copy");
    ta.remove();
    return ok;
  }
}

function getGameUrl(){
  // game.html –¥–æ–ª–∂–µ–Ω –ª–µ–∂–∞—Ç—å —Ä—è–¥–æ–º —Å index.html –≤ GitHub Pages
  const base = location.origin + location.pathname.replace(/\/[^\/]*$/, "/");
  return base + "game.html";
}

function getIframeCode(url){
  // –ú–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å height –ø–æ–¥ Genially
  return `<iframe src="${url}" width="100%" height="600" frameborder="0" allowfullscreen></iframe>`;
}

/** =========================
 *  DATA MODEL
 *  - questions hold only keys (imgKey/audioKey)
 *  - embeddedMedia holds base64 data URLs
 *  ========================= */
const state = {
  questions: [],
  embeddedMedia: {}, // { "img:<uuid>": "data:image/webp;base64,...", "aud:<uuid>": "data:audio/..;base64,..." }
  editId: null,
  previewIndex: 0,
  score: 0
};

function newQuestionDraft(){
  return { id: uuid(), q: "", a: "", imgKey: "", audKey: "" };
}

/** =========================
 *  EDITOR UI
 *  ========================= */
const ui = {
  btnNew: $("#btnNew"),
  btnExport: $("#btnExport"),
  btnCopyIframe: $("#btnCopyIframe"),
  gameUrl: $("#gameUrl"),

  btnSave: $("#btnSave"),
  btnCancel: $("#btnCancel"),
  inpQ: $("#inpQ"),
  inpA: $("#inpA"),
  inpImg: $("#inpImg"),
  inpAud: $("#inpAud"),
  qList: $("#qList"),
  editBox: $("#editBox"),
  editTitle: $("#editTitle"),
  mediaPrev: $("#mediaPrev"),
  game: $("#game"),
  btnRestart: $("#btnRestart")
};

let draft = null;

function openEditor(q){
  draft = JSON.parse(JSON.stringify(q));
  state.editId = q.id;
  ui.editBox.style.display = "block";
  ui.editTitle.textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ";
  ui.inpQ.value = draft.q || "";
  ui.inpA.value = draft.a || "";
  ui.inpImg.value = "";
  ui.inpAud.value = "";
  renderDraftPreview();
}

function closeEditor(){
  draft = null;
  state.editId = null;
  ui.editBox.style.display = "none";
}

function renderDraftPreview(){
  ui.mediaPrev.innerHTML = "";
  if (!draft) return;

  const parts = [];
  if (draft.imgKey && state.embeddedMedia[draft.imgKey]) {
    parts.push(el("img", { src: state.embeddedMedia[draft.imgKey] }));
  }
  if (draft.audKey && state.embeddedMedia[draft.audKey]) {
    parts.push(el("audio", { controls: "controls", src: state.embeddedMedia[draft.audKey] }));
  }
  if (!parts.length) {
    parts.push(el("div", { class: "muted", html: "–ú–µ–¥–∏–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ." }));
  }
  parts.forEach(p => ui.mediaPrev.appendChild(p));
}

function renderList(){
  ui.qList.innerHTML = "";
  if (!state.questions.length){
    ui.qList.appendChild(el("div", { class:"muted", html:"–ü–æ–∫–∞ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤. –ù–∞–∂–º–∏ ¬´–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å¬ª." }));
    return;
  }

  state.questions.forEach((q, idx) => {
    const hasImg = !!(q.imgKey && state.embeddedMedia[q.imgKey]);
    const hasAud = !!(q.audKey && state.embeddedMedia[q.audKey]);

    const left = el("div", { class:"meta" }, [
      el("div", { class:"t", html: `#${idx+1} ${escapeHtml(q.q || "(–±–µ–∑ —Ç–µ–∫—Å—Ç–∞)")}` }),
      el("div", { class:"s", html: `${escapeHtml(q.a || "(–±–µ–∑ –æ—Ç–≤–µ—Ç–∞)")} ¬∑ ${hasImg ? "üñº" : ""}${hasAud ? " üîä" : ""}` })
    ]);

    const right = el("div", { class:"row", style:"flex-wrap:nowrap;gap:8px" }, [
      el("button", { class:"btn small", onclick:()=>openEditor(q) }, [document.createTextNode("‚úé")]),
      el("button", { class:"btn small danger", onclick:()=>removeQuestion(q.id) }, [document.createTextNode("üóë")])
    ]);

    ui.qList.appendChild(el("div", { class:"item" }, [left, right]));
  });
}

function removeQuestion(id){
  const i = state.questions.findIndex(x=>x.id===id);
  if (i<0) return;
  const q = state.questions[i];
  if (q.imgKey) delete state.embeddedMedia[q.imgKey];
  if (q.audKey) delete state.embeddedMedia[q.audKey];
  state.questions.splice(i,1);
  toast("–£–¥–∞–ª–µ–Ω–æ", true);
  renderList();
  restartPreview();
}

/** =========================
 *  EVENTS
 *  ========================= */
ui.btnNew.addEventListener("click", ()=>{
  const q = newQuestionDraft();
  // –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É –≤ –º–∞—Å—Å–∏–≤, —á—Ç–æ–±—ã –º–µ–¥–∏–∞ –Ω–µ –º–æ–≥–ª–æ "—É–µ—Ö–∞—Ç—å –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π" –∏–∑-–∑–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏
  state.questions.push(q);
  openEditor(q);
  renderList();
  restartPreview();
});

ui.btnCancel.addEventListener("click", ()=>{
  // –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª –Ω–æ–≤—ã–π –ø—É—Å—Ç–æ–π ‚Äî –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å
  if (draft && (draft.q.trim()==="" && draft.a.trim()==="" && !draft.imgKey && !draft.audKey)){
    const i = state.questions.findIndex(x=>x.id===draft.id);
    if (i>=0) state.questions.splice(i,1);
    renderList();
    restartPreview();
  }
  closeEditor();
});

ui.btnSave.addEventListener("click", ()=>{
  if (!draft) return;
  draft.q = ui.inpQ.value.trim();
  draft.a = ui.inpA.value.trim();

  const i = state.questions.findIndex(x=>x.id===draft.id);
  if (i>=0) state.questions[i] = draft;

  toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ", true);
  closeEditor();
  renderList();
  restartPreview();
});

ui.inpImg.addEventListener("change", async (e)=>{
  if (!draft) { toast("–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π –≤–æ–ø—Ä–æ—Å", false); return; }
  const f = e.target.files && e.target.files[0];
  if (!f) return;
  try{
    const imgKey = "img:" + uuid();
    const webp = await compressImageToWebP(f, 1280, 0.82);
    state.embeddedMedia[imgKey] = webp;
    draft.imgKey = imgKey;
    renderDraftPreview();
    toast("–ö–∞—Ä—Ç–∏–Ω–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ (WebP)", true);
  }catch(err){
    console.error(err);
    toast("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É", false);
  }finally{
    ui.inpImg.value = "";
  }
});

ui.inpAud.addEventListener("change", async (e)=>{
  if (!draft) { toast("–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π –≤–æ–ø—Ä–æ—Å", false); return; }
  const f = e.target.files && e.target.files[0];
  if (!f) return;
  try{
    const audKey = "aud:" + uuid();
    const dataUrl = await readAsDataURL(f);
    state.embeddedMedia[audKey] = dataUrl;
    draft.audKey = audKey;
    renderDraftPreview();
    toast("–ó–≤—É–∫ –¥–æ–±–∞–≤–ª–µ–Ω", true);
  }catch(err){
    console.error(err);
    toast("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∑–≤—É–∫", false);
  }finally{
    ui.inpAud.value = "";
  }
});

ui.btnExport.addEventListener("click", ()=>{
  if (!state.questions.length){
    toast("–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞", false);
    return;
  }
  const payload = {
    version: 1,
    createdAt: new Date().toISOString(),
    questions: state.questions,
    embeddedMedia: state.embeddedMedia
  };

  const html = buildExportHTML(payload);
  downloadText("game.html", html);
  toast("–°–∫–∞—á–∞–Ω game.html ‚Äî –∑–∞–∫–æ–º–º–∏—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ –≤—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –≤ iframe Genially", true);
});

ui.btnCopyIframe.addEventListener("click", async ()=>{
  const url = ui.gameUrl.value || getGameUrl();
  const code = getIframeCode(url);
  const ok = await copyToClipboard(code);
  toast(ok ? "iframe-–∫–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω" : "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å (—Å–∫–æ–ø–∏—Ä—É–π –≤—Ä—É—á–Ω—É—é)", ok);
});

ui.btnRestart.addEventListener("click", restartPreview);

/** =========================
 *  PREVIEW GAME (–≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ)
 *  ========================= */
function restartPreview(){
  state.previewIndex = 0;
  state.score = 0;
  renderGameFrom(state.questions, state.embeddedMedia, ui.game);
}

function renderGameFrom(questions, embeddedMedia, mount){
  mount.innerHTML = "";
  if (!questions.length){
    mount.appendChild(el("div", { class:"muted", html:"–î–æ–±–∞–≤—å –≤–æ–ø—Ä–æ—Å—ã ‚Äî –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–µ–≤—å—é –∏–≥—Ä—ã." }));
    return;
  }

  const q = questions[state.previewIndex];

  const top = el("div", { class:"bar" }, [
    el("div", { class:"pill", html: `–í–æ–ø—Ä–æ—Å ${state.previewIndex+1} / ${questions.length}` }),
    el("div", { class:"score", html: `–û—á–∫–∏: ${state.score}` })
  ]);

  const title = el("div", { class:"qTitle", html: "–í–æ–ø—Ä–æ—Å" });
  const text = el("div", { class:"qText", html: escapeHtml(q.q || "") || "<span class='muted'>(–±–µ–∑ —Ç–µ–∫—Å—Ç–∞)</span>" });

  const media = el("div", {});
  if (q.imgKey && embeddedMedia[q.imgKey]) media.appendChild(el("img", { src: embeddedMedia[q.imgKey] }));
  if (q.audKey && embeddedMedia[q.audKey]) media.appendChild(el("audio", { controls: "controls", src: embeddedMedia[q.audKey] }));

  const inp = el("input", { type:"text", placeholder:"–¢–≤–æ–π –æ—Ç–≤–µ—Ç...", style:"width:100%;padding:10px 11px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.22);color:var(--text);outline:none" });
  const msg = el("div", { class:"muted" });

  const btnCheck = el("button", { class:"btn primary", onclick:()=>check() }, [document.createTextNode("–ü—Ä–æ–≤–µ—Ä–∏—Ç—å")]);
  const btnNext  = el("button", { class:"btn", onclick:()=>next() }, [document.createTextNode("–î–∞–ª—å—à–µ ‚Üí")]);
  const actions = el("div", { class:"row" }, [btnCheck, btnNext]);

  mount.appendChild(top);
  mount.appendChild(title);
  mount.appendChild(text);
  mount.appendChild(media);
  mount.appendChild(el("div", { class:"hr" }));
  mount.appendChild(inp);
  mount.appendChild(msg);
  mount.appendChild(actions);

  function norm(s){return String(s||"").trim().toLowerCase();}
  function check(){
    const ok = norm(inp.value) === norm(q.a);
    if (ok) { state.score += 1; msg.style.color="rgba(45,210,125,.95)"; msg.textContent="–í–µ—Ä–Ω–æ! +1"; }
    else { msg.style.color="rgba(255,190,190,.95)"; msg.textContent=`–ù–µ–≤–µ—Ä–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${q.a || "(–ø—É—Å—Ç–æ)"}`; }
    btnCheck.disabled = true;
  }
  function next(){
    state.previewIndex++;
    if (state.previewIndex >= questions.length){
      mount.innerHTML = "";
      mount.appendChild(el("div", { class:"qTitle", html:"–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ üéâ" }));
      mount.appendChild(el("div", { class:"qText", html:`–†–µ–∑—É–ª—å—Ç–∞—Ç: <b>${state.score}</b> / ${questions.length}` }));
      mount.appendChild(el("div", { class:"hr" }));
      mount.appendChild(el("button", { class:"btn primary", onclick:restartPreview }, [document.createTextNode("–°—ã–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑")]));
      return;
    }
    renderGameFrom(questions, embeddedMedia, mount);
  }
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[ch]));
}

/** =========================
 *  EXPORT: self-contained HTML (–¥–ª—è Genially iframe)
 *  ========================= */
function downloadText(filename, text){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([text], {type:"text/html;charset=utf-8"}));
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

function buildExportHTML(payload){
  const json = JSON.stringify(payload);

  return `<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ò–≥—Ä–∞ (self-contained)</title>
<style>
  :root{--text:#e9eefc;--muted:#aab4d6;--line:rgba(255,255,255,.12);--accent:#f2d37a;--accent2:#d6b14a}
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  body{margin:0;color:var(--text);background:transparent}
  .wrap{max-width:920px;margin:0 auto;padding:14px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
        border:1px solid var(--line);border-radius:18px;box-shadow:0 12px 34px rgba(0,0,0,.35);overflow:hidden}
  .head{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;align-items:center;justify-content:space-between;gap:10px}
  .body{padding:14px}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);font-size:12px;color:var(--muted)}
  .qTitle{font-weight:950;font-size:18px;line-height:1.2}
  .qText{color:rgba(255,255,255,.88);line-height:1.45;margin-top:6px}
  img{max-width:100%;border-radius:14px;border:1px solid rgba(255,255,255,.10);margin-top:10px}
  audio{width:100%;margin-top:10px}
  input{width:100%;padding:10px 11px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.22);color:var(--text);outline:none;margin-top:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .btn{cursor:pointer;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--text);
       padding:11px 12px;font-weight:900;display:inline-flex;align-items:center;gap:8px;justify-content:center;user-select:none}
  .btn.primary{background:linear-gradient(90deg, rgba(214,177,74,.35), rgba(242,211,122,.20));border-color:rgba(214,177,74,.45)}
  .muted{color:var(--muted);font-size:12.5px;line-height:1.35;margin-top:8px}
  .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
  .corner-version{
      position:fixed; right:10px; bottom:10px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.28);
      color:rgba(233,238,252,.85);
      font-size:12px; font-weight:800;
      z-index:9999;
      user-select:none;
      backdrop-filter: blur(6px);
  }
</style>
</head>
<body>
<div class="corner-version">–≤–µ—Ä—Å–∏—è 1</div>
<div class="wrap">
  <section class="card">
    <div class="head">
      <b>–ò–≥—Ä–∞</b>
      <span class="pill" id="pInfo">‚Ä¶</span>
    </div>
    <div class="body" id="app"></div>
  </section>
</div>

<script type="application/json" id="cfg">${json.replaceAll("<","\\u003c")}</script>
<script>
  const cfg = JSON.parse(document.getElementById("cfg").textContent);
  const questions = cfg.questions || [];
  const media = cfg.embeddedMedia || {};
  const app = document.getElementById("app");
  let i = 0, score = 0;

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[ch]));
  }
  function norm(s){return String(s||"").trim().toLowerCase();}

  function render(){
    if (!questions.length){
      app.innerHTML = "<div class='muted'>–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤.</div>";
      return;
    }
    if (i >= questions.length){
      app.innerHTML = "<div class='qTitle'>–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ üéâ</div><div class='qText'>–†–µ–∑—É–ª—å—Ç–∞—Ç: <b>"+score+"</b> / "+questions.length+"</div><div class='hr'></div><button class='btn primary' id='r'>–°—ã–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑</button>";
      document.getElementById("r").onclick = ()=>{ i=0; score=0; render(); };
      document.getElementById("pInfo").textContent = "–ì–æ—Ç–æ–≤–æ";
      return;
    }

    const q = questions[i];
    document.getElementById("pInfo").textContent = "–í–æ–ø—Ä–æ—Å " + (i+1) + " / " + questions.length + " ¬∑ –û—á–∫–∏: " + score;

    app.innerHTML = "";
    const t1 = document.createElement("div"); t1.className="qTitle"; t1.textContent="–í–æ–ø—Ä–æ—Å";
    const t2 = document.createElement("div"); t2.className="qText"; t2.innerHTML = escapeHtml(q.q || "") || "<span class='muted'>(–±–µ–∑ —Ç–µ–∫—Å—Ç–∞)</span>";
    app.appendChild(t1); app.appendChild(t2);

    if (q.imgKey && media[q.imgKey]){
      const im = document.createElement("img");
      im.src = media[q.imgKey];
      app.appendChild(im);
    }
    if (q.audKey && media[q.audKey]){
      const au = document.createElement("audio");
      au.controls = true;
      au.src = media[q.audKey];
      app.appendChild(au);
    }

    const inp = document.createElement("input");
    inp.placeholder = "–¢–≤–æ–π –æ—Ç–≤–µ—Ç...";
    app.appendChild(inp);

    const msg = document.createElement("div");
    msg.className="muted";
    app.appendChild(msg);

    const row = document.createElement("div");
    row.className="row";
    const b1 = document.createElement("button"); b1.className="btn primary"; b1.textContent="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å";
    const b2 = document.createElement("button"); b2.className="btn"; b2.textContent="–î–∞–ª—å—à–µ ‚Üí";
    row.appendChild(b1); row.appendChild(b2);
    app.appendChild(row);

    b1.onclick = ()=>{
      const ok = norm(inp.value) === norm(q.a);
      if (ok){ score += 1; msg.style.color="rgba(45,210,125,.95)"; msg.textContent="–í–µ—Ä–Ω–æ! +1"; }
      else { msg.style.color="rgba(255,190,190,.95)"; msg.textContent="–ù–µ–≤–µ—Ä–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω–æ: " + (q.a || "(–ø—É—Å—Ç–æ)"); }
      b1.disabled = true;
    };
    b2.onclick = ()=>{ i += 1; render(); };
  }
  render();
</script>
</body>
</html>`;
}

/** =========================
 *  INIT
 *  ========================= */
ui.gameUrl.value = getGameUrl();
renderList();
restartPreview();
</script>
</body>
</html>
