<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tower Editor (Hybrid)</title>
<style>
  :root { --bg: #0f172a; --panel: #1e293b; --accent: #38bdf8; --text: #f8fafc; --border: #334155; }
  body { margin:0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

  /* --- EDITOR SIDE --- */
  .editor { width: 450px; background: #111827; border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; box-shadow: 5px 0 20px rgba(0,0,0,0.5); }
  .header { padding: 20px; background: #1f2937; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .h-title { font-weight: 800; color: var(--accent); letter-spacing: 1px; font-size: 18px; }
  
  .scroll-wrap { flex: 1; overflow-y: auto; padding: 20px; }
  
  .section { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 20px; }
  .label { font-size: 11px; text-transform: uppercase; color: #94a3b8; font-weight: bold; margin-bottom: 8px; display: block; letter-spacing: 0.5px; }

  input[type="text"], textarea, select { 
    width: 100%; background: #020617; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; box-sizing: border-box; font-size: 14px; margin-bottom:10px; transition: 0.2s;
  }
  input:focus, textarea:focus { border-color: var(--accent); outline: none; }

  /* Custom File Upload */
  .file-row { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; border: 1px dashed #475569; }
  .file-btn { position: relative; overflow: hidden; background: #334155; color: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: bold; }
  .file-btn:hover { background: #475569; }
  .file-btn input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .file-status { font-size: 12px; color: #94a3b8; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* Question List */
  .q-item { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid transparent; transition: 0.2s; }
  .q-item:hover { background: rgba(255,255,255,0.08); border-left-color: var(--accent); }
  .q-text { font-size: 13px; font-weight: 500; }
  
  button { cursor: pointer; border: none; font-weight: bold; border-radius: 6px; transition: 0.2s; }
  .btn-gen { background: linear-gradient(90deg, #38bdf8, #818cf8); color: #000; padding: 8px 16px; font-size: 13px; text-transform: uppercase; }
  .btn-gen:hover { filter: brightness(1.1); box-shadow: 0 0 15px rgba(56, 189, 248, 0.3); }
  .btn-add { background: #22c55e; color: #000; width: 100%; padding: 10px; margin-top: 10px; }
  .btn-icon { background: transparent; color: #64748b; font-size: 16px; padding: 5px; }
  .btn-icon:hover { color: #fff; }

  /* --- PREVIEW SIDE --- */
  .preview { flex: 1; background: #000; display: flex; align-items: center; justify-content: center; position: relative; 
    background-image: radial-gradient(#1e293b 1px, transparent 1px); background-size: 30px 30px; }
  
  .device-mockup {
    width: 375px; height: 667px; background: #000; border: 12px solid #1f2937; border-radius: 40px; 
    box-shadow: 0 0 0 2px #334155, 0 30px 80px rgba(0,0,0,0.8); overflow: hidden; position: relative;
  }
  iframe { width: 100%; height: 100%; border: none; }
  .preview-label { position: absolute; top: 20px; left: 20px; color: #64748b; font-size: 12px; letter-spacing: 2px; text-transform: uppercase; font-weight: bold; pointer-events: none;}

  /* --- MODAL --- */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .modal { background: var(--panel); width: 500px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 25px 50px #000; padding: 25px; }
  .opt-row { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
  .check { width: 20px; height: 20px; accent-color: var(--accent); cursor: pointer; }

  .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #22c55e; color: #000; padding: 12px 30px; border-radius: 30px; font-weight: bold; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
  .toast.show { opacity: 1; bottom: 50px; }
</style>
</head>
<body>

<div class="editor">
  <div class="header">
    <span class="h-title">üèóÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä –ë–∞—à–Ω–∏</span>
    <button class="btn-gen" onclick="generateCode()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
  </div>
  
  <div class="scroll-wrap">
    
    <div class="section">
      <div class="label">1. –ò—Å—Ç–æ—á–Ω–∏–∫ –∫–∞—Ä—Ç–∏–Ω–æ–∫</div>
      <label style="font-size:12px; color:#cbd5e1; display:block; margin-bottom:5px">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (GitHub Pages)</label>
      <input type="text" id="repoUrl" placeholder="https://–≤–∞—à-–Ω–∏–∫.github.io/–Ω–∞–∑–≤–∞–Ω–∏–µ_–ø–∞–ø–∫–∏/" onchange="updatePreview()">
      <div style="font-size:11px; color:#64748b; line-height:1.3; margin-bottom:15px">
        –ò–≥—Ä–∞ –±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å —Ñ–∞–π–ª—ã <b>3.png ... 11.png</b> –ø–æ —ç—Ç–æ–π —Å—Å—ã–ª–∫–µ. –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç, –±–ª–æ–∫–∏ –±—É–¥—É—Ç –ø—Ä–æ—Å—Ç–æ —Ü–≤–µ—Ç–Ω—ã–º–∏ (–∑–∞–≥–ª—É—à–∫–∞–º–∏).
      </div>

      <div class="label">2. –§–æ–Ω –∏–≥—Ä—ã</div>
      <div class="file-row">
        <label class="file-btn">
          –û–±–∑–æ—Ä...
          <input type="file" accept="image/*" onchange="handleBg(this)">
        </label>
        <div class="file-status" id="bgStatus">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é (1.png —Å GitHub)</div>
        <button class="btn-icon" onclick="clearBg()" title="–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π">‚úï</button>
      </div>
      <div style="font-size:11px; color:#64748b; margin-top:5px">
        –ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–π —Ñ–∞–π–ª —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞, –∏ –æ–Ω –∑–∞–º–µ–Ω–∏—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π.
      </div>
    </div>

    <div class="section">
      <div class="label">3. –í–æ–ø—Ä–æ—Å—ã (<span id="qCount">0</span>)</div>
      <div id="qList" class="q-list"></div>
      
      <button class="btn-add" onclick="openModal()">+ –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
      <button style="width:100%; background:transparent; color:#ef4444; margin-top:5px; font-size:11px" onclick="if(confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ?')) {config.qs=[]; renderList(); updatePreview();}">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
    </div>

  </div>
</div>

<div class="preview">
  <div class="preview-label">Live Preview</div>
  <div class="device-mockup">
    <iframe id="previewFrame"></iframe>
  </div>
</div>

<div class="modal-overlay" id="modal">
  <div class="modal">
    <h3 style="margin-top:0; color:var(--accent)">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
    
    <label class="label">–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞</label>
    <select id="mType" onchange="renderOpts()">
      <option value="choice">–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞</option>
      <option value="input">–í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞</option>
    </select>

    <label class="label">–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</label>
    <textarea id="mText" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å..."></textarea>

    <div id="mOptsArea" style="margin-top:15px; padding-top:10px; border-top:1px solid #334155"></div>

    <div style="text-align:right; margin-top:20px">
      <button class="btn-gen" onclick="saveQ()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button style="background:transparent; color:#fff; margin-left:10px" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –í—Å—Ç–∞–≤–ª—è–π—Ç–µ –≤ Genially.</div>

<script id="gameTemplate" type="text/plain">
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<style>
  body{margin:0;overflow:hidden;background:#000;font-family:'Segoe UI',sans-serif;color:#fff;user-select:none;}
  canvas{display:block;width:100%;height:100%;}
  
  #hud{position:absolute;top:10px;left:10px;right:10px;display:flex;justify-content:space-between;pointer-events:none;z-index:10;}
  .pill{background:rgba(0,0,0,0.65);border:1px solid rgba(255,255,255,0.2);padding:8px 14px;border-radius:20px;font-weight:bold;backdrop-filter:blur(4px);font-size:14px;box-shadow:0 4px 10px rgba(0,0,0,0.3);}
  
  #overlay{position:absolute;inset:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center;z-index:20;pointer-events:auto;}
  #card{width:85%;max-width:380px;background:#1e293b;padding:25px;border-radius:16px;border:1px solid #475569;text-align:center;box-shadow:0 25px 60px #000;transform:scale(0.95);opacity:0;transition:0.3s;}
  #card.show{transform:scale(1);opacity:1;}
  
  #qText{font-size:19px;margin-bottom:20px;line-height:1.4;color:#f1f5f9;}
  
  .btn{display:block;width:100%;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);padding:14px;color:#fff;border-radius:10px;margin-bottom:10px;cursor:pointer;font-size:16px;text-align:left;transition:0.2s;}
  .btn:hover{background:rgba(255,255,255,0.15);border-color:#38bdf8;}
  .btn:active{transform:scale(0.98);}
  
  input.inp{width:100%;padding:14px;background:#0f172a;border:1px solid #475569;color:#fff;border-radius:10px;margin-bottom:12px;box-sizing:border-box;font-size:16px;outline:none;}
  input.inp:focus{border-color:#38bdf8;}
  
  #msg{height:24px;margin-top:10px;font-weight:bold;font-size:18px;}
  
  #startScreen, #endScreen{position:absolute;inset:0;background:rgba(0,0,0,0.92);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:30;pointer-events:auto;}
  h1{margin:0 0 15px;background:linear-gradient(90deg,#38bdf8,#a78bfa);-webkit-background-clip:text;color:transparent;font-size:36px;}
  .playBtn{padding:15px 40px;border-radius:50px;background:#38bdf8;color:#000;border:none;font-weight:900;font-size:20px;cursor:pointer;box-shadow:0 0 30px rgba(56,189,248,0.4);transition:0.2s;}
  .playBtn:hover{transform:scale(1.05);}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="c"></canvas>
  
  <div id="hud">
    <div class="pill">–≠—Ç–∞–∂: <span id="hTxt">0</span></div>
    <div class="pill">–°—á—ë—Ç: <span id="sTxt">0</span></div>
  </div>
  
  <div id="overlay">
    <div id="card">
      <div id="qText"></div>
      <div id="ansArea"></div>
      <div id="msg"></div>
    </div>
  </div>

  <div id="startScreen">
    <h1>–ë–ê–®–ù–Ø</h1>
    <p style="color:#94a3b8;margin-bottom:40px">–û—Ç–≤–µ—á–∞–π –≤–µ—Ä–Ω–æ –∏ —Å—Ç—Ä–æ–π –≤—ã—à–µ!</p>
    <button class="playBtn" onclick="startGame()">–ò–ì–†–ê–¢–¨</button>
  </div>

  <div id="endScreen" style="display:none">
    <h1>–§–ò–ù–ê–õ</h1>
    <p style="font-size:24px;margin-bottom:30px">–°—á—ë—Ç: <span id="finalScore">0</span></p>
    <button class="playBtn" onclick="location.reload()">–ó–ê–ù–û–í–û</button>
  </div>
</div>

<script>
// === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–í–°–¢–ê–í–õ–Ø–ï–¢–°–Ø –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò) ===
const CFG = {{CONFIG}};
// ================================================

const cvs = document.getElementById("c");
const ctx = cvs.getContext("2d");
let W, H, DPR;
const IMAGES = {};
const BLOCKS = ["3.png","4.png","5.png","6.png","7.png","8.png","9.png","10.png","11.png"];

let state = { running:false, tower:[], current:null, qIdx:0, score:0, camY:0, phase:'menu' };

// --- –õ–û–ì–ò–ö–ê –†–ï–°–£–†–°–û–í ---
function getUrl(file) {
  // 1. –ï—Å–ª–∏ —ç—Ç–æ —Ñ–æ–Ω –∏ –µ—Å—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π Base64 - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
  if (file === "1.png" && CFG.bgUser) return CFG.bgUser;
  
  // 2. –ò–Ω–∞—á–µ —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ GitHub
  let base = CFG.repo || "";
  if (base && !base.endsWith("/")) base += "/";
  return base + file;
}

function loadImg(src) {
  return new Promise(r => {
    if(!src || src.trim() === "") { r(null); return; }
    const i = new Image();
    i.crossOrigin = "Anonymous"; // –í–∞–∂–Ω–æ –¥–ª—è GitHub Pages
    i.onload = () => r(i);
    i.onerror = () => r(null);
    i.src = src;
  });
}

async function init() {
  resize();
  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ–Ω–∞
  IMAGES.bg = await loadImg(getUrl("1.png"));
  // –ó–∞–≥—Ä—É–∑–∫–∞ –±–ª–æ–∫–æ–≤
  for(let b of BLOCKS) {
    IMAGES[b] = await loadImg(getUrl(b));
  }
}

function resize() {
  DPR = window.devicePixelRatio || 1;
  W = window.innerWidth; H = window.innerHeight;
  cvs.width = W*DPR; cvs.height = H*DPR;
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
window.onresize = resize;

function startGame() {
  document.getElementById("startScreen").style.display="none";
  state = { running:true, tower:[], current:null, qIdx:0, score:0, camY:0, phase:'spawn' };
  spawn();
  loop();
}

function spawn() {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–±–µ–¥—É (9 –±–ª–æ–∫–æ–≤ –∏–ª–∏ –∫–æ–Ω–µ—Ü –≤–æ–ø—Ä–æ—Å–æ–≤)
  if(state.qIdx >= CFG.qs.length || state.tower.length >= 9) { win(); return; }
  
  const w = state.tower.length ? state.tower[state.tower.length-1].w : 300;
  // –ö–∞—Ä—Ç–∏–Ω–∫–∞ –±–µ—Ä–µ—Ç—Å—è –ø–æ –∏–Ω–¥–µ–∫—Å—É –∏–∑ –º–∞—Å—Å–∏–≤–∞ –∏–º–µ–Ω
  const imgKey = BLOCKS[state.qIdx % BLOCKS.length];
  
  state.current = {
    x: -w, 
    y: H - 100 - (state.tower.length*60) + state.camY,
    w: w, h: 60, 
    dir: 1, speed: 5 + (state.qIdx*0.5),
    img: IMAGES[imgKey]
  };
  state.phase = 'drop';
}

function update() {
  if(!state.running) return;
  
  // –î–≤–∏–∂–µ–Ω–∏–µ –±–ª–æ–∫–∞
  if(state.phase === 'drop') {
    const b = state.current;
    b.x += b.speed * b.dir;
    if(b.x + b.w > W && b.dir > 0) b.dir = -1;
    if(b.x < 0 && b.dir < 0) b.dir = 1;
  }
  
  // –ü–ª–∞–≤–Ω–∞—è –∫–∞–º–µ—Ä–∞
  const targetY = Math.max(0, (state.tower.length*60)-(H*0.4));
  state.camY += (targetY - state.camY)*0.1;
}

function draw() {
  // 1. –†–∏—Å—É–µ–º –§–æ–Ω
  if(IMAGES.bg) {
    const s = Math.max(W/IMAGES.bg.width, H/IMAGES.bg.height);
    ctx.drawImage(IMAGES.bg, (W-IMAGES.bg.width*s)/2, (H-IMAGES.bg.height*s)/2, IMAGES.bg.width*s, IMAGES.bg.height*s);
  } else {
    // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–µ—Ç - –∫—Ä–∞—Å–∏–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,"#0f172a"); g.addColorStop(1,"#1e293b");
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
  }

  ctx.save();
  ctx.translate(0, state.camY);
  
  // 2. –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞
  ctx.fillStyle="#64748b"; ctx.fillRect((W-300)/2, H-100, 300, 20);

  // 3. –ë–∞—à–Ω—è
  state.tower.forEach(b => {
    if(b.img) ctx.drawImage(b.img, b.x, b.y, b.w, b.h);
    else { 
      // –ó–∞–≥–ª—É—à–∫–∞ (—Ü–≤–µ—Ç–Ω–æ–π –∫–≤–∞–¥—Ä–∞—Ç) –µ—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å
      ctx.fillStyle="#38bdf8"; ctx.fillRect(b.x,b.y,b.w,b.h);
      ctx.strokeStyle="#fff"; ctx.strokeRect(b.x,b.y,b.w,b.h);
    }
  });

  // 4. –ü–∞–¥–∞—é—â–∏–π –±–ª–æ–∫
  if(state.current && state.phase==='drop') {
    const b = state.current;
    if(b.img) ctx.drawImage(b.img, b.x, b.y, b.w, b.h);
    else { ctx.fillStyle="#fff"; ctx.fillRect(b.x,b.y,b.w,b.h); }
  }
  ctx.restore();
}

function loop() {
  if(state.running) requestAnimationFrame(loop);
  update();
  draw();
}

// –ö–ª–∏–∫ / –¢–∞—á
document.addEventListener("pointerdown", (e) => {
  if(e.target.tagName==="BUTTON" || e.target.tagName==="INPUT") return;
  if(state.phase==='drop') { state.phase='wait'; showQ(); }
});

function showQ() {
  const q = CFG.qs[state.qIdx];
  const overlay = document.getElementById("overlay");
  const area = document.getElementById("ansArea");
  
  document.getElementById("qText").textContent = q.q;
  document.getElementById("msg").innerHTML = "";
  area.innerHTML = "";
  overlay.style.display = "flex";
  setTimeout(()=>document.getElementById("card").classList.add("show"), 10);

  if(q.type==='choice') {
    q.o.forEach(opt => {
      const b = document.createElement("button");
      b.className="btn"; b.textContent=opt;
      b.onclick = ()=>check(opt);
      area.appendChild(b);
    });
  } else {
    const i = document.createElement("input");
    i.className="inp"; i.placeholder="–û—Ç–≤–µ—Ç...";
    const b = document.createElement("button");
    b.className="btn"; b.style.textAlign="center"; b.style.background="#38bdf8"; b.style.color="#000"; b.textContent="OK";
    b.onclick = ()=>check(i.value);
    area.appendChild(i); area.appendChild(b);
  }
}

function check(val) {
  const q = CFG.qs[state.qIdx];
  let ok = false;
  if(Array.isArray(q.a)) ok = q.a.some(x => x.toLowerCase().trim() === String(val).toLowerCase().trim());
  else ok = String(q.a).toLowerCase().trim() === String(val).toLowerCase().trim();

  const msg = document.getElementById("msg");
  if(ok) {
    msg.style.color="#4ade80"; msg.textContent="–í–ï–†–ù–û!";
    setTimeout(()=>{
      document.getElementById("card").classList.remove("show");
      document.getElementById("overlay").style.display="none";
      land();
    }, 1000);
  } else {
    msg.style.color="#f87171"; msg.textContent="–û–®–ò–ë–ö–ê!";
    setTimeout(()=>{ fail(); }, 1200);
  }
}

function land() {
  const b = state.current;
  const prev = state.tower.length ? state.tower[state.tower.length-1] : {x:(W-300)/2, w:300};
  
  // –õ–æ–≥–∏–∫–∞ –æ–±—Ä–µ–∑–∫–∏
  const l = Math.max(b.x, prev.x);
  const r = Math.min(b.x+b.w, prev.x+prev.w);
  const w = r-l;
  
  if(w>0) {
    b.x=l; b.w=w; state.tower.push(b);
    state.score+=100;
    document.getElementById("sTxt").textContent=state.score;
    document.getElementById("hTxt").textContent=state.tower.length;
    state.qIdx++; spawn();
  } else fail();
}

function fail() {
  state.running=false;
  document.getElementById("overlay").style.display="none";
  document.getElementById("finalScore").textContent=state.score;
  document.getElementById("endScreen").style.display="flex";
}
function win() {
  state.running=false;
  document.getElementById("overlay").style.display="none";
  document.getElementById("finalScore").textContent=state.score + " (–ü–û–ë–ï–î–ê!)";
  document.getElementById("endScreen").style.display="flex";
}

init();
</script>
</body>
</html>
</script>

<script>
// ==========================================
// –õ–û–ì–ò–ö–ê –†–ï–î–ê–ö–¢–û–†–ê
// ==========================================
let config = {
  repo: "", // –°—Å—ã–ª–∫–∞ –Ω–∞ GitHub Pages
  bgUser: null, // Base64 –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ñ–æ–Ω–∞
  qs: [
    {type:"choice", q:"–°—Ç–æ–ª–∏—Ü–∞ –§—Ä–∞–Ω—Ü–∏–∏?", o:["–ü–∞—Ä–∏–∂","–†–∏–º","–ë–µ—Ä–ª–∏–Ω"], a:["–ü–∞—Ä–∏–∂"]},
    {type:"input", q:"2 + 2 = ?", a:["4"]}
  ]
};
let editId = null;

function init() { renderList(); updatePreview(); }

// 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –§–æ–Ω–∞
function handleBg(inp) {
  const f = inp.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = e => { 
    config.bgUser = e.target.result; // Base64
    document.getElementById("bgStatus").innerText = "–ó–∞–≥—Ä—É–∂–µ–Ω: " + f.name;
    document.getElementById("bgStatus").style.color = "#4ade80";
    updatePreview(); 
  };
  r.readAsDataURL(f);
}

function clearBg() {
  config.bgUser = null;
  document.getElementById("bgStatus").innerText = "–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é (1.png —Å GitHub)";
  document.getElementById("bgStatus").style.color = "#94a3b8";
  updatePreview();
}

// 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ü—Ä–µ–≤—å—é (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç Blob URL –¥–ª—è –±—ã—Å—Ç—Ä–æ—Ç—ã)
function updatePreview() {
  config.repo = document.getElementById("repoUrl").value;
  const tmpl = document.getElementById("gameTemplate").textContent;
  const html = tmpl.replace("{{CONFIG}}", JSON.stringify(config));
  const blob = new Blob([html], {type: 'text/html'});
  document.getElementById("previewFrame").src = URL.createObjectURL(blob);
}

// 3. –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤
function renderList() {
  const l = document.getElementById("qList"); l.innerHTML = "";
  document.getElementById("qCount").textContent = config.qs.length;
  config.qs.forEach((q, i) => {
    const d = document.createElement("div"); d.className = "q-item";
    d.innerHTML = `
      <span style="font-weight:bold; color:#38bdf8; margin-right:8px">#${i+1}</span>
      <span style="flex:1; overflow:hidden; white-space:nowrap; text-overflow:ellipsis">${q.q}</span>
      <div>
        <button class="btn-icon" onclick="editQ(${i})">‚úèÔ∏è</button>
        <button class="btn-icon" style="color:#ef4444" onclick="delQ(${i})">üóë</button>
      </div>
    `;
    l.appendChild(d);
  });
}

function openModal() { editId=null; document.getElementById("modal").style.display="flex"; document.getElementById("mText").value=""; renderOpts(); }
function closeModal() { document.getElementById("modal").style.display="none"; }

function renderOpts() {
  const t = document.getElementById("mType").value;
  const c = document.getElementById("mOptsArea"); c.innerHTML="";
  if(t==="choice") {
    c.innerHTML = `<div class="label">–í–∞—Ä–∏–∞–Ω—Ç—ã (–æ—Ç–º–µ—Ç—å—Ç–µ –≤–µ—Ä–Ω—ã–π)</div>`;
    for(let i=0;i<4;i++) c.innerHTML+=`<div class="opt-row"><input type="radio" name="ok" class="check"><input type="text" class="inp" style="margin:0" placeholder="–í–∞—Ä–∏–∞–Ω—Ç"></div>`;
  } else c.innerHTML=`<label class="label">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã</label><input type="text" id="mInp" class="inp" placeholder="—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é">`;
}

function editQ(i) {
  editId=i; const q=config.qs[i];
  document.getElementById("modal").style.display="flex";
  document.getElementById("mText").value=q.q;
  document.getElementById("mType").value=q.type;
  renderOpts();
  if(q.type==='choice') {
    const rows=document.querySelectorAll(".opt-row");
    q.o.forEach((txt,x)=>{ 
      if(rows[x]){ 
        rows[x].querySelector("input[type=text]").value=txt; 
        if(q.a.includes(txt)) rows[x].querySelector("input[type=radio]").checked=true; 
      }
    });
  } else document.getElementById("mInp").value=q.a.join(",");
}

function saveQ() {
  const q = document.getElementById("mText").value;
  const t = document.getElementById("mType").value;
  if(!q) return;
  let o = {type:t, q:q, a:[]};
  if(t==='choice') {
    o.o = [];
    document.querySelectorAll(".opt-row").forEach(r=>{
      const val = r.querySelector("input[type=text]").value;
      if(val) { o.o.push(val); if(r.querySelector("input[type=radio]").checked) o.a.push(val); }
    });
    if(!o.a.length) { alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç!"); return; }
  } else o.a = document.getElementById("mInp").value.split(",").map(x=>x.trim()).filter(Boolean);
  
  if(editId!==null) config.qs[editId]=o; else config.qs.push(o);
  closeModal(); renderList(); updatePreview();
}

function delQ(i) { config.qs.splice(i,1); renderList(); updatePreview(); }

// 4. –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–û–î–ê (Base64 Iframe)
function generateCode() {
  const tmpl = document.getElementById("gameTemplate").textContent;
  const html = tmpl.replace("{{CONFIG}}", JSON.stringify(config));
  
  // –ö–æ–¥–∏—Ä—É–µ–º –≤ Base64 (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä—É—Å—Å–∫–∏—Ö –±—É–∫–≤)
  const b64 = btoa(unescape(encodeURIComponent(html)));
  const embed = `<iframe src="data:text/html;base64,${b64}" width="100%" height="600" style="border:0"></iframe>`;
  
  navigator.clipboard.writeText(embed).then(() => {
    const t = document.getElementById("toast");
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"),2000);
  });
}

init();
</script>
</body>
</html>
