<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ë–∞—à–Ω—è ‚Äî Editor + Game (–æ–¥–∏–Ω —Ñ–∞–π–ª) [v8-20260210-044353]</title>

  <style>
    html, body{height:100%}

    :root{
      --text:#eaf0ff;
      --muted:#a9b6e6;
      --border: rgba(255,255,255,.10);
      --shadow2: 0 12px 34px rgba(0,0,0,.40);
      --radius: 18px;
      --radius2: 22px;

      --neon:#39ff76;
      --neon2:#00ffb3;
      --danger:#ff4d4d;
      --ok:#2dd27d;
    }

    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    body{
      margin:0;color:var(--text);
      background:
        radial-gradient(1100px 700px at 12% 18%, rgba(106,164,255,.16) 0%, rgba(5,8,22,0) 58%),
        radial-gradient(900px 640px at 88% 16%, rgba(155,123,255,.12) 0%, rgba(5,8,22,0) 62%),
        radial-gradient(1000px 780px at 55% 112%, rgba(45,210,125,.10) 0%, rgba(5,8,22,0) 58%),
        linear-gradient(180deg, rgba(10,14,40,.65), rgba(5,8,22,1));
      min-height:100vh;
    }
    body.gameOnly{background:transparent}

    .app{
      display:grid;
      grid-template-columns: 460px 1fr;
      gap:14px;
      padding:14px;
      max-width: 1540px;
      margin: 0 auto;
    }
    @media (max-width: 1020px){
      .app{grid-template-columns:1fr}
    }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid var(--border);
      border-radius:var(--radius2);
      box-shadow:var(--shadow2);
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
    }

    .panel-header{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .panel-header .h{font-weight:950;letter-spacing:.2px}
    .panel-body{padding:14px}

    .settings{
      height: calc(100vh - 28px);
      display:flex;
      flex-direction:column;
      min-height: 560px;
    }
    .settings .panel-body{
      overflow:auto;
      padding:14px;
    }

    .section{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      margin-bottom:12px;
    }
    .section .title{
      font-weight:950;
      font-size:13.5px;
      margin-bottom:10px;
      color:rgba(255,255,255,.92);
      display:flex;align-items:center;justify-content:space-between;gap:8px;
    }

    .muted{color:var(--muted); font-size:12.5px; line-height:1.35}

    label{
      display:block;
      font-size:12.5px;
      color:rgba(255,255,255,.86);
      margin:10px 0 6px
    }

    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      border-radius:14px;
      padding:10px 11px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:84px; resize:vertical}

    input[type="file"]{
      width:100%;
      border-radius:14px;
      padding:10px 11px;
      border:1px dashed rgba(255,255,255,.22);
      background:rgba(0,0,0,.18);
      color:var(--muted);
    }

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1; min-width:170px}

    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      margin-top:8px;
    }
    .toggle input{width:18px; height:18px}

    .btn{
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-weight:950;
      font-size:14px;
      transition:transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .2s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.24)}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.45; cursor:not-allowed}

    .btn.primary{
      background:linear-gradient(90deg, rgba(57,255,118,.28), rgba(0,255,179,.18));
      border-color:rgba(57,255,118,.34);
      box-shadow: 0 10px 26px rgba(57,255,118,.12);
    }
    .btn.danger{border-color:rgba(255,77,77,.35); background:rgba(255,77,77,.08)}
    .btn.small{padding:8px 10px; font-size:12.5px; border-radius:12px}

    .q-list{display:flex; flex-direction:column; gap:10px;}
    .q-item{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .q-item .meta{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
      padding-top:3px;
    }
    .q-item .meta .t{
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis
    }
    .q-item .meta .s{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(255,255,255,.92);
    }

    .preview{
      min-height: calc(100vh - 28px);
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:0;
      overflow:hidden;
    }
    .preview-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
    }
    .preview-top .name{font-weight:950; letter-spacing:.2px}
    .preview-top .hint{color:var(--muted); font-size:12.5px}

    .preview-stage{
      position:relative;
      border-radius:var(--radius2);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      min-height: 720px; height: calc(100vh - 120px);
      background:rgba(0,0,0,.18);
      box-shadow: var(--shadow2);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      z-index:999999;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px)
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999998;
      padding:14px;
    }

    .modal{
      width:min(820px, 100%);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal-head{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modal-head .h{font-weight:950}
    .modal-body{padding:14px}
    .modal-foot{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .choiceBlock{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.14);
      border-radius:14px;
      padding:10px;
      margin-top:10px;
    }

    .answerRow{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:8px;
    }
    .answerRow input[type="text"]{flex:1; min-width:0}

    .radio{
      width:18px;
      height:18px;
      accent-color: var(--neon);
      flex:0 0 auto;
    }

    .errbar{
      display:none;
      margin:12px 14px 0;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,77,77,.35);
      background:rgba(255,77,77,.10);
      color:#ffd6d6;
      font-size:13px;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .errbar.show{display:block}

    /* ===== GAME styles (scoped by .gameHost) ===== */
    .gameHost{
      width:100%;
      height:100%;
      min-height:0;
    }
    .gameHost *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .stage{
      position:relative;
      width:100%;
      height:100%;
      min-height:720px;
      overflow:hidden;
      border-radius:18px;
      background:
        radial-gradient(1100px 700px at 12% 18%, rgba(106,164,255,.18) 0%, rgba(5,8,22,0) 58%),
        radial-gradient(900px 640px at 88% 16%, rgba(155,123,255,.14) 0%, rgba(5,8,22,0) 62%),
        radial-gradient(1000px 780px at 55% 112%, rgba(45,210,125,.12) 0%, rgba(5,8,22,0) 58%),
        linear-gradient(180deg, rgba(10,14,40,.60), rgba(5,8,22,1));
      color:var(--text);
    }
    .bg{
      position:absolute; inset:0;
      background-position:center;
      background-size:cover;
      opacity: .92;
      transform: scale(1.02);
      filter: saturate(1.05) contrast(1.02);
      pointer-events:none;
      display:none;
    }
    .overlay{
      position:absolute; inset:0;
      background: radial-gradient(900px 620px at 50% 35%, rgba(0,0,0,0) 0%, rgba(0,0,0,.40) 70%);
      pointer-events:none;
    }
    .topbar{
      position:absolute;
      left:12px; right:12px; top:12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
      z-index:30;
    }
    .leftPack{display:flex; flex-direction:column; gap:2px; min-width:220px}
    .title{font-weight:950; letter-spacing:.2px}
    .sub{color:rgba(255,255,255,.78); font-size:12px}
    .rightPack{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}

    .pillGame{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(255,255,255,.92);
      font-weight:900;
      font-size:12px;
      user-select:none;
    }
    .timerBadge{
      border-color: rgba(57,255,118,.22);
      box-shadow: 0 0 18px rgba(57,255,118,.14);
    }
    .progressWrap{
      width:260px; max-width:60vw;
      height:12px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
    }
    .progressBar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(57,255,118,.35), rgba(57,255,118,.95));
      box-shadow: 0 0 14px rgba(57,255,118,.35);
      transition: width .25s ease;
    }

    .towerArea{
      position:absolute;
      left:0; right:0; top:0; bottom:0;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      z-index:10;
      padding-bottom: 64px;
    }
    .tower{
      position:relative;
      width:min(320px, 70vw);
      height: calc(100% - 170px);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      pointer-events:none;
    }

    .cssBlock{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      width:min(280px, 64vw);
      height:78px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(260px 100px at 30% 30%, rgba(255,255,255,.10), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, rgba(57,255,118,.12), rgba(0,0,0,.18));
      box-shadow: 0 22px 34px rgba(0,0,0,.35);
      overflow:hidden;
      filter: drop-shadow(0 14px 16px rgba(0,0,0,.30));
    }
    .cssBlock::after{
      content:"";
      position:absolute; inset:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      opacity:.9;
    }

    .imgBlock{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      will-change: transform, top, opacity, filter;
      filter: drop-shadow(0 18px 20px rgba(0,0,0,.35));
    }

    .burning{
      filter: grayscale(.15) brightness(.72) contrast(1.1) sepia(.28) saturate(1.15) !important;
      opacity:.96;
    }

    .nextWrap{
      position:absolute;
      left:0; right:0;
      bottom: 22px;
      display:flex;
      justify-content:center;
      z-index:35;
      pointer-events:auto;
    }
    .hintUnder{
      position:absolute;
      left:0; right:0;
      bottom: 66px;
      display:flex;
      justify-content:center;
      z-index:35;
      pointer-events:none;
    }
    .hintBubble{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      backdrop-filter: blur(10px);
      font-size:12px;
      color:rgba(255,255,255,.9);
      max-width:min(760px, 92vw);
      text-align:center;
      box-shadow: 0 18px 50px rgba(0,0,0,.20);
    }

    .btnGame{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.95);
      cursor:pointer;
      font-weight:950;
      font-size:14px;
      transition:transform .08s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btnGame:hover{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.24)}
    .btnGame:active{transform:translateY(1px)}
    .btnGame:disabled{opacity:.45; cursor:not-allowed}
    .btnGame.primary{
      background: linear-gradient(90deg, rgba(57,255,118,.22), rgba(0,255,179,.18));
      border-color: rgba(57,255,118,.30);
      box-shadow: 0 12px 30px rgba(57,255,118,.10);
    }

    .cardBack{
      position:absolute; inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
      padding:14px;
    }
    .card{
      width:min(760px, 96vw);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      overflow:hidden;
      transform: translateY(12px) scale(.985);
      opacity:0;
      animation: cardIn .32s ease-out forwards;
    }
    @keyframes cardIn{ to{ transform:none; opacity:1; } }

    .cardHead{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .cardHead .h{font-weight:950}
    .cardBody{padding:14px}
    .cardFoot{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .block{
      padding:12px 12px;
      border-radius:16px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
    }
    .block .label{font-size:12px;color:rgba(255,255,255,.70);margin-bottom:8px;font-weight:900}
    .qText{white-space:pre-wrap; font-size:16px; line-height:1.35}

    .answers{display:flex; flex-wrap:wrap; gap:8px}
    .pillBtn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(255,255,255,.92);
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition:transform .08s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
    }
    .pillBtn:hover{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.24)}
    .pillBtn:active{transform:translateY(1px)}

    .inputRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .inp{
      flex:1; min-width:220px;
      border-radius:14px;
      padding:10px 11px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:rgba(255,255,255,.92);
      outline:none;
    }

    .floatPlus{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      color: rgba(57,255,118,.96);
      font-weight:1000;
      text-shadow: 0 0 10px rgba(57,255,118,.35);
      pointer-events:none;
      z-index:45;
      animation: plusFly .9s ease-out forwards;
    }
    @keyframes plusFly{
      0%{opacity:0; transform:translateX(-50%) translateY(10px) scale(.98)}
      20%{opacity:1}
      100%{opacity:0; transform:translateX(-50%) translateY(-70px) scale(1.05)}
    }

    .spark{
      position:absolute;
      width:6px;height:6px;
      border-radius:999px;
      background: rgba(255,220,120,.95);
      box-shadow: 0 0 10px rgba(255,200,80,.35);
      pointer-events:none;
      z-index:44;
      animation: sparkFly .7s ease-out forwards;
    }
    @keyframes sparkFly{
      to{
        opacity:0;
        transform: translate(var(--dx), var(--dy)) scale(.4);
        filter: blur(0.2px);
      }
    }

    .smoke{
      position:absolute;
      width:18px;height:18px;
      border-radius:999px;
      background: rgba(120,120,120,.35);
      filter: blur(1px);
      pointer-events:none;
      z-index:43;
      animation: smokeFly 1.0s ease-out forwards;
    }
    @keyframes smokeFly{
      0%{opacity:0; transform: translate(0,0) scale(.8)}
      20%{opacity:1}
      100%{opacity:0; transform: translate(var(--dx), var(--dy)) scale(1.6)}
    }

    .finish{
      position:absolute; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:60;
      padding:14px;
    }
    .finishCard{
      width:min(820px, 96vw);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 36px 110px rgba(0,0,0,.60);
      overflow:hidden;
    }
    .finishHead{
      padding:14px 16px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .finishHead .h{font-weight:1000; font-size:18px}
    .finishBody{padding:14px 16px}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:720px){ .grid{grid-template-columns:1fr} }
    .stat{
      padding:12px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
    }
    .stat .k{color:rgba(255,255,255,.75); font-size:12px; font-weight:900}
    .stat .v{font-size:22px; font-weight:1000; margin-top:4px}
    .bigMsg{
      margin-top:12px;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(57,255,118,.25);
      background:rgba(57,255,118,.08);
    }
    .bigMsg .h{font-weight:1000; font-size:18px}
    .bigMsg .p{color:rgba(255,255,255,.85); margin-top:6px; line-height:1.35}
  

    /* ===== ORIGINAL GAME CSS (canvas version) ===== */

    :root{
      --hud-bg: rgba(10, 12, 18, .55);
      --panel-bg: rgba(20, 22, 30, .78);
      --panel-stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --good: rgba(120, 255, 170, .95);
      --bad: rgba(255, 120, 140, .95);
      --shadow: 0 18px 60px rgba(0,0,0,.35);
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);overflow:hidden;background:#000;}
    #wrap{position:relative;width:100%;height:100%;}
    canvas{width:100%;height:100%;display:block;}

    #hud{
      position:absolute; left:12px; right:12px; top:12px;
      display:flex; gap:12px; align-items:center;
      pointer-events:none;
      z-index: 3;
    }
    .pill{
      background:var(--hud-bg);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      padding:10px 14px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      display:flex; gap:10px; align-items:center;
      white-space:nowrap;
    }
    #progressWrap{
      flex:1;
      background:var(--hud-bg);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      padding:10px 14px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      display:flex; align-items:center; gap:10px;
      min-width:160px;
      pointer-events:none;
    }
    #bar{
      height:10px; flex:1;
      background:rgba(255,255,255,.12);
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    #bar>div{
      height:100%; width:0%;
      background: linear-gradient(90deg, rgba(120,190,255,.9), rgba(120,255,170,.85));
      border-radius:999px;
    }

    #scorePill{ margin-left:auto; }
    #scoreNum{ font-weight:900; letter-spacing:.2px; }
    #leftPill{ gap:12px; }
    #remainNum{ font-weight:900; }

    #nextBtn{
      position:absolute;
      left:50%;
      bottom:88px;
      transform: translateX(160px);
      pointer-events:auto;
      border-radius:16px;
      padding:12px 14px;
      border:1px solid rgba(120,190,255,.35);
      background: rgba(120,190,255,.22);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      transition: transform .08s ease, filter .12s ease, opacity .12s ease;
      user-select:none;
      z-index: 4;
    }
    #nextBtn:active{ transform: translateX(160px) scale(.99); }
    #nextBtn[disabled]{ opacity:.45; cursor:not-allowed; filter:saturate(.7); }

    #overlay{
      position:absolute; inset:0;
      display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      z-index: 5;
    }
    #card{
      width:min(640px, calc(100% - 24px));
      background:var(--panel-bg);
      border:1px solid var(--panel-stroke);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:18px 18px 14px;

      transform: translateY(10px) scale(.96);
      opacity: 0;
      transition: transform .18s ease, opacity .18s ease;
      will-change: transform, opacity;
    }
    #overlay.show #card{
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    #cardHeader{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; margin-bottom:12px;
    }
    #title{ font-size:16px; color:var(--muted); letter-spacing:.2px; }
    #q{ font-size:20px; line-height:1.25; margin-top:6px; }
    #badge{
      border-radius:999px; padding:6px 10px;
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted); font-size:12px; white-space:nowrap;
    }
    #answers{ display:flex; flex-direction:column; gap:10px; margin-top:14px; }
    .btn{
      width:100%; text-align:left;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:12px 12px;
      color:var(--text);
      cursor:pointer;
      transition: transform .08s ease, background .12s ease;
    }
    .btn:hover{ background:rgba(255,255,255,.11); }
    .btn:active{ transform:scale(.99); }

    #inputRow{ display:none; gap:10px; align-items:center; margin-top:12px; }
    #ansInput{
      flex:1;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      padding:12px 12px;
      color:var(--text);
      outline:none;
      font-size:16px;
    }
    #submit{
      background:rgba(120,190,255,.20);
      border:1px solid rgba(120,190,255,.35);
      border-radius:14px;
      padding:12px 14px;
      cursor:pointer;
      color:var(--text);
      font-weight:800;
    }
    #submit:hover{ background:rgba(120,190,255,.26); }

    #msg{ margin-top:12px; min-height:18px; font-size:14px; color:var(--muted); }
    #hint{ margin-top:10px; font-size:12px; color:rgba(255,255,255,.55); }

    #start{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1200px 800px at 50% 45%, rgba(0,0,0,.15), rgba(0,0,0,.55));
      backdrop-filter: blur(3px);
      z-index: 6;
    }
    #startCard{
      width:min(700px, calc(100% - 24px));
      background: rgba(20, 22, 30, .75);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 18px;
    }
    #startCard h1{ margin:0 0 8px 0; font-size:24px; }
    #startCard p{ margin:0 0 14px 0; color: var(--muted); line-height:1.35; }
    #play{
      display:inline-flex; gap:10px; align-items:center;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(120,190,255,.35);
      background: rgba(120,190,255,.22);
      color: var(--text);
      font-weight:900;
      cursor:pointer;
    }
    #play:hover{ background: rgba(120,190,255,.28); }

    #err{
      display:none;
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,120,140,.35);
      background: rgba(255,120,140,.12);
      color: rgba(255,235,238,.95);
      font-size:13px;
      line-height:1.35;
    }
    #err ul{ margin:8px 0 0 18px; }
    code{background:rgba(255,255,255,.08); padding:2px 6px; border-radius:8px; border:1px solid rgba(255,255,255,.12);}

    #finish{
      position:absolute; inset:0;
      display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
      z-index: 7;
    }
    #finishCard{
      width:min(720px, calc(100% - 24px));
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(18, 20, 28, .75);
      box-shadow: var(--shadow);
      padding: 18px 18px 16px;
      text-align:center;
    }
    #finishTitle{
      font-size:30px; font-weight:1000; letter-spacing:.3px;
      margin: 4px 0 8px;
      background: linear-gradient(90deg, rgba(120,190,255,.95), rgba(120,255,170,.95));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    #finishText{
      color: rgba(255,255,255,.82);
      font-size:18px;
      margin: 0 0 10px;
    }
    #stats{
      display:flex;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
      margin: 10px 0 14px;
    }
    .stat{
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 10px 12px;
      min-width: 160px;
      text-align:left;
    }
    .stat b{ font-size:18px; }
    .stat div{ color: rgba(255,255,255,.70); font-size:12px; margin-top:4px; }
    #restart{
      display:inline-flex; gap:10px; align-items:center;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(120,190,255,.35);
      background: rgba(120,190,255,.22);
      color: var(--text);
      font-weight:900;
      cursor:pointer;
    }
    #restart:hover{ background: rgba(120,190,255,.28); }
  

  </style>
</head>

<body>
  <div class="app" id="editorRoot">
    <div class="panel settings">
      <div class="panel-header">
        <div class="h">–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ë–∞—à–Ω—è¬ª <span class="pill" title="–≤–µ—Ä—Å–∏—è —Ñ–∞–π–ª–∞">v8-20260210-044353</span></div>
        <div class="row" style="margin:0">
          <button class="btn primary" id="btnCopyCode" type="button">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É (–∏–≥—Ä–∞)</button>
        </div>
      </div>

      <div class="errbar" id="errbar"></div>

      <div class="panel-body">

        <div class="section">
          <div class="title">–ù–∞–∑–≤–∞–Ω–∏–µ</div>

          <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∏–≥—Ä–µ</label>
          <input id="inpTitle" type="text" value="–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π" />
        </div>

        <div class="section">
          <div class="title">–ö–∞—Ä—Ç–∏–Ω–∫–∏ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è</div>

          <div class="toggle">
            <input id="chkUseRepoBg" type="checkbox" checked />
            <div>
              <div style="font-weight:900">–§–æ–Ω: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <b>1.png</b></div>
              <div class="muted">–ë–µ—Ä—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –∫–æ—Ä–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–µ—Å–ª–∏ —Ñ–∞–π–ª –µ—Å—Ç—å).</div>
            </div>
          </div>

          <label>–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ–æ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <input id="fileBg" type="file" accept="image/*" />

          <div class="toggle">
            <input id="chkUseImages" type="checkbox" checked />
            <div>
              <div style="font-weight:900">–ë–ª–æ–∫–∏: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <b>3.png‚Ä¶11.png</b></div>
              <div class="muted">–ë–µ—Ä—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –∫–æ—Ä–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –ø–æ –ø–æ—Ä—è–¥–∫—É.</div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="title">–¢–∞–π–º–µ—Ä</div>

          <div class="toggle">
            <input id="chkTimer" type="checkbox" />
            <div>
              <div style="font-weight:900">–í–∫–ª—é—á–∏—Ç—å —Ç–∞–π–º–µ—Ä</div>
              <div class="muted">–ï—Å–ª–∏ –≤—Ä–µ–º—è –≤—ã—à–ª–æ ‚Äî –æ—Ç–≤–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π, –±–ª–æ–∫ —Å–≥–æ—Ä–∞–µ—Ç.</div>
            </div>
          </div>

          <label>–°–µ–∫—É–Ω–¥ –Ω–∞ –≤–æ–ø—Ä–æ—Å</label>
          <input id="inpSeconds" type="number" min="5" max="600" step="1" value="30" />
        </div>

        <div class="section">
          <div class="title">–í–æ–ø—Ä–æ—Å—ã <span class="pill" id="pillCount">0 / 9</span></div>

          <div class="row">
            <button class="btn primary" id="btnAddQ" type="button">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="btn" id="btnClearQs" type="button">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>

          <div class="q-list" id="qList" style="margin-top:12px"></div>

          <div class="muted" style="margin-top:10px">
            –°—Ç—Ä–æ–≥–æ <b>9 –≤–æ–ø—Ä–æ—Å–æ–≤</b>. –ú–æ–∂–Ω–æ: <b>–≤—ã–±–æ—Ä</b> –∏–ª–∏ <b>–≤–≤–æ–¥</b> (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤).
          </div>
        </div>

        <div class="section">
          <div class="title">–≠–∫—Å–ø–æ—Ä—Ç –≤ Genially</div>
          <div class="muted">
            –ù–∞–∂–º–∏ <b>¬´üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe¬ª</b> ‚Äî –≤ –±—É—Ñ–µ—Ä–µ –±—É–¥–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–¥ –≤–∏–¥–∞:
            <div style="margin-top:8px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; color:rgba(255,255,255,.86)">
              .../index.html?game=...
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="panel preview">
      <div class="preview-top">
        <div>
          <div class="name">–ü—Ä–æ—Å–º–æ—Ç—Ä</div>
          <div class="hint">–ñ–∏–≤–æ–µ –ø—Ä–µ–≤—å—é (–∏–≥—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∫ –≤ Genially)</div>
        </div>
        <div class="muted">–ë–∞—à–Ω—è + –∫–∞—Ä—Ç–æ—á–∫–∏ + —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω</div>
      </div>

      <div class="panel-body">
        <div class="preview-stage">
          <iframe id="livePreview" title="Preview" style="width:100%;height:100%;min-height:720px;border:0;background:transparent;border-radius:18px;overflow:hidden" allow="autoplay; fullscreen" allowfullscreen></iframe>
        </div>
      
      </div>

      <div class="panel-body" style="padding-top:0;border-top:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.10)">
        <div class="row" id="stickyBar" style="padding:12px 0;gap:10px;margin:0">
          <button class="btn primary" id="btnCopyCode2" type="button" style="flex:1">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É (–∏–≥—Ä–∞)</button>
          <button class="btn" id="btnOpenGame" type="button" style="flex:1">‚ñ∂ –û—Ç–∫—Ä—ã—Ç—å –∏–≥—Ä—É</button>
        </div>
        <div class="muted">–ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–∞–≤–µ—Ä—Ö—É –Ω–µ –≤–∏–¥–Ω–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏.</div>
      </div>
    </div>
  </div>

  <!-- GAME ONLY ROOT (when opened with ?game=... or #game=...) -->
  <div id="gameRoot" style="display:none">
<div id="wrap">
  <canvas id="c"></canvas>

  <div id="hud">
    <div class="pill" id="leftPill">
      –ë–∞—à–Ω—è: <b id="heightTxt">0</b>
      <span style="opacity:.5">|</span>
      –û—Å—Ç–∞–ª–æ—Å—å: <b id="remainNum">9</b>
    </div>

    <div id="progressWrap">
      –ü—Ä–æ–≥—Ä–µ—Å—Å
      <div id="bar"><div></div></div>
      <span id="pct">0%</span>
    </div>

    <div class="pill" id="scorePill">–°—á—ë—Ç: <b id="scoreNum">0</b></div>
  </div>

  <button id="nextBtn" disabled>–î–∞–ª–µ–µ ‚Üí</button>

  <div id="overlay" role="dialog" aria-modal="true">
    <div id="card">
      <div id="cardHeader">
        <div>
          <div id="title">–í–æ–ø—Ä–æ—Å</div>
          <div id="q">...</div>
        </div>
        <div id="badge">1 / 9</div>
      </div>

      <div id="answers"></div>

      <div id="inputRow">
        <input id="ansInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..." autocomplete="off" />
        <button id="submit">–û–ö</button>
      </div>

      <div id="msg"></div>
      <div id="hint">–í–µ—Ä–Ω–æ ‚Üí –±–ª–æ–∫ –æ–ø—É—Å–∫–∞–µ—Ç—Å—è –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —ç—Ç–∞–∂–æ–º (+100). –ù–µ–≤–µ—Ä–Ω–æ ‚Üí –æ–±—É–≥–ª–∏–≤–∞–Ω–∏–µ, –≤–∑—Ä—ã–≤ –∏ –∏—Å—á–µ–∑–∞–µ—Ç.</div>
    </div>
  </div>

  <div id="start">
    <div id="startCard">
      <h1>–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π</h1>
      <p>
        –ü–µ—Ä–≤—ã–π –±–ª–æ–∫ –ø–∞–¥–∞–µ—Ç —Å–∞–º. –î–∞–ª—å—à–µ ‚Äî –Ω–∞–∂–∏–º–∞–π <b>–î–∞–ª–µ–µ</b>.
        –ö–æ–≥–¥–∞ –±–ª–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è ‚Äî –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å.
        <br/>–í–µ—Ä–Ω–æ ‚Üí –±–ª–æ–∫ –æ–ø—É—Å–∫–∞–µ—Ç—Å—è –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —ç—Ç–∞–∂–æ–º (+100).
        <br/>–ù–µ–≤–µ—Ä–Ω–æ ‚Üí –±–ª–æ–∫ –æ–±—É–≥–ª–∏–≤–∞–µ—Ç—Å—è, –≤–∑—Ä—ã–≤–∞–µ—Ç—Å—è –∏ –∏—Å—á–µ–∑–∞–µ—Ç.
      </p>
      <button id="play">‚ñ∂ –ù–∞—á–∞—Ç—å</button>
      <div id="err">
        <b>–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã.</b> –£–±–µ–¥–∏—Å—å, —á—Ç–æ –æ–Ω–∏ –ª–µ–∂–∞—Ç —Ä—è–¥–æ–º —Å <code>index.html</code> –∏ –∏–º–µ–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—é—Ç.
        <ul id="errList"></ul>
      </div>
    </div>
  </div>

  <div id="finish">
    <div id="finishCard">
      <div id="finishTitle">–ú–æ–ª–æ–¥–µ—Ü!</div>
      <div id="finishText">–¢–æ–±–æ–π –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: <b id="finishScore">0</b> –±–∞–ª–ª–æ–≤</div>

      <div id="stats">
        <div class="stat"><b id="stCorrect">0</b><div>–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</div></div>
        <div class="stat"><b id="stWrong">0</b><div>–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</div></div>
        <div class="stat"><b id="stHeight">0</b><div>–±–ª–æ–∫–æ–≤ –≤ –±–∞—à–Ω–µ</div></div>
      </div>

      <button id="restart">‚Üª –°—ã–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑</button>
    </div>
  </div>
</div>
  </div>

  <!-- MODAL -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div class="h" id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</div>
        <button class="btn small danger" id="btnCloseModal" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div class="modal-body">
        <label>–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞</label>
        <select id="selType">
          <option value="choice" selected>–° –≤—ã–±–æ—Ä–æ–º –æ—Ç–≤–µ—Ç–∞</option>
          <option value="text">–° –≤–≤–æ–¥–æ–º –æ—Ç–≤–µ—Ç–∞</option>
        </select>

        <label>–í–æ–ø—Ä–æ—Å</label>
        <textarea id="inpPrompt" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å..."></textarea>

        <div id="choiceWrap" class="choiceBlock">
          <div style="font-weight:900">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞</div>
          <div class="muted">–ú–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞. –û—Ç–º–µ—Ç—å –≤–µ—Ä–Ω—ã–π —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–æ–π.</div>
          <div id="choiceList"></div>
          <button class="btn small" id="btnAddChoice" type="button" style="margin-top:10px">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
        </div>

        <div id="textWrap" class="choiceBlock" style="display:none">
          <div style="font-weight:900">–í–µ—Ä–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–≤–≤–æ–¥)</div>
          <div class="muted">–ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –ª—é–±–æ–π.</div>
          <div id="textList"></div>
          <button class="btn small" id="btnAddText" type="button" style="margin-top:10px">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn" id="btnPreviewDraft" type="button">üëÅ –ü–æ–∫–∞–∑–∞—Ç—å –≤ –ø—Ä–µ–≤—å—é</button>
        <button class="btn primary" id="btnSaveQ" type="button">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  
  <div class="modal-backdrop" id="codeBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="codeTitle">
      <div class="modal-head">
        <div class="h" id="codeTitle">–°—Å—ã–ª–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã</div>
        <button class="btn small danger" id="btnCloseCode" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modal-body">
        <div class="muted" style="margin-bottom:8px">–≠—Ç–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–≥—Ä—É. –ï—ë –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å –≤ Genially (—á–µ—Ä–µ–∑ iframe) –∏ –∫—É–¥–∞ —É–≥–æ–¥–Ω–æ.</div>
        <label style="margin-top:0">–°—Å—ã–ª–∫–∞</label>
<textarea id="taIframe" spellcheck="false" style="min-height:90px;font-family: ui-monospace, SFMono-Regular, Menlo, monospace;"></textarea>
<label>iframe (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)</label>
<textarea id="taIframe2" spellcheck="false" style="min-height:120px;font-family: ui-monospace, SFMono-Regular, Menlo, monospace;"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnCopyFromModal" type="button">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
          <button class="btn" id="btnCopyIframe" type="button">üìé –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ</div>


<script>
(() => {
  "use strict";

  // ===== errors =====
  const errbar = document.getElementById("errbar");
  function showErr(msg){
    if (!errbar) return;
    errbar.classList.add("show");
    errbar.textContent = "–û—à–∏–±–∫–∞ JS:\\n" + msg;
  }
  window.addEventListener("error", (e) => {
    const m = e?.error?.stack || e?.message || String(e);
    showErr(m);
  });
  window.addEventListener("unhandledrejection", (e) => {
    const m = e?.reason?.stack || e?.reason?.message || String(e?.reason || e);
    showErr(m);
  });

  const $ = (id)=>document.getElementById(id);

  // ===== Canvas game boot (ported from your original file) =====
  window.__bootCanvasGame = function(cfg){
    // Store cfg for the canvas game code below
    window.__CANVAS_GAME_CFG__ = cfg || {};
  };

  function uid(){
    return "q_" + Math.random().toString(36).slice(2,9) + "_" + Date.now().toString(36);
  }
  function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

  function toast(msg){
    const t = $("toast");
    if (!t) return;
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1400);
  }

  function fileToDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=>resolve(String(r.result || ""));
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  async function copyToClipboard(text){
    try{
      if (navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch(e){}
    try{
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.setAttribute("readonly", "");
      ta.style.position = "fixed";
      ta.style.left = "0";
      ta.style.top = "0";
      ta.style.opacity = "0";
      ta.style.width = "1px";
      ta.style.height = "1px";
      ta.style.pointerEvents = "none";
      ta.style.zIndex = "-1";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      ta.setSelectionRange(0, ta.value.length);
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }catch(e){
      return false;
    }
  }

  // ===== base urls in repo (works on GitHub Pages) =====
  function basePath(){
    // https://user.github.io/repo/index.html -> https://user.github.io/repo/
    const p = location.pathname;
    return location.origin + p.replace(/\/[^\/]*$/, "/");
  }
  const BASE = basePath();
  function selfPageUrl(){
    // Works even if the file name is not index.html (e.g. index_v5.html)
    let p = location.pathname || "/";
    if(p.endsWith("/")) p += "index.html";
    return location.origin + p;
  }

  const repoBgUrl = BASE + "1.png";
  const blockUrls = Array.from({length:9}, (_,i)=> BASE + (i+3) + ".png"); // 3..11


  // ===== query params (for Genially iframe) =====
  function parseQueryParams(){
    const q = {};
    const s = window.location.search.replace(/^\?/, "");
    s.split("&").filter(Boolean).forEach(pair=>{
      const [k,v] = pair.split("=");
      if(!k) return;
      q[decodeURIComponent(k)] = decodeURIComponent(v||"");
    });
    return q;
  }

  // ===== hash params (legacy) =====

  function parseHashParams(){
    const h = (location.hash || "").replace(/^#/, "");
    // allow both: #game=... or #game=...&x=y
    const out = {};
    h.split("&").filter(Boolean).forEach(pair=>{
      const [k,v] = pair.split("=");
      if(!k) return;
      out[decodeURIComponent(k)] = decodeURIComponent(v || "");
    });
    return out;
  }

  function b64urlEncode(str){
    const b64 = btoa(unescape(encodeURIComponent(str)));
    return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
  }
  function b64urlDecode(b64url){
    let s = String(b64url||"").replaceAll("-","+").replaceAll("_","/");
    while(s.length % 4) s += "=";
    return decodeURIComponent(escape(atob(s)));
  }

  // ===== GAME (canvas version) injected below =====

  // ===== config =====
  function normalizeCfg(raw){
    const cfg = raw && typeof raw === "object" ? raw : {};
    const title = String(cfg.title || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π");
    const useRepoBg = !!cfg.useRepoBg;
    const bgDataUrl = String(cfg.bgDataUrl || "");
    const useImages = !!cfg.useImages;

    const timerEnabled = !!cfg.timer?.enabled;
    const timerSeconds = Math.max(5, Math.min(600, Number(cfg.timer?.seconds || 30)));

    let questions = Array.isArray(cfg.questions) ? cfg.questions.slice(0,9) : [];
    // sanitize
    questions = questions.map(q=>{
      if(q?.type === "text"){
        return { type:"text", prompt:String(q.prompt||""), accepts:(Array.isArray(q.accepts)?q.accepts:[]).map(x=>String(x||"")) };
      }
      return { type:"choice", prompt:String(q?.prompt||""), options:(Array.isArray(q?.options)?q.options:[]).map(x=>String(x||"")), correctIndex:Number(q?.correctIndex||0) };
    });

    // –í–∞–∂–Ω–æ: —Ä–µ–¥–∞–∫—Ç–æ—Ä –º–æ–∂–µ—Ç –æ—Ç–¥–∞—Ç—å –º–µ–Ω—å—à–µ 9 –≤–æ–ø—Ä–æ—Å–æ–≤. –ò–≥—Ä–∞ —Å–∞–º–∞ –∑–∞—Ü–∏–∫–ª–∏—Ç –∏—Ö –ø–æ –∫—Ä—É–≥—É.
    // –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ 0 ‚Äî –∏–≥—Ä–∞ –ø–æ–∫–∞–∂–µ—Ç –∑–∞–≥–ª—É—à–∫–∏.


    return {
      title,
      useRepoBg,
      bgDataUrl,
      timer: { enabled: timerEnabled, seconds: timerSeconds },
      useImages,
      blockUrls: blockUrls,
      questions
    };
  }

  // ===== Editor =====
  const Editor = {
    title: "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π",
    useRepoBg: true,
    bgDataUrl: "",
    timer: { enabled:false, seconds: 30 },
    useImages: true,
    questions: [],
    draft: null,
    editingId: null
  };

  function setCountPill(){
    $("pillCount").textContent = Editor.questions.length + " / 9";
    $("btnAddQ").disabled = (Editor.questions.length >= 9);
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function qSummary(q){
    const p = String(q.prompt || "").trim();
    const short = p.length > 50 ? p.slice(0,50)+"‚Ä¶" : p;
    const type = (q.type==="choice") ? "–í—ã–±–æ—Ä" : "–í–≤–æ–¥";
    return { title: short || "(–ø—É—Å—Ç–æ)", sub: type };
  }

  function renderList(){
    const list = $("qList");
    list.innerHTML = "";
    setCountPill();

    if(Editor.questions.length === 0){
      const d = document.createElement("div");
      d.className = "muted";
      d.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤. –ù–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ 9 –≤–æ–ø—Ä–æ—Å–æ–≤.";
      list.appendChild(d);
      return;
    }

    Editor.questions.forEach((q,i)=>{
      const wrap = document.createElement("div");
      wrap.className = "q-item";

      const meta = document.createElement("div");
      meta.className = "meta";
      const s = qSummary(q);
      meta.innerHTML = `<div class="t">${escapeHtml(String(i+1)+". "+s.title)}</div>
                        <div class="s">${escapeHtml(s.sub)}</div>`;

      const btns = document.createElement("div");
      btns.style.display="flex";
      btns.style.gap="8px";
      btns.style.flexWrap="wrap";
      btns.style.justifyContent="flex-end";

      const bPrev = document.createElement("button");
      bPrev.className = "btn small";
      bPrev.type="button";
      bPrev.textContent = "üëÅ";
      bPrev.title = "–ü–æ–∫–∞–∑–∞—Ç—å –≤ –ø—Ä–µ–≤—å—é (–ø–µ—Ä–≤—ã–º –≤–æ–ø—Ä–æ—Å–æ–º)";
      bPrev.onclick = ()=>{
        Editor.draft = deepClone(q);
        updatePreview(true);
        toast("–ü–æ–∫–∞–∑–∞–Ω–æ –≤ –ø—Ä–µ–≤—å—é");
      };

      const bEdit = document.createElement("button");
      bEdit.className = "btn small";
      bEdit.type="button";
      bEdit.textContent = "‚úèÔ∏è";
      bEdit.title = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
      bEdit.onclick = ()=> openModal(q);

      const bDel = document.createElement("button");
      bDel.className = "btn small danger";
      bDel.type="button";
      bDel.textContent = "üóë";
      bDel.title = "–£–¥–∞–ª–∏—Ç—å";
      bDel.onclick = ()=>{
        Editor.questions = Editor.questions.filter(x=>x.id!==q.id);
        renderList();
        updatePreview(false);
        toast("–£–¥–∞–ª–µ–Ω–æ");
      };

      btns.appendChild(bPrev);
      btns.appendChild(bEdit);
      btns.appendChild(bDel);

      wrap.appendChild(meta);
      wrap.appendChild(btns);
      list.appendChild(wrap);
    });
  }

  function showModal(){
    $("modalBackdrop").style.display = "flex";
    $("modalBackdrop").setAttribute("aria-hidden","false");
  }
  function hideModal(){
    $("modalBackdrop").style.display = "none";
    $("modalBackdrop").setAttribute("aria-hidden","true");
  }

  function syncModalType(){
    const t = $("selType").value;
    $("choiceWrap").style.display = (t==="choice") ? "block" : "none";
    $("textWrap").style.display = (t==="text") ? "block" : "none";
  }

  function renderChoiceUI(){
    const list = $("choiceList");
    list.innerHTML = "";
    const q = Editor.draft;
    if(!q) return;

    q.options = q.options || ["",""];
    if(typeof q.correctIndex !== "number") q.correctIndex = 0;

    q.options.forEach((val, idx)=>{
      const row = document.createElement("div");
      row.className = "answerRow";

      const r = document.createElement("input");
      r.className="radio";
      r.type="radio";
      r.name="correctChoice";
      r.checked = (q.correctIndex === idx);
      r.onchange = ()=>{ q.correctIndex = idx; renderChoiceUI(); };

      const inp = document.createElement("input");
      inp.type="text";
      inp.value = val || "";
      inp.placeholder = (idx === q.correctIndex) ? "‚úÖ –í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç" : ("–í–∞—Ä–∏–∞–Ω—Ç " + (idx+1));
      inp.oninput = ()=>{ q.options[idx] = inp.value; };

      const del = document.createElement("button");
      del.className="btn small danger";
      del.type="button";
      del.textContent="‚úñ";
      del.onclick = ()=>{
        q.options.splice(idx,1);
        if(q.options.length < 2) q.options.push("");
        if(q.correctIndex >= q.options.length) q.correctIndex = q.options.length-1;
        renderChoiceUI();
      };

      row.appendChild(r);
      row.appendChild(inp);
      row.appendChild(del);
      list.appendChild(row);
    });
  }

  function renderTextUI(){
    const list = $("textList");
    list.innerHTML = "";
    const q = Editor.draft;
    if(!q) return;

    q.accepts = q.accepts || [""];

    q.accepts.forEach((val, idx)=>{
      const row = document.createElement("div");
      row.className = "answerRow";

      const inp = document.createElement("input");
      inp.type="text";
      inp.value = val || "";
      inp.placeholder = (idx===0) ? "‚úÖ –í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç" : ("–í–µ—Ä–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç " + (idx+1));
      inp.oninput = ()=>{ q.accepts[idx] = inp.value; };

      const del = document.createElement("button");
      del.className="btn small danger";
      del.type="button";
      del.textContent="‚úñ";
      del.onclick = ()=>{
        q.accepts.splice(idx,1);
        if(q.accepts.length === 0) q.accepts.push("");
        renderTextUI();
      };

      row.appendChild(inp);
      row.appendChild(del);
      list.appendChild(row);
    });
  }

  function openModal(existing=null){
    if(existing){
      Editor.draft = deepClone(existing);
      Editor.editingId = existing.id;
      $("modalTitle").textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å";
    } else {
      Editor.draft = {
        id: uid(),
        type: "choice",
        prompt: "",
        options: ["",""],
        correctIndex: 0
      };
      Editor.editingId = null;
      $("modalTitle").textContent = "–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å";
    }

    $("selType").value = Editor.draft.type || "choice";
    $("inpPrompt").value = Editor.draft.prompt || "";
    syncModalType();
    if($("selType").value === "choice") renderChoiceUI();
    else renderTextUI();

    showModal();
    setTimeout(()=>$("inpPrompt").focus(), 40);
  }

  function getDraftFromModal(){
    const q = Editor.draft;
    if(!q) return null;

    q.type = $("selType").value;
    q.prompt = $("inpPrompt").value || "";

    if(q.type === "choice"){
      q.options = (q.options || []).map(x=>String(x||""));
      q.correctIndex = Number.isFinite(q.correctIndex) ? q.correctIndex : 0;
    } else {
      q.accepts = (q.accepts || [""]).map(x=>String(x||""));
    }
    return q;
  }

  function validateQuestion(q){
    if(!q) return "–ü—É—Å—Ç–æ–π –≤–æ–ø—Ä–æ—Å";
    if(!(q.prompt||"").trim()) return "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞";

    if(q.type === "choice"){
      const opts = (q.options||[]).map(x=>String(x||"").trim()).filter(Boolean);
      if(opts.length < 2) return "–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞";
      q.options = opts;
      if(!Number.isFinite(q.correctIndex)) q.correctIndex = 0;
      if(q.correctIndex >= q.options.length) q.correctIndex = 0;
      return "";
    }

    const acc = (q.accepts||[]).map(x=>String(x||"").trim()).filter(Boolean);
    if(acc.length === 0) return "–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç";
    q.accepts = acc;
    return "";
  }

  function buildPayload(previewWithDraft){
    let questions = Editor.questions.map(q=>{
      if(q.type === "choice"){
        return { type:"choice", prompt:q.prompt||"", options:(q.options||[]).slice(), correctIndex:Number(q.correctIndex||0) };
      }
      return { type:"text", prompt:q.prompt||"", accepts:(q.accepts||[]).slice() };
    });

    if(previewWithDraft && Editor.draft){
      const d = deepClone(Editor.draft);
      questions = questions.slice();
      if(d.type === "choice"){
        const mapped = { type:"choice", prompt:d.prompt||"", options:(d.options||[]).slice(), correctIndex:Number(d.correctIndex||0) };
        if(questions.length === 0) questions.push(mapped);
        else questions[0] = mapped;
      } else {
        const mapped = { type:"text", prompt:d.prompt||"", accepts:(d.accepts||[]).slice() };
        if(questions.length === 0) questions.push(mapped);
        else questions[0] = mapped;
      }
    }

    // –í–∞–∂–Ω–æ: —Ä–µ–¥–∞–∫—Ç–æ—Ä –º–æ–∂–µ—Ç –æ—Ç–¥–∞—Ç—å –º–µ–Ω—å—à–µ 9 –≤–æ–ø—Ä–æ—Å–æ–≤. –ò–≥—Ä–∞ —Å–∞–º–∞ –∑–∞—Ü–∏–∫–ª–∏—Ç –∏—Ö –ø–æ –∫—Ä—É–≥—É.
    // –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ 0 ‚Äî –∏–≥—Ä–∞ –ø–æ–∫–∞–∂–µ—Ç –∑–∞–≥–ª—É—à–∫–∏.


    return normalizeCfg({
      title: Editor.title || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π",
      useRepoBg: !!Editor.useRepoBg,
      bgDataUrl: Editor.bgDataUrl || "",
      timer: { enabled: !!Editor.timer.enabled, seconds: Number(Editor.timer.seconds || 30) },
      useImages: !!Editor.useImages,
      questions
    });
  }

  function buildGameUrl(payload){
    const data = b64urlEncode(JSON.stringify(payload));
    return selfPageUrl() + "?game=" + data + "#game=" + data;
  }
  function buildIframeFromUrl(src){
    return `<iframe src="${src}" style="width:100%;height:100%;min-height:720px;border:0;border-radius:18px;overflow:hidden;background:transparent" allow="autoplay; fullscreen" allowfullscreen loading="lazy"></iframe>`;
  }

  function updatePreview(previewWithDraft){
    const payload = buildPayload(previewWithDraft);
    const data = b64urlEncode(JSON.stringify(payload));
    const src = selfPageUrl() + "?game=" + data + "&preview=1#game=" + data;
    $("livePreview").src = src;
  }

  // ==== bindings ====
  $("inpTitle").addEventListener("input", ()=>{
    Editor.title = $("inpTitle").value || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π";
    updatePreview(false);
  });

  $("chkUseRepoBg").addEventListener("change", ()=>{
    Editor.useRepoBg = $("chkUseRepoBg").checked;
    updatePreview(false);
  });

  $("fileBg").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    Editor.bgDataUrl = await fileToDataUrl(f);
    toast("–§–æ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω");
    updatePreview(false);
  });

  $("chkUseImages").addEventListener("change", ()=>{
    Editor.useImages = $("chkUseImages").checked;
    updatePreview(false);
  });

  $("chkTimer").addEventListener("change", ()=>{
    Editor.timer.enabled = $("chkTimer").checked;
    updatePreview(false);
  });

  $("inpSeconds").addEventListener("input", ()=>{
    Editor.timer.seconds = Number($("inpSeconds").value || 30);
    updatePreview(false);
  });

  $("btnAddQ").addEventListener("click", ()=>{
    if(Editor.questions.length >= 9){
      toast("–í–æ–ø—Ä–æ—Å–æ–≤ —É–∂–µ 9 üôÇ");
      return;
    }
    openModal(null);
  });

  $("btnClearQs").addEventListener("click", ()=>{
    Editor.questions = [];
    renderList();
    updatePreview(false);
    toast("–û—á–∏—â–µ–Ω–æ");
  });

  $("btnCloseModal").addEventListener("click", ()=>{
    Editor.draft=null; Editor.editingId=null; hideModal();
  });

  $("modalBackdrop").addEventListener("click", (e)=>{
    if(e.target === $("modalBackdrop")){
      Editor.draft=null; Editor.editingId=null; hideModal();
    }
  });

  $("selType").addEventListener("change", ()=>{
    const q = Editor.draft;
    if(!q) return;
    q.type = $("selType").value;
    syncModalType();
    if(q.type === "choice"){
      q.options = q.options || ["",""];
      if(typeof q.correctIndex !== "number") q.correctIndex = 0;
      renderChoiceUI();
    } else {
      q.accepts = q.accepts || [""];
      renderTextUI();
    }
  });

  $("btnAddChoice").addEventListener("click", ()=>{
    const q = Editor.draft;
    if(!q) return;
    q.options = q.options || ["",""];
    q.options.push("");
    renderChoiceUI();
  });

  $("btnAddText").addEventListener("click", ()=>{
    const q = Editor.draft;
    if(!q) return;
    q.accepts = q.accepts || [""];
    q.accepts.push("");
    renderTextUI();
  });

  $("btnPreviewDraft").addEventListener("click", ()=>{
    getDraftFromModal();
    updatePreview(true);
    toast("–ß–µ—Ä–Ω–æ–≤–∏–∫ –ø–æ–∫–∞–∑–∞–Ω –≤ –ø—Ä–µ–≤—å—é");
  });

  $("btnSaveQ").addEventListener("click", ()=>{
    const q = getDraftFromModal();
    const err = validateQuestion(q);
    if(err){ toast(err); return; }

    if(Editor.editingId){
      const idx = Editor.questions.findIndex(x=>x.id === Editor.editingId);
      if(idx >= 0){
        q.id = Editor.editingId;
        Editor.questions[idx] = q;
        toast("–í–æ–ø—Ä–æ—Å –æ–±–Ω–æ–≤–ª—ë–Ω");
      } else {
        Editor.questions.push(q);
        toast("–í–æ–ø—Ä–æ—Å –¥–æ–±–∞–≤–ª–µ–Ω");
      }
    } else {
      Editor.questions.push(q);
      toast("–í–æ–ø—Ä–æ—Å –¥–æ–±–∞–≤–ª–µ–Ω");
    }

    Editor.draft=null; Editor.editingId=null;
    hideModal();
    renderList();
    updatePreview(false);
  });

  $("btnCopyCode").addEventListener("click", async ()=>{
    if(Editor.questions.length === 0){
      toast("–ú–æ–∂–Ω–æ –∏ –±–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤: –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –∑–∞–≥–ª—É—à–∫–∏");
    }
    const payload = buildPayload(false);
    const url = buildGameUrl(payload);
    const iframeCode = buildIframeFromUrl(url);

    // show modal so you can SEE what will be pasted
    if ($("taIframe") && $("codeBackdrop")) {
      $("taIframe").value = url;
      if ($("taIframe2")) $("taIframe2").value = iframeCode;
      $("codeBackdrop").style.display = "flex";
      $("codeBackdrop").setAttribute("aria-hidden","false");
    }

    const ok = await copyToClipboard(url);
    toast(ok ? "–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ ‚úÖ" : "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
  });

  
  // iframe code modal
  function hideCodeModal(){
    if(!$("codeBackdrop")) return;
    $("codeBackdrop").style.display = "none";
    $("codeBackdrop").setAttribute("aria-hidden","true");
  }
  if ($("btnCloseCode")) $("btnCloseCode").addEventListener("click", hideCodeModal);
  if ($("codeBackdrop")) {
    $("codeBackdrop").addEventListener("click", (e)=>{
      if(e.target === $("codeBackdrop")) hideCodeModal();
    });
  }
  if ($("btnCopyFromModal")) {
    $("btnCopyFromModal").addEventListener("click", async ()=>{
      const text = ($("taIframe")?.value || "").trim();
      if(!text){ toast("–ü—É—Å—Ç–æ"); return; }
      const ok = await copyToClipboard(text);
      toast(ok ? "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ" : "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
    });
  
  if ($("btnCopyIframe")) {
    $("btnCopyIframe").addEventListener("click", async ()=>{
      const text = ($("taIframe2")?.value || "").trim();
      if(!text){ toast("–ü—É—Å—Ç–æ"); return; }
      const ok = await copyToClipboard(text);
      toast(ok ? "iframe —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω ‚úÖ" : "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
    });
  }
}

// ===== game-only mode =====
  function bootGameOnly(cfg){
    document.body.setAttribute("data-mode","game");
    document.body.classList.add("gameOnly");
    $("editorRoot").style.display = "none";
    $("modalBackdrop").style.display = "none";
    if($("codeBackdrop")) $("codeBackdrop").style.display = "none";
    $("gameRoot").style.display = "block";
    // Pass config to canvas game
    window.__BOOT_CANVAS_CFG__ = cfg;
    if(typeof window.__bootCanvasGame === "function"){
      window.__bootCanvasGame(cfg);
    }
  }

  // init (decide mode by hash)
  const qp = parseQueryParams();
  const hp = parseHashParams();
  const gameParam = qp.game || hp.game;
  if(gameParam){
    try{
      const raw = JSON.parse(b64urlDecode(gameParam));
      bootGameOnly(normalizeCfg(raw));
    }catch(e){
      const host = $("gameHost");
      $("editorRoot").style.display = "none";
      $("gameRoot").style.display = "block";
      host.innerHTML = `<div style="padding:16px;color:#ffd6d6;font-weight:900">–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ –∏–∑ iframe üòï</div>`;
    }
    return;
  }

  // editor init
  Editor.title = $("inpTitle").value || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π";
  Editor.timer.enabled = $("chkTimer").checked;
  Editor.timer.seconds = Number($("inpSeconds").value || 30);
  Editor.useImages = $("chkUseImages").checked;
  Editor.useRepoBg = $("chkUseRepoBg").checked;

  renderList();
  updatePreview(false);

// ===== Canvas game code (from original) =====
(function(){
  const __qp2 = new URLSearchParams(location.search);
  const __hasGame2 = __qp2.get("game") || (location.hash||"").includes("game=");
  if(!__hasGame2) return;
  // cfg comes from bootGameOnly
  const cfg = window.__CANVAS_GAME_CFG__ || {};
  try{
    window.__CFG = { title: cfg.title || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π", questions: cfg.questions || [] };
  }catch(e){ window.__CFG = { title:"–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π", questions:[] }; }
let __CFG = {title:'–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π', questions: []};

/** –§–ê–ô–õ–´ */
const BG_FILE = "1.png";
const BLOCK_FILES = ["3.png","4.png","5.png","6.png","7.png","8.png","9.png","10.png","11.png"];

/** –û–ß–ö–ò */
const SCORE_PER_BLOCK = 100;

/* QUESTIONS injected from cfg */
let QUESTIONS = [];

/** –î–∏–Ω–∞–º–∏–∫–∞ */
const FALL_SPEED = 620;
const DROP_SPEED = 900;

/** –≠—Ñ—Ñ–µ–∫—Ç—ã */
const SHAKE_ON_BOOM = 18;
const SHAKE_ON_LAND = 7;

/** –ü—Ä–æ–≥—Ä–µ—Å—Å */
const TARGET_BLOCKS_FOR_100 = 9;

/** –í–ª–µ–∑–∞–Ω–∏–µ */
const SAFE_TOP_MARGIN = 86;
const SAFE_BOTTOM_MARGIN = 100;
const DESIRED_TOWER_WIDTH = () => Math.min(window.innerWidth * 0.38, 360);

/** TRIM/PROFILE */
const TRIM_ALPHA_MIN = 34;
const PROFILE_ALPHA_MIN = 22;
const CENTROID_ALPHA_MIN = 24;

/** –ü—Ä—É–∂–∏–Ω—è—â–∏–π ‚Äúbounce‚Äù –ø—Ä–∏ –ø—Ä–∏–∑–µ–º–ª–µ–Ω–∏–∏ */
const LAND_BOUNCE_UP = 10;      // px –≤–≤–µ—Ä—Ö –ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –ø—Ä–∏–∂–∞—Ç–∏–µ–º
const LAND_BOUNCE_TIME = 0.10;  // —Å–µ–∫

const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

const overlay = document.getElementById("overlay");
const qEl = document.getElementById("q");
const badgeEl = document.getElementById("badge");
const answersEl = document.getElementById("answers");
const inputRow = document.getElementById("inputRow");
const ansInput = document.getElementById("ansInput");
const submitBtn = document.getElementById("submit");
const msgEl = document.getElementById("msg");

const startLayer = document.getElementById("start");
const playBtn = document.getElementById("play");

const finishLayer = document.getElementById("finish");
const finishScoreEl = document.getElementById("finishScore");
const stCorrect = document.getElementById("stCorrect");
const stWrong = document.getElementById("stWrong");
const stHeight = document.getElementById("stHeight");
const restartBtn = document.getElementById("restart");

const errBox = document.getElementById("err");
const errList = document.getElementById("errList");

const heightTxt = document.getElementById("heightTxt");
const remainNum = document.getElementById("remainNum");
const pctTxt = document.getElementById("pct");
const barFill = document.querySelector("#bar > div");

const scoreNum = document.getElementById("scoreNum");
const nextBtn = document.getElementById("nextBtn");

let W=0,H=0,DPR=1;
function resize(){
  DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
  W = Math.floor(window.innerWidth);
  H = Math.floor(window.innerHeight);
  canvas.width = W * DPR;
  canvas.height = H * DPR;
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener("resize", resize);
resize();

/** Audio */
let audioCtx=null;
function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function playBoom(){
  ensureAudio();
  const t = audioCtx.currentTime;

  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type="sawtooth";
  osc.frequency.setValueAtTime(120,t);
  osc.frequency.exponentialRampToValueAtTime(38,t+0.22);
  gain.gain.setValueAtTime(0.0001,t);
  gain.gain.exponentialRampToValueAtTime(0.50,t+0.02);
  gain.gain.exponentialRampToValueAtTime(0.0001,t+0.34);

  const noiseBuf = audioCtx.createBuffer(1, audioCtx.sampleRate*0.30, audioCtx.sampleRate);
  const data = noiseBuf.getChannelData(0);
  for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*0.95;
  const noise = audioCtx.createBufferSource(); noise.buffer=noiseBuf;
  const nGain = audioCtx.createGain();
  nGain.gain.setValueAtTime(0.0001,t);
  nGain.gain.exponentialRampToValueAtTime(0.40,t+0.01);
  nGain.gain.exponentialRampToValueAtTime(0.0001,t+0.30);

  const filter = audioCtx.createBiquadFilter();
  filter.type="lowpass";
  filter.frequency.setValueAtTime(1700,t);
  filter.frequency.exponentialRampToValueAtTime(320,t+0.26);

  osc.connect(gain).connect(audioCtx.destination);
  noise.connect(filter).connect(nGain).connect(audioCtx.destination);

  osc.start(t); osc.stop(t+0.36);
  noise.start(t); noise.stop(t+0.32);
}
function playGood(){
  ensureAudio();
  const t = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type="triangle";
  osc.frequency.setValueAtTime(420,t);
  osc.frequency.exponentialRampToValueAtTime(780,t+0.12);
  gain.gain.setValueAtTime(0.0001,t);
  gain.gain.exponentialRampToValueAtTime(0.20,t+0.02);
  gain.gain.exponentialRampToValueAtTime(0.0001,t+0.18);
  osc.connect(gain).connect(audioCtx.destination);
  osc.start(t); osc.stop(t+0.2);
}

/** Assets */
function assetUrl(file){ return new URL(file, new URL(".", window.location.href)).toString(); }
function loadImage(url){
  return new Promise((resolve, reject)=>{
    const img=new Image();
    img.onload=()=>resolve(img);
    img.onerror=()=>reject(new Error(url));
    img.src=url;
  });
}

/** –ü—Ä–æ—Ñ–∏–ª–∏ */
function buildTopBottomProfiles(imageData, w, h){
  const d = imageData.data;
  const top = new Array(w).fill(h);
  const bottom = new Array(w).fill(-1);

  for(let x=0;x<w;x++){
    for(let y=0;y<h;y++){
      const a = d[(y*w + x)*4 + 3];
      if(a >= PROFILE_ALPHA_MIN){ top[x]=y; break; }
    }
    for(let y=h-1;y>=0;y--){
      const a = d[(y*w + x)*4 + 3];
      if(a >= PROFILE_ALPHA_MIN){ bottom[x]=y; break; }
    }
    if(bottom[x] < 0){ bottom[x] = h-1; }
    if(top[x] >= h){ top[x] = 0; }
  }
  return { top, bottom };
}

function trimAndCentroidAndProfiles(img){
  const c=document.createElement("canvas");
  c.width=img.width; c.height=img.height;
  const g=c.getContext("2d");
  g.drawImage(img,0,0);

  const im=g.getImageData(0,0,c.width,c.height);
  const d=im.data;

  let minX=c.width, minY=c.height, maxX=-1, maxY=-1;
  let sumA=0, sumX=0, sumY=0;

  for(let y=0;y<c.height;y++){
    for(let x=0;x<c.width;x++){
      const a = d[(y*c.width + x)*4 + 3];
      if(a >= TRIM_ALPHA_MIN){
        if(x<minX) minX=x;
        if(y<minY) minY=y;
        if(x>maxX) maxX=x;
        if(y>maxY) maxY=y;
      }
      if(a >= CENTROID_ALPHA_MIN){
        const wgt=a;
        sumA += wgt;
        sumX += x*wgt;
        sumY += y*wgt;
      }
    }
  }

  if(maxX<0 || maxY<0){
    return Promise.resolve({ img, w: img.width, h: img.height, cx: img.width/2, cy: img.height/2, top:null, bottom:null });
  }

  const w = (maxX-minX+1);
  const h = (maxY-minY+1);

  const outC=document.createElement("canvas");
  outC.width=w; outC.height=h;
  const og=outC.getContext("2d");
  og.drawImage(c, minX, minY, w, h, 0, 0, w, h);

  const cropped = og.getImageData(0,0,w,h);
  const { top, bottom } = buildTopBottomProfiles(cropped, w, h);

  let cx=w/2, cy=h/2;
  if(sumA>0){
    cx = (sumX/sumA) - minX;
    cy = (sumY/sumA) - minY;
  }

  const out=new Image();
  out.src=outC.toDataURL("image/png");
  return new Promise((res,rej)=>{
    out.onload=()=>res({ img: out, w, h, cx, cy, top, bottom });
    out.onerror=rej;
  });
}


function applyTitle(title){
  const t = String(title || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π");
  document.title = t;
  const h1 = document.querySelector("#startCard h1");
  if(h1) h1.textContent = t;
}
/** State */
const state = {
  running:false,
  bg:null,
  blocks:[],
  towerScale:1,

  tower:[],
  current:null,

  particles:[],
  smokes:[],
  rings:[],
  sparks:[],
  flash:0,

  cameraShake:0,
  cameraX:0, cameraY:0,

  towerOffsetY:0,
  towerOffsetV:0,

  questionIndex:0,
  waitingAnswer:false,
  dropping:false,

  blockIndex:0,
  readyForNext:false,

  finished:false,

  score:0,
  scoreFloats:[],

  correct:0,
  wrong:0,

  // bounce state
  landingBounce: null, // {fromY,toY,age,dur}
};

/** HUD helpers */
function setNextEnabled(on){
  state.readyForNext = on;
  nextBtn.disabled = !on;
}
function updateRemain(){
  const remain = Math.max(0, 9 - state.questionIndex);
  remainNum.textContent = String(remain);
}

function groundY(){
  return H - 70 + state.towerOffsetY;
}
function alignedXForIdx(idx){
  const b = state.blocks[idx];
  const cxScaled = b.cx * state.towerScale;
  return (W/2) - cxScaled;
}
function blockSize(idx){
  const b = state.blocks[idx];
  return { w: b.w*state.towerScale, h: b.h*state.towerScale };
}
function computeTowerScale(blocks){
  const maxW = Math.max(...blocks.map(b => b.w));
  const totalH = blocks.reduce((s,b)=>s+b.h,0);
  const scaleByWidth = DESIRED_TOWER_WIDTH() / maxW;
  const availableH = Math.max(220, H - SAFE_TOP_MARGIN - SAFE_BOTTOM_MARGIN);
  const scaleByHeight = availableH / totalH;
  return Math.min(scaleByWidth, scaleByHeight);
}

/** –ü–∏–∫—Å–µ–ª—å–Ω–æ —Ç–æ—á–Ω—ã–π —Å—Ç–µ–∫ */
function computeStackY(upper, lower){
  const su = state.towerScale;
  const upperMeta = state.blocks[upper.idx];
  const lowerMeta = state.blocks[lower.idx];

  const overlapLeft = Math.max(upper.x, lower.x);
  const overlapRight = Math.min(upper.x + upper.w, lower.x + lower.w);

  if(overlapRight <= overlapLeft + 2){
    return Math.round(lower.y - upper.h);
  }

  let yMaxAllowed = Infinity;
  const step = 2;

  for(let wx = overlapLeft; wx <= overlapRight; wx += step){
    const xu = Math.floor((wx - upper.x) / su);
    const xl = Math.floor((wx - lower.x) / su);
    if(xu < 0 || xu >= upperMeta.w) continue;
    if(xl < 0 || xl >= lowerMeta.w) continue;

    const bu = upperMeta.bottom[xu];
    const tl = lowerMeta.top[xl];

    const allowed = lower.y + tl*su - bu*su;
    if(allowed < yMaxAllowed) yMaxAllowed = allowed;
  }
  // –ø–ª–æ—Ç–Ω–µ–µ –±–µ–∑ —â–µ–ª–µ–π
  return Math.round(yMaxAllowed) - 1;
}

/** spawn */
function spawnBlock(){
  if(state.finished) return;
  if(state.blockIndex >= 9){ finishGame(); return; }

  const idx = state.blockIndex;
  const {w,h} = blockSize(idx);

  state.current = { idx, w,h, x: alignedXForIdx(idx), y: -h - 30, char:0 };
  state.dropping=false;
  state.waitingAnswer=false;
  state.landingBounce=null;
  setNextEnabled(false);
}

/** score pop */
function addScorePop(x,y, text){
  state.scoreFloats.push({
    x, y,
    vx: (Math.random()*2-1)*30,
    vy: -160 - Math.random()*60,
    life: 0.85,
    age: 0,
    text
  });
}

/** sparks at seam */
function sparksAtSeam(x, y){
  for(let i=0;i<18;i++){
    const a = (-Math.PI/2) + (Math.random()*Math.PI*0.9 - Math.PI*0.45);
    const sp = 220 + Math.random()*360;
    state.sparks.push({
      x: x + (Math.random()*40 - 20),
      y: y + (Math.random()*6 - 3),
      vx: Math.cos(a)*sp,
      vy: Math.sin(a)*sp - (40+Math.random()*60),
      life: 0.45 + Math.random()*0.2,
      age: 0
    });
  }
}

/** smoke/dust */
function dustAt(x,y){
  for(let i=0;i<10;i++){
    const a=Math.random()*Math.PI*2;
    const sp=30+Math.random()*110;
    state.smokes.push({
      x:x + (Math.random()*18-9),
      y:y + (Math.random()*10-5),
      vx:Math.cos(a)*sp,
      vy:Math.sin(a)*sp - (30+Math.random()*40),
      life:0.55+Math.random()*0.35,
      age:0,
      rad: 10+Math.random()*14
    });
  }
}

/** settle with bounce */
function settleCurrentBlock(){
  const b = state.current;

  let yFinal;
  if(state.tower.length===0){
    yFinal = Math.round(groundY() - b.h);
  } else {
    const lower = state.tower[state.tower.length - 1];
    yFinal = computeStackY(b, lower);
  }

  // bounce: —Å–Ω–∞—á–∞–ª–∞ —á—É—Ç—å –≤—ã—à–µ, –ø–æ—Ç–æ–º –≤–Ω–∏–∑ –≤ —Ñ–∏–Ω–∞–ª
  const yUp = Math.max(-200, yFinal - LAND_BOUNCE_UP);
  state.landingBounce = { fromY: yUp, toY: yFinal, age: 0, dur: LAND_BOUNCE_TIME };

  b.x = Math.round(b.x);
  b.y = yUp;

  // –ó–∞–ø–æ–º–Ω–∏–º –≤—Ä–µ–º–µ–Ω–Ω–æ ‚Äú—Å–æ–±–∏—Ä–∞–µ–º—ã–π‚Äù –±–ª–æ–∫, –¥–æ–±–∞–≤–∏–º –≤ –±–∞—à–Ω—é —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ bounce
}

/** finalize land */
function finalizeLand(){
  const b = state.current;
  if(!b) return;

  // –∏—Å–∫—Ä—ã –∏–∑ —à–≤–∞ (x –ø–æ —Ü–µ–Ω—Ç—Ä—É –±–∞—à–Ω–∏, y –Ω–∞ —Å—Ç—ã–∫–µ)
  const seamY = b.y + b.h;
  sparksAtSeam(W/2, seamY);

  state.tower.push({
    x: Math.round(b.x),
    y: Math.round(b.y),
    w: b.w, h: b.h, idx: b.idx,
    squash:1.0, squashV:0.0
  });

  // –æ—á–∫–∏
  state.score += SCORE_PER_BLOCK;
  scoreNum.textContent = String(state.score);
  addScorePop(W/2 + 70, b.y + 30, `+${SCORE_PER_BLOCK}`);

  dustAt(W/2, seamY);
  state.cameraShake = Math.max(state.cameraShake, SHAKE_ON_LAND);
  state.towerOffsetV -= 120;

  state.current = null;
}

/** boom + scorch */
function boomAt(block){
  const cx = block.x + block.w/2;
  const cy = block.y + block.h/2;

  state.flash = Math.min(1, state.flash + 0.95);
  state.rings.push({ x:cx, y:cy, r:10, vr: 900, life:0.45, age:0 });

  for(let i=0;i<44;i++){
    const a=Math.random()*Math.PI*2;
    const sp=160+Math.random()*720;
    state.particles.push({
      x:cx,y:cy,
      vx:Math.cos(a)*sp,
      vy:Math.sin(a)*sp-(260+Math.random()*360),
      life:0.55+Math.random()*0.35,
      age:0,
      r:2+Math.random()*4
    });
  }

  for(let i=0;i<14;i++){
    const a=Math.random()*Math.PI*2;
    const sp=50+Math.random()*210;
    state.smokes.push({
      x:cx,y:cy,
      vx:Math.cos(a)*sp,
      vy:Math.sin(a)*sp-(90+Math.random()*120),
      life:1.1+Math.random()*0.8,
      age:0,
      rad: 22+Math.random()*26
    });
  }

  state.cameraShake = Math.max(state.cameraShake, SHAKE_ON_BOOM);
  playBoom();
}

/** finish */
function finishGame(){
  state.finished = true;
  setNextEnabled(false);

  finishScoreEl.textContent = String(state.score);
  stCorrect.textContent = String(state.correct);
  stWrong.textContent = String(state.wrong);
  stHeight.textContent = String(state.tower.length);

  finishLayer.style.display="flex";
}

/** restart */
restartBtn.addEventListener("click", async ()=>{
  finishLayer.style.display="none";
  startLayer.style.display="flex";
});

/** card show/hide with animation */
function showOverlayAnimated(){
  overlay.style.display="flex";
  requestAnimationFrame(()=> overlay.classList.add("show"));
}
function hideOverlayAnimated(){
  overlay.classList.remove("show");
  setTimeout(()=>{ overlay.style.display="none"; }, 140);
}

/** Update */
function update(dt){
  if(!state.running) return;

  // remain
  updateRemain();

  // camera shake
  if(state.cameraShake>0){
    state.cameraShake=Math.max(0, state.cameraShake - dt*22);
    const s=state.cameraShake;
    state.cameraX=(Math.random()*2-1)*s;
    state.cameraY=(Math.random()*2-1)*s;
  } else {
    state.cameraX=0; state.cameraY=0;
  }

  state.flash = Math.max(0, state.flash - dt*3.8);

  // ground spring
  {
    const k=55, damp=10;
    const a = -k*(state.towerOffsetY) - damp*state.towerOffsetV;
    state.towerOffsetV += a*dt;
    state.towerOffsetY += state.towerOffsetV*dt;
    state.towerOffsetY = Math.max(-10, Math.min(10, state.towerOffsetY));
  }

  // tower squash
  for(const b of state.tower){
    const k=40, damp=8;
    const a=-k*(b.squash-1)-damp*b.squashV;
    b.squashV += a*dt;
    b.squash  += b.squashV*dt;
    b.squash = Math.max(0.88, Math.min(1.08, b.squash));
  }

  // particles
  for(const p of state.particles){
    p.age += dt; p.vy += 980*dt; p.x += p.vx*dt; p.y += p.vy*dt;
  }
  state.particles = state.particles.filter(p => p.age < p.life);

  // smoke
  for(const s of state.smokes){
    s.age += dt; s.vy += 120*dt; s.x += s.vx*dt; s.y += s.vy*dt;
  }
  state.smokes = state.smokes.filter(s => s.age < s.life);

  // ring
  for(const r of state.rings){
    r.age += dt; r.r += r.vr*dt;
  }
  state.rings = state.rings.filter(r => r.age < r.life);

  // sparks
  for(const sp of state.sparks){
    sp.age += dt;
    sp.vy += 980*dt;
    sp.x += sp.vx*dt;
    sp.y += sp.vy*dt;
    sp.vx *= (1 - dt*1.8);
  }
  state.sparks = state.sparks.filter(s => s.age < s.life);

  // score floats
  for(const f of state.scoreFloats){
    f.age += dt; f.vy += 260*dt; f.x += f.vx*dt; f.y += f.vy*dt;
  }
  state.scoreFloats = state.scoreFloats.filter(f => f.age < f.life);

  // bounce step
  if(state.landingBounce && state.current){
    const bb = state.landingBounce;
    bb.age += dt;
    const t = Math.min(1, bb.age / bb.dur);
    // easing
    const ease = 1 - Math.pow(1 - t, 3);
    state.current.y = Math.round(bb.fromY + (bb.toY - bb.fromY)*ease);

    // —á—É—Ç—å ‚Äú—Å–∂–∞—Ç–∏–µ‚Äù –Ω–∏–∂–Ω–µ–≥–æ –±–ª–æ–∫–∞
    if(state.tower.length>0){
      const last = state.tower[state.tower.length-1];
      last.squashV += 14 * dt;
    }

    if(t >= 1){
      state.landingBounce = null;
      // —Ñ–∏–Ω–∞–ª—å–Ω—ã–π y —É–∂–µ —Å—Ç–æ–∏—Ç, —Ñ–∏–∫—Å–∏—Ä—É–µ–º –±–ª–æ–∫ –∫–∞–∫ —ç—Ç–∞–∂
      finalizeLand();
      setNextEnabled(true);
    }
  }

  // current block movement
  if(state.current && !state.landingBounce){
    const b = state.current;

    if(state.waitingAnswer){
      // wait
    } else if(state.dropping){
      let yTarget;
      if(state.tower.length===0){
        yTarget = groundY() - b.h;
      } else {
        const lower = state.tower[state.tower.length - 1];
        yTarget = computeStackY(b, lower);
      }

      b.y += DROP_SPEED*dt;
      if(b.y >= yTarget){
        b.y = yTarget;
        // –Ω–∞—á–∏–Ω–∞–µ–º bounce
        settleCurrentBlock();
      }
    } else {
      // stop before question
      const topY = (state.tower.length===0 ? groundY() : state.tower[state.tower.length-1].y);
      const stopY = Math.max(80, topY - b.h - 18);
      b.y += FALL_SPEED*dt;
      if(b.y>=stopY){
        b.y=stopY;
        state.waitingAnswer=true;
        showQuestion();
      }
    }
  }

  // hud progress
  heightTxt.textContent = String(state.tower.length);
  const pct = Math.max(0, Math.min(100, Math.round((state.tower.length / TARGET_BLOCKS_FOR_100)*100)));
  pctTxt.textContent = pct + "%";
  barFill.style.width = pct + "%";
}

/** Draw */
function drawBackground(){
  if(state.bg){
    const img=state.bg;
    const scale=Math.max(W/img.width,H/img.height);
    const dw=img.width*scale, dh=img.height*scale;
    ctx.drawImage(img,(W-dw)/2,(H-dh)/2,dw,dh);
  } else {
    ctx.fillStyle="#0b0f18"; ctx.fillRect(0,0,W,H);
  }
  const grd=ctx.createRadialGradient(W*0.5,H*0.45,60, W*0.5,H*0.5, Math.max(W,H)*0.7);
  grd.addColorStop(0,"rgba(0,0,0,0)");
  grd.addColorStop(1,"rgba(0,0,0,0.45)");
  ctx.fillStyle=grd; ctx.fillRect(0,0,W,H);

  ctx.fillStyle="rgba(0,0,0,.35)";
  ctx.fillRect(0,H-70,W,70);
}

function drawBlock(o, glow=false, squash=1.0, char=0){
  const img = state.blocks[o.idx].img;

  ctx.save();
  ctx.shadowColor = glow ? "rgba(120,190,255,.35)" : "rgba(0,0,0,.45)";
  ctx.shadowBlur  = glow ? 18 : 14;

  const cx = o.x + o.w/2;
  const cy = o.y + o.h;
  const sx = 1 + (1 - squash) * 0.35;
  const sy = squash;

  ctx.translate(cx, cy);
  ctx.scale(sx, sy);
  ctx.translate(-cx, -cy);

  ctx.drawImage(img, o.x, o.y, o.w, o.h);

  // —ç—Ñ—Ñ–µ–∫—Ç –æ–±—É–≥–ª–∏–≤–∞–Ω–∏—è (—á–µ—Ä–Ω–∞—è –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –º–∞—Å–∫–∞)
  if(char > 0){
    ctx.globalCompositeOperation = "source-atop";
    ctx.fillStyle = `rgba(0,0,0,${0.70*char})`;
    ctx.fillRect(o.x-2, o.y-2, o.w+4, o.h+4);

    // —á—É—Ç—å –∫—Ä–∞—Å–Ω–æ–≤–∞—Ç–æ–≥–æ ‚Äú–∂–∞—Ä–∞‚Äù
    ctx.globalCompositeOperation = "screen";
    ctx.fillStyle = `rgba(255,120,60,${0.10*char})`;
    ctx.fillRect(o.x-2, o.y-2, o.w+4, o.h+4);

    ctx.globalCompositeOperation = "source-over";
  }

  ctx.restore();
}

function drawScorePops(){
  for(const f of state.scoreFloats){
    const t = f.age / f.life;
    const a = Math.max(0, 1 - t);
    const s = 1 + (1 - a) * 0.15;

    ctx.save();
    ctx.globalAlpha = a;
    ctx.translate(f.x, f.y);
    ctx.scale(s, s);

    ctx.font = "900 22px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.lineWidth = 5;
    ctx.strokeStyle = "rgba(0,0,0,.35)";
    ctx.strokeText(f.text, 0, 0);
    ctx.fillStyle = "rgba(120,255,170,.95)";
    ctx.fillText(f.text, 0, 0);

    ctx.restore();
  }
}

function draw(){
  ctx.clearRect(0,0,W,H);

  ctx.save();
  ctx.translate(state.cameraX, state.cameraY);

  drawBackground();

  for(const b of state.tower){
    drawBlock(b, false, b.squash, 0);
  }

  if(state.current){
    drawBlock(state.current, true, 1.0, state.current.char || 0);
  }

  // smoke
  for(const s of state.smokes){
    const t = s.age / s.life;
    const a = (1 - t) * 0.35;
    const r = s.rad * (1 + t*1.25);
    ctx.fillStyle = `rgba(20,20,20,${a})`;
    ctx.beginPath();
    ctx.arc(s.x, s.y, r, 0, Math.PI*2);
    ctx.fill();
  }

  // ring
  for(const r of state.rings){
    const t = r.age / r.life;
    const a = (1 - t) * 0.55;
    ctx.strokeStyle = `rgba(255,255,255,${a})`;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(r.x, r.y, r.r, 0, Math.PI*2);
    ctx.stroke();
  }

  // sparks
  for(const sp of state.sparks){
    const t = sp.age / sp.life;
    const a = Math.max(0, 1 - t);
    ctx.strokeStyle = `rgba(255, 220, 140, ${0.9*a})`;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(sp.x, sp.y);
    ctx.lineTo(sp.x - sp.vx*0.012, sp.y - sp.vy*0.012);
    ctx.stroke();
  }

  // particles
  for(const p of state.particles){
    const a = 1 - (p.age/p.life);
    ctx.fillStyle = `rgba(255, 200, 120, ${0.78*a})`;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    ctx.fill();
  }

  drawScorePops();

  if(state.flash>0){
    ctx.fillStyle = `rgba(255,255,255,${state.flash*0.22})`;
    ctx.fillRect(0,0,W,H);
  }

  ctx.restore();
  requestAnimationFrame(draw);
}

let lastT=0;
function loop(t){
  if(!lastT) lastT=t;
  const dt=Math.min(0.033,(t-lastT)/1000);
  lastT=t;
  update(dt);
  requestAnimationFrame(loop);
}

/** Questions */
function normalizeAnswer(s){ return String(s??"").trim().toLowerCase(); }

function showQuestion(){
  const qi = state.questionIndex;
  const q = QUESTIONS[qi % QUESTIONS.length];

  msgEl.textContent="";
  answersEl.innerHTML="";
  inputRow.style.display="none";
  answersEl.style.display="flex";

  qEl.textContent=q.q;
  badgeEl.textContent=`${qi+1} / 9`;

  if(q.type==="choice"){
    for(const opt of q.options){
      const btn=document.createElement("button");
      btn.className="btn";
      btn.textContent=opt;
      btn.addEventListener("click", ()=>checkAnswer(opt));
      answersEl.appendChild(btn);
    }
  } else {
    answersEl.style.display="none";
    inputRow.style.display="flex";
    ansInput.value="";
  }

  showOverlayAnimated();
  setTimeout(()=>{ if(q.type==="input") ansInput.focus(); }, 50);
}

function checkAnswer(userValue){
  const qi = state.questionIndex;
  const q = QUESTIONS[qi % QUESTIONS.length];
  let ok=false;
  if(q.type==="choice"){
    ok = normalizeAnswer(userValue) === normalizeAnswer(q.answer);
  } else {
    const acc = (q.accepts && q.accepts.length) ? q.accepts : [q.answer];
    ok = acc.map(normalizeAnswer).includes(normalizeAnswer(userValue));
  }
  const waitingBlock = state.current;

  if(ok){
    state.correct++;
    msgEl.innerHTML = `<span style="color: var(--good); font-weight:900;">–í–µ—Ä–Ω–æ!</span> –ë–ª–æ–∫ –æ–ø—É—Å–∫–∞–µ—Ç—Å—è (+100).`;
    playGood();
    state.dropping = false;

    setTimeout(()=>{
      hideOverlayAnimated();
      state.waitingAnswer = false;
      if(state.current) state.dropping = true;
      else setNextEnabled(true);
    }, 220);

  } else {
    state.wrong++;
    msgEl.innerHTML = `<span style="color: var(--bad); font-weight:900;">–ù–µ–≤–µ—Ä–Ω–æ!</span> –ë–ª–æ–∫ –æ–±—É–≥–ª–∏–≤–∞–µ—Ç—Å—è –∏ –∏—Å—á–µ–∑–∞–µ—Ç.`;
    state.dropping = false;

    // –æ–±—É–≥–ª–∏–≤–∞–Ω–∏–µ (0.35 —Å–µ–∫), –ø–æ—Ç–æ–º –≤–∑—Ä—ã–≤ –∏ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ
    const scorchDur = 0.35;
    let elapsed = 0;

    function scorchStep(){
      if(!state.current || state.current !== waitingBlock) return;
      elapsed += 1/60;
      state.current.char = Math.min(1, elapsed / scorchDur);
      // –Ω–µ–º–Ω–æ–≥–æ –¥—ã–º–∞
      if(Math.random() < 0.25){
        state.smokes.push({
          x: waitingBlock.x + waitingBlock.w/2 + (Math.random()*30-15),
          y: waitingBlock.y + waitingBlock.h/2 + (Math.random()*20-10),
          vx: (Math.random()*2-1)*40,
          vy: -80 - Math.random()*80,
          life:0.6+Math.random()*0.4,
          age:0,
          rad: 14+Math.random()*18
        });
      }
      if(elapsed < scorchDur){
        requestAnimationFrame(scorchStep);
      }
    }
    requestAnimationFrame(scorchStep);

    setTimeout(()=>{
      hideOverlayAnimated();
      state.waitingAnswer = false;

      if(waitingBlock && waitingBlock === state.current){
        boomAt(waitingBlock);
      }
      state.current = null;

      setNextEnabled(true);
    }, 520);
  }

  state.blockIndex++;
}

submitBtn.addEventListener("click", ()=>checkAnswer(ansInput.value));
ansInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter") checkAnswer(ansInput.value); });
document.addEventListener("keydown",(e)=>{
  if(overlay.style.display==="flex" && e.key==="Enter"){
    const qi=state.questionIndex;
    if(QUESTIONS[qi].type==="input") checkAnswer(ansInput.value);
  }
});

/** Next */
nextBtn.addEventListener("click", ()=>{
  if(nextBtn.disabled) return;

  state.questionIndex++;
  if(state.questionIndex >= 9){
    finishGame();
    return;
  }
  spawnBlock();
});


function buildQuestionsFromCfg(cfg){
  const src = Array.isArray(cfg?.questions) ? cfg.questions : [];
  if(src.length === 0){
    // fallback placeholders
    return Array.from({length:9}, (_,i)=>({
      type:"choice",
      q:`(–≤–æ–ø—Ä–æ—Å ${i+1})`,
      options:["OK","..."],
      answer:"OK"
    }));
  }
  // Map editor schema -> game schema
  const mapped = src.map((q,i)=>{
    if(q && (q.type==="text" || q.type==="input")){
      const accepts = Array.isArray(q.accepts) ? q.accepts : (Array.isArray(q.acceptsRaw) ? q.acceptsRaw : (Array.isArray(q.accepts) ? q.accepts : []));
      const acc2 = Array.isArray(q.accepts) ? q.accepts : [];
      const fromEditor = Array.isArray(q.accepts) ? q.accepts : (Array.isArray(q.accepts) ? q.accepts : []);
      const a = Array.isArray(q.accepts) ? q.accepts : [];
      // We'll read editor format: {type:"text", prompt, accepts:[...]}
      const acc = Array.isArray(q.accepts) ? q.accepts : [];
      return { type:"input", q:String(q.prompt||q.q||""), accepts: acc.map(String), answer: String(acc[0]||"") };
    }
    // choice
    const opts = Array.isArray(q.options) ? q.options.map(String) : (Array.isArray(q.optionsRaw)?q.optionsRaw.map(String):[]);
    const ci = Number.isFinite(q.correctIndex) ? q.correctIndex : 0;
    const ans = (opts[ci] ?? opts[0] ?? "OK");
    return { type:"choice", q:String(q.prompt||q.q||""), options: opts.length?opts:["OK","..."], answer: String(ans) };
  });

  // Ensure we have at least 1
  if(mapped.length === 0){
    return Array.from({length:9}, (_,i)=>({type:"choice", q:`(–≤–æ–ø—Ä–æ—Å ${i+1})`, options:["OK","..."], answer:"OK"}));
  }
  // For gameplay we need QUESTIONS.length >0; we'll cycle for 9 steps
  return mapped;
}
/** Start / Load */
async function startGame(){
  applyTitle(__CFG.title);
  QUESTIONS = buildQuestionsFromCfg(__CFG);

  errBox.style.display="none";
  errList.innerHTML="";

  ensureAudio();
  if(audioCtx.state==="suspended"){ try{ await audioCtx.resume(); }catch{} }

  Object.assign(state, {
    running:false, bg:null, blocks:[], towerScale:1,
    tower:[], current:null,
    particles:[], smokes:[], rings:[], sparks:[], flash:0,
    cameraShake:0, cameraX:0, cameraY:0,
    towerOffsetY:0, towerOffsetV:0,
    questionIndex:0, waitingAnswer:false, dropping:false,
    blockIndex:0, readyForNext:false,
    finished:false,
    score:0,
    scoreFloats:[],
    correct:0,
    wrong:0,
    landingBounce:null,
  });
  scoreNum.textContent = "0";
  setNextEnabled(false);
  updateRemain();

  const missing=[];

  try{ state.bg = await loadImage(assetUrl(BG_FILE)); }
  catch{ missing.push(BG_FILE); }

  const blocks=[];
  for(const f of BLOCK_FILES){
    try{
      const raw = await loadImage(assetUrl(f));
      const t = await trimAndCentroidAndProfiles(raw);
      blocks.push({ file:f, img:t.img, w:t.w, h:t.h, cx:t.cx, cy:t.cy, top:t.top, bottom:t.bottom });
    } catch {
      missing.push(f);
    }
  }

  if(missing.length){
    errBox.style.display="block";
    for(const f of missing){
      const li=document.createElement("li");
      li.textContent = f + " (–Ω–µ –Ω–∞–π–¥–µ–Ω/–Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è)";
      errList.appendChild(li);
    }
    return;
  }

  state.towerScale = computeTowerScale(blocks);
  state.blocks = blocks;

  state.running = true;

  spawnBlock(); // –ø–µ—Ä–≤—ã–π –±–ª–æ–∫ —Å–∞–º
}

playBtn.addEventListener("click", async ()=>{
  startLayer.style.display="none";
  await startGame();
});

// auto-start for iframe preview
const __qp = new URLSearchParams(location.search);
if(__qp.get("preview")==="1"){
  startLayer.style.display="none";
  setTimeout(()=>startGame(), 50);
}

requestAnimationFrame(loop);
requestAnimationFrame(draw);

})();

})();
</script>
</body>
</html>
