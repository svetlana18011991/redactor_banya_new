<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gold Tower Builder</title>
<style>
  /* --- STYLES FOR EDITOR UI --- */
  :root { --bg: #050505; --panel: #0f1219; --gold: #d4af37; --text: #e2e8f0; --border: #333; }
  body { margin:0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }
  
  /* Left Panel */
  .editor { width: 450px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; box-shadow: 5px 0 30px #000; }
  .header { padding: 15px 20px; border-bottom: 1px solid var(--gold); background: #0a0c10; display:flex; justify-content:space-between; align-items:center; }
  .h-title { color: var(--gold); font-weight: 900; letter-spacing: 2px; text-transform: uppercase; font-size:18px; }
  
  .scroll-area { flex: 1; overflow-y: auto; padding: 20px; }
  .section { margin-bottom: 25px; padding: 15px; border: 1px solid #222; border-radius: 8px; background: rgba(255,255,255,0.02); }
  .sec-label { color: #888; font-size: 11px; text-transform: uppercase; font-weight: bold; margin-bottom: 10px; display:block; }

  /* Inputs & Buttons */
  input, textarea, select { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 4px; box-sizing: border-box; font-size: 14px; margin-bottom: 10px; }
  input:focus { border-color: var(--gold); outline: none; }
  
  button { cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; }
  .btn-gold { background: linear-gradient(135deg, #b8860b, #d4af37); color: #000; padding: 8px 20px; text-transform: uppercase; font-size: 12px; }
  .btn-gold:hover { filter: brightness(1.2); }
  .btn-add { width: 100%; padding: 12px; background: rgba(212, 175, 55, 0.1); border: 1px dashed var(--gold); color: var(--gold); }
  .btn-add:hover { background: var(--gold); color: #000; }
  
  .q-item { background: #1a1d26; padding: 10px; border-radius: 4px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; border-left: 2px solid transparent; }
  .q-item:hover { border-left-color: var(--gold); }
  
  /* Right Preview */
  .preview { flex: 1; background: #000; position: relative; display: flex; flex-direction: column; }
  .preview-bar { height: 30px; background: #111; color: #555; display: flex; align-items: center; justify-content: center; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; border-bottom: 1px solid #333; }
  iframe { flex: 1; width: 100%; border: none; background: #000; }

  /* Modal */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; }
  .modal { background: #111; width: 500px; border: 1px solid var(--gold); border-radius: 8px; padding: 20px; box-shadow: 0 0 50px rgba(212,175,55,0.2); }
  
  .file-box { border: 1px dashed #444; padding: 10px; text-align: center; cursor: pointer; color: #aaa; font-size: 12px; position: relative; }
  .file-box input { position: absolute; inset: 0; opacity: 0; cursor: pointer; height: 100%; }
  .file-box:hover { border-color: var(--gold); color: #fff; }

  .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--gold); color: #000; padding: 12px 30px; border-radius: 30px; font-weight: bold; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000; }
  .toast.show { opacity: 1; bottom: 50px; }
</style>
</head>
<body>

<div class="editor">
  <div class="header">
    <div class="h-title">üèóÔ∏è GOLD TOWER</div>
    <button class="btn-gold" onclick="generateCode()">–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î</button>
  </div>
  
  <div class="scroll-area">
    <div class="section">
      <span class="sec-label">1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –§–æ–Ω–∞</span>
      <div class="file-box">
        <span id="bgStatus">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –§–û–ù (–ö–∞—Ä—Ç–∏–Ω–∫–∞)</span>
        <input type="file" accept="image/*" onchange="uploadBg(this)">
      </div>
      <button onclick="clearBg()" style="background:none; color:#ef4444; font-size:11px; margin-top:5px; padding:0">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>

    <div class="section">
      <span class="sec-label">2. –í–æ–ø—Ä–æ—Å—ã (<span id="qCount">0</span>/9)</span>
      <div id="qList"></div>
      <button class="btn-add" onclick="openModal()">+ –î–û–ë–ê–í–ò–¢–¨ –í–û–ü–†–û–°</button>
      <button onclick="resetQs()" style="background:none; color:#666; width:100%; margin-top:10px; font-size:11px">–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
    </div>
  </div>
</div>

<div class="preview">
  <div class="preview-bar">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–≥—Ä—ã</div>
  <iframe id="previewFrame"></iframe>
</div>

<div class="modal-overlay" id="modal">
  <div class="modal">
    <h3 style="color:var(--gold); margin-top:0">–†–µ–¥–∞–∫—Ç–æ—Ä –≤–æ–ø—Ä–æ—Å–∞</h3>
    
    <label style="color:#888; font-size:11px">–¢–ò–ü –í–û–ü–†–û–°–ê</label>
    <select id="mType" onchange="renderOpts()">
      <option value="choice">–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞</option>
      <option value="input">–í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞</option>
    </select>

    <label style="color:#888; font-size:11px">–¢–ï–ö–°–¢</label>
    <textarea id="mText" rows="2"></textarea>

    <div class="file-box" style="margin-bottom:15px">
      <span id="mMediaLabel">–î–æ–±–∞–≤–∏—Ç—å –ö–∞—Ä—Ç–∏–Ω–∫—É –∏–ª–∏ –ó–≤—É–∫ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
      <input type="file" accept="image/*,audio/*" onchange="uploadMedia(this)">
    </div>

    <div id="mOptsArea" style="border-top:1px solid #333; padding-top:15px"></div>

    <div style="text-align:right; margin-top:20px">
      <button class="btn-gold" onclick="saveQ()">–°–û–•–†–ê–ù–ò–¢–¨</button>
      <button onclick="closeModal()" style="background:none; color:#fff; margin-left:10px">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –í—Å—Ç–∞–≤–ª—è–π –≤ Genially.</div>

<script id="gameTemplate" type="text/template">
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<style>
  :root { --gold: #d4af37; --dark: #050505; }
  body { margin:0; overflow:hidden; background: var(--dark); font-family: 'Segoe UI', sans-serif; user-select:none; }
  
  #gameStage { 
    position: absolute; inset: 0; overflow: hidden; 
    transition: transform 0.5s ease-out; /* –ü–ª–∞–≤–Ω—ã–π –∑—É–º */
    transform-origin: center bottom;
  }

  /* –§–û–ù */
  #bgLayer { position: absolute; inset: 0; background-size: cover; background-position: center; opacity: 0.6; }
  
  /* –ë–ê–®–ù–Ø */
  .block { 
    position: absolute; height: 50px; 
    background: linear-gradient(to bottom, #f3e5ab, #b8860b);
    border: 1px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    border-radius: 4px;
  }
  .base-block {
    position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
    width: 320px; height: 30px; background: #333; border-top: 2px solid var(--gold);
    border-radius: 4px 4px 0 0; z-index: 10;
  }

  /* UI */
  .hud { position: fixed; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; z-index: 50; }
  .pill { background: rgba(0,0,0,0.8); color: var(--gold); padding: 5px 15px; border-radius: 20px; border: 1px solid var(--gold); font-weight: bold; font-size: 14px; }

  /* OVERLAYS */
  .screen { position: fixed; inset: 0; background: rgba(5,5,5,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; text-align: center; }
  h1 { font-size: 40px; color: var(--gold); margin-bottom: 30px; letter-spacing: 3px; }
  p { color: #fff; font-size: 18px; margin-bottom: 40px; }
  
  .btn-big { 
    padding: 15px 50px; background: var(--gold); color: #000; border: none; 
    border-radius: 50px; font-size: 20px; font-weight: 900; cursor: pointer; 
    box-shadow: 0 0 20px rgba(212,175,55,0.5); text-transform: uppercase; animation: pulse 2s infinite;
  }
  @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }

  /* CARD */
  #cardOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 90; display: none; align-items: center; justify-content: center; }
  .card { width: 90%; max-width: 400px; background: #111; border: 2px solid var(--gold); border-radius: 15px; padding: 20px; text-align: center; }
  
  #qText { color: #fff; font-size: 18px; font-weight: bold; margin-bottom: 20px; }
  .ans-btn { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: #fff; margin-bottom: 8px; border-radius: 8px; cursor: pointer; text-align: left; transition:0.2s; }
  .ans-btn:hover { border-color: var(--gold); background: #333; }
  input.inp { width: 100%; padding: 10px; background: #000; border: 1px solid var(--gold); color: #fff; margin-bottom: 10px; text-align: center; }
  
  #mediaBox img { max-width: 100%; max-height: 150px; border-radius: 5px; margin-bottom: 10px; }
  #mediaBox { margin-bottom: 10px; }

</style>
</head>
<body>

<div id="gameStage">
  <div id="bgLayer"></div>
  <div class="base-block"></div>
  </div>

<div class="hud">
  <div class="pill">–≠—Ç–∞–∂: <span id="score">0</span></div>
  <div class="pill">–ë–ª–æ–∫–æ–≤: <span id="total">0</span>/9</div>
</div>

<div id="startScreen" class="screen">
  <h1>–ë–ê–®–ù–Ø</h1>
  <button class="btn-big" onclick="game.start()">–ù–ê–ß–ê–¢–¨</button>
</div>

<div id="endScreen" class="screen" style="display:none">
  <h1 id="endTitle">–§–ò–ù–ê–õ</h1>
  <p id="endMsg"></p>
  <button class="btn-big" onclick="location.reload()">–ï–©–ï –†–ê–ó</button>
</div>

<div id="cardOverlay">
  <div class="card">
    <div id="mediaBox"></div>
    <div id="qText"></div>
    <div id="ansOpts"></div>
    <div id="feedback" style="height:20px; font-weight:bold; margin-top:10px"></div>
  </div>
</div>

<script>
// === –ö–û–ù–§–ò–ì –í–°–¢–ê–í–õ–Ø–ï–¢–°–Ø –°–Æ–î–ê ===
const CFG = {{CONFIG}}; 
// ==============================

// –î–í–ò–ñ–û–ö
const game = {
  active: false,
  level: 0,
  blocks: [],
  currentBlock: null,
  speed: 3,
  direction: 1,
  width: 250, // –ù–∞—á–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –ø–µ—Ä–≤–æ–≥–æ –±–ª–æ–∫–∞
  pos: 0, // –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è (X)
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  start: function() {
    document.getElementById('startScreen').style.display = 'none';
    
    // –§–æ–Ω
    if(CFG.bg) document.getElementById('bgLayer').style.backgroundImage = `url('${CFG.bg}')`;
    else document.getElementById('bgLayer').style.background = 'radial-gradient(circle, #1e293b 0%, #000 100%)';

    this.active = true;
    this.level = 0;
    this.width = 250; // –ü–µ—Ä–≤—ã–π –±–ª–æ–∫ —É–∂–µ –ø–µ—Ä–≤–æ–≥–æ –æ—Å–Ω–æ–≤–∞–Ω–∏—è (320px), –Ω–æ —à–∏—Ä–æ–∫–∏–π
    this.spawn();
    this.loop();
  },

  spawn: function() {
    if(this.level >= 9 || this.level >= CFG.qs.length) {
      this.end(true);
      return;
    }

    // –°–æ–∑–¥–∞–µ–º –±–ª–æ–∫
    const el = document.createElement('div');
    el.className = 'block';
    el.style.width = this.width + 'px';
    el.style.bottom = (30 + this.level * 50) + 'px'; // 30px - –≤—ã—Å–æ—Ç–∞ –±–∞–∑—ã
    el.style.left = '50%'; // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º
    
    // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –±–ª–æ–∫–∞
    const bImg = this.getBlockImage(this.level);
    if(bImg) {
      el.style.backgroundImage = `url('${bImg}')`;
      el.style.backgroundSize = '100% 100%';
      el.style.border = 'none'; // –£–±–∏—Ä–∞–µ–º —Ä–∞–º–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∞
    }

    document.getElementById('gameStage').appendChild(el);
    
    this.currentBlock = {
      el: el,
      x: -200 // –ù–∞—á–∞–ª–æ —Å–ª–µ–≤–∞
    };
    this.pos = -200;
    this.active = true;
    
    this.autoFit(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Å—à—Ç–∞–±
  },

  loop: function() {
    if(!game.active || !game.currentBlock) return;
    
    // –î–≤–∏–∂–µ–Ω–∏–µ
    game.pos += game.speed * game.direction;
    if(game.pos > 200) game.direction = -1;
    if(game.pos < -200) game.direction = 1;
    
    game.currentBlock.el.style.transform = `translateX(calc(-50% + ${game.pos}px))`;
    
    requestAnimationFrame(game.loop);
  },

  // –ö–ª–∏–∫ / –°—Ç–æ–ø
  stop: function() {
    if(!this.active || !this.currentBlock) return;
    this.active = false; // –ü–∞—É–∑–∞ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞
    this.showQuestion();
  },

  showQuestion: function() {
    const q = CFG.qs[this.level];
    const overlay = document.getElementById('cardOverlay');
    const txt = document.getElementById('qText');
    const opts = document.getElementById('ansOpts');
    const media = document.getElementById('mediaBox');
    const feed = document.getElementById('feedback');

    overlay.style.display = 'flex';
    txt.innerText = q.q;
    opts.innerHTML = '';
    feed.innerText = '';
    media.innerHTML = '';

    // –ú–µ–¥–∏–∞
    if(q.media) {
      if(q.media.startsWith('data:audio')) media.innerHTML = `<audio controls autoplay src="${q.media}"></audio>`;
      else media.innerHTML = `<img src="${q.media}">`;
    }

    // –í–∞—Ä–∏–∞–Ω—Ç—ã
    if(q.type === 'choice') {
      q.o.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'ans-btn';
        btn.innerText = opt;
        btn.onclick = () => game.checkAnswer(opt);
        opts.appendChild(btn);
      });
    } else {
      const inp = document.createElement('input');
      inp.className = 'ans-btn inp'; // Reuse styles
      inp.placeholder = '–û—Ç–≤–µ—Ç...';
      const btn = document.createElement('button');
      btn.className = 'ans-btn';
      btn.style.textAlign = 'center';
      btn.style.background = '#d4af37';
      btn.style.color = '#000';
      btn.style.fontWeight = 'bold';
      btn.innerText = '–ü–†–û–í–ï–†–ò–¢–¨';
      btn.onclick = () => game.checkAnswer(inp.value);
      opts.appendChild(inp);
      opts.appendChild(btn);
    }
  },

  checkAnswer: function(val) {
    const q = CFG.qs[this.level];
    let isCorrect = false;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞
    if(Array.isArray(q.a)) {
      isCorrect = q.a.some(ans => ans.trim().toLowerCase() === val.trim().toLowerCase());
    } else {
      isCorrect = (q.a.trim().toLowerCase() === val.trim().toLowerCase());
    }

    const feed = document.getElementById('feedback');
    if(isCorrect) {
      feed.innerText = "–í–ï–†–ù–û!";
      feed.style.color = "#4ade80";
      setTimeout(() => {
        document.getElementById('cardOverlay').style.display = 'none';
        game.placeBlock();
      }, 1000);
    } else {
      feed.innerText = "–û–®–ò–ë–ö–ê!";
      feed.style.color = "#ef4444";
      setTimeout(() => {
        game.end(false);
      }, 1000);
    }
  },

  placeBlock: function() {
    // –õ–æ–≥–∏–∫–∞ –æ–±—Ä–µ–∑–∫–∏ –±–ª–æ–∫–∞
    const prevBlockX = this.blocks.length > 0 ? this.blocks[this.blocks.length-1].x : 0;
    const diff = this.pos - prevBlockX;
    const absDiff = Math.abs(diff);
    
    if(absDiff > this.width) {
      this.end(false); // –ü—Ä–æ–º–∞—Ö
      return;
    }

    // –ù–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ = –°—Ç–∞—Ä–∞—è —à–∏—Ä–∏–Ω–∞ - –°–º–µ—â–µ–Ω–∏–µ
    const newWidth = this.width - absDiff;
    this.width = newWidth;
    
    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è
    this.currentBlock.el.style.width = newWidth + 'px';
    // –°–¥–≤–∏–≥ "—Ü–µ–Ω—Ç—Ä–∞" –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞—É–Ω–¥–∞
    const newCenter = this.pos - (diff / 2); 
    this.currentBlock.el.style.transform = `translateX(calc(-50% + ${newCenter}px))`;
    
    this.blocks.push({ el: this.currentBlock.el, x: newCenter });
    
    this.level++;
    this.speed += 0.5;
    
    document.getElementById('score').innerText = this.level * 100;
    document.getElementById('total').innerText = this.level;

    setTimeout(() => game.spawn(), 500);
  },

  autoFit: function() {
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑—É–º, —á—Ç–æ–±—ã –±–∞—à–Ω—è –≤–ª–µ–∑–∞–ª–∞
    const stage = document.getElementById('gameStage');
    const towerHeight = (this.level + 2) * 50; // –¢–µ–∫—É—â–∞—è –≤—ã—Å–æ—Ç–∞ + –∑–∞–ø–∞—Å
    const screenHeight = window.innerHeight;
    
    if(towerHeight > screenHeight * 0.7) {
      const scale = (screenHeight * 0.7) / towerHeight;
      stage.style.transform = `scale(${scale})`;
    } else {
      stage.style.transform = `scale(1)`;
    }
  },

  end: function(win) {
    document.getElementById('cardOverlay').style.display = 'none';
    document.getElementById('endScreen').style.display = 'flex';
    const t = document.getElementById('endTitle');
    const m = document.getElementById('endMsg');
    
    if(win) {
      t.innerText = "–ü–û–ë–ï–î–ê!";
      t.style.color = "#4ade80";
      m.innerText = "–¢—ã –ø–æ—Å—Ç—Ä–æ–∏–ª –∏–¥–µ–∞–ª—å–Ω—É—é –±–∞—à–Ω—é!";
    } else {
      t.innerText = "–£–ü–ê–õ–ê...";
      t.style.color = "#ef4444";
      m.innerText = "–ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑!";
    }
  },

  getBlockImage: function(idx) {
    // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –∫–æ–Ω—Ñ–∏–≥–µ (–µ—Å–ª–∏ –º—ã –ø–µ—Ä–µ–¥–∞–ª–∏ –ø—É—Ç–∏)
    // –ù–æ —Ç–∞–∫ –∫–∞–∫ –º—ã –≤ Base64, —Ç—É—Ç —Å–ª–æ–∂–Ω–µ–µ.
    // –£–ø—Ä–æ—â–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤, –µ—Å–ª–∏ –æ–Ω –ø–µ—Ä–µ–¥–∞–Ω
    if(CFG.blockImgs && CFG.blockImgs[idx]) return CFG.blockImgs[idx];
    return null;
  }
};

// Global Listener
document.addEventListener('pointerdown', (e) => {
  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
  if(e.target.closest('.hud') || e.target.closest('.screen') || e.target.closest('.card')) return;
  if(game.active && game.currentBlock) game.stop();
});

</script>
</body>
</html>
</script>

<script>
// ==========================================
// –õ–û–ì–ò–ö–ê –†–ï–î–ê–ö–¢–û–†–ê
// ==========================================
let config = { 
  bg: null, 
  qs: [],
  blockImgs: [] // –°—é–¥–∞ –º—ã —Å–æ–±–µ—Ä–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏
};
let editId = null;
let tempMedia = null;

// --- –ê–í–¢–û-–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –°–°–´–õ–û–ö –ù–ê –ö–ê–†–¢–ò–ù–ö–ò ---
function detectBlockImages() {
  // –†–µ–¥–∞–∫—Ç–æ—Ä –∑–Ω–∞–µ—Ç —Å–≤–æ–π URL. –û–Ω —Å–æ–∑–¥–∞–µ—Ç –º–∞—Å—Å–∏–≤ –ø—Ä—è–º—ã—Ö —Å—Å—ã–ª–æ–∫ –Ω–∞ 3.png...11.png
  const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
  const blocks = [];
  // –ò–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –±–ª–æ–∫–æ–≤: 3.png ... 11.png
  for(let i=3; i<=11; i++) {
    blocks.push(baseUrl + i + ".png");
  }
  config.blockImgs = blocks;
  
  // –§–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  if(!config.bg) config.bg = baseUrl + "1.png";
}

function init() { 
  detectBlockImages(); 
  renderList(); 
  updatePreview(); 
}

// 1. –§–û–ù
function uploadBg(inp) {
  const f = inp.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = e => { 
    config.bg = e.target.result; // Base64 –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç —Å—Å—ã–ª–∫—É
    document.getElementById("bgStatus").innerText = "–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω";
    document.getElementById("bgStatus").style.color = "#d4af37";
    updatePreview(); 
  };
  r.readAsDataURL(f);
}
function clearBg() {
  config.bg = null; // –í–µ—Ä–Ω–µ—Ç—Å—è –∫ –¥–µ—Ñ–æ–ª—Ç—É –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
  detectBlockImages(); // –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –¥–µ—Ñ–æ–ª—Ç
  document.getElementById("bgStatus").innerText = "–ó–ê–ì–†–£–ó–ò–¢–¨";
  document.getElementById("bgStatus").style.color = "#aaa";
  updatePreview();
}

// 2. –í–û–ü–†–û–°–´
function renderList() {
  const l = document.getElementById("qList"); l.innerHTML="";
  document.getElementById("qCount").innerText = config.qs.length;
  if(!config.qs.length) { l.innerHTML="<div style='text-align:center;color:#444;font-size:12px;padding:20px'>–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤</div>"; return; }
  
  config.qs.forEach((q, i) => {
    const d = document.createElement("div"); d.className="q-item";
    d.innerHTML = `
      <div style="font-size:12px; color:#ddd; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width:280px">
        <span style="color:#d4af37; font-weight:bold; margin-right:5px">#${i+1}</span> ${q.q}
      </div>
      <div>
        <button style="background:none; cursor:pointer" onclick="editQ(${i})">‚úèÔ∏è</button>
        <button style="background:none; cursor:pointer; color:#ef4444" onclick="delQ(${i})">üóë</button>
      </div>
    `;
    l.appendChild(d);
  });
}

function openModal() { 
  editId=null; document.getElementById("modal").style.display="flex"; 
  document.getElementById("mText").value=""; tempMedia=null;
  renderMediaUI(); renderOpts(); 
}
function closeModal() { document.getElementById("modal").style.display="none"; }

function uploadMedia(inp) {
  const f = inp.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = e => { tempMedia = e.target.result; renderMediaUI(); };
  r.readAsDataURL(f);
}
function clearMedia() { tempMedia=null; renderMediaUI(); }
function renderMediaUI() {
  const st = document.getElementById("mMediaStatus");
  const img = document.getElementById("mImgPrev");
  if(tempMedia) {
    st.innerText = "–§–∞–π–ª –≤—ã–±—Ä–∞–Ω"; st.style.color="#4ade80";
    if(tempMedia.startsWith("data:image")) { img.src=tempMedia; img.style.display="block"; }
    else { img.style.display="none"; }
  } else {
    st.innerText = "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª..."; st.style.color="#aaa"; img.style.display="none";
  }
}

function renderOpts() {
  const t = document.getElementById("mType").value;
  const c = document.getElementById("mOptsArea"); c.innerHTML="";
  if(t==="choice") {
    c.innerHTML = `<div style="margin-bottom:10px; font-size:11px; color:#888; display:flex; justify-content:space-between"><span>–í–ê–†–ò–ê–ù–¢–´</span><span onclick="addOpt()" style="cursor:pointer; color:#d4af37">+ –î–û–ë–ê–í–ò–¢–¨</span></div><div id="optsList"></div>`;
    if(editId===null) { addOpt(); addOpt(); }
  } else {
    c.innerHTML = `<label style="color:#888; font-size:11px">–ü–†–ê–í–ò–õ–¨–ù–´–ô –û–¢–í–ï–¢</label><input type="text" id="mInp">`;
  }
}

function addOpt(val="", ok=false) {
  const l = document.getElementById("optsList"); if(!l) return;
  const d = document.createElement("div"); d.className="opt-row";
  d.innerHTML=`<input type="radio" name="ok" class="radio" ${ok?'checked':''}><input type="text" class="opt-val" value="${val}"><button onclick="this.parentElement.remove()" style="background:none;color:#666">‚úï</button>`;
  l.appendChild(d);
}

function editQ(i) {
  editId=i; const q=config.qs[i];
  document.getElementById("modal").style.display="flex";
  document.getElementById("mText").value=q.q;
  document.getElementById("mType").value=q.type;
  tempMedia=q.media; renderMediaUI(); renderOpts();
  if(q.type==='choice') {
    document.getElementById("optsList").innerHTML="";
    q.o.forEach(opt => addOpt(opt, q.a.includes(opt)));
  } else document.getElementById("mInp").value=q.a.join(", ");
}

function saveQ() {
  const txt = document.getElementById("mText").value;
  const type = document.getElementById("mType").value;
  if(!txt) return;
  let o = {type:type, q:txt, a:[], media:tempMedia};
  if(type==='choice') {
    o.o=[];
    document.querySelectorAll(".opt-row").forEach(r=>{
      let v = r.querySelector(".opt-val").value;
      if(v) { o.o.push(v); if(r.querySelector(".radio").checked) o.a.push(v); }
    });
    if(!o.a.length) { alert("–í—ã–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π!"); return; }
  } else o.a = document.getElementById("mInp").value.split(",").map(x=>x.trim()).filter(Boolean);
  
  if(editId!==null) config.qs[editId]=o; else config.qs.push(o);
  closeModal(); renderList(); updatePreview();
}

function delQ(i) { config.qs.splice(i,1); renderList(); updatePreview(); }
function resetQs() { config.qs=[]; renderList(); updatePreview(); }

// 4. –ü–†–ï–í–¨–Æ –ò –ì–ï–ù–ï–†–ê–¶–ò–Ø
function updatePreview() {
  const tmpl = document.getElementById("gameTemplate").textContent;
  const html = tmpl.replace("{{CONFIG}}", JSON.stringify(config));
  const blob = new Blob([html], {type: 'text/html'});
  document.getElementById("previewFrame").src = URL.createObjectURL(blob);
}

function generateCode() {
  const tmpl = document.getElementById("gameTemplate").textContent;
  const html = tmpl.replace("{{CONFIG}}", JSON.stringify(config));
  // –ö–æ–¥–∏—Ä—É–µ–º –≤ Base64 —Å UTF-8
  const b64 = btoa(unescape(encodeURIComponent(html)));
  const embed = `<iframe src="data:text/html;base64,${b64}" width="100%" height="600" style="border:0"></iframe>`;
  navigator.clipboard.writeText(embed).then(()=>{
    const t = document.getElementById("toast"); t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2000);
  });
}

init();
</script>
</body>
</html>
