<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ë–∞—à–Ω—è ‚Äî Editor + Game [Fixed]</title>
  <style>
    html, body{height:100%}
    :root{
      --text:#eaf0ff; --muted:#a9b6e6; --border: rgba(255,255,255,.10);
      --shadow2: 0 12px 34px rgba(0,0,0,.40); --radius: 18px; --radius2: 22px;
      --neon:#d6b14a; --neon2:#f2d37a; --danger:#ff4d4d; --ok:#2dd27d;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    body{
      margin:0;color:var(--text);
      background: radial-gradient(1100px 700px at 12% 18%, rgba(35,82,200,.28) 0%, rgba(5,8,22,0) 58%),
                  radial-gradient(900px 640px at 88% 16%, rgba(20,160,255,.18) 0%, rgba(5,8,22,0) 62%),
                  linear-gradient(180deg, rgba(4,10,32,.92), rgba(3,6,18,1));
      min-height:100vh;
    }
    .app{ display:grid; grid-template-columns: 460px 1fr; gap:14px; padding:14px; max-width: 1540px; margin: 0 auto; }
    @media (max-width: 1020px){ .app{grid-template-columns:1fr} }
    .panel{ background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04)); border:1px solid var(--border); border-radius:var(--radius2); box-shadow:var(--shadow2); backdrop-filter: blur(10px); overflow:hidden; position:relative; }
    .panel-header{ padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.10); display:flex; align-items:center; justify-content:space-between; }
    .panel-body{ padding:14px; overflow:auto; }
    .settings{ height: calc(100vh - 28px); display:flex; flex-direction:column; }
    .section{ padding:12px; border-radius:16px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.16); margin-bottom:12px; }
    .section .title{ font-weight:950; font-size:13.5px; margin-bottom:10px; color:rgba(255,255,255,.92); display:flex; justify-content:space-between; }
    input, textarea, select { width:100%; border-radius:14px; padding:10px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.25); color:var(--text); outline:none; margin-top:5px; }
    .btn{ padding:11px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); color:var(--text); cursor:pointer; font-weight:950; transition: 0.2s; display:inline-flex; align-items:center; justify-content:center; gap:8px; }
    .btn:hover{ background:rgba(255,255,255,.10); }
    .btn.primary{ background:linear-gradient(90deg, rgba(214,177,74,.35), rgba(242,211,122,.22)); border-color:rgba(214,177,74,.40); }
    .q-item{ padding:10px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .preview-stage{ border-radius:var(--radius2); overflow:hidden; height: calc(100vh - 120px); background:rgba(0,0,0,.18); }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); backdrop-filter: blur(8px); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal{ width:min(600px, 95%); background: #1a1d26; border-radius:20px; border:1px solid var(--neon); padding:20px; box-shadow: 0 0 30px rgba(214,177,74,0.2); }
    .toast{ position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:rgba(0,0,0,.8); padding:10px 20px; border-radius:10px; opacity:0; transition:0.3s; pointer-events:none; }
    .toast.show{ opacity:1; }
  </style>
</head>
<body>

<div class="app" id="editorRoot">
  <div class="panel settings">
    <div class="panel-header"><div class="h">–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ë–∞—à–Ω—è¬ª</div></div>
    <div class="panel-body">
      <div class="section">
        <div class="title">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
        <input id="inpTitle" type="text" value="–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π" />
      </div>
      <div class="section">
        <div class="title">–í–æ–ø—Ä–æ—Å—ã <span id="pillCount">0 / 9</span></div>
        <div style="display:flex; gap:10px">
          <button class="btn primary" id="btnAddQ">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
          <button class="btn" id="btnClearQs">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div id="qList" style="margin-top:15px"></div>
      </div>
      <button class="btn primary" style="width:100%" id="btnCopyCode">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ (iframe)</button>
    </div>
  </div>
  <div class="panel">
    <div class="panel-header"><div class="h">–ü—Ä–æ—Å–º–æ—Ç—Ä</div></div>
    <div class="preview-stage">
      <iframe id="livePreview" style="width:100%; height:100%; border:0;"></iframe>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <h3 id="modalTitle">–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å</h3>
    <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</label>
    <textarea id="inpPrompt"></textarea>
    <div style="margin-top:15px">
      <label>–¢–∏–ø –æ—Ç–≤–µ—Ç–∞</label>
      <select id="selType"><option value="choice">–í—ã–±–æ—Ä</option><option value="text">–í–≤–æ–¥</option></select>
    </div>
    <div id="choiceWrap" style="margin-top:15px">
      <div id="choiceList"></div>
      <button class="btn" style="margin-top:10px" id="btnAddChoice">‚ûï –í–∞—Ä–∏–∞–Ω—Ç</button>
    </div>
    <div id="textWrap" style="display:none; margin-top:15px">
      <input id="inpAnswer" placeholder="–í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç" />
    </div>
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px">
      <button class="btn" id="btnCloseModal">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn primary" id="btnSaveQ">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function() {
  const $ = id => document.getElementById(id);
  let questions = [];
  let editingId = null;

  function toast(msg) { 
    $('toast').textContent = msg; $('toast').classList.add('show'); 
    setTimeout(() => $('toast').classList.remove('show'), 2000); 
  }

  function updatePreview() {
    const config = {
      title: $('inpTitle').value,
      questions: questions.map(q => ({
        type: q.type,
        prompt: q.prompt,
        options: q.options || [],
        correctIndex: q.correctIndex || 0,
        accepts: q.type === 'text' ? [q.answer] : []
      }))
    };
    const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(config))));
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç–æ–π srcdoc –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –∏–ª–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º URL
    $('livePreview').srcdoc = `
      <html><body style="background:#050816; color:white; display:flex; align-items:center; justify-content:center; height:100vh; font-family:sans-serif">
      <div style="text-align:center">
        <h2>\u0411\u0430\u0448\u043d\u044f: ${config.title}</h2>
        <p>\u0412\u043e\u043f\u0440\u043e\u0441\u043e\u0432: ${questions.length}</p>
        <button style="padding:10px 20px; border-radius:10px; border:none; background:#d6b14a; cursor:pointer">\u041d\u0430\u0447\u0430\u0442\u044c</button>
      </div>
      </body></html>`;
  }

  $('btnAddQ').onclick = () => {
    if (questions.length >= 9) return toast("–ú–∞–∫—Å–∏–º—É–º 9 –≤–æ–ø—Ä–æ—Å–æ–≤");
    editingId = null;
    $('inpPrompt').value = "";
    $('choiceList').innerHTML = "";
    addChoiceRow(); addChoiceRow();
    $('modalBackdrop').style.display = 'flex';
  };

  function addChoiceRow(val = "") {
    const div = document.createElement('div');
    div.className = 'answerRow';
    div.style.display = 'flex'; div.style.gap = '5px'; div.style.marginTop = '5px';
    div.innerHTML = `<input type="radio" name="correct" style="width:20px"> <input type="text" value="${val}" style="flex:1">`;
    $('choiceList').appendChild(div);
  }

  $('btnSaveQ').onclick = () => {
    const type = $('selType').value;
    const prompt = $('inpPrompt').value;
    if (!prompt) return toast("–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å");

    const newQ = { id: editingId || Date.now(), type, prompt };
    if (type === 'choice') {
      const rows = $('choiceList').querySelectorAll('.answerRow');
      newQ.options = Array.from(rows).map(r => r.querySelector('input[type="text"]').value);
      newQ.correctIndex = Array.from(rows).findIndex(r => r.querySelector('input[type="radio"]').checked);
      if (newQ.correctIndex === -1) newQ.correctIndex = 0;
    } else {
      newQ.answer = $('inpAnswer').value;
    }

    if (editingId) {
      const idx = questions.findIndex(q => q.id === editingId);
      questions[idx] = newQ;
    } else {
      questions.push(newQ);
    }

    renderList();
    $('modalBackdrop').style.display = 'none';
    updatePreview();
  };

  function renderList() {
    $('qList').innerHTML = "";
    $('pillCount').textContent = `${questions.length} / 9`;
    questions.forEach((q, i) => {
      const div = document.createElement('div');
      div.className = 'q-item';
      div.innerHTML = `<span>${i+1}. ${q.prompt.substring(0,20)}...</span>
        <button class="btn small" onclick="this.parentElement.remove()">üóë</button>`;
      $('qList').appendChild(div);
    });
  }

  $('btnCloseModal').onclick = () => $('modalBackdrop').style.display = 'none';
  $('btnAddChoice').onclick = () => addChoiceRow();
  $('selType').onchange = () => {
    const isChoice = $('selType').value === 'choice';
    $('choiceWrap').style.display = isChoice ? 'block' : 'none';
    $('textWrap').style.display = isChoice ? 'none' : 'block';
  };

  $('inpTitle').oninput = updatePreview;
  updatePreview();
})();
</script>
</body>
</html>
