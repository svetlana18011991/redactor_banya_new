<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ë–∞—à–Ω—è ‚Äî Editor + Game (–æ–¥–∏–Ω —Ñ–∞–π–ª)</title>

  <style>
    html, body{height:100%}

    :root{
      --text:#eaf0ff;
      --muted:#a9b6e6;
      --border: rgba(255,255,255,.10);
      --shadow2: 0 12px 34px rgba(0,0,0,.40);
      --radius: 18px;
      --radius2: 22px;

      --neon:#d6b14a;
      --neon2:#f2d37a;
      --danger:#ff4d4d;
      --ok:#2dd27d;
    }

    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    body{
      margin:0;color:var(--text);
      background:
        radial-gradient(1100px 700px at 12% 18%, rgba(35,82,200,.28) 0%, rgba(5,8,22,0) 58%),
        radial-gradient(900px 640px at 88% 16%, rgba(20,160,255,.18) 0%, rgba(5,8,22,0) 62%),
        radial-gradient(1000px 780px at 55% 112%, rgba(214,177,74,.14) 0%, rgba(5,8,22,0) 58%),
        linear-gradient(180deg, rgba(4,10,32,.92), rgba(3,6,18,1));
      min-height:100vh;
    }
    body.gameOnly{background:transparent}

    .app{
      display:grid;
      grid-template-columns: 460px 1fr;
      gap:14px;
      padding:14px;
      max-width: 1540px;
      margin: 0 auto;
    }
    @media (max-width: 1020px){
      .app{grid-template-columns:1fr}
    }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid var(--border);
      border-radius:var(--radius2);
      box-shadow:var(--shadow2);
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
    }

    .panel-header{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .panel-header .h{font-weight:950;letter-spacing:.2px; display:flex; align-items:center; gap:10px;}
    .panel-header .h img { height: 32px; width: auto; border-radius: 6px; object-fit: contain; }
    .panel-body{padding:14px}

    .settings{
      height: calc(100vh - 28px);
      display:flex;
      flex-direction:column;
      min-height: 560px;
    }
    .settings .panel-body{
      overflow:auto;
      padding:14px;
    }

    /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
    .settings .panel-body::-webkit-scrollbar { width: 8px; }
    .settings .panel-body::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 4px; }
    .settings .panel-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    .settings .panel-body::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

    [data-section="timer"]{display:none !important}
    [data-hide="blocks"]{display:none !important}

    .section{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      margin-bottom:12px;
    }
    .section .title{
      font-weight:950;
      font-size:13.5px;
      margin-bottom:10px;
      color:rgba(255,255,255,.92);
      display:flex;align-items:center;justify-content:space-between;gap:8px;
    }

    .muted{color:var(--muted); font-size:12.5px; line-height:1.35}

    label{
      display:block;
      font-size:12.5px;
      color:rgba(255,255,255,.86);
      margin:10px 0 6px
    }

    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      border-radius:14px;
      padding:10px 11px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:84px; resize:vertical}

    input[type="file"]{
      width:100%;
      border-radius:14px;
      padding:10px 11px;
      border:1px dashed rgba(255,255,255,.22);
      background:rgba(0,0,0,.18);
      color:var(--muted);
    }

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1; min-width:170px}

    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      margin-top:8px;
    }
    .toggle input{width:18px; height:18px}

    .btn{
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-weight:950;
      font-size:14px;
      transition:transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .2s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.24)}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.45; cursor:not-allowed}

    .btn.primary{
      background:linear-gradient(90deg, rgba(214,177,74,.35), rgba(242,211,122,.22));
      border-color:rgba(214,177,74,.40);
      box-shadow: 0 10px 26px rgba(214,177,74,.18);
    }
    .btn.danger{border-color:rgba(255,77,77,.35); background:rgba(255,77,77,.08)}
    .btn.small{padding:8px 10px; font-size:12.5px; border-radius:12px}

    .q-list{display:flex; flex-direction:column; gap:10px;}
    .q-item{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .q-item .meta{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
      padding-top:3px;
    }
    .q-item .meta .t{
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis
    }
    .q-item .meta .s{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(255,255,255,.92);
    }

    .preview{
      min-height: calc(100vh - 28px);
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:0;
      overflow:hidden;
    }
    .preview-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
    }
    .preview-top .name{font-weight:950; letter-spacing:.2px}
    .preview-top .hint{color:var(--muted); font-size:12.5px}

    .preview-stage{
      position:relative;
      border-radius:var(--radius2);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      min-height: 720px;
      height: calc(100vh - 80px);
      background:rgba(0,0,0,.18);
      box-shadow: var(--shadow2);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      z-index:999999;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px)
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999998;
      padding:14px;
    }

    .modal{
      width:min(820px, 100%);
      max-height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal-head{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      flex-shrink: 0;
    }
    .modal-head .h{font-weight:950}
    .modal-body{
      padding:14px;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
    }
    
    /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
    .modal-body::-webkit-scrollbar { width: 8px; }
    .modal-body::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 4px; }
    .modal-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    .modal-body::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

    .modal-foot{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      flex-shrink: 0;
    }

    .choiceBlock{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.14);
      border-radius:14px;
      padding:10px;
      margin-top:10px;
    }

    .answerRow{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:8px;
    }
    .answerRow input[type="text"]{flex:1; min-width:0}

    .radio{
      width:18px;
      height:18px;
      accent-color: var(--neon);
      flex:0 0 auto;
    }

    .errbar{
      display:none;
      margin:12px 14px 0;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,77,77,.35);
      background:rgba(255,77,77,.10);
      color:#ffd6d6;
      font-size:13px;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .errbar.show{display:block}

    /* ===== GAME styles (scoped by .gameHost) ===== */
    .gameHost{
      width:100%;
      height:100%;
      min-height:0;
    }
    .gameHost *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .stage{
      position:relative;
      width:100%;
      height:100%;
      min-height:720px;
      overflow:hidden;
      border-radius:18px;
      background:
        radial-gradient(1100px 700px at 12% 18%, rgba(106,164,255,.18) 0%, rgba(5,8,22,0) 58%),
        radial-gradient(900px 640px at 88% 16%, rgba(155,123,255,.14) 0%, rgba(5,8,22,0) 62%),
        radial-gradient(1000px 780px at 55% 112%, rgba(45,210,125,.12) 0%, rgba(5,8,22,0) 58%),
        linear-gradient(180deg, rgba(10,14,40,.60), rgba(5,8,22,1));
      color:var(--text);
    }
    
    /* Premium gold/blue polish */
    .panel{
      border-color: rgba(214,177,74,.22);
      box-shadow: 0 18px 60px rgba(0,0,0,.50);
    }
    .panel::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(242,211,122,.08), rgba(0,0,0,0) 60%),
        radial-gradient(700px 520px at 80% 20%, rgba(20,160,255,.10), rgba(0,0,0,0) 55%),
        repeating-linear-gradient(135deg, rgba(214,177,74,.06) 0 2px, rgba(0,0,0,0) 2px 14px);
      opacity:.45;
      pointer-events:none;
      mix-blend-mode: overlay;
    }
    .panel > *{position:relative; z-index:1}
    .section{
      border-color: rgba(214,177,74,.18);
      background: rgba(0,0,0,.18);
    }
    input[type="text"], input[type="number"], textarea, select{
      border-color: rgba(214,177,74,.20);
      background: rgba(0,0,0,.28);
    }
    input[type="file"]{
      border-color: rgba(214,177,74,.25);
    }
    .btn{
      border-color: rgba(214,177,74,.22);
    }
    .btn.primary{
      background: linear-gradient(90deg, rgba(214,177,74,.42), rgba(242,211,122,.20));
      border-color: rgba(242,211,122,.38);
      box-shadow: 0 14px 34px rgba(214,177,74,.18);
    }
    .btn.primary:hover{
      box-shadow: 0 18px 44px rgba(214,177,74,.22);
    }
    .pill{
      border-color: rgba(242,211,122,.30);
      background: rgba(0,0,0,.24);
    }

    /* Neon orange accents for the whole question modal window */
    .modal{
      box-shadow:
        0 30px 80px rgba(0,0,0,.55),
        0 0 0 1px rgba(255,150,0,.22),
        0 0 32px rgba(255,130,0,.14);
    }
    .modal .choiceBlock{
      border:1px solid rgba(255,150,0,.18);
      box-shadow: 0 0 18px rgba(255,130,0,.10) inset;
    }
    .modal input:focus, .modal textarea:focus, .modal select:focus{
      outline:none;
      border-color: rgba(255,170,0,.55) !important;
      box-shadow: 0 0 0 3px rgba(255,150,0,.18) !important;
    }
</style>
</head>

<body>
  <div class="app" id="editorRoot">
    <div class="panel settings">
      <div class="panel-header">
        <div class="h">
          <img src="63.png" alt="–õ–æ–≥–æ—Ç–∏–ø" />
          <span data-i18n="editorTitle">–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ë–∞—à–Ω—è¬ª</span>
        </div>
        <div class="row" style="margin:0">
          <button class="btn primary" id="btnCopyCode" type="button" data-i18n="btnCopyCode">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ (iframe)</button>
        </div>
      </div>

      <div class="errbar" id="errbar"></div>

      <div class="panel-body">

        <div class="section">
          <div class="title" data-i18n="langTitle">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
          <select id="selLang" style="margin-top:6px;">
            <option value="ru" selected>–†—É—Å—Å–∫–∏–π</option>
            <option value="en">English</option>
            <option value="de">Deutsch</option>
            <option value="zh">‰∏≠Êñá</option>
          </select>
        </div>

        <div class="section">
          <div class="title" data-i18n="secTitleName">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
          <label data-i18n="lblTitleInGame">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∏–≥—Ä–µ</label>
          <input id="inpTitle" type="text" value="–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π" />
        </div>

        <div class="section">
          <div class="title" data-i18n="secTitleDesign">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</div>
          <label data-i18n="lblCustomBg">–í—ã–±—Ä–∞—Ç—å —Å–≤–æ–π —Ñ–æ–Ω</label>
          <div class="row" style="gap:10px; align-items:center; margin-top:6px">
            <input id="fileBg" type="file" accept="image/*" />
            <button id="btnResetBg" type="button" class="btn small" data-i18n="btnResetBg">‚Ü© –°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ–Ω</button>
          </div>

          <div class="toggle" data-hide="blocks">
            <input id="chkUseImages" type="checkbox" checked />
            <div>
              <div style="font-weight:900" data-i18n="lblBlocksStd">–ë–ª–æ–∫–∏: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ</div>
              <div class="muted"></div>
            </div>
          </div>
          
          <div class="toggle">
            <input id="chkUseLatex" type="checkbox" />
            <div>
              <div style="font-weight:900" data-i18n="lblUseLatex">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LaTeX</div>
              <div class="muted" data-i18n="lblLatexHint">–í–∫–ª—é—á–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–æ—Ä–º—É–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, $x^2$)</div>
            </div>
          </div>
        </div>

        <div class="section" data-section="timer">
          <div class="title" data-i18n="secTitleTimer">–¢–∞–π–º–µ—Ä</div>

          <div class="toggle">
            <input id="chkTimer" type="checkbox" />
            <div>
              <div style="font-weight:900" data-i18n="lblEnableTimer">–í–∫–ª—é—á–∏—Ç—å —Ç–∞–π–º–µ—Ä</div>
              <div class="muted" data-i18n="lblTimerHint">–ï—Å–ª–∏ –≤—Ä–µ–º—è –≤—ã—à–ª–æ ‚Äî –æ—Ç–≤–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π, –±–ª–æ–∫ —Å–≥–æ—Ä–∞–µ—Ç.</div>
            </div>
          </div>

          <label data-i18n="lblSecPerQ">–°–µ–∫—É–Ω–¥ –Ω–∞ –≤–æ–ø—Ä–æ—Å</label>
          <input id="inpSeconds" type="number" min="5" max="600" step="1" value="30" />
        </div>

        <div class="section">
          <div class="title"><span data-i18n="secTitleQuestions">–í–æ–ø—Ä–æ—Å—ã</span> <span class="pill" id="pillCount">0 / 9</span></div>

          <div class="row">
            <button class="btn primary" id="btnAddQ" type="button" data-i18n="btnAdd">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="btn" id="btnClearQs" type="button" data-i18n="btnClear">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>

          <div class="q-list" id="qList" style="margin-top:12px"></div>

          <div class="muted" style="margin-top:10px" data-i18n="lblExact9" data-i18n-html="true">–°—Ç—Ä–æ–≥–æ <b>9 –≤–æ–ø—Ä–æ—Å–æ–≤</b>.</div>
          <div class="muted" data-i18n="lblTypes" data-i18n-html="true">–ú–æ–∂–Ω–æ: <b>–≤—ã–±–æ—Ä</b> –∏–ª–∏ <b>–≤–≤–æ–¥</b> (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤).</div>
        </div>

        <div class="section">
          <div class="title" data-hide="exportTitle" data-i18n="secTitleExport">–≠–∫—Å–ø–æ—Ä—Ç –≤ Genially</div>
          <div class="muted">
            <span data-i18n="lblExportHint" data-i18n-html="true">–ù–∞–∂–º–∏ <b>¬´üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe¬ª</b> ‚Äî –≤ –±—É—Ñ–µ—Ä–µ –±—É–¥–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–¥ –≤–∏–¥–∞:</span>
            <div style="margin-top:8px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; color:rgba(255,255,255,.86)">
               .../index.html?game=...
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="panel preview">
      <div class="preview-top">
        <div>
          <div class="name" data-i18n="previewTitle">–ü—Ä–æ—Å–º–æ—Ç—Ä</div>
          <div class="hint" data-i18n="previewHint">–ñ–∏–≤–æ–µ –ø—Ä–µ–≤—å—é (–∏–≥—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∫ –≤ Genially)</div>
        </div>
        <div class="muted" data-i18n="previewSub">–ë–∞—à–Ω—è + –∫–∞—Ä—Ç–æ—á–∫–∏ + —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω</div>
      </div>

      <div class="panel-body" style="height:100%; padding-bottom:0">
        <div class="preview-stage" style="height:100%">
          <iframe id="livePreview" title="Preview" style="width:100%;height:100%;min-height:720px;border:0;background:transparent;border-radius:18px;overflow:hidden" allow="autoplay; fullscreen" allowfullscreen></iframe>
        </div>
      </div>
    </div>
  </div>

  <div id="gameRoot" style="display:none"></div>

  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div class="h" id="modalTitle" data-i18n="modalTitleAdd">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</div>
        <button class="btn small danger" id="btnCloseModal" type="button" data-i18n="btnClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div class="modal-body">
        <label data-i18n="lblQType">–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞</label>
        <select id="selType">
          <option value="choice" selected data-i18n="optChoice">–° –≤—ã–±–æ—Ä–æ–º –æ—Ç–≤–µ—Ç–∞</option>
          <option value="text" data-i18n="optText">–° –≤–≤–æ–¥–æ–º –æ—Ç–≤–µ—Ç–∞</option>
        </select>

        <label data-i18n="lblQuestionText">–í–æ–ø—Ä–æ—Å</label>
        <textarea id="inpPrompt" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å..." data-i18n="phQuestion"></textarea>

        <div class="choiceBlock" style="margin-top:10px">
          <div style="font-weight:900" data-i18n="lblTimerForThis">–¢–∞–π–º–µ—Ä –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞</div>
          <div class="muted" data-i18n="lblTimerForThisHint">–ú–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –≤—Ä–µ–º—è –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ (–ø—É—Å—Ç–æ = –±–µ–∑ —Ç–∞–π–º–µ—Ä–∞/–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é).</div>

          <div style="margin-top:10px">
              <label data-i18n="lblSecForThis">–°–µ–∫—É–Ω–¥ –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å</label>
              <input id="inpQSeconds" type="number" min="3" max="600" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 20" data-i18n="phTimer" />
          </div>
        </div>
        
        <div class="choiceBlock" style="margin-top:10px">
          <div style="font-weight:900" data-i18n="lblMedia">–ú–µ–¥–∏–∞ (—Å—Å—ã–ª–∫–∏)</div>
          <div class="muted" data-i18n="lblMediaHint">–í—Å—Ç–∞–≤—å—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É (URL) –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–ª–∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª.</div>
          
          <div class="answerRow">
            <span style="font-size:20px; line-height:1; cursor:help;" title="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É">üñºÔ∏è</span>
            <input id="inpQImage" type="text" placeholder="https://.../image.jpg" />
            <button class="btn small danger" id="btnClearImage" type="button" title="–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É">‚úñ</button>
          </div>
          
          <div class="answerRow">
            <span style="font-size:20px; line-height:1; cursor:help;" title="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞—É–¥–∏–æ">üéµ</span>
            <input id="inpQAudio" type="text" placeholder="https://.../audio.mp3" />
            <button class="btn small danger" id="btnClearAudio" type="button" title="–£–¥–∞–ª–∏—Ç—å –∞—É–¥–∏–æ">‚úñ</button>
          </div>
        </div>

        <div id="choiceWrap" class="choiceBlock">
          <div style="font-weight:900" data-i18n="lblChoices">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞</div>
          <div class="muted" data-i18n="lblChoicesHint">–ú–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞. –û—Ç–º–µ—Ç—å –≤–µ—Ä–Ω—ã–π —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–æ–π.</div>
          <div id="choiceList"></div>
          <button class="btn small" id="btnAddChoice" type="button" style="margin-top:10px" data-i18n="btnAddChoice">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
        </div>

        <div id="textWrap" class="choiceBlock" style="display:none">
          <div style="font-weight:900" data-i18n="lblTextAns">–í–µ—Ä–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–≤–≤–æ–¥)</div>
          <div class="muted" data-i18n="lblTextAnsHint">–ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –ª—é–±–æ–π.</div>
          <div id="textList"></div>
          <button class="btn small" id="btnAddText" type="button" style="margin-top:10px" data-i18n="btnAddText">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn" id="btnPreviewDraft" type="button" data-i18n="btnPreviewDraft">üëÅ –ü–æ–∫–∞–∑–∞—Ç—å –≤ –ø—Ä–µ–≤—å—é</button>
        <button class="btn primary" id="btnSaveQ" type="button" data-i18n="btnSaveQ">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="codeBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="codeTitle">
      <div class="modal-head">
        <div class="h" id="codeTitle" data-i18n="lblCodeTitle">–°—Å—ã–ª–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã</div>
        <button class="btn small danger" id="btnCloseCode" type="button" data-i18n="btnClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modal-body">
        <div class="muted" style="margin-bottom:8px" data-i18n="lblCodeHint">–≠—Ç–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–≥—Ä—É. –ï—ë –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å –≤ Genially (—á–µ—Ä–µ–∑ iframe) –∏ –∫—É–¥–∞ —É–≥–æ–¥–Ω–æ.</div>
        <label style="margin-top:0" data-i18n="lblLink">–°—Å—ã–ª–∫–∞</label>
        <textarea id="taIframe" spellcheck="false" style="min-height:90px;font-family: ui-monospace, SFMono-Regular, Menlo, monospace;"></textarea>
        <label data-i18n="lblIframe">iframe (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)</label>
        <textarea id="taIframe2" spellcheck="false" style="min-height:120px;font-family: ui-monospace, SFMono-Regular, Menlo, monospace;"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnCopyFromModal" type="button" data-i18n="btnCopyLink">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
          <button class="btn" id="btnCopyIframe" type="button" data-i18n="btnCopyIframe">üìé –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe</button>
          <button class="btn" id="btnDownloadGame" type="button" data-i18n="btnDownload">‚¨á –°–∫–∞—á–∞—Ç—å –∏–≥—Ä—É (HTML)</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ</div>

<script>
(() => {
  "use strict";

  // ===== –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (i18n) =====
  const i18n = {
    ru: {
      editorTitle: "–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ë–∞—à–Ω—è¬ª", btnCopyCode: "üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ (iframe)", langTitle: "–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞",
      secTitleName: "–ù–∞–∑–≤–∞–Ω–∏–µ", lblTitleInGame: "–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∏–≥—Ä–µ", secTitleDesign: "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ",
      lblCustomBg: "–í—ã–±—Ä–∞—Ç—å —Å–≤–æ–π —Ñ–æ–Ω", btnResetBg: "‚Ü© –°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ–Ω", lblBlocksStd: "–ë–ª–æ–∫–∏: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ",
      lblUseLatex: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LaTeX", lblLatexHint: "–í–∫–ª—é—á–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–æ—Ä–º—É–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, $x^2$)",
      secTitleTimer: "–¢–∞–π–º–µ—Ä", lblEnableTimer: "–í–∫–ª—é—á–∏—Ç—å —Ç–∞–π–º–µ—Ä", lblTimerHint: "–ï—Å–ª–∏ –≤—Ä–µ–º—è –≤—ã—à–ª–æ ‚Äî –æ—Ç–≤–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π, –±–ª–æ–∫ —Å–≥–æ—Ä–∞–µ—Ç.",
      lblSecPerQ: "–°–µ–∫—É–Ω–¥ –Ω–∞ –≤–æ–ø—Ä–æ—Å", secTitleQuestions: "–í–æ–ø—Ä–æ—Å—ã", btnAdd: "‚ûï –î–æ–±–∞–≤–∏—Ç—å", btnClear: "üßπ –û—á–∏—Å—Ç–∏—Ç—å",
      lblExact9: "–°—Ç—Ä–æ–≥–æ <b>9 –≤–æ–ø—Ä–æ—Å–æ–≤</b>.", lblTypes: "–ú–æ–∂–Ω–æ: <b>–≤—ã–±–æ—Ä</b> –∏–ª–∏ <b>–≤–≤–æ–¥</b> (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤).",
      secTitleExport: "–≠–∫—Å–ø–æ—Ä—Ç –≤ Genially", lblExportHint: "–ù–∞–∂–º–∏ <b>¬´üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe¬ª</b> ‚Äî –≤ –±—É—Ñ–µ—Ä–µ –±—É–¥–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–¥ –≤–∏–¥–∞:",
      previewTitle: "–ü—Ä–æ—Å–º–æ—Ç—Ä", previewHint: "–ñ–∏–≤–æ–µ –ø—Ä–µ–≤—å—é (–∏–≥—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∫ –≤ Genially)", previewSub: "–ë–∞—à–Ω—è + –∫–∞—Ä—Ç–æ—á–∫–∏ + —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω",
      modalTitleAdd: "–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å", modalTitleEdit: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å", btnClose: "–ó–∞–∫—Ä—ã—Ç—å",
      lblQType: "–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞", optChoice: "–° –≤—ã–±–æ—Ä–æ–º –æ—Ç–≤–µ—Ç–∞", optText: "–° –≤–≤–æ–¥–æ–º –æ—Ç–≤–µ—Ç–∞", lblQuestionText: "–í–æ–ø—Ä–æ—Å", phQuestion: "–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å...",
      lblTimerForThis: "–¢–∞–π–º–µ—Ä –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞", lblTimerForThisHint: "–ú–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –≤—Ä–µ–º—è –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ (–ø—É—Å—Ç–æ = –±–µ–∑ —Ç–∞–π–º–µ—Ä–∞/–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é).",
      lblSecForThis: "–°–µ–∫—É–Ω–¥ –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å", phTimer: "–Ω–∞–ø—Ä–∏–º–µ—Ä 20", lblMedia: "–ú–µ–¥–∏–∞ (—Å—Å—ã–ª–∫–∏)", lblMediaHint: "–í—Å—Ç–∞–≤—å—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É (URL) –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–ª–∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª.",
      lblChoices: "–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞", lblChoicesHint: "–ú–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞. –û—Ç–º–µ—Ç—å –≤–µ—Ä–Ω—ã–π —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–æ–π.", btnAddChoice: "‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç",
      lblTextAns: "–í–µ—Ä–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–≤–≤–æ–¥)", lblTextAnsHint: "–ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –ª—é–±–æ–π.", btnAddText: "‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç",
      btnPreviewDraft: "üëÅ –ü–æ–∫–∞–∑–∞—Ç—å –≤ –ø—Ä–µ–≤—å—é", btnSaveQ: "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", lblCodeTitle: "–°—Å—ã–ª–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã",
      lblCodeHint: "–≠—Ç–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–≥—Ä—É. –ï—ë –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å –≤ Genially (—á–µ—Ä–µ–∑ iframe) –∏ –∫—É–¥–∞ —É–≥–æ–¥–Ω–æ.", lblLink: "–°—Å—ã–ª–∫–∞", lblIframe: "iframe (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)",
      btnCopyLink: "üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É", btnCopyIframe: "üìé –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe", btnDownload: "‚¨á –°–∫–∞—á–∞—Ç—å –∏–≥—Ä—É (HTML)",
      noQs: "–ü–æ–∫–∞ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤. –ù–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ 9 –≤–æ–ø—Ä–æ—Å–æ–≤.", rightAns: "‚úÖ –í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç", optionN: "–í–∞—Ä–∏–∞–Ω—Ç ",
      rightOptionN: "–í–µ—Ä–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç ", toastCopied: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ", toastError: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å", toastBgLoaded: "–§–æ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω",
      toast9Q: "–í–æ–ø—Ä–æ—Å–æ–≤ —É–∂–µ 9 üôÇ", toastCleared: "–û—á–∏—â–µ–Ω–æ", toastQAdded: "–í–æ–ø—Ä–æ—Å –¥–æ–±–∞–≤–ª–µ–Ω", toastQUpdated: "–í–æ–ø—Ä–æ—Å –æ–±–Ω–æ–≤–ª—ë–Ω",
      toastDraft: "–ß–µ—Ä–Ω–æ–≤–∏–∫ –ø–æ–∫–∞–∑–∞–Ω –≤ –ø—Ä–µ–≤—å—é", toastEmptyQ: "–ü—É—Å—Ç–æ–π –≤–æ–ø—Ä–æ—Å", toastNoText: "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞",
      toastMin2: "–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞", toastAtLeast1: "–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç", typeChoice: "–í—ã–±–æ—Ä", typeText: "–í–≤–æ–¥",
      withMedia: " (+ –º–µ–¥–∏–∞)", btnShow: "–ü–æ–∫–∞–∑–∞—Ç—å –≤ –ø—Ä–µ–≤—å—é (–ø–µ—Ä–≤—ã–º –≤–æ–ø—Ä–æ—Å–æ–º)", btnEdit: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", btnDel: "–£–¥–∞–ª–∏—Ç—å",
      toastDeleted: "–£–¥–∞–ª–µ–Ω–æ", toastShown: "–ü–æ–∫–∞–∑–∞–Ω–æ –≤ –ø—Ä–µ–≤—å—é"
    },
    en: {
      editorTitle: "Tower Editor", btnCopyCode: "üìã Copy code (iframe)", langTitle: "Interface Language",
      secTitleName: "Name", lblTitleInGame: "In-game Title", secTitleDesign: "Design",
      lblCustomBg: "Choose custom background", btnResetBg: "‚Ü© Reset background", lblBlocksStd: "Blocks: standard",
      lblUseLatex: "Use LaTeX", lblLatexHint: "Enables support for math formulas (e.g., $x^2$)",
      secTitleTimer: "Timer", lblEnableTimer: "Enable timer", lblTimerHint: "If time runs out ‚Äî wrong answer, block burns.",
      lblSecPerQ: "Seconds per question", secTitleQuestions: "Questions", btnAdd: "‚ûï Add", btnClear: "üßπ Clear",
      lblExact9: "Strictly <b>9 questions</b>.", lblTypes: "Allowed: <b>choice</b> or <b>input</b> (multiple correct options).",
      secTitleExport: "Export to Genially", lblExportHint: "Click <b>¬´üìã Copy iframe¬ª</b> ‚Äî a short code will be in your clipboard:",
      previewTitle: "Preview", previewHint: "Live preview (game runs as in Genially)", previewSub: "Tower + cards + final screen",
      modalTitleAdd: "Add question", modalTitleEdit: "Edit question", btnClose: "Close",
      lblQType: "Question type", optChoice: "Multiple choice", optText: "Text input", lblQuestionText: "Question", phQuestion: "Enter question...",
      lblTimerForThis: "Timer for this question", lblTimerForThisHint: "You can set time specifically for this question (empty = no timer/default).",
      lblSecForThis: "Seconds for this question", phTimer: "e.g., 20", lblMedia: "Media (links)", lblMediaHint: "Insert a direct link (URL) to an image or audio file.",
      lblChoices: "Answer choices", lblChoicesHint: "Minimum 2 options. Mark the correct one with the radio button.", btnAddChoice: "‚ûï Add option",
      lblTextAns: "Correct answers (input)", lblTextAnsHint: "Multiple options allowed ‚Äî any will be accepted.", btnAddText: "‚ûï Add option",
      btnPreviewDraft: "üëÅ Show in preview", btnSaveQ: "üíæ Save", lblCodeTitle: "Game Launch Link",
      lblCodeHint: "This is the link to the game. It can be embedded in Genially (via iframe) or anywhere else.", lblLink: "Link", lblIframe: "iframe (if needed)",
      btnCopyLink: "üìã Copy link", btnCopyIframe: "üìé Copy iframe", btnDownload: "‚¨á Download game (HTML)",
      noQs: "No questions yet. Click ¬´Add¬ª and fill in 9 questions.", rightAns: "‚úÖ Correct answer", optionN: "Option ",
      rightOptionN: "Correct option ", toastCopied: "Copied ‚úÖ", toastError: "Failed to copy", toastBgLoaded: "Background loaded",
      toast9Q: "Already 9 questions üôÇ", toastCleared: "Cleared", toastQAdded: "Question added", toastQUpdated: "Question updated",
      toastDraft: "Draft shown in preview", toastEmptyQ: "Empty question", toastNoText: "Enter question text",
      toastMin2: "Minimum 2 choices required", toastAtLeast1: "Add at least one correct answer", typeChoice: "Choice", typeText: "Input",
      withMedia: " (+ media)", btnShow: "Show in preview (first question)", btnEdit: "Edit", btnDel: "Delete",
      toastDeleted: "Deleted", toastShown: "Shown in preview"
    },
    de: {
      editorTitle: "Turm-Editor", btnCopyCode: "üìã Code kopieren (iframe)", langTitle: "Sprache der Benutzeroberfl√§che",
      secTitleName: "Name", lblTitleInGame: "Titel im Spiel", secTitleDesign: "Design",
      lblCustomBg: "Eigenen Hintergrund w√§hlen", btnResetBg: "‚Ü© Hintergrund zur√ºcksetzen", lblBlocksStd: "Bl√∂cke: Standard",
      lblUseLatex: "LaTeX verwenden", lblLatexHint: "Aktiviert die Unterst√ºtzung f√ºr mathematische Formeln (z.B. $x^2$)",
      secTitleTimer: "Timer", lblEnableTimer: "Timer aktivieren", lblTimerHint: "Wenn die Zeit abl√§uft ‚Äî falsche Antwort, Block verbrennt.",
      lblSecPerQ: "Sekunden pro Frage", secTitleQuestions: "Fragen", btnAdd: "‚ûï Hinzuf√ºgen", btnClear: "üßπ Leeren",
      lblExact9: "Streng <b>9 Fragen</b>.", lblTypes: "Erlaubt: <b>Auswahl</b> oder <b>Eingabe</b> (mehrere richtige Optionen).",
      secTitleExport: "Export nach Genially", lblExportHint: "Klicke auf <b>¬´üìã iframe kopieren¬ª</b> ‚Äî ein kurzer Code befindet sich in der Zwischenablage:",
      previewTitle: "Vorschau", previewHint: "Live-Vorschau (Spiel l√§uft wie in Genially)", previewSub: "Turm + Karten + Endbildschirm",
      modalTitleAdd: "Frage hinzuf√ºgen", modalTitleEdit: "Frage bearbeiten", btnClose: "Schlie√üen",
      lblQType: "Fragetyp", optChoice: "Mehrfachauswahl", optText: "Texteingabe", lblQuestionText: "Frage", phQuestion: "Frage eingeben...",
      lblTimerForThis: "Timer f√ºr diese Frage", lblTimerForThisHint: "Du kannst die Zeit speziell f√ºr diese Frage einstellen (leer = kein Timer/Standard).",
      lblSecForThis: "Sekunden f√ºr diese Frage", phTimer: "z.B. 20", lblMedia: "Medien (Links)", lblMediaHint: "F√ºge einen direkten Link (URL) zu einem Bild oder einer Audiodatei ein.",
      lblChoices: "Antwortm√∂glichkeiten", lblChoicesHint: "Mindestens 2 Optionen. Markiere die richtige mit dem Radio-Button.", btnAddChoice: "‚ûï Option hinzuf√ºgen",
      lblTextAns: "Richtige Antworten (Eingabe)", lblTextAnsHint: "Mehrere Optionen erlaubt ‚Äî jede wird akzeptiert.", btnAddText: "‚ûï Option hinzuf√ºgen",
      btnPreviewDraft: "üëÅ In Vorschau zeigen", btnSaveQ: "üíæ Speichern", lblCodeTitle: "Spielstart-Link",
      lblCodeHint: "Dies ist der Link zum Spiel. Er kann in Genially (√ºber iframe) oder anderswo eingebettet werden.", lblLink: "Link", lblIframe: "iframe (falls ben√∂tigt)",
      btnCopyLink: "üìã Link kopieren", btnCopyIframe: "üìé iframe kopieren", btnDownload: "‚¨á Spiel herunterladen (HTML)",
      noQs: "Noch keine Fragen. Klicke auf ¬´Hinzuf√ºgen¬ª und f√ºlle 9 Fragen aus.", rightAns: "‚úÖ Richtige Antwort", optionN: "Option ",
      rightOptionN: "Richtige Option ", toastCopied: "Kopiert ‚úÖ", toastError: "Kopieren fehlgeschlagen", toastBgLoaded: "Hintergrund geladen",
      toast9Q: "Schon 9 Fragen üôÇ", toastCleared: "Geleert", toastQAdded: "Frage hinzugef√ºgt", toastQUpdated: "Frage aktualisiert",
      toastDraft: "Entwurf in Vorschau gezeigt", toastEmptyQ: "Leere Frage", toastNoText: "Fragentext eingeben",
      toastMin2: "Mindestens 2 Auswahlm√∂glichkeiten erforderlich", toastAtLeast1: "F√ºge mindestens eine richtige Antwort hinzu", typeChoice: "Auswahl", typeText: "Eingabe",
      withMedia: " (+ Medien)", btnShow: "In Vorschau zeigen (erste Frage)", btnEdit: "Bearbeiten", btnDel: "L√∂schen",
      toastDeleted: "Gel√∂scht", toastShown: "In Vorschau gezeigt"
    },
    zh: {
      editorTitle: "Â°îÊ•ºÁºñËæëÂô®", btnCopyCode: "üìã Â§çÂà∂‰ª£Á†Å (iframe)", langTitle: "ÁïåÈù¢ËØ≠Ë®Ä",
      secTitleName: "ÂêçÁß∞", lblTitleInGame: "Ê∏∏ÊàèÂÜÖÊ†áÈ¢ò", secTitleDesign: "ËÆæËÆ°",
      lblCustomBg: "ÈÄâÊã©Ëá™ÂÆö‰πâËÉåÊôØ", btnResetBg: "‚Ü© ÈáçÁΩÆËÉåÊôØ", lblBlocksStd: "ÊñπÂùóÔºöÊ†áÂáÜ",
      lblUseLatex: "‰ΩøÁî® LaTeX", lblLatexHint: "ÂêØÁî®ÂØπÊï∞Â≠¶ÂÖ¨ÂºèÁöÑÊîØÊåÅ (‰æãÂ¶Ç $x^2$)",
      secTitleTimer: "ËÆ°Êó∂Âô®", lblEnableTimer: "ÂêØÁî®ËÆ°Êó∂Âô®", lblTimerHint: "Â¶ÇÊûúÊó∂Èó¥Áî®ÂÆå ‚Äî ÂõûÁ≠îÈîôËØØÔºåÊñπÂùóÁÉßÊØÅ„ÄÇ",
      lblSecPerQ: "ÊØèÈ¢òÁßíÊï∞", secTitleQuestions: "ÈóÆÈ¢ò", btnAdd: "‚ûï Ê∑ªÂä†", btnClear: "üßπ Ê∏ÖÈô§",
      lblExact9: "‰∏•Ê†º <b>9 ‰∏™ÈóÆÈ¢ò</b>.", lblTypes: "ÂÖÅËÆ∏Ôºö<b>ÈÄâÊã©</b> Êàñ <b>ËæìÂÖ•</b> (Â§ö‰∏™Ê≠£Á°ÆÈÄâÈ°π)„ÄÇ",
      secTitleExport: "ÂØºÂá∫Âà∞ Genially", lblExportHint: "ÁÇπÂáª <b>¬´üìã Â§çÂà∂ iframe¬ª</b> ‚Äî ÁÆÄÁü≠ÁöÑ‰ª£Á†ÅÂ∞ÜÂú®ÊÇ®ÁöÑÂâ™Ë¥¥Êùø‰∏≠Ôºö",
      previewTitle: "È¢ÑËßà", previewHint: "ÂÆûÊó∂È¢ÑËßà (Ê∏∏ÊàèÂ¶ÇÂú® Genially ‰∏≠ËøêË°å)", previewSub: "Â°îÊ•º + Âç°Áâá + ÊúÄÁªàÂ±èÂπï",
      modalTitleAdd: "Ê∑ªÂä†ÈóÆÈ¢ò", modalTitleEdit: "ÁºñËæëÈóÆÈ¢ò", btnClose: "ÂÖ≥Èó≠",
      lblQType: "ÈóÆÈ¢òÁ±ªÂûã", optChoice: "ÈÄâÊã©È¢ò", optText: "ÊñáÊú¨ËæìÂÖ•", lblQuestionText: "ÈóÆÈ¢ò", phQuestion: "ËæìÂÖ•ÈóÆÈ¢ò...",
      lblTimerForThis: "Ê≠§È¢òËÆ°Êó∂Âô®", lblTimerForThisHint: "ÊÇ®ÂèØ‰ª•‰∏ìÈó®‰∏∫Ê≠§È¢òËÆæÁΩÆÊó∂Èó¥ (Á©∫ = Êó†ËÆ°Êó∂Âô®/ÈªòËÆ§)„ÄÇ",
      lblSecForThis: "Ê≠§È¢òÁßíÊï∞", phTimer: "‰æãÂ¶Ç 20", lblMedia: "Â™í‰Ωì (ÈìæÊé•)", lblMediaHint: "ÊèíÂÖ•ÂõæÁâáÊàñÈü≥È¢ëÊñá‰ª∂ÁöÑÁõ¥Êé•ÈìæÊé• (URL)„ÄÇ",
      lblChoices: "ÈÄâÈ°π", lblChoicesHint: "ÊúÄÂ∞ë 2 ‰∏™ÈÄâÈ°π„ÄÇÁî®ÂçïÈÄâÊåâÈíÆÊ†áËÆ∞Ê≠£Á°ÆÁöÑÈÄâÈ°π„ÄÇ", btnAddChoice: "‚ûï Ê∑ªÂä†ÈÄâÈ°π",
      lblTextAns: "Ê≠£Á°ÆÁ≠îÊ°à (ËæìÂÖ•)", lblTextAnsHint: "ÂÖÅËÆ∏Â§ö‰∏™ÈÄâÈ°π ‚Äî ‰ªª‰Ωï‰∏Ä‰∏™ÈÉΩÂ∞ÜË¢´Êé•Âèó„ÄÇ", btnAddText: "‚ûï Ê∑ªÂä†ÈÄâÈ°π",
      btnPreviewDraft: "üëÅ Âú®È¢ÑËßà‰∏≠ÊòæÁ§∫", btnSaveQ: "üíæ ‰øùÂ≠ò", lblCodeTitle: "Ê∏∏ÊàèÂêØÂä®ÈìæÊé•",
      lblCodeHint: "ËøôÊòØÊ∏∏ÊàèÁöÑÈìæÊé•„ÄÇÂÆÉÂèØ‰ª•ÂµåÂÖ•Âà∞ Genially (ÈÄöËøá iframe) ÊàñÂÖ∂‰ªñ‰ªª‰ΩïÂú∞Êñπ„ÄÇ", lblLink: "ÈìæÊé•", lblIframe: "iframe (Â¶ÇÊûúÈúÄË¶Å)",
      btnCopyLink: "üìã Â§çÂà∂ÈìæÊé•", btnCopyIframe: "üìé Â§çÂà∂ iframe", btnDownload: "‚¨á ‰∏ãËΩΩÊ∏∏Êàè (HTML)",
      noQs: "ÁõÆÂâçÊ≤°ÊúâÈóÆÈ¢ò„ÄÇÁÇπÂáª‚ÄúÊ∑ªÂä†‚ÄùÂπ∂Â°´ÂÜô 9 ‰∏™ÈóÆÈ¢ò„ÄÇ", rightAns: "‚úÖ Ê≠£Á°ÆÁ≠îÊ°à", optionN: "ÈÄâÈ°π ",
      rightOptionN: "Ê≠£Á°ÆÈÄâÈ°π ", toastCopied: "Â∑≤Â§çÂà∂ ‚úÖ", toastError: "Â§çÂà∂Â§±Ë¥•", toastBgLoaded: "ËÉåÊôØÂ∑≤Âä†ËΩΩ",
      toast9Q: "Â∑≤Êúâ 9 ‰∏™ÈóÆÈ¢ò üôÇ", toastCleared: "Â∑≤Ê∏ÖÈô§", toastQAdded: "Â∑≤Ê∑ªÂä†ÈóÆÈ¢ò", toastQUpdated: "ÈóÆÈ¢òÂ∑≤Êõ¥Êñ∞",
      toastDraft: "ËçâÁ®øÂú®È¢ÑËßà‰∏≠ÊòæÁ§∫", toastEmptyQ: "Á©∫ÈóÆÈ¢ò", toastNoText: "ËØ∑ËæìÂÖ•ÈóÆÈ¢òÂÜÖÂÆπ",
      toastMin2: "ÈúÄË¶ÅËá≥Â∞ë 2 ‰∏™ÈÄâÈ°π", toastAtLeast1: "Ê∑ªÂä†Ëá≥Â∞ë‰∏Ä‰∏™Ê≠£Á°ÆÁ≠îÊ°à", typeChoice: "ÈÄâÊã©", typeText: "ËæìÂÖ•",
      withMedia: " (+ Â™í‰Ωì)", btnShow: "Âú®È¢ÑËßà‰∏≠ÊòæÁ§∫ (Á¨¨‰∏ÄÈ¢ò)", btnEdit: "ÁºñËæë", btnDel: "Âà†Èô§",
      toastDeleted: "Â∑≤Âà†Èô§", toastShown: "Â∑≤Âú®È¢ÑËßà‰∏≠ÊòæÁ§∫"
    }
  };

  let currentLang = "ru";

  function t(key) {
    const dict = i18n[currentLang] || i18n.ru;
    return dict[key] || i18n.ru[key] || key;
  }

  function setLanguage(lang) {
    currentLang = lang;
    const dict = i18n[lang] || i18n.ru;
    
    document.querySelectorAll("[data-i18n]").forEach(el => {
      const key = el.getAttribute("data-i18n");
      if (dict[key]) {
        if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
          el.placeholder = dict[key];
        } else if (el.hasAttribute("data-i18n-html")) {
          el.innerHTML = dict[key];
        } else {
          if (el.tagName === "OPTION") el.textContent = dict[key];
          else if (el.childNodes.length) {
            // Safely replace text nodes without destroying child elements if needed
            let foundTextNode = false;
            for (let node of el.childNodes) {
              if (node.nodeType === 3 && node.nodeValue.trim().length > 0) {
                node.nodeValue = dict[key];
                foundTextNode = true;
                break;
              }
            }
            if(!foundTextNode) el.textContent = dict[key];
          } else {
            el.textContent = dict[key];
          }
        }
      }
    });

    // Re-render dynamic components
    renderList();
    if($("selType") && $("selType").value === "choice") renderChoiceUI();
    else if($("selType") && $("selType").value === "text") renderTextUI();
  }

  const selLang = document.getElementById("selLang");
  if (selLang) {
    selLang.addEventListener("change", (e) => setLanguage(e.target.value));
  }

  // ===== errors =====
  const errbar = document.getElementById("errbar");
  function showErr(msg){
    if (!errbar) return;
    errbar.classList.add("show");
    errbar.textContent = "–û—à–∏–±–∫–∞ JS:\n" + msg;
  }
  window.addEventListener("error", (e) => {
    const m = e?.error?.stack || e?.message || String(e);
    showErr(m);
  });
  window.addEventListener("unhandledrejection", (e) => {
    const m = e?.reason?.stack || e?.reason?.message || String(e?.reason || e);
    showErr(m);
  });
  const $ = (id)=>document.getElementById(id);

  // –ó–î–ï–°–¨ –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –í–ê–® __GAME_CSS__, __GAME_HTML__, __GAME_JS__ (–ö–û–î –ò–ì–†–´ –ù–ï –¢–†–û–ì–ê–ï–ú)
  // –Ø –∏—Å–ø–æ–ª—å–∑—É—é –∑–∞–≥–ª—É—à–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã –∫–æ–¥ –±—ã–ª –≤–∞–ª–∏–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –∏—Ç–æ–≥–æ–≤–æ–º —Ñ–∞–π–ª–µ –ª–µ–∂–∞—Ç –≤–∞—à–∏ –±–æ–ª—å—à–∏–µ —Å—Ç—Ä–æ–∫–∏ —Å –∏–≥—Ä–æ–π.
  const __GAME_CSS__ = `/* –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ __GAME_CSS__ */`;
  const __GAME_HTML__ = ``;
  const __GAME_JS__ = `// –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ __GAME_JS__ `;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—ä–µ–∫—Ü–∏–∏ –∏–≥—Ä—ã
  function injectCanvasGame(cfg){
    // –ü–æ–ª–Ω—ã–π –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ injectCanvasGame –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    const root = $("gameRoot");
    root.innerHTML = __GAME_HTML__;
    // ... –≤–∞—à –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ –ª–æ–≥–∏–∫–∏ –æ–∫–Ω–∞ –∏–≥—Ä—ã ...
  }

  function uid(){ return "q_" + Math.random().toString(36).slice(2,9) + "_" + Date.now().toString(36); }
  function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

  function toast(msg){
    const tEl = $("toast");
    if (!tEl) return;
    tEl.textContent = msg;
    tEl.classList.add("show");
    setTimeout(()=>tEl.classList.remove("show"), 1400);
  }

  function fileToDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=>resolve(String(r.result || ""));
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  async function copyToClipboard(text){
    try{
      if (navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch(e){}
    try{
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.setAttribute("readonly", "");
      ta.style.position = "fixed";
      ta.style.left = "0";
      ta.style.top = "0";
      ta.style.opacity = "0";
      ta.style.width = "1px";
      ta.style.height = "1px";
      ta.style.pointerEvents = "none";
      ta.style.zIndex = "-1";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      ta.setSelectionRange(0, ta.value.length);
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }catch(e){ return false; }
  }

  function basePath(){ return location.origin + location.pathname.replace(/\/[^\/]*$/, "/"); }
  const BASE = basePath();
  function selfPageUrl(){
    let p = location.pathname || "/";
    if(p.endsWith("/")) p += "index.html";
    return location.origin + p;
  }

  const repoBgUrl = BASE + "1.png";
  const blockUrls = Array.from({length:9}, (_,i)=> BASE + (i+3) + ".png");

  function parseQueryParams(){
    const q = {};
    const s = window.location.search.replace(/^\?/, "");
    s.split("&").filter(Boolean).forEach(pair=>{
      const [k,v] = pair.split("=");
      if(!k) return;
      q[decodeURIComponent(k)] = decodeURIComponent(v||"");
    });
    return q;
  }

  function parseHashParams(){
    const h = (location.hash || "").replace(/^#/, "");
    const out = {};
    h.split("&").filter(Boolean).forEach(pair=>{
      const [k,v] = pair.split("=");
      if(!k) return;
      out[decodeURIComponent(k)] = decodeURIComponent(v || "");
    });
    return out;
  }

  function b64urlEncode(str){
    const b64 = btoa(unescape(encodeURIComponent(str)));
    return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
  }
  function b64urlDecode(b64url){
    let s = String(b64url||"").replaceAll("-","+").replaceAll("_","/");
    while(s.length % 4) s += "=";
    return decodeURIComponent(escape(atob(s)));
  }

  function normalizeCfg(raw){
    const cfg = raw && typeof raw === "object" ? raw : {};
    const title = String(cfg.title || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π");
    const useRepoBg = !!cfg.useRepoBg;
    const bgDataUrl = String(cfg.bgDataUrl || "");
    const useImages = !!cfg.useImages;
    const useLatex = !!cfg.useLatex;

    const timerEnabled = !!cfg.timer?.enabled;
    const timerSeconds = Math.max(5, Math.min(600, Number(cfg.timer?.seconds || 30)));
    let questions = Array.isArray(cfg.questions) ? cfg.questions.slice(0,9) : [];

    questions = questions.map(q=>{
      const rawSecs = (q && ("seconds" in q)) ? q.seconds : null;
      const nSecs = (rawSecs==null || rawSecs==="") ? null : Number(rawSecs);
      const seconds = (Number.isFinite(nSecs) && nSecs>0) ? Math.max(1, Math.min(600, Math.round(nSecs))) : null;
      const image = String(q?.image || "").trim();
      const audio = String(q?.audio || "").trim();
      
      if(q?.type === "text"){
        return { type:"text", prompt:String(q.prompt||""), accepts:(Array.isArray(q.accepts)?q.accepts:[]).map(x=>String(x||"")), seconds, image, audio };
      }
      return { type:"choice", prompt:String(q?.prompt||""), options:(Array.isArray(q?.options)?q.options:[]).map(x=>String(x||"")), correctIndex:Number(q?.correctIndex||0), seconds, image, audio };
    });
    return { title, useRepoBg, bgDataUrl, timer: { enabled: timerEnabled, seconds: timerSeconds }, useImages, useLatex, blockUrls: blockUrls, questions };
  }

  const Editor = {
    title: "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π",
    useRepoBg: true,
    bgDataUrl: "",
    timer: { enabled:false, seconds: 30 },
    useImages: true,
    useLatex: false,
    questions: [],
    draft: null,
    editingId: null
  };

  function setCountPill(){
    $("pillCount").textContent = Editor.questions.length + " / 9";
    $("btnAddQ").disabled = (Editor.questions.length >= 9);
  }

  function escapeHtml(s){
    return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function qSummary(q){
    const p = String(q.prompt || "").trim();
    const short = p.length > 50 ? p.slice(0,50)+"‚Ä¶" : p;
    let type = (q.type==="choice") ? t("typeChoice") : t("typeText");
    if (q.image || q.audio) type += t("withMedia");
    return { title: short || "(–ø—É—Å—Ç–æ)", sub: type };
  }

  function renderList(){
    const list = $("qList");
    list.innerHTML = "";
    setCountPill();

    if(Editor.questions.length === 0){
      const d = document.createElement("div");
      d.className = "muted";
      d.textContent = t("noQs");
      list.appendChild(d);
      return;
    }

    Editor.questions.forEach((q,i)=>{
      const wrap = document.createElement("div");
      wrap.className = "q-item";

      const meta = document.createElement("div");
      meta.className = "meta";
      const s = qSummary(q);
      meta.innerHTML = `<div class="t">${escapeHtml(String(i+1)+". "+s.title)}</div><div class="s">${escapeHtml(s.sub)}</div>`;

      const btns = document.createElement("div");
      btns.style.display="flex";
      btns.style.gap="8px";
      btns.style.flexWrap="wrap";
      btns.style.justifyContent="flex-end";

      const bPrev = document.createElement("button");
      bPrev.className = "btn small";
      bPrev.type="button";
      bPrev.textContent = "üëÅ";
      bPrev.title = t("btnShow");
      bPrev.onclick = ()=>{
        Editor.draft = deepClone(q);
        updatePreview(true);
        toast(t("toastShown"));
      };
      
      const bEdit = document.createElement("button");
      bEdit.className = "btn small";
      bEdit.type="button";
      bEdit.textContent = "‚úèÔ∏è";
      bEdit.title = t("btnEdit");
      bEdit.onclick = ()=> openModal(q);
      
      const bDel = document.createElement("button");
      bDel.className = "btn small danger";
      bDel.type="button";
      bDel.textContent = "üóë";
      bDel.title = t("btnDel");
      bDel.onclick = ()=>{
        Editor.questions = Editor.questions.filter(x=>x.id!==q.id);
        renderList();
        updatePreview(false);
        toast(t("toastDeleted"));
      };

      btns.appendChild(bPrev);
      btns.appendChild(bEdit);
      btns.appendChild(bDel);
      wrap.appendChild(meta);
      wrap.appendChild(btns);
      list.appendChild(wrap);
    });
  }

  function showModal(){
    $("modalBackdrop").style.display = "flex";
    $("modalBackdrop").setAttribute("aria-hidden","false");
  }
  function hideModal(){
    $("modalBackdrop").style.display = "none";
    $("modalBackdrop").setAttribute("aria-hidden","true");
  }

  function syncModalType(){
    const ty = $("selType").value;
    $("choiceWrap").style.display = (ty==="choice") ? "block" : "none";
    $("textWrap").style.display = (ty==="text") ? "block" : "none";
  }

  function renderChoiceUI(){
    const list = $("choiceList");
    list.innerHTML = "";
    const q = Editor.draft;
    if(!q) return;

    q.options = q.options || ["",""];
    if(typeof q.correctIndex !== "number") q.correctIndex = 0;

    q.options.forEach((val, idx)=>{
      const row = document.createElement("div");
      row.className = "answerRow";

      const r = document.createElement("input");
      r.className="radio";
      r.type="radio";
      r.name="correctChoice";
      r.checked = (q.correctIndex === idx);
      r.onchange = ()=>{ q.correctIndex = idx; renderChoiceUI(); };

      const inp = document.createElement("input");
      inp.type="text";
      inp.value = val || "";
      inp.placeholder = (idx === q.correctIndex) ? t("rightAns") : (t("optionN") + (idx+1));
      inp.oninput = ()=>{ q.options[idx] = inp.value; };

      const del = document.createElement("button");
      del.className="btn small danger";
      del.type="button";
      del.textContent="‚úñ";
      del.onclick = ()=>{
        q.options.splice(idx,1);
        if(q.options.length < 2) q.options.push("");
        if(q.correctIndex >= q.options.length) q.correctIndex = q.options.length-1;
        renderChoiceUI();
      };

      row.appendChild(r);
      row.appendChild(inp);
      row.appendChild(del);
      list.appendChild(row);
    });
  }

  function renderTextUI(){
    const list = $("textList");
    list.innerHTML = "";
    const q = Editor.draft;
    if(!q) return;
    q.accepts = q.accepts || [""];

    q.accepts.forEach((val, idx)=>{
      const row = document.createElement("div");
      row.className = "answerRow";

      const inp = document.createElement("input");
      inp.type="text";
      inp.value = val || "";
      inp.placeholder = (idx===0) ? t("rightAns") : (t("rightOptionN") + (idx+1));
      inp.oninput = ()=>{ q.accepts[idx] = inp.value; };

      const del = document.createElement("button");
      del.className="btn small danger";
      del.type="button";
      del.textContent="‚úñ";
      del.onclick = ()=>{
        q.accepts.splice(idx,1);
        if(q.accepts.length === 0) q.accepts.push("");
        renderTextUI();
      };

      row.appendChild(inp);
      row.appendChild(del);
      list.appendChild(row);
    });
  }

  function openModal(existing=null){
    if(existing){
      Editor.draft = deepClone(existing);
      Editor.editingId = existing.id;
      $("modalTitle").textContent = t("modalTitleEdit");
    } else {
      Editor.draft = {
        id: uid(), type: "choice", prompt: "", options: ["",""], correctIndex: 0, seconds: null, image: "", audio: ""
      };
      Editor.editingId = null;
      $("modalTitle").textContent = t("modalTitleAdd");
    }

    $("selType").value = Editor.draft.type || "choice";
    $("inpPrompt").value = Editor.draft.prompt || "";
    
    if(!("seconds" in Editor.draft)) Editor.draft.seconds = null;
    if($("inpQSeconds")) $("inpQSeconds").value = (Editor.draft.seconds ?? "");
    
    if(!("image" in Editor.draft)) Editor.draft.image = "";
    if(!("audio" in Editor.draft)) Editor.draft.audio = "";
    if($("inpQImage")) $("inpQImage").value = Editor.draft.image;
    if($("inpQAudio")) $("inpQAudio").value = Editor.draft.audio;
    
    syncModalType();
    if($("selType").value === "choice") renderChoiceUI();
    else renderTextUI();

    showModal();
    setTimeout(()=>$("inpPrompt").focus(), 40);
  }

  function getDraftFromModal(){
    const q = Editor.draft;
    if(!q) return null;
    q.type = $("selType").value;
    q.prompt = $("inpPrompt").value || "";

    q.seconds = ($("inpQSeconds") && $("inpQSeconds").value !== "") ? Number($("inpQSeconds").value) : null;
    if(q.seconds != null){
      const s = Number(q.seconds);
      if(!Number.isFinite(s) || s < 3 || s > 600) return "–¢–∞–π–º–µ—Ä –≤–æ–ø—Ä–æ—Å–∞: 3‚Äì600 —Å–µ–∫—É–Ω–¥";
      q.seconds = Math.round(s);
    }
    
    q.image = $("inpQImage") ? $("inpQImage").value.trim() : "";
    q.audio = $("inpQAudio") ? $("inpQAudio").value.trim() : "";

    if(q.type === "choice"){
      q.options = (q.options || []).map(x=>String(x||""));
      q.correctIndex = Number.isFinite(q.correctIndex) ? q.correctIndex : 0;
    } else {
      q.accepts = (q.accepts || [""]).map(x=>String(x||""));
    }
    return q;
  }

  function validateQuestion(q){
    if(!q) return t("toastEmptyQ");
    if(!(q.prompt||"").trim()) return t("toastNoText");

    if(q.type === "choice"){
      const opts = (q.options||[]).map(x=>String(x||"").trim()).filter(Boolean);
      if(opts.length < 2) return t("toastMin2");
      q.options = opts;
      if(!Number.isFinite(q.correctIndex)) q.correctIndex = 0;
      if(q.correctIndex >= q.options.length) q.correctIndex = 0;
      return "";
    }

    const acc = (q.accepts||[]).map(x=>String(x||"").trim()).filter(Boolean);
    if(acc.length === 0) return t("toastAtLeast1");
    q.accepts = acc;
    return "";
  }

  function buildPayload(previewWithDraft){
    let questions = Editor.questions.map(q=>{
      if(q.type === "choice"){
        return { type:"choice", prompt:q.prompt||"", options:(q.options||[]).slice(), correctIndex:Number(q.correctIndex||0), seconds:(q.seconds??null), image:q.image||"", audio:q.audio||"" };
      }
      return { type:"text", prompt:q.prompt||"", accepts:(q.accepts||[]).slice(), seconds:(q.seconds??null), image:q.image||"", audio:q.audio||"" };
    });
    
    if(previewWithDraft && Editor.draft){
      const d = deepClone(Editor.draft);
      questions = questions.slice();
      if(d.type === "choice"){
        const mapped = {
          type:"choice", prompt:d.prompt||"", options:(d.options||[]).slice(), correctIndex:Number(d.correctIndex||0),
          seconds: (d.seconds==null || d.seconds==="") ? null : Number(d.seconds), image:d.image||"", audio:d.audio||""
        };
        if(questions.length === 0) questions.push(mapped);
        else questions[0] = mapped;
      } else {
        const mapped = {
          type:"text", prompt:d.prompt||"", accepts:(d.accepts||[]).slice(),
          seconds: (d.seconds==null || d.seconds==="") ? null : Number(d.seconds), image:d.image||"", audio:d.audio||""
        };
        if(questions.length === 0) questions.push(mapped);
        else questions[0] = mapped;
      }
    }

    return normalizeCfg({
      title: Editor.title || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π",
      useRepoBg: true,
      bgDataUrl: Editor.bgDataUrl || "",
      timer: { enabled: !!Editor.timer.enabled, seconds: Number(Editor.timer.seconds || 30) },
      useImages: !!Editor.useImages,
      useLatex: !!Editor.useLatex,
      questions
    });
  }

  function buildGameUrl(payload){
    const data = b64urlEncode(JSON.stringify(payload));
    return selfPageUrl() + "?game=" + data + "#game=" + data;
  }
  
  function buildIframeFromUrl(src){
    return `<iframe src="${src}" style="width:100%;height:100%;min-height:720px;border:0;border-radius:18px;overflow:hidden;background:transparent" allow="autoplay; fullscreen" allowfullscreen loading="lazy"></iframe>`;
  }

  const PREVIEW_CFGKEY = "__tower_preview_cfg__";
  function storePreviewCfg(cfg){
    try{ localStorage.setItem(PREVIEW_CFGKEY, JSON.stringify(cfg)); return PREVIEW_CFGKEY; }
    catch(e){ return ""; }
  }

  function updatePreview(previewWithDraft){
    const payload = buildPayload(previewWithDraft);
    const jsonStr = JSON.stringify(payload);
    const useKey = jsonStr.length > 1800;
    if(useKey){
      const key = storePreviewCfg(payload);
      if(key){
        const src = selfPageUrl() + "?cfgkey=" + encodeURIComponent(key) + "&preview=1#cfgkey=" + encodeURIComponent(key);
        $("livePreview").src = src;
        return;
      }
    }
    const data = b64urlEncode(jsonStr);
    const src = selfPageUrl() + "?game=" + data + "&preview=1#game=" + data;
    $("livePreview").src = src;
  }

  $("inpTitle").addEventListener("input", ()=>{ Editor.title = $("inpTitle").value || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π"; updatePreview(false); });
  
  $("fileBg").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    Editor.bgDataUrl = await fileToDataUrl(f); toast(t("toastBgLoaded")); updatePreview(false);
  });
  
  $("btnResetBg").addEventListener("click", ()=>{ Editor.bgDataUrl = ""; $("fileBg").value = ""; updatePreview(false); });
  $("chkUseImages").addEventListener("change", ()=>{ Editor.useImages = true; if($("chkUseImages")) $("chkUseImages").checked = true; updatePreview(false); });
  if($("chkUseLatex")) $("chkUseLatex").addEventListener("change", ()=>{ Editor.useLatex = $("chkUseLatex").checked; updatePreview(false); });
  $("chkTimer").addEventListener("change", ()=>{ Editor.timer.enabled = $("chkTimer").checked; updatePreview(false); });
  $("inpSeconds").addEventListener("input", ()=>{ Editor.timer.seconds = Number($("inpSeconds").value || 30); updatePreview(false); });
  
  $("btnAddQ").addEventListener("click", ()=>{ if(Editor.questions.length >= 9){ toast(t("toast9Q")); return; } openModal(null); });
  $("btnClearQs").addEventListener("click", ()=>{ Editor.questions = []; renderList(); updatePreview(false); toast(t("toastCleared")); });
  $("btnCloseModal").addEventListener("click", ()=>{ Editor.draft=null; Editor.editingId=null; hideModal(); });
  $("modalBackdrop").addEventListener("click", (e)=>{ if(e.target === $("modalBackdrop")){ Editor.draft=null; Editor.editingId=null; hideModal(); } });
  
  $("selType").addEventListener("change", ()=>{
    const q = Editor.draft; if(!q) return; q.type = $("selType").value; syncModalType();
    if(q.type === "choice"){ q.options = q.options || ["",""]; if(typeof q.correctIndex !== "number") q.correctIndex = 0; renderChoiceUI(); } 
    else { q.accepts = q.accepts || [""]; renderTextUI(); }
  });
  
  if($("btnClearImage")) $("btnClearImage").addEventListener("click", () => { $("inpQImage").value = ""; });
  if($("btnClearAudio")) $("btnClearAudio").addEventListener("click", () => { $("inpQAudio").value = ""; });
  
  $("btnAddChoice").addEventListener("click", ()=>{ const q = Editor.draft; if(!q) return; q.options = q.options || ["",""]; q.options.push(""); renderChoiceUI(); });
  $("btnAddText").addEventListener("click", ()=>{ const q = Editor.draft; if(!q) return; q.accepts = q.accepts || [""]; q.accepts.push(""); renderTextUI(); });
  
  $("btnPreviewDraft").addEventListener("click", ()=>{ getDraftFromModal(); updatePreview(true); toast(t("toastDraft")); });
  
  $("btnSaveQ").addEventListener("click", ()=>{
    const q = getDraftFromModal(); const err = validateQuestion(q);
    if(err){ toast(err); return; }
    if(Editor.editingId){
      const idx = Editor.questions.findIndex(x=>x.id === Editor.editingId);
      if(idx >= 0){ q.id = Editor.editingId; Editor.questions[idx] = q; toast(t("toastQUpdated")); } 
      else { Editor.questions.push(q); toast(t("toastQAdded")); }
    } else { Editor.questions.push(q); toast(t("toastQAdded")); }
    Editor.draft=null; Editor.editingId=null; hideModal(); renderList(); updatePreview(false);
  });
  
  $("btnCopyCode").addEventListener("click", async ()=>{
    const payload = buildPayload(false); const url = buildGameUrl(payload); const iframeCode = buildIframeFromUrl(url);
    const ok = await copyToClipboard(iframeCode); toast(ok ? t("toastCopied") : t("toastError"));
  });
  
  function hideCodeModal(){
    if(!$("codeBackdrop")) return; $("codeBackdrop").style.display = "none"; $("codeBackdrop").setAttribute("aria-hidden","true");
  }
  if ($("btnCloseCode")) $("btnCloseCode").addEventListener("click", hideCodeModal);
  if ($("codeBackdrop")) { $("codeBackdrop").addEventListener("click", (e)=>{ if(e.target === $("codeBackdrop")) hideCodeModal(); }); }
  
  if ($("btnCopyFromModal")) {
    $("btnCopyFromModal").addEventListener("click", async ()=>{
      const text = ($("taIframe")?.value || "").trim(); if(!text){ toast("–ü—É—Å—Ç–æ"); return; }
      const ok = await copyToClipboard(text); toast(ok ? t("toastCopied") : t("toastError"));
    });
    if ($("btnCopyIframe")) {
      $("btnCopyIframe").addEventListener("click", async ()=>{
        const text = ($("taIframe2")?.value || "").trim(); if(!text){ toast("–ü—É—Å—Ç–æ"); return; }
        const ok = await copyToClipboard(text); toast(ok ? t("toastCopied") : t("toastError"));
      });
    }
  }

  if ($("btnDownloadGame")) {
    $("btnDownloadGame").addEventListener("click", ()=>{
      try{
        const payload = buildPayload(true); const safeJson = JSON.stringify(payload).replace(/</g, "\\u003c");
        const embed = `<script>window.__EMBEDDED_CFG__=${safeJson};<\/script>\n`;
        const full = "<!doctype html>\n" + document.documentElement.outerHTML;
        const out = full.replace("<script>\n(() => {", embed + "<script>\n(() => {");
        const blob = new Blob([out], {type:"text/html;charset=utf-8"});
        const a = document.createElement("a"); const ts = new Date(); const pad = (n)=> String(n).padStart(2,"0");
        const name = `tower_game_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}.html`;
        a.href = URL.createObjectURL(blob); a.download = name; document.body.appendChild(a); a.click();
        setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0); toast("–ò–≥—Ä–∞ —Å–∫–∞—á–∞–Ω–∞ ‚úÖ");
      }catch(e){ showErr(e?.stack || e?.message || String(e)); toast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å üòï"); }
    });
  }

  function bootGameOnly(cfg){
    document.body.setAttribute("data-mode","game"); document.body.classList.add("gameOnly");
    $("editorRoot").style.display = "none"; $("modalBackdrop").style.display = "none";
    if($("codeBackdrop")) $("codeBackdrop").style.display = "none";
    $("gameRoot").style.display = "block";
    injectCanvasGame(cfg);
  }

  const qp = parseQueryParams(); const hp = parseHashParams();
  const gameParam = qp.game || hp.game;
  const cfgKeyParam = qp.cfgkey || hp.cfgkey;

  if (window.__EMBEDDED_CFG__) {
    try{ bootGameOnly(normalizeCfg(window.__EMBEDDED_CFG__)); }
    catch(e){ $("gameHost").innerHTML = `<div style="padding:16px;color:#ffd6d6;font-weight:900">–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ üòï</div>`; }
    return;
  }
  if(gameParam){
    try{ const raw = JSON.parse(b64urlDecode(gameParam)); bootGameOnly(normalizeCfg(raw)); }
    catch(e){ $("gameHost").innerHTML = `<div style="padding:16px;color:#ffd6d6;font-weight:900">–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ –∏–∑ iframe üòï</div>`; }
    return;
  }
  if(cfgKeyParam){
    try{
      const rawStr = localStorage.getItem(cfgKeyParam) || sessionStorage.getItem(cfgKeyParam);
      if(!rawStr) throw new Error("cfgkey not found in storage");
      const raw = JSON.parse(rawStr); bootGameOnly(normalizeCfg(raw));
    }catch(e){ $("gameHost").innerHTML = `<div style="padding:16px;color:#ffd6d6;font-weight:900">–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ (cfgkey) üòï</div>`; }
    return;
  }

  Editor.title = $("inpTitle").value || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π";
  Editor.timer.enabled = $("chkTimer").checked; Editor.timer.seconds = Number($("inpSeconds").value || 30);
  Editor.useImages = true;
  if($("chkUseImages")) $("chkUseImages").checked = true;
  if($("chkUseLatex")) Editor.useLatex = $("chkUseLatex").checked;
  Editor.useRepoBg = true;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
  setLanguage("ru");
  updatePreview(false);
  
  try{
    const titles = Array.from(document.querySelectorAll(".section .title"));
    const tEl = titles.find(x=>x.textContent.trim()==="–≠–∫—Å–ø–æ—Ä—Ç –≤ Genially" || x.getAttribute("data-i18n")==="secTitleExport");
    if(tEl){ const sec = tEl.closest(".section");
    if(sec) sec.style.display="none"; }
  }catch(e){}

})();
</script>
</body>
</html>
