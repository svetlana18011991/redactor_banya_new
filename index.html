<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ë–∞—à–Ω—è ‚Äî Editor + Game (–æ–¥–∏–Ω —Ñ–∞–π–ª)</title>

  <style>
    html, body{height:100%}

    :root{
      --text:#eaf0ff;
      --muted:#a9b6e6;
      --border: rgba(255,255,255,.10);
      --shadow2: 0 12px 34px rgba(0,0,0,.40);
      --radius: 18px;
      --radius2: 22px;

      --neon:#d6b14a;
      --neon2:#f2d37a;
      --danger:#ff4d4d;
      --ok:#2dd27d;
    }

    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    body{
      margin:0;color:var(--text);
      background:
        radial-gradient(1100px 700px at 12% 18%, rgba(35,82,200,.28) 0%, rgba(5,8,22,0) 58%),
        radial-gradient(900px 640px at 88% 16%, rgba(20,160,255,.18) 0%, rgba(5,8,22,0) 62%),
        radial-gradient(1000px 780px at 55% 112%, rgba(214,177,74,.14) 0%, rgba(5,8,22,0) 58%),
        linear-gradient(180deg, rgba(4,10,32,.92), rgba(3,6,18,1));
      min-height:100vh;
    }
    body.gameOnly{background:transparent}

    .app{
      display:grid;
      grid-template-columns: 460px 1fr;
      gap:14px;
      padding:14px;
      max-width: 1540px;
      margin: 0 auto;
    }
    @media (max-width: 1020px){
      .app{grid-template-columns:1fr}
    }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid var(--border);
      border-radius:var(--radius2);
      box-shadow:var(--shadow2);
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
    }

    .panel-header{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }

    .header-left{display:flex;flex-direction:column;gap:6px;min-width:0}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{width:40px;height:40px;border-radius:14px;box-shadow:0 12px 34px rgba(0,0,0,.45)}
    .brand .name{font-weight:800;letter-spacing:.2px;font-size:14px;color:rgba(255,255,255,.92)}

    .panel-header .h{font-weight:950;letter-spacing:.2px}
    .panel-body{padding:14px}

    .settings{
      height: calc(100vh - 28px);
      display:flex;
      flex-direction:column;
      min-height: 560px;
    }
    .settings .panel-body{
      overflow:auto;
      padding:14px;
    }

    /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
    .settings .panel-body::-webkit-scrollbar { width: 8px; }
    .settings .panel-body::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 4px; }
    .settings .panel-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    .settings .panel-body::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

    [data-section="timer"]{display:none !important}
    [data-hide="blocks"]{display:none !important}

    .section{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      margin-bottom:12px;
    }
    .section .title{
      font-weight:950;
      font-size:13.5px;
      margin-bottom:10px;
      color:rgba(255,255,255,.92);
      display:flex;align-items:center;justify-content:space-between;gap:8px;
    }

    .muted{color:var(--muted); font-size:12.5px; line-height:1.35}

    label{
      display:block;
      font-size:12.5px;
      color:rgba(255,255,255,.86);
      margin:10px 0 6px
    }

    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      border-radius:14px;
      padding:10px 11px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:84px;
      resize:vertical}

    input[type="file"]{
      width:100%;
      border-radius:14px;
      padding:10px 11px;
      border:1px dashed rgba(255,255,255,.22);
      background:rgba(0,0,0,.18);
      color:var(--muted);
    }

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1;
      min-width:170px}

    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      margin-top:8px;
    }
    .toggle input{width:18px; height:18px}

    .btn{
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-weight:950;
      font-size:14px;
      transition:transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .2s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.24)}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.45;
      cursor:not-allowed}

    .btn.primary{
      background:linear-gradient(90deg, rgba(214,177,74,.35), rgba(242,211,122,.22));
      border-color:rgba(214,177,74,.40);
      box-shadow: 0 10px 26px rgba(214,177,74,.18);
    }
    .btn.danger{border-color:rgba(255,77,77,.35); background:rgba(255,77,77,.08)}
    .btn.small{padding:8px 10px; font-size:12.5px; border-radius:12px}

    .q-list{display:flex; flex-direction:column;
      gap:10px;}
    .q-item{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .q-item .meta{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
      padding-top:3px;
    }
    .q-item .meta .t{
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis
    }
    .q-item .meta .s{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(255,255,255,.92);
    }

    .preview{
      min-height: calc(100vh - 28px);
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:0;
      overflow:hidden;
    }
    .preview-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
    }
    .preview-top .name{font-weight:950; letter-spacing:.2px}
    .preview-top .hint{color:var(--muted);
      font-size:12.5px}

    .preview-stage{
      position:relative;
      border-radius:var(--radius2);
      overflow:hidden;
      min-height: 720px;
      height: calc(100vh - 80px);
      background:rgba(0,0,0,.18);

      /* Neon orange frame */
      border: 1px solid rgba(255, 140, 0, .35);
      box-shadow:
        0 18px 60px rgba(0,0,0,.55),
        0 0 0 1px rgba(255, 140, 0, .20),
        0 0 26px rgba(255, 120, 0, .22),
        0 0 70px rgba(255, 120, 0, .14);
    }

    .preview-stage::before{
      content:"";
      position:absolute;
      inset:10px;
      border-radius: calc(var(--radius2) - 10px);
      pointer-events:none;
      border: 1px solid rgba(255, 170, 40, .18);
      box-shadow: 0 0 22px rgba(255, 140, 0, .12) inset;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      z-index:999999;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px)
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999998;
      padding:14px;
    }

    .modal{
      width:min(820px, 100%);
      max-height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal-head{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      flex-shrink: 0;
    }
    .modal-head .h{font-weight:950}
    .modal-body{
      padding:14px;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
    }
    
    /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
    .modal-body::-webkit-scrollbar { width: 8px; }
    .modal-body::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 4px; }
    .modal-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    .modal-body::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

    .modal-foot{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      flex-shrink: 0;
    }

    .choiceBlock{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.14);
      border-radius:14px;
      padding:10px;
      margin-top:10px;
    }

    .answerRow{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:8px;
    }
    .answerRow input[type="text"]{flex:1; min-width:0}

    .radio{
      width:18px;
      height:18px;
      accent-color: var(--neon);
      flex:0 0 auto;
    }

    .errbar{
      display:none;
      margin:12px 14px 0;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,77,77,.35);
      background:rgba(255,77,77,.10);
      color:#ffd6d6;
      font-size:13px;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .errbar.show{display:block}

    /* ===== GAME styles (scoped by .gameHost) ===== */
    .gameHost{
      width:100%;
      height:100%;
      min-height:0;
    }
    .gameHost *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .stage{
      position:relative;
      width:100%;
      height:100%;
      min-height:720px;
      overflow:hidden;
      border-radius:18px;
      background:
        radial-gradient(1100px 700px at 12% 18%, rgba(106,164,255,.18) 0%, rgba(5,8,22,0) 58%),
        radial-gradient(900px 640px at 88% 16%, rgba(155,123,255,.14) 0%, rgba(5,8,22,0) 62%),
        radial-gradient(1000px 780px at 55% 112%, rgba(45,210,125,.12) 0%, rgba(5,8,22,0) 58%),
        linear-gradient(180deg, rgba(10,14,40,.60), rgba(5,8,22,1));
      color:var(--text);
    }
    .bg{
      position:absolute; inset:0;
      background-position:center;
      background-size:cover;
      opacity: .92;
      transform: scale(1.02);
      filter: saturate(1.05) contrast(1.02);
      pointer-events:none;
      display:none;
    }
    .overlay{
      position:absolute; inset:0;
      background: radial-gradient(900px 620px at 50% 35%, rgba(0,0,0,0) 0%, rgba(0,0,0,.40) 70%);
      pointer-events:none;
    }
    .topbar{
      position:absolute;
      left:12px; right:12px; top:12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
      z-index:30;
    }
    .leftPack{display:flex;
      flex-direction:column; gap:2px; min-width:220px}
    .title{font-weight:950; letter-spacing:.2px}
    .sub{color:rgba(255,255,255,.78); font-size:12px}
    .rightPack{display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end}

    .pillGame{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(255,255,255,.92);
      font-weight:900;
      font-size:12px;
      user-select:none;
    }
    .timerBadge{
      border-color: rgba(57,255,118,.22);
      box-shadow: 0 0 18px rgba(57,255,118,.14);
    }
    .progressWrap{
      width:260px; max-width:60vw;
      height:12px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
    }
    .progressBar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(57,255,118,.35), rgba(57,255,118,.95));
      box-shadow: 0 0 14px rgba(57,255,118,.35);
      transition: width .25s ease;
    }

    .towerArea{
      position:absolute;
      left:0; right:0; top:0; bottom:0;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      z-index:10;
      padding-bottom: 64px;
    }
    .tower{
      position:relative;
      width:min(320px, 70vw);
      height: calc(100% - 170px);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      pointer-events:none;
    }

    .cssBlock{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      width:min(280px, 64vw);
      height:78px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(260px 100px at 30% 30%, rgba(255,255,255,.10), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, rgba(57,255,118,.12), rgba(0,0,0,.18));
      box-shadow: 0 22px 34px rgba(0,0,0,.35);
      overflow:hidden;
      filter: drop-shadow(0 14px 16px rgba(0,0,0,.30));
    }
    .cssBlock::after{
      content:"";
      position:absolute; inset:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      opacity:.9;
    }

    .imgBlock{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      will-change: transform, top, opacity, filter;
      filter: drop-shadow(0 18px 20px rgba(0,0,0,.35));
    }

    .burning{
      filter: grayscale(.15) brightness(.72) contrast(1.1) sepia(.28) saturate(1.15) !important;
      opacity:.96;
    }

    .nextWrap{
      position:absolute;
      left:0; right:0;
      bottom: 22px;
      display:flex;
      justify-content:center;
      z-index:35;
      pointer-events:auto;
    }
    .hintUnder{
      position:absolute;
      left:0; right:0;
      bottom: 66px;
      display:flex;
      justify-content:center;
      z-index:35;
      pointer-events:none;
    }
    .hintBubble{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      backdrop-filter: blur(10px);
      font-size:12px;
      color:rgba(255,255,255,.9);
      max-width:min(760px, 92vw);
      text-align:center;
      box-shadow: 0 18px 50px rgba(0,0,0,.20);
    }

    .btnGame{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.95);
      cursor:pointer;
      font-weight:950;
      font-size:14px;
      transition:transform .08s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btnGame:hover{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.24)}
    .btnGame:active{transform:translateY(1px)}
    .btnGame:disabled{opacity:.45;
      cursor:not-allowed}
    .btnGame.primary{
      background: linear-gradient(90deg, rgba(57,255,118,.22), rgba(0,255,179,.18));
      border-color: rgba(57,255,118,.30);
      box-shadow: 0 12px 30px rgba(57,255,118,.10);
    }

    .cardBack{
      position:absolute; inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
      padding:14px;
    }
    .card{
      width:min(760px, 96vw);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      overflow:hidden;
      transform: translateY(12px) scale(.985);
      opacity:0;
      animation: cardIn .32s ease-out forwards;
    }
    @keyframes cardIn{ to{ transform:none; opacity:1;
    } }

    .cardHead{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .cardHead .h{font-weight:950}
    .cardBody{padding:14px}
    .cardFoot{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .block{
      padding:12px 12px;
      border-radius:16px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
    }
    .block .label{font-size:12px;color:rgba(255,255,255,.70);margin-bottom:8px;font-weight:900}
    .qText{white-space:pre-wrap; font-size:16px; line-height:1.35}

    .answers{display:flex;
      flex-wrap:wrap; gap:8px}
    .pillBtn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(255,255,255,.92);
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition:transform .08s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
    }
    .pillBtn:hover{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.24)}
    .pillBtn:active{transform:translateY(1px)}

    .inputRow{display:flex; gap:10px; align-items:center;
      flex-wrap:wrap}
    .inp{
      flex:1; min-width:220px;
      border-radius:14px;
      padding:10px 11px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:rgba(255,255,255,.92);
      outline:none;
    }

    .floatPlus{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      color: rgba(57,255,118,.96);
      font-weight:1000;
      text-shadow: 0 0 10px rgba(57,255,118,.35);
      pointer-events:none;
      z-index:45;
      animation: plusFly .9s ease-out forwards;
    }
    @keyframes plusFly{
      0%{opacity:0;
      transform:translateX(-50%) translateY(10px) scale(.98)}
      20%{opacity:1}
      100%{opacity:0;
      transform:translateX(-50%) translateY(-70px) scale(1.05)}
    }

    .spark{
      position:absolute;
      width:6px;height:6px;
      border-radius:999px;
      background: rgba(255,220,120,.95);
      box-shadow: 0 0 10px rgba(255,200,80,.35);
      pointer-events:none;
      z-index:44;
      animation: sparkFly .7s ease-out forwards;
    }
    @keyframes sparkFly{
      to{
        opacity:0;
        transform: translate(var(--dx), var(--dy)) scale(.4);
        filter: blur(0.2px);
      }
    }

    .smoke{
      position:absolute;
      width:18px;height:18px;
      border-radius:999px;
      background: rgba(120,120,120,.35);
      filter: blur(1px);
      pointer-events:none;
      z-index:43;
      animation: smokeFly 1.0s ease-out forwards;
    }
    @keyframes smokeFly{
      0%{opacity:0;
      transform: translate(0,0) scale(.8)}
      20%{opacity:1}
      100%{opacity:0;
      transform: translate(var(--dx), var(--dy)) scale(1.6)}
    }

    .finish{
      position:absolute; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:60;
      padding:14px;
    }
    .finishCard{
      width:min(820px, 96vw);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 36px 110px rgba(0,0,0,.60);
      overflow:hidden;
    }
    .finishHead{
      padding:14px 16px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .finishHead .h{font-weight:1000;
      font-size:18px}
    .finishBody{padding:14px 16px}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:720px){ .grid{grid-template-columns:1fr} }
    .stat{
      padding:12px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
    }
    .stat .k{color:rgba(255,255,255,.75); font-size:12px; font-weight:900}
    .stat .v{font-size:22px; font-weight:1000;
      margin-top:4px}
    .bigMsg{
      margin-top:12px;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(57,255,118,.25);
      background:rgba(57,255,118,.08);
    }
    .bigMsg .h{font-weight:1000; font-size:18px}
    .bigMsg .p{color:rgba(255,255,255,.85); margin-top:6px;
      line-height:1.35}
  
    /* ===== Premium gold/blue polish ===== */
    .panel{
      border-color: rgba(214,177,74,.22);
      box-shadow: 0 18px 60px rgba(0,0,0,.50);
    }
    .panel::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(242,211,122,.08), rgba(0,0,0,0) 60%),
        radial-gradient(700px 520px at 80% 20%, rgba(20,160,255,.10), rgba(0,0,0,0) 55%),
        repeating-linear-gradient(135deg, rgba(214,177,74,.06) 0 2px, rgba(0,0,0,0) 2px 14px);
      opacity:.45;
      pointer-events:none;
      mix-blend-mode: overlay;
    }
    .panel > *{position:relative;
      z-index:1}
    .section{
      border-color: rgba(214,177,74,.18);
      background: rgba(0,0,0,.18);
    }
    input[type="text"], input[type="number"], textarea, select{
      border-color: rgba(214,177,74,.20);
      background: rgba(0,0,0,.28);
    }
    input[type="file"]{
      border-color: rgba(214,177,74,.25);
    }
    .btn{
      border-color: rgba(214,177,74,.22);
    }
    .btn.primary{
      background: linear-gradient(90deg, rgba(214,177,74,.42), rgba(242,211,122,.20));
      border-color: rgba(242,211,122,.38);
      box-shadow: 0 14px 34px rgba(214,177,74,.18);
    }
    .btn.primary:hover{
      box-shadow: 0 18px 44px rgba(214,177,74,.22);
    }
    .pill{
      border-color: rgba(242,211,122,.30);
      background: rgba(0,0,0,.24);
    }

    /* Neon orange accents for the whole question modal window */
    .modal{
      box-shadow:
        0 30px 80px rgba(0,0,0,.55),
        0 0 0 1px rgba(255,150,0,.22),
        0 0 32px rgba(255,130,0,.14);
    }
    .modal .choiceBlock{
      border:1px solid rgba(255,150,0,.18);
      box-shadow: 0 0 18px rgba(255,130,0,.10) inset;
    }
    .modal input:focus, .modal textarea:focus, .modal select:focus{
      outline:none;
      border-color: rgba(255,170,0,.55) !important;
      box-shadow: 0 0 0 3px rgba(255,150,0,.18) !important;
    }

    /* UI cleanup (keep elements for scripts, but hide them visually) */
    [data-i18n="ui_feedback_label"]{ display:none !important; }
    [data-i18n="ui_bgurl_hint"]{ display:none !important; }
    /* Hide the old "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ" (file background) section */
    #secStyle{ display:none !important; }


  #versionBadge{
    position: fixed;
    right: 18px;
    bottom: 14px;
    z-index: 9999;
    padding: 6px 10px;
    border-radius: 10px;
    font: 600 12px/1.1 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    color: rgba(255,255,255,.9);
    background: rgba(0,0,0,.35);
    border: 1px solid rgba(255,140,0,.45);
    box-shadow: 0 0 14px rgba(255,140,0,.25);
    pointer-events: none;
    backdrop-filter: blur(6px);
  }

</style>
</head>

<body>
  <div class="app" id="editorRoot">
    <div class="panel settings">
      <div class="panel-header">
        <div class="header-left">
          <div class="brand">
            <img src="https://svetlana18011991.github.io/redactor_banya_new/63.png" alt="MathBox logo"/>
            <div class="name">–°–≤–µ—Ç–ª–∞–Ω–∞ –ë—ã–∫–æ–≤–∞</div>
          </div>
          <div class="h"><span data-i18n="editor_title">–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ë–∞—à–Ω—è¬ª</span></div>
        </div>
        <div class="row" style="margin:0">
          <button class="btn primary" id="btnCopyCode" type="button"><span data-i18n="btn_copy_iframe">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ (iframe)</span></button>
        </div>
      </div>

      <div class="errbar" id="errbar"></div>

      <div class="panel-body">

        <div class="section">
          <div class="title" data-i18n="ui_lang_title">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
          <label data-i18n="ui_lang_label">–í—ã–±—Ä–∞—Ç—å —è–∑—ã–∫</label>
          <select id="selLang">
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="en">English</option>
            <option value="de">Deutsch</option>
            <option value="zh">‰∏≠Êñá</option>
          </select>
        </div>

        <div class="section">
          <div class="title" data-i18n="sec_title">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
          <label><span data-i18n="label_game_title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∏–≥—Ä–µ</span></label>
          <input id="inpTitle" type="text" value="–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π" />
        </div>

        <div class="section" id="secStyle">
          <div class="title" data-i18n="sec_style">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</div>
          <label><span data-i18n="label_bg">–í—ã–±—Ä–∞—Ç—å —Å–≤–æ–π —Ñ–æ–Ω</span></label>
          <div class="row" style="gap:10px; align-items:center; margin-top:6px">
            <input id="fileBg" type="file" accept="image/*" />
            <button id="btnResetBg" type="button" class="btn small"><span data-i18n="btn_reset_bg">‚Ü© –°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ–Ω</span></button>
          </div>

          <div class="toggle" data-hide="blocks">
            <input id="chkUseImages" type="checkbox" checked />
            <div>
              <div style="font-weight:900">–ë–ª–æ–∫–∏: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ</div>
              <div class="muted"></div>
            </div>
          </div>
          
          <div class="toggle">
            <input id="chkUseLatex" type="checkbox" />
            <div>
              <div style="font-weight:900"><span data-i18n="use_latex">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LaTeX</span></div>
              <div class="muted" data-i18n="latex_desc">–í–∫–ª—é—á–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–æ—Ä–º—É–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, $x^2$)</div>
            </div>
          </div>
        </div>

        <div class="section" data-section="timer">
          <div class="title">–¢–∞–π–º–µ—Ä</div>

          <div class="toggle">
            <input id="chkTimer" type="checkbox" />
            <div>
              <div style="font-weight:900">–í–∫–ª—é—á–∏—Ç—å —Ç–∞–π–º–µ—Ä</div>
              <div class="muted">–ï—Å–ª–∏ –≤—Ä–µ–º—è –≤—ã—à–ª–æ ‚Äî –æ—Ç–≤–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π, –±–ª–æ–∫ —Å–≥–æ—Ä–∞–µ—Ç.</div>
            </div>
          </div>

          <label>–°–µ–∫—É–Ω–¥ –Ω–∞ –≤–æ–ø—Ä–æ—Å</label>
          <input id="inpSeconds" type="number" min="5" max="600" step="1" value="30" />
        </div>

        <div class="section">
          <div class="title" data-i18n="ui_bgurl_title">–§–æ–Ω –ø–æ —Å—Å—ã–ª–∫–µ</div>
          <label data-i18n="ui_bgurl_label">URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ —Ñ–∞–π–ª–∞)</label>
          <input id="inpBgUrl" type="text" placeholder="https://.../background.jpg" />
          <div class="hint" data-i18n="ui_bgurl_hint">–°–æ–≤–µ—Ç: —Ç–∞–∫ –±—ã—Å—Ç—Ä–µ–µ –¥–ª—è Genially, —á–µ–º –≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª.</div>
        </div>

<div class="section">
          <div class="title"><span data-i18n="sec_questions_title">–í–æ–ø—Ä–æ—Å—ã</span> <span class="pill" id="pillCount">0 / 9</span></div>

          <div class="row">
            <button class="btn primary" id="btnAddQ" type="button">‚ûï <span data-i18n="btn_add">–î–æ–±–∞–≤–∏—Ç—å</span></button>
            <button class="btn" id="btnClearQs" type="button">üßπ <span data-i18n="btn_clear">–û—á–∏—Å—Ç–∏—Ç—å</span></button>
          </div>

          <div class="q-list" id="qList" style="margin-top:12px"></div>

          <div class="muted" style="margin-top:10px">
            <span data-i18n="qs_help">–°—Ç—Ä–æ–≥–æ <b>9 –≤–æ–ø—Ä–æ—Å–æ–≤</b>. –ú–æ–∂–Ω–æ: <b>–≤—ã–±–æ—Ä</b> –∏–ª–∏ <b>–≤–≤–æ–¥</b> (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤).</span>
          </div>
        </div>

        

        <div class="section">
          <div class="title" data-i18n="ui_feedback_title">–§–∏–¥–±–µ–∫ –≤ –∫–æ–Ω—Ü–µ</div>
          <label data-i18n="ui_feedback_label">–¢–µ–∫—Å—Ç –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º —ç–∫—Ä–∞–Ω–µ (–∏—Å–ø–æ–ª—å–∑—É–π {{score}} –∏–ª–∏ _________)</label>
          <textarea id="inpFeedback" rows="3" data-i18n-placeholder="ui_feedback_ph" placeholder="–ú–æ–ª–æ–¥–µ—Ü! –¢–æ–±–æ–π –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ _________ –±–∞–ª–ª–æ–≤"></textarea>
        </div>

        


        





<div class="section">
          <div class="title" data-hide="exportTitle" data-i18n="sec_export">–≠–∫—Å–ø–æ—Ä—Ç –≤ Genially</div>
          <div class="muted">
            <span data-i18n="export_hint">–ù–∞–∂–º–∏ <b>¬´üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe¬ª</b> ‚Äî –≤ –±—É—Ñ–µ—Ä–µ –±—É–¥–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–¥ –≤–∏–¥–∞:</span>
            <div style="margin-top:8px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; color:rgba(255,255,255,.86)">
              .../index.html?game=...
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="panel preview">
      <div class="preview-top">
        <div>
          <div class="name">–ü—Ä–æ—Å–º–æ—Ç—Ä</div>
          <div class="hint">–ñ–∏–≤–æ–µ –ø—Ä–µ–≤—å—é (–∏–≥—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∫ –≤ Genially)</div>
        </div>
        <div class="muted">–ë–∞—à–Ω—è + –∫–∞—Ä—Ç–æ—á–∫–∏ + —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω</div>
      </div>

      <div class="panel-body" style="height:100%; padding-bottom:0">
        <div class="preview-stage" style="height:100%">
          <iframe id="livePreview" title="Preview" style="width:100%;height:720px;min-height:720px;border:0;background:transparent;border-radius:18px;overflow:hidden" allow="autoplay; fullscreen" allowfullscreen></iframe>
        </div>
      </div>
    </div>
  </div>

  <div id="gameRoot" style="display:none"></div>

  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div class="h" id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</div>
        <button class="btn small danger" id="btnCloseModal" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div class="modal-body">
        <label>–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞</label>
        <select id="selType">
          <option value="choice" selected>–° –≤—ã–±–æ—Ä–æ–º –æ—Ç–≤–µ—Ç–∞</option>
          <option value="text">–° –≤–≤–æ–¥–æ–º –æ—Ç–≤–µ—Ç–∞</option>
        </select>

        <label>–í–æ–ø—Ä–æ—Å</label>
        <textarea id="inpPrompt" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å..."></textarea>

        <div class="choiceBlock" style="margin-top:10px">
          <div style="font-weight:900">–¢–∞–π–º–µ—Ä –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞</div>
          <div class="muted">–ú–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –≤—Ä–µ–º—è –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ (–ø—É—Å—Ç–æ = –±–µ–∑ —Ç–∞–π–º–µ—Ä–∞/–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é).</div>

          <div style="margin-top:10px">
              <label>–°–µ–∫—É–Ω–¥ –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å</label>
              <input id="inpQSeconds" type="number" min="3" max="600" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 20" />
          </div>
        </div>
        
        <div class="choiceBlock" style="margin-top:10px">
          <div style="font-weight:900">–ú–µ–¥–∏–∞ (—Å—Å—ã–ª–∫–∏)</div>
          <div class="muted">–í—Å—Ç–∞–≤—å—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É (URL) –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–ª–∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª.</div>
          
          <div class="answerRow">
            <span style="font-size:20px; line-height:1; cursor:help;" title="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É">üñºÔ∏è</span>
            <input id="inpQImage" type="text" placeholder="https://.../image.jpg" />
            <button class="btn small danger" id="btnClearImage" type="button" title="–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É">‚úñ</button>
          </div>
          
          <div class="answerRow">
            <span style="font-size:20px; line-height:1; cursor:help;" title="–°—Å—ã–ª–∫–∞ –Ω–∞ –∞—É–¥–∏–æ">üéµ</span>
            <input id="inpQAudio" type="text" placeholder="https://.../audio.mp3" />
            <button class="btn small danger" id="btnClearAudio" type="button" title="–£–¥–∞–ª–∏—Ç—å –∞—É–¥–∏–æ">‚úñ</button>
          </div>
        </div>

        <div id="choiceWrap" class="choiceBlock">
          <div style="font-weight:900">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞</div>
          <div class="muted">–ú–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞. –û—Ç–º–µ—Ç—å –≤–µ—Ä–Ω—ã–π —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–æ–π.</div>
          <div id="choiceList"></div>
          <button class="btn small" id="btnAddChoice" type="button" style="margin-top:10px">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
        </div>

        <div id="textWrap" class="choiceBlock" style="display:none">
          <div style="font-weight:900">–í–µ—Ä–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–≤–≤–æ–¥)</div>
          <div class="muted">–ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –ª—é–±–æ–π.</div>
          <div id="textList"></div>
          <button class="btn small" id="btnAddText" type="button" style="margin-top:10px">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn" id="btnPreviewDraft" type="button">üëÅ –ü–æ–∫–∞–∑–∞—Ç—å –≤ –ø—Ä–µ–≤—å—é</button>
        <button class="btn primary" id="btnSaveQ" type="button">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  
  <div class="modal-backdrop" id="codeBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="codeTitle">
      <div class="modal-head">
        <div class="h" id="codeTitle">–°—Å—ã–ª–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã</div>
        <button class="btn small danger" id="btnCloseCode" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modal-body">
        <div class="muted" style="margin-bottom:8px">–≠—Ç–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–≥—Ä—É. –ï—ë –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å –≤ Genially (—á–µ—Ä–µ–∑ iframe) –∏ –∫—É–¥–∞ —É–≥–æ–¥–Ω–æ.</div>
        <label style="margin-top:0">–°—Å—ã–ª–∫–∞</label>
<textarea id="taIframe" spellcheck="false" style="min-height:90px;font-family: ui-monospace, SFMono-Regular, Menlo, monospace;"></textarea>
<label>iframe (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)</label>
<textarea id="taIframe2" spellcheck="false" style="min-height:120px;font-family: ui-monospace, SFMono-Regular, Menlo, monospace;"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnCopyFromModal" type="button">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
          <button class="btn" id="btnCopyIframe" type="button">üìé –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe</button>
          <button class="btn" id="btnDownloadGame" type="button">‚¨á –°–∫–∞—á–∞—Ç—å –∏–≥—Ä—É (HTML)</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ</div>


<script>
(() => {
  "use strict";

  // ===== errors =====
  const errbar = document.getElementById("errbar");
  function showErr(msg){
    if (!errbar) return;
    errbar.classList.add("show");
    errbar.textContent = "–û—à–∏–±–∫–∞ JS:\\n" + msg;
  }
  window.addEventListener("error", (e) => {
    const m = e?.error?.stack || e?.message || String(e);
    showErr(m);
  });
  window.addEventListener("unhandledrejection", (e) => {
    const m = e?.reason?.stack || e?.reason?.message || String(e?.reason || e);
    showErr(m);
  });
  const $ = (id)=>document.getElementById(id);
  const isChecked = (id)=>{ const el = $(id); return !!(el && el.checked); };

  const __GAME_CSS__ = "\n    :root{\n      --hud-bg: rgba(10, 12, 18, .55);\n      --panel-bg: rgba(20, 22, 30, .78);\n      --panel-stroke: rgba(255,255,255,.12);\n      --text: rgba(255,255,255,.92);\n      --muted: rgba(255,255,255,.72);\n      --good: rgba(120, 255, 170, .95);\n      --bad: rgba(255, 120, 140, .95);\n      --shadow: 0 18px 60px rgba(0,0,0,.35);\n    }\n    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);overflow:hidden;background:#000;}\n    #wrap{position:relative;width:100%;height:100%;}\n    canvas{width:100%;height:100%;display:block;}\n\n    #hud{\n      position:absolute; left:12px; right:12px; top:12px;\n      display:flex; gap:12px; align-items:center;\n      pointer-events:none;\n      z-index: 3;\n    }\n    .pill{\n      background:var(--hud-bg);\n      border:1px solid rgba(255,255,255,.10);\n      border-radius:999px;\n      padding:10px 14px;\n      box-shadow:var(--shadow);\n      backdrop-filter: blur(10px);\n      display:flex; gap:10px; align-items:center;\n      white-space:nowrap;\n    }\n    #progressWrap{\n      flex:1;\n      background:var(--hud-bg);\n      border:1px solid rgba(255,255,255,.10);\n      border-radius:999px;\n      padding:10px 14px;\n      box-shadow:var(--shadow);\n      backdrop-filter: blur(10px);\n      display:flex; align-items:center; gap:10px;\n      min-width:160px;\n      pointer-events:none;\n    }\n    #bar{\n      height:10px; flex:1;\n      background:rgba(255,255,255,.12);\n      border-radius:999px;\n      overflow:hidden;\n      border:1px solid rgba(255,255,255,.10);\n    }\n    #bar>div{\n      height:100%; width:0%;\n      background: linear-gradient(90deg, rgba(120,190,255,.9), rgba(120,255,170,.85));\n      border-radius:999px;\n    }\n\n    #scorePill{ margin-left:auto; }\n    #scoreNum{ font-weight:900; letter-spacing:.2px; }\n    #leftPill{ gap:12px; }\n    #remainNum{ font-weight:900; }\n\n    #nextBtn{\n      position:absolute;\n      left:50%;\n      bottom:88px;\n      transform: translateX(160px);\n      pointer-events:auto;\n      border-radius:16px;\n      padding:12px 14px;\n      border:1px solid rgba(120,190,255,.35);\n      background: rgba(120,190,255,.22);\n      color: var(--text);\n      font-weight: 900;\n      cursor:pointer;\n      box-shadow: var(--shadow);\n      backdrop-filter: blur(10px);\n      transition: transform .08s ease, filter .12s ease, opacity .12s ease;\n      user-select:none;\n      z-index: 4;\n    }\n    #nextBtn:active{ transform: translateX(160px) scale(.99); }\n    #nextBtn[disabled]{ opacity:.45; cursor:not-allowed; filter:saturate(.7); }\n\n    #overlay{\n      position:absolute; inset:0;\n      display:none; align-items:center; justify-content:center;\n      background: rgba(0,0,0,.25);\n      backdrop-filter: blur(6px);\n      z-index: 5;\n    }\n    #card{\n      width:min(640px, calc(100% - 24px));\n      background:var(--panel-bg);\n      border:1px solid var(--panel-stroke);\n      border-radius:18px;\n      box-shadow:var(--shadow);\n      padding:18px 18px 14px;\n\n      transform: translateY(10px) scale(.96);\n      opacity: 0;\n      transition: transform .18s ease, opacity .18s ease;\n      will-change: transform, opacity;\n    }\n    #overlay.show #card{\n      transform: translateY(0) scale(1);\n      opacity: 1;\n    }\n\n    #cardHeader{\n      display:flex; align-items:flex-start; justify-content:space-between;\n      gap:12px; margin-bottom:12px;\n    }\n    #title{ font-size:16px; color:var(--muted); letter-spacing:.2px; }\n    #q{ font-size:20px; line-height:1.25; margin-top:6px; }\n    #badge{\n      border-radius:999px; padding:6px 10px;\n      border:1px solid rgba(255,255,255,.12);\n      color:var(--muted); font-size:12px; white-space:nowrap;\n    }\n    #answers{ display:flex; flex-direction:column; gap:10px; margin-top:14px; }\n    .btn{\n      width:100%; text-align:left;\n      background:rgba(255,255,255,.08);\n      border:1px solid rgba(255,255,255,.12);\n      border-radius:14px;\n      padding:12px 12px;\n      color:var(--text);\n      cursor:pointer;\n      transition: transform .08s ease, background .12s ease;\n    }\n    .btn:hover{ background:rgba(255,255,255,.11); }\n    .btn:active{ transform:scale(.99); }\n\n    #inputRow{ display:none; gap:10px; align-items:center; margin-top:12px; }\n    #ansInput{\n      flex:1;\n      background:rgba(255,255,255,.07);\n      border:1px solid rgba(255,255,255,.14);\n      border-radius:14px;\n      padding:12px 12px;\n      color:var(--text);\n      outline:none;\n      font-size:16px;\n    }\n    #submit{\n      background:rgba(120,190,255,.20);\n      border:1px solid rgba(120,190,255,.35);\n      border-radius:14px;\n      padding:12px 14px;\n      cursor:pointer;\n      color:var(--text);\n      font-weight:800;\n    }\n    #submit:hover{ background:rgba(120,190,255,.26); }\n\n    #msg{ margin-top:12px; min-height:18px; font-size:14px; color:var(--muted); }\n    #hint{ margin-top:10px; font-size:12px; color:rgba(255,255,255,.55); }\n\n    #start{\n      position:absolute; inset:0;\n      display:flex; align-items:center; justify-content:center;\n      background: radial-gradient(1200px 800px at 50% 45%, rgba(0,0,0,.15), rgba(0,0,0,.55));\n      backdrop-filter: blur(3px);\n      z-index: 6;\n    }\n    #startCard{\n      width:min(720px, calc(100% - 24px));\n      background: rgba(20, 22, 30, .76);\n      border: 1px solid rgba(255, 140, 0, .28);\n      border-radius: 18px;\n      box-shadow: 0 26px 90px rgba(0,0,0,.55), 0 0 0 1px rgba(255,140,0,.16), 0 0 34px rgba(255,120,0,.18);\n      padding: 18px;\n      position:relative;\n      overflow:hidden;\n    }\n    #startCard::before{\n      content:\"\";\n      position:absolute; inset:0;\n      background: radial-gradient(700px 380px at 18% 10%, rgba(255,160,40,.16), transparent 60%), radial-gradient(600px 380px at 88% 22%, rgba(120,190,255,.12), transparent 62%);\n      opacity:.85;\n      pointer-events:none;\n    }\n    #startCard::after{\n      content:\"\";\n      position:absolute; inset:-2px;\n      border-radius: 20px;\n      pointer-events:none;\n      box-shadow: 0 0 0 1px rgba(255,140,0,.22), 0 0 28px rgba(255,120,0,.30), 0 0 90px rgba(255,120,0,.16);\n    }\n    #startCard > *{ position:relative; z-index:1; }\n    #startCard h1{ margin:0 0 8px 0; font-size:24px; }\n    #startCard p{ margin:0 0 14px 0; color: var(--muted); line-height:1.35; }\n    #play{\n      display:inline-flex; gap:10px; align-items:center;\n      padding:12px 14px;\n      border-radius:14px;\n      border:1px solid rgba(120,190,255,.35);\n      background: rgba(120,190,255,.22);\n      color: var(--text);\n      font-weight:900;\n      cursor:pointer;\n    }\n    #play:hover{ background: rgba(120,190,255,.28); }\n\n    #err{\n      display:none;\n      margin-top:12px;\n      padding:12px;\n      border-radius:14px;\n      border:1px solid rgba(255,120,140,.35);\n      background: rgba(255,120,140,.12);\n      color: rgba(255,235,238,.95);\n      font-size:13px;\n      line-height:1.35;\n    }\n    #err ul{ margin:8px 0 0 18px; }\n    code{background:rgba(255,255,255,.08); padding:2px 6px; border-radius:8px; border:1px solid rgba(255,255,255,.12);}\n\n    #finish{\n      position:absolute; inset:0;\n      display:none; align-items:center; justify-content:center;\n      background: rgba(0,0,0,.35);\n      backdrop-filter: blur(8px);\n      z-index: 7;\n    }\n    #finishCard{\n      width:min(720px, calc(100% - 24px));\n      border-radius:20px;\n      border:1px solid rgba(255,255,255,.14);\n      background: rgba(18, 20, 28, .75);\n      box-shadow: var(--shadow);\n      padding: 18px 18px 16px;\n      text-align:center;\n    }\n    #finishTitle{\n      font-size:30px; font-weight:1000; letter-spacing:.3px;\n      margin: 4px 0 8px;\n      background: linear-gradient(90deg, rgba(120,190,255,.95), rgba(120,255,170,.95));\n      -webkit-background-clip:text;\n      background-clip:text;\n      color:transparent;\n    }\n    #finishText{\n      color: rgba(255,255,255,.82);\n      font-size:18px;\n      margin: 0 0 10px;\n    }\n    #stats{\n      display:flex;\n      justify-content:center;\n      gap:12px;\n      flex-wrap:wrap;\n      margin: 10px 0 14px;\n    }\n    .stat{\n      background: rgba(255,255,255,.07);\n      border: 1px solid rgba(255,255,255,.12);\n      border-radius: 14px;\n      padding: 10px 12px;\n      min-width: 160px;\n      text-align:left;\n    }\n    .stat b{ font-size:18px; }\n    .stat div{ color: rgba(255,255,255,.70); font-size:12px; margin-top:4px; }\n    #restart{\n      display:inline-flex; gap:10px; align-items:center;\n      padding:12px 14px;\n      border-radius:14px;\n      border:1px solid rgba(120,190,255,.35);\n      background: rgba(120,190,255,.22);\n      color: var(--text);\n      font-weight:900;\n      cursor:pointer;\n    }\n    #restart:hover{ background: rgba(120,190,255,.28); }\n  \n/* per-question timer badge */\n.qTimer{\n  padding:8px 10px;\n  border-radius:999px;\n  border:1px solid rgba(242,211,122,.35);\n  background: rgba(0,0,0,.35);\n  color: rgba(255,255,255,.95);\n  font-weight:900;\n  font-size:12px;\n  box-shadow: 0 10px 30px rgba(0,0,0,.35);\n  backdrop-filter: blur(10px);\n}\n";
  const __GAME_HTML__ = "<div id=\"wrap\">\n  <canvas id=\"c\"></canvas>\n\n  <div id=\"hud\">\n    <div class=\"pill\" id=\"leftPill\">\n      –ë–∞—à–Ω—è: <b id=\"heightTxt\">0</b>\n      <span style=\"opacity:.5\">|</span>\n      –û—Å—Ç–∞–ª–æ—Å—å: <b id=\"remainNum\">9</b>\n    </div>\n\n    <div id=\"progressWrap\">\n      –ü—Ä–æ–≥—Ä–µ—Å—Å\n      <div id=\"bar\"><div></div></div>\n      <span id=\"pct\">0%</span>\n    </div>\n\n    <div class=\"pill\" id=\"scorePill\">–°—á—ë—Ç: <b id=\"scoreNum\">0</b></div>\n  </div>\n\n  <button id=\"nextBtn\" disabled>–î–∞–ª–µ–µ ‚Üí</button>\n\n  <div id=\"overlay\" role=\"dialog\" aria-modal=\"true\">\n    <div id=\"card\">\n      <div id=\"cardHeader\">\n        <div>\n          <div id=\"title\">–í–æ–ø—Ä–æ—Å</div>\n          <div id=\"q\">...</div>\n        </div>\n        <div style=\"display:flex;flex-direction:column;align-items:flex-end;gap:8px\">\n          <div id=\"badge\">1 / 9</div>\n          <div id=\"qTimerBadge\" class=\"qTimer\" style=\"display:none\">‚è≥ 10</div>\n        </div>\n      </div>\n\n      <div id=\"qMedia\" style=\"display:none; margin-top:10px; margin-bottom:14px; text-align:center;\">\n        <img id=\"qImg\" src=\"\" style=\"max-width:100%; max-height:160px; border-radius:12px; display:none; margin: 0 auto; border:1px solid rgba(255,255,255,.1);\" />\n        <audio id=\"qAudio\" controls style=\"width:100%; height:36px; display:none; margin-top:8px; border-radius:12px;\"></audio>\n      </div>\n\n      <div id=\"answers\"></div>\n\n      <div id=\"inputRow\">\n        <input id=\"ansInput\" type=\"text\" placeholder=\"–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç...\" autocomplete=\"off\" />\n        <button id=\"submit\">–û–ö</button>\n      </div>\n\n      <div id=\"msg\"></div>\n      <div id=\"hint\">–í–µ—Ä–Ω–æ ‚Üí –±–ª–æ–∫ –æ–ø—É—Å–∫–∞–µ—Ç—Å—è –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —ç—Ç–∞–∂–æ–º (+100). –ù–µ–≤–µ—Ä–Ω–æ ‚Üí –æ–±—É–≥–ª–∏–≤–∞–Ω–∏–µ, –≤–∑—Ä—ã–≤ –∏ –∏—Å—á–µ–∑–∞–µ—Ç.</div>\n    </div>\n  </div>\n\n  <div id=\"start\">\n    <div id=\"startCard\">\n      <h1>–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π</h1>\n      <p class=\"lead\" id=\"startLead\"></p>\n      <div class=\"rules\">\n        <ul id=\"startRules\">\n          <li>–ü–µ—Ä–≤—ã–π –±–ª–æ–∫ –ø–∞–¥–∞–µ—Ç —Å–∞–º.</li>\n          <li>–î–∞–ª—å—à–µ –Ω–∞–∂–∏–º–∞–π <b>–î–∞–ª–µ–µ</b>, —á—Ç–æ–±—ã –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫.</li>\n          <li>–ö–æ–≥–¥–∞ –±–ª–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è ‚Äî –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å.</li>\n          <li><b>–í–µ—Ä–Ω–æ</b> ‚Üí –±–ª–æ–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —ç—Ç–∞–∂–æ–º (+100).</li>\n          <li><b>–ù–µ–≤–µ—Ä–Ω–æ</b> ‚Üí –±–ª–æ–∫ –æ–±—É–≥–ª–∏–≤–∞–µ—Ç—Å—è, –≤–∑—Ä—ã–≤–∞–µ—Ç—Å—è –∏ –∏—Å—á–µ–∑–∞–µ—Ç.</li>\n        </ul>\n      </div>\n      <button id=\"play\"><span id=\"playLabel\">‚ñ∂ Start</span></button>\n      <div id=\"err\">\n        <b>–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã.</b> –£–±–µ–¥–∏—Å—å, —á—Ç–æ –æ–Ω–∏ –ª–µ–∂–∞—Ç —Ä—è–¥–æ–º —Å <code>index.html</code> –∏ –∏–º–µ–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—é—Ç.\n        <ul id=\"errList\"></ul>\n      </div>\n    </div>\n  </div>\n\n  <div id=\"finish\">\n    <div id=\"finishCard\">\n      <div id=\"finishTitle\">–ú–æ–ª–æ–¥–µ—Ü!</div>\n      <div id=\"finishText\"></div>\n\n      <div id=\"stats\">\n        <div class=\"stat\"><b id=\"stCorrect\">0</b><div id=\"lblCorrect\">–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</div></div>\n        <div class=\"stat\"><b id=\"stWrong\">0</b><div id=\"lblWrong\">–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</div></div>\n        <div class=\"stat\"><b id=\"stHeight\">0</b><div id=\"lblHeight\">–±–ª–æ–∫–æ–≤ –≤ –±–∞—à–Ω–µ</div></div>\n      </div>\n\n      <button id=\"restart\">‚Üª –°—ã–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑</button>\n    </div>\n  </div>\n</div>";
  const __GAME_JS__ = "function thudSound(){try{const ctx=window.__audioCtx||(window.__audioCtx=new (window.AudioContext||window.webkitAudioContext)());const o=ctx.createOscillator();const g=ctx.createGain();o.type='sine';o.frequency.setValueAtTime(120,ctx.currentTime);o.frequency.exponentialRampToValueAtTime(55,ctx.currentTime+0.10);g.gain.setValueAtTime(0.0001,ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.22,ctx.currentTime+0.015);g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+0.18);o.connect(g);g.connect(ctx.destination);o.start();o.stop(ctx.currentTime+0.20);}catch(e){}}\n\n/** \u0424\u0410\u0419\u041b\u042b */\nconst BG_FILE = \"1.png\";\nconst BLOCK_FILES = [\"3.png\",\"4.png\",\"5.png\",\"6.png\",\"7.png\",\"8.png\",\"9.png\",\"10.png\",\"11.png\"];\n\n/** \u041e\u0427\u041a\u0418 */\nconst SCORE_PER_BLOCK = 100;\n\n/* QUESTIONS injected from cfg */\nlet QUESTIONS = [];\n\n/** \u0414\u0438\u043d\u0430\u043c\u0438\u043a\u0430 */\nconst FALL_SPEED = 620;\nconst DROP_SPEED = 900;\n\n/** \u042d\u0444\u0444\u0435\u043a\u0442\u044b */\nconst SHAKE_ON_BOOM = 18;\nconst SHAKE_ON_LAND = 7;\n\n/** \u041f\u0440\u043e\u0433\u0440\u0435\u0441\u0441 */\nconst TARGET_BLOCKS_FOR_100 = 9;\n\n/** \u0412\u043b\u0435\u0437\u0430\u043d\u0438\u0435 */\nconst SAFE_TOP_MARGIN = 86;\nconst SAFE_BOTTOM_MARGIN = 100;\nconst DESIRED_TOWER_WIDTH = () => Math.min(window.innerWidth * 0.38, 360);\n\n/** TRIM/PROFILE */\nconst TRIM_ALPHA_MIN = 34;\nconst PROFILE_ALPHA_MIN = 22;\nconst CENTROID_ALPHA_MIN = 24;\n\n/** \u041f\u0440\u0443\u0436\u0438\u043d\u044f\u0449\u0438\u0439 bounce */\nconst LAND_BOUNCE_UP = 10; // px \u0432\u0432\u0435\u0440\u0445\nconst LAND_BOUNCE_TIME = 0.10;  // \u0441\u0435\u043a\n\nconst canvas = document.getElementById(\"c\");\nconst ctx = canvas.getContext(\"2d\");\n\nconst overlay = document.getElementById(\"overlay\");\nconst qEl = document.getElementById(\"q\");\nconst badgeEl = document.getElementById(\"badge\");\nconst answersEl = document.getElementById(\"answers\");\nconst inputRow = document.getElementById(\"inputRow\");\nconst ansInput = document.getElementById(\"ansInput\");\nconst submitBtn = document.getElementById(\"submit\");\nconst msgEl = document.getElementById(\"msg\");\n\nconst startLayer = document.getElementById(\"start\");\nconst playBtn = document.getElementById(\"play\");\n\nconst finishLayer = document.getElementById(\"finish\");\nconst finishScoreEl = document.getElementById(\"finishScore\");\nconst stCorrect = document.getElementById(\"stCorrect\");\nconst stWrong = document.getElementById(\"stWrong\");\nconst stHeight = document.getElementById(\"stHeight\");\nconst restartBtn = document.getElementById(\"restart\");\n\nconst errBox = document.getElementById(\"err\");\nconst errList = document.getElementById(\"errList\");\n\nconst heightTxt = document.getElementById(\"heightTxt\");\nconst remainNum = document.getElementById(\"remainNum\");\nconst pctTxt = document.getElementById(\"pct\");\nconst barFill = document.querySelector(\"#bar > div\");\n\nconst scoreNum = document.getElementById(\"scoreNum\");\nconst nextBtn = document.getElementById(\"nextBtn\");\n\nlet W=0,H=0,DPR=1;\nfunction resize(){\n  DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));\n  W = Math.floor(window.innerWidth);\n  H = Math.floor(window.innerHeight);\n  canvas.width = W * DPR;\n  canvas.height = H * DPR;\n  ctx.setTransform(DPR,0,0,DPR,0,0);\n}\nwindow.addEventListener(\"resize\", resize);\nresize();\n\n/** Audio */\nlet audioCtx=null;\nfunction ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }\nfunction playBoom(){\n  ensureAudio();\n  const t = audioCtx.currentTime;\n\n  const osc = audioCtx.createOscillator();\n  const gain = audioCtx.createGain();\n  osc.type=\"sawtooth\";\n  osc.frequency.setValueAtTime(120,t);\n  osc.frequency.exponentialRampToValueAtTime(38,t+0.22);\n  gain.gain.setValueAtTime(0.0001,t);\n  gain.gain.exponentialRampToValueAtTime(0.50,t+0.02);\n  gain.gain.exponentialRampToValueAtTime(0.0001,t+0.34);\n\n  const noiseBuf = audioCtx.createBuffer(1, audioCtx.sampleRate*0.30, audioCtx.sampleRate);\n  const data = noiseBuf.getChannelData(0);\n  for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*0.95;\n  const noise = audioCtx.createBufferSource(); noise.buffer=noiseBuf;\n  const nGain = audioCtx.createGain();\n  nGain.gain.setValueAtTime(0.0001,t);\n  nGain.gain.exponentialRampToValueAtTime(0.40,t+0.01);\n  nGain.gain.exponentialRampToValueAtTime(0.0001,t+0.30);\n\n  const filter = audioCtx.createBiquadFilter();\n  filter.type=\"lowpass\";\n  filter.frequency.setValueAtTime(1700,t);\n  filter.frequency.exponentialRampToValueAtTime(320,t+0.26);\n\n  osc.connect(gain).connect(audioCtx.destination);\n  noise.connect(filter).connect(nGain).connect(audioCtx.destination);\n\n  osc.start(t); osc.stop(t+0.36);\n  noise.start(t); noise.stop(t+0.32);\n}\nfunction playGood(){\n  ensureAudio();\n  const t = audioCtx.currentTime;\n  const osc = audioCtx.createOscillator();\n  const gain = audioCtx.createGain();\n  osc.type=\"triangle\";\n  osc.frequency.setValueAtTime(420,t);\n  osc.frequency.exponentialRampToValueAtTime(780,t+0.12);\n  gain.gain.setValueAtTime(0.0001,t);\n  gain.gain.exponentialRampToValueAtTime(0.20,t+0.02);\n  gain.gain.exponentialRampToValueAtTime(0.0001,t+0.18);\n  osc.connect(gain).connect(audioCtx.destination);\n  osc.start(t); osc.stop(t+0.2);\n}\n\n/** Assets */\nfunction assetUrl(file){ return new URL(file, new URL(\".\", window.location.href)).toString(); }\nfunction loadImage(url){\n  return new Promise((resolve, reject)=>{\n    const img=new Image();\n    img.onload=()=>resolve(img);\n    img.onerror=()=>reject(new Error(url));\n    img.src=url;\n  });\n}\n\n/** \u041f\u0440\u043e\u0444\u0438\u043b\u0438 */\nfunction buildTopBottomProfiles(imageData, w, h){\n  const d = imageData.data;\n  const top = new Array(w).fill(h);\n  const bottom = new Array(w).fill(-1);\n\n  for(let x=0;x<w;x++){\n    for(let y=0;y<h;y++){\n      const a = d[(y*w + x)*4 + 3];\n      if(a >= PROFILE_ALPHA_MIN){ top[x]=y; break; }\n    }\n    for(let y=h-1;y>=0;y--){\n      const a = d[(y*w + x)*4 + 3];\n      if(a >= PROFILE_ALPHA_MIN){ bottom[x]=y; break; }\n    }\n    if(bottom[x] < 0){ bottom[x] = h-1; }\n    if(top[x] >= h){ top[x] = 0; }\n  }\n  return { top, bottom };\n}\n\nfunction trimAndCentroidAndProfiles(img){\n  const c=document.createElement(\"canvas\");\n  c.width=img.width; c.height=img.height;\n  const g=c.getContext(\"2d\");\n  g.drawImage(img,0,0);\n\n  const im=g.getImageData(0,0,c.width,c.height);\n  const d=im.data;\n\n  let minX=c.width, minY=c.height, maxX=-1, maxY=-1;\n  let sumA=0, sumX=0, sumY=0;\n\n  for(let y=0;y<c.height;y++){\n    for(let x=0;x<c.width;x++){\n      const a = d[(y*c.width + x)*4 + 3];\n      if(a >= TRIM_ALPHA_MIN){\n        if(x<minX) minX=x;\n        if(y<minY) minY=y;\n        if(x>maxX) maxX=x;\n        if(y>maxY) maxY=y;\n      }\n      if(a >= CENTROID_ALPHA_MIN){\n        const wgt=a;\n        sumA += wgt;\n        sumX += x*wgt;\n        sumY += y*wgt;\n      }\n    }\n  }\n\n  if(maxX<0 || maxY<0){\n    return Promise.resolve({ img, w: img.width, h: img.height, cx: img.width/2, cy: img.height/2, top:null, bottom:null });\n  }\n\n  const w = (maxX-minX+1);\n  const h = (maxY-minY+1);\n\n  const outC=document.createElement(\"canvas\");\n  outC.width=w; outC.height=h;\n  const og=outC.getContext(\"2d\");\n  og.drawImage(c, minX, minY, w, h, 0, 0, w, h);\n\n  const cropped = og.getImageData(0,0,w,h);\n  const { top, bottom } = buildTopBottomProfiles(cropped, w, h);\n\n  let cx=w/2, cy=h/2;\n  if(sumA>0){\n    cx = (sumX/sumA) - minX;\n    cy = (sumY/sumA) - minY;\n  }\n\n  const out=new Image();\n  out.src=outC.toDataURL(\"image/png\");\n  return new Promise((res,rej)=>{\n    out.onload=()=>res({ img: out, w, h, cx, cy, top, bottom });\n    out.onerror=rej;\n  });\n}\n\n/** State */\nconst state = {\n  running:false,\n  bg:null,\n  blocks:[],\n  towerScale:1,\n  tower:[],\n  current:null,\n  particles:[], smokes:[], rings:[], sparks:[], flash:0,\n  cameraShake:0, cameraX:0, cameraY:0,\n  towerOffsetY:0, towerOffsetV:0,\n  questionIndex:0, waitingAnswer:false, dropping:false,\n  blockIndex:0, readyForNext:false, finished:false,\n  score:0, scoreFloats:[], correct:0, wrong:0,\n  landingBounce: null,\n};\n\n/** HUD helpers */\nfunction setNextEnabled(on){\n  state.readyForNext = on;\n  nextBtn.disabled = !on;\n}\nfunction updateRemain(){\n  const remain = Math.max(0, 9 - state.questionIndex);\n  remainNum.textContent = String(remain);\n}\n\nfunction groundY(){\n  return H - 70 + state.towerOffsetY;\n}\nfunction alignedXForIdx(idx){\n  const b = state.blocks[idx];\n  const cxScaled = b.cx * state.towerScale;\n  return (W/2) - cxScaled;\n}\nfunction blockSize(idx){\n  const b = state.blocks[idx];\n  return { w: b.w*state.towerScale, h: b.h*state.towerScale };\n}\nfunction computeTowerScale(blocks){\n  const maxW = Math.max(...blocks.map(b => b.w));\n  const totalH = blocks.reduce((s,b)=>s+b.h,0);\n  const scaleByWidth = DESIRED_TOWER_WIDTH() / maxW;\n  const availableH = Math.max(220, H - SAFE_TOP_MARGIN - SAFE_BOTTOM_MARGIN);\n  const scaleByHeight = availableH / totalH;\n  return Math.min(scaleByWidth, scaleByHeight);\n}\n\nfunction computeStackY(upper, lower){\n  const su = state.towerScale;\n  const upperMeta = state.blocks[upper.idx];\n  const lowerMeta = state.blocks[lower.idx];\n\n  const overlapLeft = Math.max(upper.x, lower.x);\n  const overlapRight = Math.min(upper.x + upper.w, lower.x + lower.w);\n\n  if(overlapRight <= overlapLeft + 2){\n    return Math.round(lower.y - upper.h);\n  }\n\n  let yMaxAllowed = Infinity;\n  const step = 2;\n\n  for(let wx = overlapLeft; wx <= overlapRight; wx += step){\n    const xu = Math.floor((wx - upper.x) / su);\n    const xl = Math.floor((wx - lower.x) / su);\n    if(xu < 0 || xu >= upperMeta.w) continue;\n    if(xl < 0 || xl >= lowerMeta.w) continue;\n\n    const bu = upperMeta.bottom[xu];\n    const tl = lowerMeta.top[xl];\n\n    const allowed = lower.y + tl*su - bu*su;\n    if(allowed < yMaxAllowed) yMaxAllowed = allowed;\n  }\n  return Math.round(yMaxAllowed) - 1;\n}\n\nfunction spawnBlock(){\n  if(state.finished) return;\n  if(state.blockIndex >= 9){ finishGame(); return; }\n\n  const idx = state.blockIndex;\n  const {w,h} = blockSize(idx);\n\n  state.current = { idx, w,h, x: alignedXForIdx(idx), y: -h - 30, char:0 };\n  state.dropping=false;\n  state.waitingAnswer=false;\n  state.landingBounce=null;\n  setNextEnabled(false);\n}\n\nfunction addScorePop(x,y, text){\n  state.scoreFloats.push({ x, y, vx: (Math.random()*2-1)*30, vy: -160 - Math.random()*60, life: 0.85, age: 0, text });\n}\n\nfunction sparksAtSeam(x, y){\n  for(let i=0;i<18;i++){\n    const a = (-Math.PI/2) + (Math.random()*Math.PI*0.9 - Math.PI*0.45);\n    const sp = 220 + Math.random()*360;\n    state.sparks.push({\n      x: x + (Math.random()*40 - 20),\n      y: y + (Math.random()*6 - 3),\n      vx: Math.cos(a)*sp,\n      vy: Math.sin(a)*sp - (40+Math.random()*60),\n      life: 0.45 + Math.random()*0.2,\n      age: 0\n    });\n  }\n}\n\nfunction dustAt(x,y){\n  for(let i=0;i<10;i++){\n    const a=Math.random()*Math.PI*2;\n    const sp=30+Math.random()*110;\n    state.smokes.push({\n      x:x + (Math.random()*18-9),\n      y:y + (Math.random()*10-5),\n      vx:Math.cos(a)*sp,\n      vy:Math.sin(a)*sp - (30+Math.random()*40),\n      life:0.55+Math.random()*0.35,\n      age:0,\n      rad: 10+Math.random()*14\n    });\n  }\n}\n\nfunction settleCurrentBlock(){\n  const b = state.current;\n  let yFinal;\n  if(state.tower.length===0){\n    yFinal = Math.round(groundY() - b.h);\n  } else {\n    const lower = state.tower[state.tower.length - 1];\n    yFinal = computeStackY(b, lower);\n  }\n\n  const yUp = Math.max(-200, yFinal - LAND_BOUNCE_UP);\n  state.landingBounce = { fromY: yUp, toY: yFinal, age: 0, dur: LAND_BOUNCE_TIME };\n  b.x = Math.round(b.x);\n  b.y = yUp;\n}\n\nfunction finalizeLand(){\n  try{ thudSound(); }catch(e){}\n  const b = state.current;\n  if(!b) return;\n\n  const seamY = b.y + b.h;\n  sparksAtSeam(W/2, seamY);\n\n  state.tower.push({\n    x: Math.round(b.x), y: Math.round(b.y),\n    w: b.w, h: b.h, idx: b.idx,\n    squash:1.0, squashV:0.0\n  });\n\n  state.score += SCORE_PER_BLOCK;\n  scoreNum.textContent = String(state.score);\n  addScorePop(W/2 + 70, b.y + 30, `+${SCORE_PER_BLOCK}`);\n\n  dustAt(W/2, seamY);\n  state.cameraShake = Math.max(state.cameraShake, SHAKE_ON_LAND);\n  state.towerOffsetV -= 120;\n  state.current = null;\n}\n\nfunction boomAt(block){\n  const cx = block.x + block.w/2;\n  const cy = block.y + block.h/2;\n\n  state.flash = Math.min(1, state.flash + 0.95);\n  state.rings.push({ x:cx, y:cy, r:10, vr: 900, life:0.45, age:0 });\n\n  for(let i=0;i<44;i++){\n    const a=Math.random()*Math.PI*2;\n    const sp=160+Math.random()*720;\n    state.particles.push({\n      x:cx,y:cy, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp-(260+Math.random()*360),\n      life:0.55+Math.random()*0.35, age:0, r:2+Math.random()*4\n    });\n  }\n\n  for(let i=0;i<14;i++){\n    const a=Math.random()*Math.PI*2;\n    const sp=50+Math.random()*210;\n    state.smokes.push({\n      x:cx,y:cy, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp-(90+Math.random()*120),\n      life:1.1+Math.random()*0.8, age:0, rad: 22+Math.random()*26\n    });\n  }\n\n  state.cameraShake = Math.max(state.cameraShake, SHAKE_ON_BOOM);\n  playBoom();\n}\n\nfunction finishGame(){\n  state.finished = true;\n  setNextEnabled(false);\n  finishScoreEl.textContent = String(state.score);\n  const tpl = String(window.__CFG?.feedback || \"\u041c\u043e\u043b\u043e\u0434\u0435\u0446! \u0422\u043e\u0431\u043e\u0439 \u0437\u0430\u0440\u0430\u0431\u043e\u0442\u0430\u043d\u043e _________ \u0431\u0430\u043b\u043b\u043e\u0432\");\n  const txt = tpl.replaceAll(\"{{score}}\", String(state.score)).replaceAll(\"_________\", String(state.score));\n  const ft = document.getElementById(\"finishText\");\n  if(ft) ft.innerHTML = txt;\n  applyLangGame();\n  stCorrect.textContent = String(state.correct);\n  stWrong.textContent = String(state.wrong);\n  stHeight.textContent = String(state.tower.length);\n  finishLayer.style.display=\"flex\";\n}\n\nrestartBtn.addEventListener(\"click\", async ()=>{\n  finishLayer.style.display=\"none\";\n  startLayer.style.display=\"flex\";\n});\n\nfunction showOverlayAnimated(){\n  overlay.style.display=\"flex\";\n  requestAnimationFrame(()=> overlay.classList.add(\"show\"));\n}\nfunction hideOverlayAnimated(){\n  overlay.classList.remove(\"show\");\n  setTimeout(()=>{ overlay.style.display=\"none\"; }, 140);\n}\n\nfunction update(dt){\n  if(!state.running) return;\n  updateRemain();\n\n  if(state.cameraShake>0){\n    state.cameraShake=Math.max(0, state.cameraShake - dt*22);\n    const s=state.cameraShake;\n    state.cameraX=(Math.random()*2-1)*s; state.cameraY=(Math.random()*2-1)*s;\n  } else {\n    state.cameraX=0; state.cameraY=0;\n  }\n  state.flash = Math.max(0, state.flash - dt*3.8);\n\n  {\n    const k=55, damp=10;\n    const a = -k*(state.towerOffsetY) - damp*state.towerOffsetV;\n    state.towerOffsetV += a*dt;\n    state.towerOffsetY += state.towerOffsetV*dt;\n    state.towerOffsetY = Math.max(-10, Math.min(10, state.towerOffsetY));\n  }\n\n  for(const b of state.tower){\n    const k=40, damp=8;\n    const a=-k*(b.squash-1)-damp*b.squashV;\n    b.squashV += a*dt; b.squash  += b.squashV*dt;\n    b.squash = Math.max(0.88, Math.min(1.08, b.squash));\n  }\n\n  for(const p of state.particles){ p.age += dt; p.vy += 980*dt; p.x += p.vx*dt; p.y += p.vy*dt; }\n  state.particles = state.particles.filter(p => p.age < p.life);\n\n  for(const s of state.smokes){ s.age += dt; s.vy += 120*dt; s.x += s.vx*dt; s.y += s.vy*dt; }\n  state.smokes = state.smokes.filter(s => s.age < s.life);\n\n  for(const r of state.rings){ r.age += dt; r.r += r.vr*dt; }\n  state.rings = state.rings.filter(r => r.age < r.life);\n\n  for(const sp of state.sparks){ sp.age += dt; sp.vy += 980*dt; sp.x += sp.vx*dt; sp.y += sp.vy*dt; sp.vx *= (1 - dt*1.8); }\n  state.sparks = state.sparks.filter(s => s.age < s.life);\n\n  for(const f of state.scoreFloats){ f.age += dt; f.vy += 260*dt; f.x += f.vx*dt; f.y += f.vy*dt; }\n  state.scoreFloats = state.scoreFloats.filter(f => f.age < f.life);\n\n  if(state.landingBounce && state.current){\n    const bb = state.landingBounce;\n    bb.age += dt;\n    const t = Math.min(1, bb.age / bb.dur);\n    const ease = 1 - Math.pow(1 - t, 3);\n    state.current.y = Math.round(bb.fromY + (bb.toY - bb.fromY)*ease);\n\n    if(state.tower.length>0){\n      const last = state.tower[state.tower.length-1];\n      last.squashV += 14 * dt;\n    }\n\n    if(t >= 1){\n      state.landingBounce = null;\n      finalizeLand();\n      setNextEnabled(true);\n    }\n  }\n\n  if(state.current && !state.landingBounce){\n    const b = state.current;\n    if(state.waitingAnswer){\n    } else if(state.dropping){\n      let yTarget;\n      if(state.tower.length===0){ yTarget = groundY() - b.h; }\n      else { const lower = state.tower[state.tower.length - 1]; yTarget = computeStackY(b, lower); }\n\n      b.y += DROP_SPEED*dt;\n      if(b.y >= yTarget){\n        b.y = yTarget;\n        settleCurrentBlock();\n      }\n    } else {\n      const topY = (state.tower.length===0 ? groundY() : state.tower[state.tower.length-1].y);\n      const stopY = Math.max(80, topY - b.h - 18);\n      b.y += FALL_SPEED*dt;\n      if(b.y>=stopY){\n        b.y=stopY;\n        state.waitingAnswer=true;\n        showQuestion();\n      }\n    }\n  }\n\n  heightTxt.textContent = String(state.tower.length);\n  const pct = Math.max(0, Math.min(100, Math.round((state.tower.length / TARGET_BLOCKS_FOR_100)*100)));\n  pctTxt.textContent = pct + \"%\";\n  barFill.style.width = pct + \"%\";\n}\n\nfunction drawBackground(){\n  if(state.bg){\n    const img=state.bg;\n    const scale=Math.max(W/img.width,H/img.height);\n    const dw=img.width*scale, dh=img.height*scale;\n    ctx.drawImage(img,(W-dw)/2,(H-dh)/2,dw,dh);\n  } else {\n    ctx.fillStyle=\"#0b0f18\"; ctx.fillRect(0,0,W,H);\n  }\n  const grd=ctx.createRadialGradient(W*0.5,H*0.45,60, W*0.5,H*0.5, Math.max(W,H)*0.7);\n  grd.addColorStop(0,\"rgba(0,0,0,0)\");\n  grd.addColorStop(1,\"rgba(0,0,0,0.45)\");\n  ctx.fillStyle=grd; ctx.fillRect(0,0,W,H);\n\n  ctx.fillStyle=\"rgba(0,0,0,.35)\";\n  ctx.fillRect(0,H-70,W,70);\n}\n\nfunction drawBlock(o, glow=false, squash=1.0, char=0){\n  const img = state.blocks[o.idx].img;\n  ctx.save();\n  ctx.shadowColor = glow ? \"rgba(120,190,255,.35)\" : \"rgba(0,0,0,.45)\";\n  ctx.shadowBlur  = glow ? 18 : 14;\n\n  const cx = o.x + o.w/2;\n  const cy = o.y + o.h;\n  const sx = 1 + (1 - squash) * 0.35;\n  const sy = squash;\n\n  ctx.translate(cx, cy);\n  ctx.scale(sx, sy);\n  ctx.translate(-cx, -cy);\n\n  ctx.drawImage(img, o.x, o.y, o.w, o.h);\n\n  if(char > 0){\n    ctx.globalCompositeOperation = \"source-atop\";\n    ctx.fillStyle = `rgba(0,0,0,${0.70*char})`;\n    ctx.fillRect(o.x-2, o.y-2, o.w+4, o.h+4);\n    ctx.globalCompositeOperation = \"screen\";\n    ctx.fillStyle = `rgba(255,120,60,${0.10*char})`;\n    ctx.fillRect(o.x-2, o.y-2, o.w+4, o.h+4);\n    ctx.globalCompositeOperation = \"source-over\";\n  }\n  ctx.restore();\n}\n\nfunction drawScorePops(){\n  for(const f of state.scoreFloats){\n    const t = f.age / f.life;\n    const a = Math.max(0, 1 - t);\n    const s = 1 + (1 - a) * 0.15;\n    ctx.save();\n    ctx.globalAlpha = a;\n    ctx.translate(f.x, f.y);\n    ctx.scale(s, s);\n    ctx.font = \"900 22px system-ui, -apple-system, Segoe UI, Roboto, Arial\";\n    ctx.lineWidth = 5;\n    ctx.strokeStyle = \"rgba(0,0,0,.35)\";\n    ctx.strokeText(f.text, 0, 0);\n    ctx.fillStyle = \"rgba(120,255,170,.95)\";\n    ctx.fillText(f.text, 0, 0);\n    ctx.restore();\n  }\n}\n\nfunction draw(){\n  ctx.clearRect(0,0,W,H);\n  ctx.save();\n  ctx.translate(state.cameraX, state.cameraY);\n  drawBackground();\n\n  for(const b of state.tower){ drawBlock(b, false, b.squash, 0); }\n  if(state.current){ drawBlock(state.current, true, 1.0, state.current.char || 0); }\n\n  for(const s of state.smokes){\n    const t = s.age / s.life; const a = (1 - t) * 0.35;\n    const r = s.rad * (1 + t*1.25);\n    ctx.fillStyle = `rgba(20,20,20,${a})`; ctx.beginPath(); ctx.arc(s.x, s.y, r, 0, Math.PI*2); ctx.fill();\n  }\n  for(const r of state.rings){\n    const t = r.age / r.life; const a = (1 - t) * 0.55;\n    ctx.strokeStyle = `rgba(255,255,255,${a})`; ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(r.x, r.y, r.r, 0, Math.PI*2); ctx.stroke();\n  }\n  for(const sp of state.sparks){\n    const t = sp.age / sp.life; const a = Math.max(0, 1 - t);\n    ctx.strokeStyle = `rgba(255, 220, 140, ${0.9*a})`; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(sp.x, sp.y); ctx.lineTo(sp.x - sp.vx*0.012, sp.y - sp.vy*0.012); ctx.stroke();\n  }\n  for(const p of state.particles){\n    const a = 1 - (p.age/p.life);\n    ctx.fillStyle = `rgba(255, 200, 120, ${0.78*a})`; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();\n  }\n  drawScorePops();\n\n  if(state.flash>0){\n    ctx.fillStyle = `rgba(255,255,255,${state.flash*0.22})`; ctx.fillRect(0,0,W,H);\n  }\n  ctx.restore();\n  requestAnimationFrame(draw);\n}\n\nlet lastT=0;\nfunction loop(t){\n  if(!lastT) lastT=t;\n  const dt=Math.min(0.033,(t-lastT)/1000);\n  lastT=t;\n  update(dt);\n  requestAnimationFrame(loop);\n}\n\nfunction normalizeAnswer(s){ return String(s??\"\").trim().toLowerCase(); }\n\nfunction showQuestion(){\n  const qi = state.questionIndex;\n  const q = QUESTIONS[(QUESTIONS.length? (qi % QUESTIONS.length):0)];\n\n  msgEl.textContent=\"\";\n  answersEl.innerHTML=\"\";\n  inputRow.style.display=\"none\";\n  answersEl.style.display=\"flex\";\n\n  qEl.textContent=q.q;\n  badgeEl.textContent=`${qi+1} / 9`;\n\n  const qMedia = document.getElementById(\"qMedia\");\n  const qImg = document.getElementById(\"qImg\");\n  const qAudio = document.getElementById(\"qAudio\");\n  \n  qImg.style.display = \"none\";\n  qAudio.style.display = \"none\";\n  qMedia.style.display = \"none\";\n  try { qAudio.pause(); } catch(e){}\n  qImg.src = \"\"; qAudio.src = \"\";\n\n  if(q.image || q.audio) {\n    qMedia.style.display = \"block\";\n    if(q.image) { qImg.src = q.image; qImg.style.display = \"block\"; }\n    if(q.audio) { qAudio.src = q.audio; qAudio.style.display = \"block\"; }\n  }\n\n  if(q.type===\"choice\"){\n    const opts = Array.isArray(q.options) ? q.options.slice() : [];\n    shuffleArray(opts);\n    for(const opt of opts){\n      const btn=document.createElement(\"button\");\n      btn.className=\"btn\";\n      btn.textContent=opt;\n      btn.addEventListener(\"click\", ()=>checkAnswer(opt));\n      answersEl.appendChild(btn);\n    }\n  } else {\n    answersEl.style.display=\"none\";\n    inputRow.style.display=\"flex\";\n    ansInput.value=\"\";\n  }\n\n  showOverlayAnimated();\n  setTimeout(()=>{ if(q.type===\"input\") ansInput.focus(); }, 50);\n\n  try{\n    if(window.__qTimerId){ clearInterval(window.__qTimerId); window.__qTimerId=null; }\n    const secs = (q.seconds!=null) ? Number(q.seconds) : ( (GAME && GAME.timer && GAME.timer.enabled) ? Number(GAME.timer.seconds||0) : null );\n    const timerEl = document.getElementById(\"qTimerBadge\") || document.querySelector(\".timer\") || document.querySelector(\"[data-role='pillTimer']\");\n    const txtEl = timerEl ? (timerEl.querySelector(\".qTimerText\") || timerEl.querySelector(\"[data-role='timerText']\")) : null;\n    const progEl = timerEl ? (timerEl.querySelector(\".qTimerProg\") || timerEl.querySelector(\"circle.qTimerProg\")) : null;\n    const R = 16;\n    const C = 2 * Math.PI * R;\n    if(progEl){\n      progEl.style.strokeDasharray = String(C);\n      progEl.style.strokeDashoffset = String(C);\n    }\n    if(Number.isFinite(secs) && secs>0){\n      const total = Math.max(1, Math.round(secs));\n      let left = total;\n\n      const paint = ()=>{\n        const p = Math.max(0, Math.min(1, left / total));\n        const hue = 45 * p;\n        if(timerEl){\n          timerEl.style.display = \"\";\n          timerEl.style.setProperty(\"--p\", String(p));\n          timerEl.style.setProperty(\"--h\", String(hue));\n          if(left <= 5) timerEl.classList.add(\"qPulse\"); else timerEl.classList.remove(\"qPulse\");\n        }\n        if(txtEl){ txtEl.textContent = String(left); }\n        else if(timerEl){ timerEl.textContent = \"\u23f3 \" + String(left); }\n        if(progEl){ progEl.style.strokeDashoffset = String(C * (1 - p)); }\n      };\n\n      paint();\n      window.__qTimerId = setInterval(()=>{\n        left--;\n        paint();\n        if(left<=0){\n          clearInterval(window.__qTimerId); window.__qTimerId=null;\n          try{ if(typeof checkAnswer === \"function\"){ checkAnswer(\"__TIMEOUT__\"); } }catch(e){}\n        }\n      },1000);\n    } else {\n      if(timerEl){\n        timerEl.style.display=\"none\";\n        timerEl.classList.remove(\"qPulse\");\n        if(txtEl) txtEl.textContent=\"\"; else timerEl.textContent=\"\";\n        if(progEl) progEl.style.strokeDashoffset = String(C);\n      }\n    }\n  }catch(e){}\n\n  if (window.__CFG?.useLatex && window.MathJax && window.MathJax.typesetPromise) {\n    setTimeout(() => {\n      window.MathJax.typesetPromise([document.getElementById(\"card\")]).catch(()=>{});\n    }, 60);\n  }\n}\n\nconst GAME_I18N = {\n  ru:{\n    start_lead:\"\u0421\u043e\u0431\u0435\u0440\u0438 \u0431\u0430\u0448\u043d\u044e \u0438\u0437 \u0431\u043b\u043e\u043a\u043e\u0432: \u043a\u0430\u0436\u0434\u044b\u0439 \u0443\u0440\u043e\u0432\u0435\u043d\u044c \u043f\u043e\u044f\u0432\u043b\u044f\u0435\u0442\u0441\u044f \u043f\u043e\u0441\u043b\u0435 \u043f\u0440\u0430\u0432\u0438\u043b\u044c\u043d\u043e\u0433\u043e \u043e\u0442\u0432\u0435\u0442\u0430.\",\n    start_rules:[\n      \"\u041f\u0435\u0440\u0432\u044b\u0439 \u0431\u043b\u043e\u043a \u043f\u0430\u0434\u0430\u0435\u0442 \u0441\u0430\u043c.\",\n      \"\u0414\u0430\u043b\u044c\u0448\u0435 \u043d\u0430\u0436\u0438\u043c\u0430\u0439 <b>\u0414\u0430\u043b\u0435\u0435</b>, \u0447\u0442\u043e\u0431\u044b \u0437\u0430\u043f\u0443\u0441\u043a\u0430\u0442\u044c \u0441\u043b\u0435\u0434\u0443\u044e\u0449\u0438\u0439 \u0431\u043b\u043e\u043a.\",\n      \"\u041a\u043e\u0433\u0434\u0430 \u0431\u043b\u043e\u043a \u043e\u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u0441\u044f \u2014 \u043e\u0442\u0432\u0435\u0442\u044c \u043d\u0430 \u0432\u043e\u043f\u0440\u043e\u0441.\",\n      \"<b>\u0412\u0435\u0440\u043d\u043e</b> \u2192 \u0431\u043b\u043e\u043a \u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u0441\u044f \u044d\u0442\u0430\u0436\u043e\u043c (+100).\",\n      \"<b>\u041d\u0435\u0432\u0435\u0440\u043d\u043e</b> \u2192 \u0431\u043b\u043e\u043a \u043e\u0431\u0443\u0433\u043b\u0438\u0432\u0430\u0435\u0442\u0441\u044f, \u0432\u0437\u0440\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u0438 \u0438\u0441\u0447\u0435\u0437\u0430\u0435\u0442.\"\n    ],\n    btn_play:\"\u25b6 \u041d\u0430\u0447\u0430\u0442\u044c\",\n    btn_next:\"\u0414\u0430\u043b\u0435\u0435\",\n    btn_submit:\"\u041e\u0442\u0432\u0435\u0442\u0438\u0442\u044c\",\n    correct:\"\u0412\u0435\u0440\u043d\u043e\",\n    wrong:\"\u041d\u0435\u0432\u0435\u0440\u043d\u043e\",\n    finish_title:\"\u041c\u043e\u043b\u043e\u0434\u0435\u0446!\",\n    stats_correct:\"\u043f\u0440\u0430\u0432\u0438\u043b\u044c\u043d\u044b\u0445 \u043e\u0442\u0432\u0435\u0442\u043e\u0432\",\n    stats_wrong:\"\u043d\u0435\u043f\u0440\u0430\u0432\u0438\u043b\u044c\u043d\u044b\u0445 \u043e\u0442\u0432\u0435\u0442\u043e\u0432\",\n    stats_height:\"\u0431\u043b\u043e\u043a\u043e\u0432 \u0432 \u0431\u0430\u0448\u043d\u0435\",\n    btn_restart:\"\u21bb \u0421\u044b\u0433\u0440\u0430\u0442\u044c \u0435\u0449\u0451 \u0440\u0430\u0437\"\n      sec_questions_title:\"\u0412\u043e\u043f\u0440\u043e\u0441\u044b\",\n      btn_add:\"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c\",\n      qs_help:\"\u0421\u0442\u0440\u043e\u0433\u043e <b>9 \u0432\u043e\u043f\u0440\u043e\u0441\u043e\u0432</b>. \u041c\u043e\u0436\u043d\u043e: <b>\u0432\u044b\u0431\u043e\u0440</b> \u0438\u043b\u0438 <b>\u0432\u0432\u043e\u0434</b> (\u043d\u0435\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u043f\u0440\u0430\u0432\u0438\u043b\u044c\u043d\u044b\u0445 \u0432\u0430\u0440\u0438\u0430\u043d\u0442\u043e\u0432).\",\n      sec_export:\"\u042d\u043a\u0441\u043f\u043e\u0440\u0442 \u0432 Genially\",\n      export_hint:\"\u041d\u0430\u0436\u043c\u0438 <b>\u00ab\ud83d\udccb \u0421\u043a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u0442\u044c iframe\u00bb</b> \u2014 \u0432 \u0431\u0443\u0444\u0435\u0440\u0435 \u0431\u0443\u0434\u0435\u0442 \u043a\u043e\u0440\u043e\u0442\u043a\u0438\u0439 \u043a\u043e\u0434 \u0432\u0438\u0434\u0430:\",\n      latex_desc:\"\u0412\u043a\u043b\u044e\u0447\u0430\u0435\u0442 \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u043a\u0443 \u043c\u0430\u0442\u0435\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u0445 \u0444\u043e\u0440\u043c\u0443\u043b (\u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440, $x^2$)\",\n      ui_feedback_ph:\"\u041c\u043e\u043b\u043e\u0434\u0435\u0446! \u0422\u043e\u0431\u043e\u0439 \u0437\u0430\u0440\u0430\u0431\u043e\u0442\u0430\u043d\u043e _________ \u0431\u0430\u043b\u043b\u043e\u0432\",\n\n\n  },\n  en:{\n    start_lead:\"Build the tower: each level appears after a correct answer.\",\n    start_rules:[\n      \"The first block falls automatically.\",\n      \"Then press <b>Next</b> to drop the next block.\",\n      \"When the block stops \u2014 answer the question.\",\n      \"<b>Correct</b> \u2192 the block becomes a level (+100).\",\n      \"<b>Wrong</b> \u2192 the block burns, explodes and disappears.\"\n    ],\n    btn_play:\"\u25b6 Start\",\n    btn_next:\"Next\",\n    btn_submit:\"Submit\",\n    correct:\"Correct\",\n    wrong:\"Wrong\",\n    finish_title:\"Well done!\",\n    stats_correct:\"correct answers\",\n    stats_wrong:\"wrong answers\",\n    stats_height:\"blocks in tower\",\n    btn_restart:\"\u21bb Play again\"\n      sec_questions_title:\"Questions\",\n      btn_add:\"Add\",\n      qs_help:\"Exactly <b>9 questions</b>. Types: <b>choice</b> or <b>input</b> (multiple correct answers allowed).\",\n      sec_export:\"Export to Genially\",\n      export_hint:'Click <b>\"\ud83d\udccb Copy iframe\"</b> \u2014 you will get a short code like:',\n      latex_desc:\"Enables math formulas (e.g., $x^2$)\",\n      ui_feedback_ph:\"Well done! You scored _________ points.\",\n\n\n  },\n  de:{\n    start_lead:\"Baue den Turm: jede Ebene \u043f\u043e\u044f\u0432\u043b\u044f\u0435\u0442\u0441\u044f nach der richtigen Antwort.\",\n    start_rules:[\n      \"Der erste Block f\u00e4llt automatisch.\",\n      \"Danach <b>Weiter</b> dr\u00fccken, um den n\u00e4chsten Block zu starten.\",\n      \"Wenn der Block \u0441\u0442\u043e\u043fpt \u2014 beantworte die Frage.\",\n      \"<b>Richtig</b> \u2192 Block wird zur Ebene (+100).\",\n      \"<b>Falsch</b> \u2192 Block verbrennt, explodiert und verschwindet.\"\n    ],\n    btn_play:\"\u25b6 Start\",\n    btn_next:\"Weiter\",\n    btn_submit:\"Antworten\",\n    correct:\"Richtig\",\n    wrong:\"Falsch\",\n    finish_title:\"Super!\",\n    stats_correct:\"richtige Antworten\",\n    stats_wrong:\"falsche Antworten\",\n    stats_height:\"Bl\u00f6cke im Turm\",\n    btn_restart:\"\u21bb Nochmal spielen\"\n      sec_questions_title:\"Fragen\",\n      btn_add:\"Hinzuf\u00fcgen\",\n      qs_help:\"Genau <b>9 Fragen</b>. Typen: <b>Auswahl</b> oder <b>Eingabe</b> (mehrere richtige Antworten m\u00f6glich).\",\n      sec_export:\"Export zu Genially\",\n      export_hint:'Klicke <b>\"\ud83d\udccb iframe kopieren\"</b> \u2014 du erh\u00e4ltst einen kurzen Code wie:',\n      latex_desc:\"Aktiviert mathematische Formeln (z.B. $x^2$)\",\n      ui_feedback_ph:\"Super! Du hast _________ Punkte erzielt.\",\n\n\n  },\n  zh:{\n    start_lead:\"\u642d\u5efa\u9ad8\u5854\uff1a\u6bcf\u7b54\u5bf9\u4e00\u6b21\u5c31\u589e\u52a0\u4e00\u5c42\u3002\",\n    start_rules:[\n      \"\u7b2c\u4e00\u4e2a\u65b9\u5757\u4f1a\u81ea\u52a8\u4e0b\u843d\u3002\",\n      \"\u4e4b\u540e\u70b9\u51fb <b>\u4e0b\u4e00\u6b65</b> \u8ba9\u4e0b\u4e00\u4e2a\u65b9\u5757\u4e0b\u843d\u3002\",\n      \"\u65b9\u5757\u505c\u6b62\u540e\u56de\u7b54\u95ee\u9898\u3002\",\n      \"<b>\u6b63\u786e</b> \u2192 \u65b9\u5757\u6210\u4e3a\u4e00\u5c42\uff08+100\uff09\u3002\",\n      \"<b>\u9519\u8bef</b> \u2192 \u65b9\u5757\u70e7\u6bc1\u3001\u7206\u70b8\u5e76\u6d88\u5931\u3002\"\n    ],\n    btn_play:\"\u25b6 \u5f00\u59cb\",\n    btn_next:\"\u4e0b\u4e00\u6b65\",\n    btn_submit:\"\u63d0\u4ea4\",\n    correct:\"\u6b63\u786e\",\n    wrong:\"\u9519\u8bef\",\n    finish_title:\"\u505a\u5f97\u597d\uff01\",\n    stats_correct:\"\u7b54\u5bf9\u6570\u91cf\",\n    stats_wrong:\"\u7b54\u9519\u6570\u91cf\",\n    stats_height:\"\u5854\u7684\u5c42\u6570\",\n    btn_restart:\"\u21bb \u518d\u73a9\u4e00\u6b21\"\n  }\n};\n\nfunction gT(key){\n  const lang = (window.__CFG?.lang || \"ru\");\n  return (GAME_I18N[lang] && GAME_I18N[lang][key]) ? GAME_I18N[lang][key] : (GAME_I18N.ru[key] || key);\n}\n\nfunction applyLangGame(){\n  // dynamic start-screen content + labels\n  const rules={\n    ru:[\n      \"–ü–µ—Ä–≤—ã–π –±–ª–æ–∫ –ø–∞–¥–∞–µ—Ç —Å–∞–º.\",\n      \"–î–∞–ª—å—à–µ –Ω–∞–∂–∏–º–∞–π <b>–î–∞–ª–µ–µ</b>, —á—Ç–æ–±—ã –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫.\",\n      \"–ö–æ–≥–¥–∞ –±–ª–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è ‚Äî –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å.\",\n      \"<b>–í–µ—Ä–Ω–æ</b> ‚Üí –±–ª–æ–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —ç—Ç–∞–∂–æ–º (+100).\",\n      \"<b>–ù–µ–≤–µ—Ä–Ω–æ</b> ‚Üí –±–ª–æ–∫ –æ–±—É–≥–ª–∏–≤–∞–µ—Ç—Å—è, –≤–∑—Ä—ã–≤–∞–µ—Ç—Å—è –∏ –∏—Å—á–µ–∑–∞–µ—Ç.\"\n    ],\n    en:[\n      \"The first block falls automatically.\",\n      \"Then press <b>Next</b> to drop the next block.\",\n      \"When the block stops ‚Äî answer the question.\",\n      \"<b>Correct</b> ‚Üí the block becomes a floor (+100).\",\n      \"<b>Wrong</b> ‚Üí the block burns, explodes and disappears.\"\n    ],\n    de:[\n      \"Der erste Block f√§llt automatisch.\",\n      \"Dann dr√ºcke <b>Weiter</b>, um den n√§chsten Block fallen zu lassen.\",\n      \"Wenn der Block stoppt ‚Äî beantworte die Frage.\",\n      \"<b>Richtig</b> ‚Üí der Block wird zu einer Etage (+100).\",\n      \"<b>Falsch</b> ‚Üí der Block verkohlt, explodiert und verschwindet.\"\n    ],\n    zh:[\n      \"Á¨¨‰∏Ä‰∏™ÊñπÂùó‰ºöËá™Âä®‰∏ãËêΩ„ÄÇ\",\n      \"‰πãÂêéÁÇπÂáª<b>‰∏ã‰∏ÄÊ≠•</b>ËÆ©‰∏ã‰∏Ä‰∏™ÊñπÂùó‰∏ãËêΩ„ÄÇ\",\n      \"ÊñπÂùóÂÅúÊ≠¢ÂêéÔºåËØ∑ÂõûÁ≠îÈóÆÈ¢ò„ÄÇ\",\n      \"<b>Ê≠£Á°Æ</b> ‚Üí ÊñπÂùóÂèòÊàêÊ•ºÂ±ÇÔºà+100Ôºâ„ÄÇ\",\n      \"<b>ÈîôËØØ</b> ‚Üí ÊñπÂùóÁÉßÁÑ¶„ÄÅÁàÜÁÇ∏Âπ∂Ê∂àÂ§±„ÄÇ\"\n    ]\n  };\n  try{\n    const ul=document.getElementById(\"startRules\");\n    if(ul){ ul.innerHTML=\"\"; (rules[lang]||rules.ru).forEach(t=>{ const li=document.createElement(\"li\"); li.innerHTML=t; ul.appendChild(li); }); }\n    const pl=document.getElementById(\"playLabel\");\n    if(pl){ pl.innerHTML=(lang===\"ru\"?\"‚ñ∂ –ù–∞—á–∞—Ç—å\":lang===\"de\"?\"‚ñ∂ Starten\":lang===\"zh\"?\"‚ñ∂ ÂºÄÂßã\":\"‚ñ∂ Start\"); }\n  }catch(e){}\n\n  try{\n    const playBtn = document.getElementById(\"play\");\n    if(playBtn) playBtn.innerHTML = gT(\"btn_play\");\n    const nextBtn = document.getElementById(\"next\");\n    if(nextBtn) nextBtn.textContent = gT(\"btn_next\");\n    const submitBtn = document.getElementById(\"submit\");\n    if(submitBtn) submitBtn.textContent = gT(\"btn_submit\");\n    const finTitle = document.getElementById(\"finishTitle\");\n    if(finTitle) finTitle.textContent = gT(\"finish_title\");\n    const lblCorrect = document.getElementById(\"lblCorrect\");\n    if(lblCorrect) lblCorrect.textContent = gT(\"stats_correct\");\n    const lblWrong = document.getElementById(\"lblWrong\");\n    if(lblWrong) lblWrong.textContent = gT(\"stats_wrong\");\n    const lblHeight = document.getElementById(\"lblHeight\");\n    if(lblHeight) lblHeight.textContent = gT(\"stats_height\");\n    const restart = document.getElementById(\"restart\");\n    if(restart) restart.textContent = gT(\"btn_restart\");\n\n    const lead = document.getElementById(\"startLead\");\n    if(lead) lead.textContent = gT(\"start_lead\");\n    const ul = document.getElementById(\"startRules\");\n    if(ul){\n      ul.innerHTML = \"\";\n      (gT(\"start_rules\") || []).forEach(line=>{\n        const li = document.createElement(\"li\");\n        li.innerHTML = line;\n        ul.appendChild(li);\n      });\n    }\n  }catch(e){}\n}\n\nfunction __applyTitle__(title){\n  const t = String(title || \"\u0411\u0430\u0448\u043d\u044f \u0437\u043d\u0430\u043d\u0438\u0439\");\n  document.title = t;\n  const h1 = document.querySelector(\"#startCard h1\");\n  if(h1) h1.textContent = t;\n}\n\nfunction __buildQuestionsFromCfg__(cfg){\n  const src = Array.isArray(cfg?.questions) ? cfg.questions : [];\n  if(src.length === 0){\n    return Array.from({length:9}, (_,i)=>({\n      type:\"choice\",\n      q:`(\u0432\u043e\u043f\u0440\u043e\u0441 ${i+1})`,\n      options:[\"OK\",\"...\"],\n      answer:\"OK\"\n    }));\n  }\n  return src.map((q,i)=>{\n    if(q && (q.type===\"text\" || q.type===\"input\")){\n      const acc = Array.isArray(q.accepts) ? q.accepts.map(String).filter(s=>s.trim()) : [];\n      return { type:\"input\", q:String(q.prompt||q.q||\"\"), accepts: acc, answer: String(acc[0]||\"\"), seconds:(q.seconds??null), image:(q.image||\"\"), audio:(q.audio||\"\") };\n    }\n    const opts = Array.isArray(q.options) ? q.options.map(String).filter(s=>s.trim()) : [];\n    const ci = Number.isFinite(q.correctIndex) ? q.correctIndex : 0;\n    const ans = (opts[ci] ?? opts[0] ?? \"OK\");\n    return { type:\"choice\", q:String(q.prompt||q.q||\"\"), options: opts.length?opts:[\"OK\",\"...\"], answer: String(ans), seconds:(q.seconds??null), image:(q.image||\"\"), audio:(q.audio||\"\") };\n  });\n}\n\nfunction checkAnswer(userValue){\n  try{ if(window.__qTimerId){ clearInterval(window.__qTimerId); window.__qTimerId=null; } }catch(e){}\n  try{ document.getElementById(\"qAudio\").pause(); }catch(e){}\n\n  const qi = state.questionIndex;\n  const q = QUESTIONS[(QUESTIONS.length? (qi % QUESTIONS.length):0)];\n  let ok=false;\n  if(q.type===\"input\"){\n    const acc = (q.accepts && q.accepts.length) ? q.accepts : [q.answer];\n    ok = acc.map(normalizeAnswer).includes(normalizeAnswer(userValue));\n  } else {\n    ok = normalizeAnswer(userValue) === normalizeAnswer(q.answer);\n  }\n  const waitingBlock = state.current;\n\n  if(ok){\n    state.correct++;\n    msgEl.innerHTML = `<span style=\"color: var(--good); font-weight:900;\">\u0412\u0435\u0440\u043d\u043e!</span> \u0411\u043b\u043e\u043a \u043e\u043f\u0443\u0441\u043a\u0430\u0435\u0442\u0441\u044f (+100).`;\n    playGood();\n    state.dropping = false;\n    setTimeout(()=>{\n      hideOverlayAnimated();\n      state.waitingAnswer = false;\n      if(state.current) state.dropping = true;\n      else setNextEnabled(true);\n    }, 220);\n  } else {\n    state.wrong++;\n    msgEl.innerHTML = `<span style=\"color: var(--bad); font-weight:900;\">\u041d\u0435\u0432\u0435\u0440\u043d\u043e!</span> \u0411\u043b\u043e\u043a \u043e\u0431\u0443\u0433\u043b\u0438\u0432\u0430\u0435\u0442\u0441\u044f \u0438 \u0438\u0441\u0447\u0435\u0437\u0430\u0435\u0442.`;\n    state.dropping = false;\n\n    const scorchDur = 0.35;\n    let elapsed = 0;\n    function scorchStep(){\n      if(!state.current || state.current !== waitingBlock) return;\n      elapsed += 1/60;\n      state.current.char = Math.min(1, elapsed / scorchDur);\n      if(Math.random() < 0.25){\n        state.smokes.push({\n          x: waitingBlock.x + waitingBlock.w/2 + (Math.random()*30-15),\n          y: waitingBlock.y + waitingBlock.h/2 + (Math.random()*20-10),\n          vx: (Math.random()*2-1)*40,\n          vy: -80 - Math.random()*80,\n          life:0.6+Math.random()*0.4,\n          age:0,\n          rad: 14+Math.random()*18\n        });\n      }\n      if(elapsed < scorchDur){\n        requestAnimationFrame(scorchStep);\n      }\n    }\n    requestAnimationFrame(scorchStep);\n\n    setTimeout(()=>{\n      hideOverlayAnimated();\n      state.waitingAnswer = false;\n      if(waitingBlock && waitingBlock === state.current){\n        boomAt(waitingBlock);\n      }\n      state.current = null;\n      setNextEnabled(true);\n    }, 520);\n  }\n  state.blockIndex++;\n}\n\nsubmitBtn.addEventListener(\"click\", ()=>checkAnswer(ansInput.value));\nansInput.addEventListener(\"keydown\",(e)=>{ if(e.key===\"Enter\") checkAnswer(ansInput.value); });\ndocument.addEventListener(\"keydown\",(e)=>{\n  if(overlay.style.display===\"flex\" && e.key===\"Enter\"){\n    const qi=state.questionIndex;\n    if(QUESTIONS[qi].type===\"input\") checkAnswer(ansInput.value);\n  }\n});\n\nnextBtn.addEventListener(\"click\", ()=>{\n  if(nextBtn.disabled) return;\n  state.questionIndex++;\n  if(state.questionIndex >= 9){\n    finishGame();\n    return;\n  }\n  spawnBlock();\n});\n\nasync function startGame(){\n  if (window.__CFG?.useLatex && !window.MathJax) {\n    window.MathJax = {\n      tex: { inlineMath: [['$', '$']], displayMath: [['$$', '$$']] },\n      startup: { typeset: false }\n    };\n    const script = document.createElement('script');\n    script.src = \"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js\";\n    document.head.appendChild(script);\n  }\n\n  try{\n    if(typeof __applyTitle__ === \"function\") __applyTitle__(window.__CFG?.title || \"\u0411\u0430\u0448\u043d\u044f \u0437\u043d\u0430\u043d\u0438\u0439\");\n    if(typeof __buildQuestionsFromCfg__ === \"function\") QUESTIONS = __buildQuestionsFromCfg__(window.__CFG || {});\n    if(!Array.isArray(QUESTIONS) || QUESTIONS.length===0){\n      QUESTIONS = Array.from({length:9}, (_,i)=>({type:\"choice\", q:`(\u0432\u043e\u043f\u0440\u043e\u0441 ${i+1})`, options:[\"OK\",\"...\"], answer:\"OK\"}));\n    }\n  }catch(e){}\n\n  errBox.style.display=\"none\";\n  errList.innerHTML=\"\";\n\n  ensureAudio();\n  if(audioCtx.state===\"suspended\"){ try{ await audioCtx.resume(); }catch{} }\n\n  Object.assign(state, {\n    running:false, bg:null, blocks:[], towerScale:1,\n    tower:[], current:null,\n    particles:[], smokes:[], rings:[], sparks:[], flash:0,\n    cameraShake:0, cameraX:0, cameraY:0,\n    towerOffsetY:0, towerOffsetV:0,\n    questionIndex:0, waitingAnswer:false, dropping:false,\n    blockIndex:0, readyForNext:false,\n    finished:false, score:0, scoreFloats:[], correct:0, wrong:0, landingBounce:null,\n  });\n  scoreNum.textContent = \"0\";\n  setNextEnabled(false);\n  updateRemain();\n\n  const missing=[];\n\n  const bgSrc = (window.__CFG?.bgUrl && String(window.__CFG.bgUrl).trim()) || (window.__CFG?.bgDataUrl && String(window.__CFG.bgDataUrl).trim()) || assetUrl(BG_FILE);\n\n  try{ state.bg = await loadImage(bgSrc); }\n  catch{ missing.push(bgSrc); }\n\n  const blocks=[];\n  for(const f of BLOCK_FILES){\n    try{\n      const raw = await loadImage(assetUrl(f));\n      const t = await trimAndCentroidAndProfiles(raw);\n      blocks.push({ file:f, img:t.img, w:t.w, h:t.h, cx:t.cx, cy:t.cy, top:t.top, bottom:t.bottom });\n    } catch {\n      missing.push(f);\n    }\n  }\n\n  if(missing.length){\n    errBox.style.display=\"block\";\n    for(const f of missing){\n      const li=document.createElement(\"li\");\n      li.textContent = f + \" (\u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d/\u043d\u0435 \u0437\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u0442\u0441\u044f)\";\n      errList.appendChild(li);\n    }\n    return;\n  }\n\n  state.towerScale = computeTowerScale(blocks);\n  state.blocks = blocks;\n  state.running = true;\n  spawnBlock();\n}\n\nwindow.__startGame = startGame;\ntry{const pb=document.getElementById(\"play\"); if(pb){ pb.addEventListener(\"click\", async ()=>{ try{document.getElementById(\"start\").style.display=\"none\";}catch(e){}; await startGame(); }); }}catch(e){}\nstartLayer.addEventListener(\"click\", async (e)=>{ if(e.target===startLayer){ startLayer.style.display=\"none\"; await startGame(); }});\n\nplayBtn.addEventListener(\"click\", async ()=>{\n  startLayer.style.display=\"none\";\n  await startGame();\n});\n\nrequestAnimationFrame(loop);\nrequestAnimationFrame(draw);\n\ntry{\n  const __qp = new URLSearchParams(location.search);\n  if(__qp.get(\"preview\")===\"1\"){\n    const startLayer = document.getElementById(\"startLayer\");\n    if(startLayer) startLayer.style.display=\"none\";\n    setTimeout(()=>{\n      const playBtn = document.getElementById(\"playBtn\");\n      if(playBtn) playBtn.click();\n    }, 60);\n  }\n}catch(e){}\n";

  function injectCanvasGame(cfg){
    const root = $("gameRoot");
    root.innerHTML = __GAME_HTML__;

    let st = document.getElementById("__tower_game_style");
    if(!st){
      st = document.createElement("style");
      st.id="__tower_game_style";
      st.textContent = __GAME_CSS__;
      document.head.appendChild(st);
    
    // --- Start screen i18n (title + rules + buttons + hint) ---
    try{
      const start = document.getElementById("start");
      if(start){
        const h1 = start.querySelector("h1");
        if(h1) h1.textContent = t("game_title") || h1.textContent;
        const ul = document.getElementById("startRules");
        const rules = I18N[lang]?.game_rules;
        if(ul && Array.isArray(rules)){
          ul.innerHTML = rules.map(r=>`<li>${r}</li>`).join("");
        }
        const play = document.getElementById("play");
        if(play) play.textContent = (t("game_start_btn") || play.textContent).replace(/^‚ñ∂\s*/, "‚ñ∂ ");
      }
      const nextBtn = document.getElementById("next");
      if(nextBtn) nextBtn.textContent = t("game_next_btn") || nextBtn.textContent;
      const hint = document.getElementById("hint");
      if(hint) hint.textContent = t("game_hint") || hint.textContent;
    }catch(e){}
}

    try{
      const qb = root.querySelector("#qTimerBadge");
      if(qb){
        qb.classList.add("qTimer");
        qb.innerHTML = `
          <svg class="qTimerRing" viewBox="0 0 40 40" aria-hidden="true">
            <circle class="qTimerTrack" cx="20" cy="20" r="16"></circle>
            <circle class="qTimerProg"  cx="20" cy="20" r="16"></circle>
          </svg>
          <span class="qTimerText"></span>
        `;
        qb.style.display = "none";
      }

      let st2 = document.getElementById("__tower_timer_style");
      if(!st2){
        st2 = document.createElement("style");
        st2.id="__tower_timer_style";
        st2.textContent = `
#gameRoot #card{ position:relative; }
#gameRoot #qTimerBadge.qTimer{
  --p: 1; --h: 45;
  position:absolute; top:-40px; left:50%; transform: translateX(-50%);
  display:flex; align-items:center; gap:12px; padding:10px 14px;
  border-radius:999px; color: rgba(255,255,255,.96);
  background: linear-gradient(180deg, rgba(18,22,34,.78), rgba(8,10,16,.62));
  border: 1px solid rgba(255,255,255,.16);
  box-shadow: 0 18px 55px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.10);
  backdrop-filter: blur(12px);
}
#gameRoot #qTimerBadge.qTimer::after{
  content:""; position:absolute; inset:-2px; border-radius:999px; pointer-events:none; opacity:.55;
  background: radial-gradient(60% 120% at 50% 0%, hsla(var(--h), 92%, 62%, .38), transparent 70%);
}
#gameRoot #qTimerBadge .qTimerRing{ width:38px; height:38px; transform: rotate(-90deg); filter: drop-shadow(0 6px 10px rgba(0,0,0,.35)); }
#gameRoot #qTimerBadge .qTimerTrack{ fill:none; stroke: rgba(255,255,255,.10); stroke-width:4; }
#gameRoot #qTimerBadge .qTimerProg{ fill:none; stroke-width:4; stroke-linecap:round; stroke: hsl(var(--h) 90% 60% / .95); stroke-dasharray: 100.53; stroke-dashoffset: calc(100.53 * (1 - var(--p))); transition: stroke .25s linear, stroke-dashoffset .25s linear; }
#gameRoot #qTimerBadge .qTimerText{ font-weight:900; font-size:16px; color: rgba(255,255,255,.94); letter-spacing:.2px; min-width: 2ch; text-align:right; }
#gameRoot #qTimerBadge.qPulse{ animation: qPulseAnim .85s ease-in-out infinite; }
@keyframes qPulseAnim{
  0%,100%{ transform: translateX(-50%) scale(1); filter: drop-shadow(0 10px 22px rgba(0,0,0,.35)); }
  50%{ transform: translateX(-50%) scale(1.06); filter: drop-shadow(0 14px 30px hsla(var(--h), 92%, 60%, .38)); }
}
`;
        document.head.appendChild(st2);
      }
    }catch(e){}

    window.__CFG = { title: cfg.title || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π", questions: cfg.questions || [], useLatex: !!cfg.useLatex, lang: (cfg.lang||"ru"), feedback: (cfg.feedback||""), bgUrl: (cfg.bgUrl||"") };

    try{
      const qp = new URLSearchParams(location.search);
      if(qp.get("preview")==="1"){ /* keep start screen; no auto-click */ }
    }catch(e){}

    if(!window.__TOWER_GAME_RAN__){
      window.__TOWER_GAME_RAN__ = true;
      try{
        eval(__GAME_JS__);
      }catch(e){
        showErr(e?.stack || e?.message || String(e));
      }
    } else {
      try{
        const playBtn = document.getElementById("play");
        const startLayer = document.getElementById("start");
        if(startLayer) startLayer.style.display="";
        // no auto-start in preview; user must click the button
}catch(e){}
    }
  }


  function uid(){ return "q_" + Math.random().toString(36).slice(2,9) + "_" + Date.now().toString(36); }
  function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

  function toast(msg){
    const t = $("toast");
    if (!t) return;
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1400);
  }

  function fileToDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=>resolve(String(r.result || ""));
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  async function copyToClipboard(text){
    try{
      if (navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch(e){}
    try{
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.setAttribute("readonly", "");
      ta.style.position = "fixed";
      ta.style.left = "0";
      ta.style.top = "0";
      ta.style.opacity = "0";
      ta.style.width = "1px";
      ta.style.height = "1px";
      ta.style.pointerEvents = "none";
      ta.style.zIndex = "-1";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      ta.setSelectionRange(0, ta.value.length);
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }catch(e){ return false; }
  }

  function basePath(){ return location.origin + location.pathname.replace(/\/[^\/]*$/, "/"); }
  const BASE = basePath();
  function selfPageUrl(){
    let p = location.pathname || "/";
    if(p.endsWith("/")) p += "index.html";
    return location.origin + p;
  }

  const repoBgUrl = BASE + "1.png";
  const blockUrls = Array.from({length:9}, (_,i)=> BASE + (i+3) + ".png");

  function parseQueryParams(){
    const q = {};
    const s = window.location.search.replace(/^\?/, "");
    s.split("&").filter(Boolean).forEach(pair=>{
      const [k,v] = pair.split("=");
      if(!k) return;
      q[decodeURIComponent(k)] = decodeURIComponent(v||"");
    });
    return q;
  }

  function parseHashParams(){
    const h = (location.hash || "").replace(/^#/, "");
    const out = {};
    h.split("&").filter(Boolean).forEach(pair=>{
      const [k,v] = pair.split("=");
      if(!k) return;
      out[decodeURIComponent(k)] = decodeURIComponent(v || "");
    });
    return out;
  }

  function b64urlEncode(str){
    const b64 = btoa(unescape(encodeURIComponent(str)));
    return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
  }
  function b64urlDecode(b64url){
    let s = String(b64url||"").replaceAll("-","+").replaceAll("_","/");
    while(s.length % 4) s += "=";
    return decodeURIComponent(escape(atob(s)));
  }

  function normalizeCfg(raw){
    const cfg = raw && typeof raw === "object" ? raw : {};
    const title = String(cfg.title || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π");
    const useRepoBg = !!cfg.useRepoBg;
    const bgDataUrl = String(cfg.bgDataUrl || "");
    const bgUrl = String(cfg.bgUrl || "").trim();
    const lang = String(cfg.lang || "ru");
    const feedback = String(cfg.feedback || "–ú–æ–ª–æ–¥–µ—Ü! –¢–æ–±–æ–π –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ _________ –±–∞–ª–ª–æ–≤");
    const useImages = !!cfg.useImages;
    const useLatex = !!cfg.useLatex;

    const timerEnabled = !!cfg.timer?.enabled;
    const timerSeconds = Math.max(5, Math.min(600, Number(cfg.timer?.seconds || 30)));
    let questions = Array.isArray(cfg.questions) ? cfg.questions.slice(0,9) : [];

    questions = questions.map(q=>{
      const rawSecs = (q && ("seconds" in q)) ? q.seconds : null;
      const nSecs = (rawSecs==null || rawSecs==="") ? null : Number(rawSecs);
      const seconds = (Number.isFinite(nSecs) && nSecs>0) ? Math.max(1, Math.min(600, Math.round(nSecs))) : null;
      const image = String(q?.image || "").trim();
      const audio = String(q?.audio || "").trim();
      
      if(q?.type === "text"){
        return { type:"text", prompt:String(q.prompt||""), accepts:(Array.isArray(q.accepts)?q.accepts:[]).map(x=>String(x||"")), seconds, image, audio };
      }
      return { type:"choice", prompt:String(q?.prompt||""), options:(Array.isArray(q?.options)?q.options:[]).map(x=>String(x||"")), correctIndex:Number(q?.correctIndex||0), seconds, image, audio };
    });

    return { title, useRepoBg, bgDataUrl, bgUrl, lang, feedback, timer: { enabled: timerEnabled, seconds: timerSeconds }, useImages, useLatex, blockUrls: blockUrls, questions };
  }

  const Editor = {
    title: "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π",
    useRepoBg: true,
    bgDataUrl: "",
    bgUrl: "",
    lang: "ru",
    feedback: "–ú–æ–ª–æ–¥–µ—Ü! –¢–æ–±–æ–π –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ _________ –±–∞–ª–ª–æ–≤",
    timer: { enabled:false, seconds: 30 },
    useImages: true,
    useLatex: false,
    questions: [],
    draft: null,
    editingId: null
  };

  function setCountPill(){
    $("pillCount").textContent = Editor.questions.length + " / 9";
    $("btnAddQ").disabled = (Editor.questions.length >= 9);
  }

  function escapeHtml(s){
    return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function qSummary(q){
    const p = String(q.prompt || "").trim();
    const short = p.length > 50 ? p.slice(0,50)+"‚Ä¶" : p;
    let type = (q.type==="choice") ? "–í—ã–±–æ—Ä" : "–í–≤–æ–¥";
    if (q.image || q.audio) type += " (+ –º–µ–¥–∏–∞)";
    return { title: short || "(–ø—É—Å—Ç–æ)", sub: type };
  }

  function renderList(){
    const list = $("qList");
    list.innerHTML = "";
    setCountPill();

    if(Editor.questions.length === 0){
      const d = document.createElement("div");
      d.className = "muted";
      d.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤. –ù–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ 9 –≤–æ–ø—Ä–æ—Å–æ–≤.";
      list.appendChild(d);
      return;
    }

    Editor.questions.forEach((q,i)=>{
      const wrap = document.createElement("div");
      wrap.className = "q-item";

      const meta = document.createElement("div");
      meta.className = "meta";
      const s = qSummary(q);
      meta.innerHTML = `<div class="t">${escapeHtml(String(i+1)+". "+s.title)}</div><div class="s">${escapeHtml(s.sub)}</div>`;

      const btns = document.createElement("div");
      btns.style.display="flex";
      btns.style.gap="8px";
      btns.style.flexWrap="wrap";
      btns.style.justifyContent="flex-end";

      const bPrev = document.createElement("button");
      bPrev.className = "btn small";
      bPrev.type="button";
      bPrev.textContent = "üëÅ";
      bPrev.title = "–ü–æ–∫–∞–∑–∞—Ç—å –≤ –ø—Ä–µ–≤—å—é (–ø–µ—Ä–≤—ã–º –≤–æ–ø—Ä–æ—Å–æ–º)";
      bPrev.onclick = ()=>{
        Editor.draft = deepClone(q);
        updatePreview(true);
        toast("–ü–æ–∫–∞–∑–∞–Ω–æ –≤ –ø—Ä–µ–≤—å—é");
      };
      const bEdit = document.createElement("button");
      bEdit.className = "btn small";
      bEdit.type="button";
      bEdit.textContent = "‚úèÔ∏è";
      bEdit.title = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
      bEdit.onclick = ()=> openModal(q);
      const bDel = document.createElement("button");
      bDel.className = "btn small danger";
      bDel.type="button";
      bDel.textContent = "üóë";
      bDel.title = "–£–¥–∞–ª–∏—Ç—å";
      bDel.onclick = ()=>{
        Editor.questions = Editor.questions.filter(x=>x.id!==q.id);
        renderList();
        updatePreview(false);
        toast("–£–¥–∞–ª–µ–Ω–æ");
      };

      btns.appendChild(bPrev);
      btns.appendChild(bEdit);
      btns.appendChild(bDel);
      wrap.appendChild(meta);
      wrap.appendChild(btns);
      list.appendChild(wrap);
    });
  }

  function showModal(){
    $("modalBackdrop").style.display = "flex";
    $("modalBackdrop").setAttribute("aria-hidden","false");
  }
  function hideModal(){
    $("modalBackdrop").style.display = "none";
    $("modalBackdrop").setAttribute("aria-hidden","true");
  }

  function syncModalType(){
    const t = $("selType").value;
    $("choiceWrap").style.display = (t==="choice") ? "block" : "none";
    $("textWrap").style.display = (t==="text") ? "block" : "none";
  }

  function renderChoiceUI(){
    const list = $("choiceList");
    list.innerHTML = "";
    const q = Editor.draft;
    if(!q) return;

    q.options = q.options || ["",""];
    if(typeof q.correctIndex !== "number") q.correctIndex = 0;

    q.options.forEach((val, idx)=>{
      const row = document.createElement("div");
      row.className = "answerRow";

      const r = document.createElement("input");
      r.className="radio";
      r.type="radio";
      r.name="correctChoice";
      r.checked = (q.correctIndex === idx);
      r.onchange = ()=>{ q.correctIndex = idx; renderChoiceUI(); };

      const inp = document.createElement("input");
      inp.type="text";
      inp.value = val || "";
      inp.placeholder = (idx === q.correctIndex) ? "‚úÖ –í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç" : ("–í–∞—Ä–∏–∞–Ω—Ç " + (idx+1));
      inp.oninput = ()=>{ q.options[idx] = inp.value; };

      const del = document.createElement("button");
      del.className="btn small danger";
      del.type="button";
      del.textContent="‚úñ";
      del.onclick = ()=>{
        q.options.splice(idx,1);
        if(q.options.length < 2) q.options.push("");
        if(q.correctIndex >= q.options.length) q.correctIndex = q.options.length-1;
        renderChoiceUI();
      };

      row.appendChild(r);
      row.appendChild(inp);
      row.appendChild(del);
      list.appendChild(row);
    });
  }

  function renderTextUI(){
    const list = $("textList");
    list.innerHTML = "";
    const q = Editor.draft;
    if(!q) return;
    q.accepts = q.accepts || [""];

    q.accepts.forEach((val, idx)=>{
      const row = document.createElement("div");
      row.className = "answerRow";

      const inp = document.createElement("input");
      inp.type="text";
      inp.value = val || "";
      inp.placeholder = (idx===0) ? "‚úÖ –í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç" : ("–í–µ—Ä–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç " + (idx+1));
      inp.oninput = ()=>{ q.accepts[idx] = inp.value; };

      const del = document.createElement("button");
      del.className="btn small danger";
      del.type="button";
      del.textContent="‚úñ";
      del.onclick = ()=>{
        q.accepts.splice(idx,1);
        if(q.accepts.length === 0) q.accepts.push("");
        renderTextUI();
      };

      row.appendChild(inp);
      row.appendChild(del);
      list.appendChild(row);
    });
  }

  function openModal(existing=null){
    if(existing){
      Editor.draft = deepClone(existing);
      Editor.editingId = existing.id;
      $("modalTitle").textContent = t("modal_edit_q");
    } else {
      Editor.draft = {
        id: uid(), type: "choice", prompt: "", options: ["",""], correctIndex: 0, seconds: null, image: "", audio: ""
      };
      Editor.editingId = null;
      $("modalTitle").textContent = t("modal_add_q");
    }

    $("selType").value = Editor.draft.type || "choice";
    $("inpPrompt").value = Editor.draft.prompt || "";
    
    if(!("seconds" in Editor.draft)) Editor.draft.seconds = null;
    if($("inpQSeconds")) $("inpQSeconds").value = (Editor.draft.seconds ?? "");
    
    if(!("image" in Editor.draft)) Editor.draft.image = "";
    if(!("audio" in Editor.draft)) Editor.draft.audio = "";
    if($("inpQImage")) $("inpQImage").value = Editor.draft.image;
    if($("inpQAudio")) $("inpQAudio").value = Editor.draft.audio;
    
    syncModalType();
    if($("selType").value === "choice") renderChoiceUI();
    else renderTextUI();

    showModal();
    try{ applyLangModals(); }catch(e){}
    setTimeout(()=>$("inpPrompt").focus(), 40);
  }

  function getDraftFromModal(){
    const q = Editor.draft;
    if(!q) return null;

    q.type = $("selType").value;
    q.prompt = $("inpPrompt").value || "";

    q.seconds = ($("inpQSeconds") && $("inpQSeconds").value !== "") ? Number($("inpQSeconds").value) : null;
    if(q.seconds != null){
      const s = Number(q.seconds);
      if(!Number.isFinite(s) || s < 3 || s > 600) return "–¢–∞–π–º–µ—Ä –≤–æ–ø—Ä–æ—Å–∞: 3‚Äì600 —Å–µ–∫—É–Ω–¥";
      q.seconds = Math.round(s);
    }
    
    q.image = $("inpQImage") ? $("inpQImage").value.trim() : "";
    q.audio = $("inpQAudio") ? $("inpQAudio").value.trim() : "";

    if(q.type === "choice"){
      q.options = (q.options || []).map(x=>String(x||""));
      q.correctIndex = Number.isFinite(q.correctIndex) ? q.correctIndex : 0;
    } else {
      q.accepts = (q.accepts || [""]).map(x=>String(x||""));
    }
    return q;
  }

  function validateQuestion(q){
    if(!q) return "–ü—É—Å—Ç–æ–π –≤–æ–ø—Ä–æ—Å";
    if(!(q.prompt||"").trim()) return "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞";

    if(q.type === "choice"){
      const opts = (q.options||[]).map(x=>String(x||"").trim()).filter(Boolean);
      if(opts.length < 2) return "–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞";
      q.options = opts;
      if(!Number.isFinite(q.correctIndex)) q.correctIndex = 0;
      if(q.correctIndex >= q.options.length) q.correctIndex = 0;
      return "";
    }

    const acc = (q.accepts||[]).map(x=>String(x||"").trim()).filter(Boolean);
    if(acc.length === 0) return "–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç";
    q.accepts = acc;
    return "";
  }

  function buildPayload(previewWithDraft){
    let questions = Editor.questions.map(q=>{
      if(q.type === "choice"){
        return { type:"choice", prompt:q.prompt||"", options:(q.options||[]).slice(), correctIndex:Number(q.correctIndex||0), seconds:(q.seconds??null), image:q.image||"", audio:q.audio||"" };
      }
      return { type:"text", prompt:q.prompt||"", accepts:(q.accepts||[]).slice(), seconds:(q.seconds??null), image:q.image||"", audio:q.audio||"" };
    });
    
    if(previewWithDraft && Editor.draft){
      const d = deepClone(Editor.draft);
      questions = questions.slice();
      if(d.type === "choice"){
        const mapped = {
          type:"choice", prompt:d.prompt||"", options:(d.options||[]).slice(), correctIndex:Number(d.correctIndex||0),
          seconds: (d.seconds==null || d.seconds==="") ? null : Number(d.seconds), image:d.image||"", audio:d.audio||""
        };
        if(questions.length === 0) questions.push(mapped);
        else questions[0] = mapped;
      } else {
        const mapped = {
          type:"text", prompt:d.prompt||"", accepts:(d.accepts||[]).slice(),
          seconds: (d.seconds==null || d.seconds==="") ? null : Number(d.seconds), image:d.image||"", audio:d.audio||""
        };
        if(questions.length === 0) questions.push(mapped);
        else questions[0] = mapped;
      }
    }

    return normalizeCfg({
      title: Editor.title || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π",
      useRepoBg: true,
      bgDataUrl: Editor.bgDataUrl || "",
      bgUrl: Editor.bgUrl || "",
      lang: Editor.lang || "ru",
      feedback: Editor.feedback || "–ú–æ–ª–æ–¥–µ—Ü! –¢–æ–±–æ–π –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ _________ –±–∞–ª–ª–æ–≤",
      timer: { enabled: !!Editor.timer.enabled, seconds: Number(Editor.timer.seconds || 30) },
      useImages: !!Editor.useImages,
      useLatex: !!Editor.useLatex,
      questions
    });
  }

  function buildGameUrl(payload){
    const data = b64urlEncode(JSON.stringify(payload));
    return selfPageUrl() + "?game=" + data + "#game=" + data;
  }
  function buildIframeFromUrl(src){
    return `<iframe src="${src}" style="width:100%;height:720px;min-height:720px;border:0;border-radius:18px;overflow:hidden;background:transparent" allow="autoplay; fullscreen" allowfullscreen loading="lazy"></iframe>`;
  }

  const PREVIEW_CFGKEY = "__tower_preview_cfg__";
  function storePreviewCfg(cfg){
    try{ localStorage.setItem(PREVIEW_CFGKEY, JSON.stringify(cfg)); return PREVIEW_CFGKEY; }
    catch(e){ return ""; }
  }

  function updatePreview(previewWithDraft){
    const payload = buildPayload(previewWithDraft);
    const jsonStr = JSON.stringify(payload);
    const useKey = jsonStr.length > 1800;
    if(useKey){
      const key = storePreviewCfg(payload);
      if(key){
        const src = selfPageUrl() + "?cfgkey=" + encodeURIComponent(key) + "&preview=1#cfgkey=" + encodeURIComponent(key);
        $("livePreview").src = src;
        return;
      }
    }
    const data = b64urlEncode(jsonStr);
    const src = selfPageUrl() + "?game=" + data + "&preview=1#game=" + data;
    $("livePreview").src = src;
  }

  $("inpTitle").addEventListener("input", ()=>{ Editor.title = $("inpTitle").value || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π";
  if($("inpBgUrl")) $("inpBgUrl").value = Editor.bgUrl || "";
  if($("inpFeedback")) $("inpFeedback").value = Editor.feedback || "–ú–æ–ª–æ–¥–µ—Ü! –¢–æ–±–æ–π –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ _________ –±–∞–ª–ª–æ–≤";
  if($("selLang")) $("selLang").value = Editor.lang || "ru";
  try{ applyLangEditor(); applyLangSelectLabels(); }catch(e){} updatePreview(false); });
  $("fileBg").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    Editor.bgDataUrl = await fileToDataUrl(f); toast(t("toast_bg_loaded")); updatePreview(false);
  });
  $("btnResetBg").addEventListener("click", ()=>{ Editor.bgDataUrl = ""; $("fileBg").value = ""; updatePreview(false); });
  // bg url (lighter than file for Genially)
  if($("inpBgUrl")){
    $("inpBgUrl").addEventListener("input", ()=>{ Editor.bgUrl = $("inpBgUrl").value.trim(); updatePreview(false); });
  }

  // feedback template
  if($("inpFeedback")){
    $("inpFeedback").addEventListener("input", ()=>{ Editor.feedback = $("inpFeedback").value; updatePreview(false); });
  }

  // language
  const I18N = {
    ru: {
      editor_title:"–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ë–∞—à–Ω—è¬ª",
      btn_copy_iframe:"üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ (iframe)",
      sec_title:"–ù–∞–∑–≤–∞–Ω–∏–µ",
      label_game_title:"–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∏–≥—Ä–µ",
      ui_lang_title:"–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞",
      ui_lang_label:"–í—ã–±—Ä–∞—Ç—å —è–∑—ã–∫",
      ui_feedback_title:"–§–∏–¥–±–µ–∫ –≤ –∫–æ–Ω—Ü–µ",
      ui_feedback_label:"–¢–µ–∫—Å—Ç –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º —ç–∫—Ä–∞–Ω–µ (–∏—Å–ø–æ–ª—å–∑—É–π {{score}} –∏–ª–∏ _________)",
      ui_bgurl_title:"–§–æ–Ω –ø–æ —Å—Å—ã–ª–∫–µ",
      ui_bgurl_label:"URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ —Ñ–∞–π–ª–∞)",
      ui_bgurl_hint:"–°–æ–≤–µ—Ç: —Ç–∞–∫ –±—ã—Å—Ç—Ä–µ–µ –¥–ª—è Genially, —á–µ–º –≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª.",
      sec_style:"–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ",
      label_bg:"–í—ã–±—Ä–∞—Ç—å —Å–≤–æ–π —Ñ–æ–Ω",
      btn_reset_bg:"‚Ü© –°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ–Ω",
      use_latex:"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LaTeX",
      sec_questions:"–í–æ–ø—Ä–æ—Å—ã",
      btn_add:"–î–æ–±–∞–≤–∏—Ç—å",
      btn_clear:"–û—á–∏—Å—Ç–∏—Ç—å",
      toast_iframe_ok:"iframe —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω ‚úÖ",
      toast_iframe_fail:"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
      toast_bg_loaded:"–§–æ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω",
      sec_questions_title:"–í–æ–ø—Ä–æ—Å—ã",
      btn_add:"Ê∑ªÂä†",
      qs_help:"–°—Ç—Ä–æ–≥–æ <b>9 –≤–æ–ø—Ä–æ—Å–æ–≤</b>. –ú–æ–∂–Ω–æ: <b>–≤—ã–±–æ—Ä</b> –∏–ª–∏ <b>–≤–≤–æ–¥</b> (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤).",
      sec_export:"ÂØºÂá∫Âà∞ Genially",
      export_hint:'ÁÇπÂáª <b>"üìã Â§çÂà∂ iframe"</b>ÔºåÂç≥ÂèØÂæóÂà∞Â¶Ç‰∏ãÁü≠‰ª£Á†ÅÔºö',
      latex_desc:"ÂêØÁî®Êï∞Â≠¶ÂÖ¨ÂºèÔºà‰æãÂ¶Ç $x^2$Ôºâ",
      ui_feedback_ph:"ÂÅöÂæóÂ•ΩÔºÅ‰Ω†Ëé∑Âæó‰∫Ü _________ ÂàÜ„ÄÇ",
      modal_add_q:"–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å",
      modal_edit_q:"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å",
      modal_close:"–ó–∞–∫—Ä—ã—Ç—å",
      modal_q_type:"–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞",
      modal_type_choice:"–° –≤—ã–±–æ—Ä–æ–º –æ—Ç–≤–µ—Ç–∞",
      modal_type_text:"–° –≤–≤–æ–¥–æ–º –æ—Ç–≤–µ—Ç–∞",
      modal_question:"–í–æ–ø—Ä–æ—Å",
      modal_question_ph:"–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å‚Ä¶",
      modal_timer_title:"–¢–∞–π–º–µ—Ä –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞",
      modal_timer_desc_plain:"–ú–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –≤—Ä–µ–º—è –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ (–ø—É—Å—Ç–æ = –±–µ–∑ —Ç–∞–π–º–µ—Ä–∞/–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é).",
      modal_seconds_label:"–°–µ–∫—É–Ω–¥ –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å",
      modal_seconds_ph:"–Ω–∞–ø—Ä–∏–º–µ—Ä 20",
      modal_media_title:"–ú–µ–¥–∏–∞ (—Å—Å—ã–ª–∫–∏)",
      modal_media_desc_plain:"–í—Å—Ç–∞–≤—å—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É (URL) –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–ª–∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª.",
      modal_img_title:"–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É",
      modal_audio_title:"–°—Å—ã–ª–∫–∞ –Ω–∞ –∞—É–¥–∏–æ",
      modal_img_ph:"https://.../image.jpg",
      modal_audio_ph:"https://.../audio.mp3",
      modal_clear_img:"–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É",
      modal_clear_audio:"–£–¥–∞–ª–∏—Ç—å –∞—É–¥–∏–æ",
      modal_answers_title:"–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞",
      modal_answers_desc_plain:"–ú–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞. –û—Ç–º–µ—Ç—å –≤–µ—Ä–Ω—ã–π —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–æ–π.",
      modal_text_answers_title:"–í–µ—Ä–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–≤–≤–æ–¥)",
      modal_text_answers_desc_plain:"–ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –ª—é–±–æ–π.",
      modal_add_option:"–î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç",
      modal_preview:"–ü–æ–∫–∞–∑–∞—Ç—å –≤ –ø—Ä–µ–≤—å—é",
      modal_save:"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
      code_title:"–°—Å—ã–ª–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã",
      code_desc_plain:"–≠—Ç–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–≥—Ä—É. –ï—ë –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å –≤ Genially (—á–µ—Ä–µ–∑ iframe) –∏ –∫—É–¥–∞ —É–≥–æ–¥–Ω–æ.",
      code_link_label:"–°—Å—ã–ª–∫–∞",
      code_iframe_label:"iframe (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)",
      code_copy_link:"–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É",
      code_copy_iframe:"–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe",
      code_download:"–°–∫–∞—á–∞—Ç—å –∏–≥—Ä—É (HTML)",
      toast_copied:"–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ",
        modal_option_ph:"ÈÄâÈ°π",
        modal_answer_ph:"Á≠îÊ°à",
        game_title:"Áü•ËØÜ‰πãÂ°î",
        game_start_btn:"‚ñ∂ ÂºÄÂßã",
        game_next_btn:"‰∏ã‰∏ÄÊ≠• ‚Üí",
        game_rules:[
          "Á¨¨‰∏Ä‰∏™ÊñπÂùó‰ºöËá™Âä®‰∏ãËêΩ„ÄÇ",
          "‰πãÂêéÁÇπÂáª <b>‰∏ã‰∏ÄÊ≠•</b> ÂºÄÂßã‰∏ã‰∏Ä‰∏™ÊñπÂùó„ÄÇ",
          "ÂΩìÊñπÂùóÂÅúÊ≠¢Êó∂ ‚Äî ÂõûÁ≠îÈóÆÈ¢ò„ÄÇ",
          "<b>Ê≠£Á°Æ</b> ‚Üí ÊñπÂùóÂèòÊàêÊ•ºÂ±Ç (+100)„ÄÇ",
          "<b>ÈîôËØØ</b> ‚Üí ÊñπÂùóÁÉßÁÑ¶„ÄÅÁàÜÁÇ∏Âπ∂Ê∂àÂ§±„ÄÇ"
        ],
        game_hint:"Ê≠£Á°Æ ‚Üí ÊñπÂùóÂèòÊàêÊ•ºÂ±Ç (+100)„ÄÇÈîôËØØ ‚Üí ÁÉßÁÑ¶„ÄÅÁàÜÁÇ∏Âπ∂Ê∂àÂ§±„ÄÇ",
        modal_option_ph:"Option",
        modal_answer_ph:"Antwort",
        game_title:"Wissens-Turm",
        game_start_btn:"‚ñ∂ Start",
        game_next_btn:"Weiter ‚Üí",
        game_rules:[
          "Der erste Block f√§llt automatisch.",
          "Dann klicke <b>Weiter</b>, um den n√§chsten Block zu starten.",
          "Wenn der Block stoppt ‚Äî beantworte die Frage.",
          "<b>Richtig</b> ‚Üí der Block wird zur Etage (+100).",
          "<b>Falsch</b> ‚Üí der Block verkohlt, explodiert und verschwindet."
        ],
        game_hint:"Richtig ‚Üí der Block wird zur Etage (+100). Falsch ‚Üí verkohlt, explodiert und verschwindet.",
        modal_option_ph:"Option",
        modal_answer_ph:"Answer",
        game_title:"Knowledge Tower",
        game_start_btn:"‚ñ∂ Start",
        game_next_btn:"Next ‚Üí",
        game_rules:[
          "The first block falls automatically.",
          "Then click <b>Next</b> to launch the next block.",
          "When the block stops ‚Äî answer the question.",
          "<b>Correct</b> ‚Üí the block becomes a floor (+100).",
          "<b>Wrong</b> ‚Üí the block burns, explodes and disappears."
        ],
        game_hint:"Correct ‚Üí the block becomes a floor (+100). Wrong ‚Üí burns, explodes and disappears.",
        modal_option_ph:"–í–∞—Ä–∏–∞–Ω—Ç",
        modal_answer_ph:"–û—Ç–≤–µ—Ç",
        game_title:"–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π",
        game_start_btn:"‚ñ∂ –ù–∞—á–∞—Ç—å",
        game_next_btn:"–î–∞–ª–µ–µ ‚Üí",
        game_rules:[
          "–ü–µ—Ä–≤—ã–π –±–ª–æ–∫ –ø–∞–¥–∞–µ—Ç —Å–∞–º.",
          "–î–∞–ª—å—à–µ –Ω–∞–∂–∏–º–∞–π <b>–î–∞–ª–µ–µ</b>, —á—Ç–æ–±—ã –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫.",
          "–ö–æ–≥–¥–∞ –±–ª–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è ‚Äî –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å.",
          "<b>–í–µ—Ä–Ω–æ</b> ‚Üí –±–ª–æ–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —ç—Ç–∞–∂–æ–º (+100).",
          "<b>–ù–µ–≤–µ—Ä–Ω–æ</b> ‚Üí –±–ª–æ–∫ –æ–±—É–≥–ª–∏–≤–∞–µ—Ç—Å—è, –≤–∑—Ä—ã–≤–∞–µ—Ç—Å—è –∏ –∏—Å—á–µ–∑–∞–µ—Ç."
        ],
        game_hint:"–í–µ—Ä–Ω–æ ‚Üí –±–ª–æ–∫ –æ–ø—É—Å–∫–∞–µ—Ç—Å—è –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —ç—Ç–∞–∂–æ–º (+100). –ù–µ–≤–µ—Ä–Ω–æ ‚Üí –æ–±—É–≥–ª–∏–≤–∞–Ω–∏–µ, –≤–∑—Ä—ã–≤ –∏ –∏—Å—á–µ–∑–∞–µ—Ç.",
    },
    en: {
      editor_title:"Tower Editor",
      btn_copy_iframe:"üìã Copy iframe code",
      sec_title:"Title",
      label_game_title:"Game title",
      ui_lang_title:"Interface language",
      ui_lang_label:"Choose language",
      ui_feedback_title:"Final feedback",
      ui_feedback_label:"Text on final screen (use {{score}} or _________)",
      ui_bgurl_title:"Background by link",
      ui_bgurl_label:"Image URL (if set ‚Äî used instead of file)",
      ui_bgurl_hint:"Tip: faster for Genially than uploading a file.",
      sec_style:"Style",
      label_bg:"Choose background file",
      btn_reset_bg:"‚Ü© Reset background",
      use_latex:"Enable LaTeX",
      sec_questions:"Questions",
      btn_add:"Add",
      btn_clear:"Clear",
      toast_iframe_ok:"iframe copied ‚úÖ",
      toast_iframe_fail:"Copy failed",
      toast_bg_loaded:"Background loaded",
      modal_add_q:"Add question",
      modal_edit_q:"Edit question",
      modal_close:"Close",
      modal_q_type:"Question type",
      modal_type_choice:"Multiple choice",
      modal_type_text:"Text input",
      modal_question:"Question",
      modal_question_ph:"Type your question‚Ä¶",
      modal_timer_title:"Timer for this question",
      modal_timer_desc_plain:"You can set time for this question (empty = no timer / default).",
      modal_seconds_label:"Seconds for this question",
      modal_seconds_ph:"e.g. 20",
      modal_media_title:"Media (links)",
      modal_media_desc_plain:"Paste direct URL to an image or an audio file.",
      modal_img_title:"Image link",
      modal_audio_title:"Audio link",
      modal_img_ph:"https://.../image.jpg",
      modal_audio_ph:"https://.../audio.mp3",
      modal_clear_img:"Remove image",
      modal_clear_audio:"Remove audio",
      modal_answers_title:"Answer options",
      modal_answers_desc_plain:"Minimum 2 options. Mark the correct one with the radio button.",
      modal_text_answers_title:"Correct answers (text)",
      modal_text_answers_desc_plain:"You can add several variants ‚Äî any of them will be accepted.",
      modal_add_option:"Add option",
      modal_preview:"Show in preview",
      modal_save:"Save",
      code_title:"Game launch link",
      code_desc_plain:"This is the game link. You can embed it in Genially (via iframe) and anywhere else.",
      code_link_label:"Link",
      code_iframe_label:"iframe (if needed)",
      code_copy_link:"Copy link",
      code_copy_iframe:"Copy iframe",
      code_download:"Download game (HTML)",
      toast_copied:"Copied",
    },
    de: {
      editor_title:"Turm-Editor",
      btn_copy_iframe:"üìã Iframe-Code –∫–æ–øieren",
      sec_title:"Titel",
      label_game_title:"Spieltitel",
      ui_lang_title:"Sprache",
      ui_lang_label:"Sprache w√§hlen",
      ui_feedback_title:"Feedback am Ende",
      ui_feedback_label:"Text im Endbildschirm ({{score}} oder _________)",
      ui_bgurl_title:"Hintergrund per Link",
      ui_bgurl_label:"Bild-URL (wenn gesetzt ‚Äî statt Datei)",
      ui_bgurl_hint:"Tipp: –±—ã—Å—Ç—Ä–µ–µ f√ºr Genially als Upload.",
      sec_style:"Design",
      label_bg:"Hintergrunddatei w√§hlen",
      btn_reset_bg:"‚Ü© Hintergrund zur√ºcksetzen",
      use_latex:"LaTeX aktivieren",
      sec_questions:"Fragen",
      btn_add:"Hinzuf√ºgen",
      btn_clear:"Leeren",
      toast_iframe_ok:"iframe kopiert ‚úÖ",
      toast_iframe_fail:"Kopieren fehlgeschlagen",
      toast_bg_loaded:"Hintergrund geladen",
      modal_add_q:"Frage hinzuf√ºgen",
      modal_edit_q:"Frage bearbeiten",
      modal_close:"Schlie√üen",
      modal_q_type:"Fragetyp",
      modal_type_choice:"Multiple Choice",
      modal_type_text:"Texteingabe",
      modal_question:"Frage",
      modal_question_ph:"Gib deine Frage ein‚Ä¶",
      modal_timer_title:"Timer f√ºr diese Frage",
      modal_timer_desc_plain:"Du kannst die Zeit f√ºr diese Frage setzen (leer = kein Timer / Standard).",
      modal_seconds_label:"Sekunden f√ºr diese Frage",
      modal_seconds_ph:"z.B. 20",
      modal_media_title:"Medien (Links)",
      modal_media_desc_plain:"F√ºge eine direkte URL zu einem Bild oder einer Audiodatei ein.",
      modal_img_title:"Bild-Link",
      modal_audio_title:"Audio-Link",
      modal_img_ph:"https://.../bild.jpg",
      modal_audio_ph:"https://.../audio.mp3",
      modal_clear_img:"Bild entfernen",
      modal_clear_audio:"Audio entfernen",
      modal_answers_title:"Antwortoptionen",
      modal_answers_desc_plain:"Mindestens 2 Optionen. Markiere die richtige mit dem Radiobutton.",
      modal_text_answers_title:"Richtige Antworten (Text)",
      modal_text_answers_desc_plain:"Du kannst mehrere Varianten hinzuf√ºgen ‚Äî jede wird akzeptiert.",
      modal_add_option:"Option hinzuf√ºgen",
      modal_preview:"In Vorschau zeigen",
      modal_save:"Speichern",
      code_title:"Spiel-Link",
      code_desc_plain:"Das ist der Spiel-Link. Du kannst ihn in Genially (per iframe) und √ºberall einbetten.",
      code_link_label:"Link",
      code_iframe_label:"iframe (optional)",
      code_copy_link:"Link kopieren",
      code_copy_iframe:"iframe kopieren",
      code_download:"Spiel herunterladen (HTML)",
      toast_copied:"Kopiert",
    },
    zh: {
      editor_title:"Â°îÊ•ºÁºñËæëÂô®",
      btn_copy_iframe:"üìã Â§çÂà∂ iframe ‰ª£Á†Å",
      sec_title:"Ê†áÈ¢ò",
      label_game_title:"Ê∏∏ÊàèÊ†áÈ¢ò",
      ui_lang_title:"ÁïåÈù¢ËØ≠Ë®Ä",
      ui_lang_label:"ÈÄâÊã©ËØ≠Ë®Ä",
      ui_feedback_title:"ÁªìÂ∞æÂèçÈ¶à",
      ui_feedback_label:"ÁªìÂ∞æÊñáÂ≠óÔºà‰ΩøÁî® {{score}} Êàñ _________Ôºâ",
      ui_bgurl_title:"ËÉåÊôØÈìæÊé•",
      ui_bgurl_label:"ÂõæÁâá URLÔºàÂ°´ÂÜôÂàô‰ºòÂÖà‰ΩøÁî®Ôºâ",
      ui_bgurl_hint:"ÊèêÁ§∫ÔºöÊØî‰∏ä‰º†Êñá‰ª∂Êõ¥ÈÄÇÂêà Genially„ÄÇ",
      sec_style:"Ê†∑Âºè",
      label_bg:"ÈÄâÊã©ËÉåÊôØÊñá‰ª∂",
      btn_reset_bg:"‚Ü© ÈáçÁΩÆËÉåÊôØ",
      use_latex:"ÂêØÁî® LaTeX",
      sec_questions:"È¢òÁõÆ",
      btn_add:"Ê∑ªÂä†",
      btn_clear:"Ê∏ÖÁ©∫",
      toast_iframe_ok:"Â∑≤Â§çÂà∂ ‚úÖ",
      toast_iframe_fail:"Â§çÂà∂Â§±Ë¥•",
      toast_bg_loaded:"ËÉåÊôØÂ∑≤Âä†ËΩΩ",
      modal_add_q:"Ê∑ªÂä†È¢òÁõÆ",
      modal_edit_q:"ÁºñËæëÈ¢òÁõÆ",
      modal_close:"ÂÖ≥Èó≠",
      modal_q_type:"È¢òÁõÆÁ±ªÂûã",
      modal_type_choice:"ÈÄâÊã©È¢ò",
      modal_type_text:"ËæìÂÖ•È¢ò",
      modal_question:"È¢òÁõÆ",
      modal_question_ph:"ËØ∑ËæìÂÖ•È¢òÁõÆ‚Ä¶",
      modal_timer_title:"Êú¨È¢òËÆ°Êó∂Âô®",
      modal_timer_desc_plain:"ÂèØ‰∏∫Êú¨È¢òËÆæÁΩÆÊó∂Èó¥ÔºàÁïôÁ©∫ = Êó†ËÆ°Êó∂/ÈªòËÆ§Ôºâ„ÄÇ",
      modal_seconds_label:"Êú¨È¢òÁßíÊï∞",
      modal_seconds_ph:"‰æãÂ¶Ç 20",
      modal_media_title:"Â™í‰ΩìÔºàÈìæÊé•Ôºâ",
      modal_media_desc_plain:"Á≤òË¥¥ÂõæÁâáÊàñÈü≥È¢ëÊñá‰ª∂ÁöÑÁõ¥Êé•ÈìæÊé•ÔºàURLÔºâ„ÄÇ",
      modal_img_title:"ÂõæÁâáÈìæÊé•",
      modal_audio_title:"Èü≥È¢ëÈìæÊé•",
      modal_img_ph:"https://.../image.jpg",
      modal_audio_ph:"https://.../audio.mp3",
      modal_clear_img:"Âà†Èô§ÂõæÁâá",
      modal_clear_audio:"Âà†Èô§Èü≥È¢ë",
      modal_answers_title:"Á≠îÊ°àÈÄâÈ°π",
      modal_answers_desc_plain:"Ëá≥Â∞ë 2 ‰∏™ÈÄâÈ°πÔºåÁî®ÂçïÈÄâÊåâÈíÆÊ†áËÆ∞Ê≠£Á°ÆÁ≠îÊ°à„ÄÇ",
      modal_text_answers_title:"Ê≠£Á°ÆÁ≠îÊ°àÔºàËæìÂÖ•Ôºâ",
      modal_text_answers_desc_plain:"ÂèØÊ∑ªÂä†Â§ö‰∏™Á≠îÊ°àÔºå‰ªªÊÑè‰∏Ä‰∏™ÈÉΩÁÆóÊ≠£Á°Æ„ÄÇ",
      modal_add_option:"Ê∑ªÂä†ÈÄâÈ°π",
      modal_preview:"Âú®È¢ÑËßà‰∏≠ÊòæÁ§∫",
      modal_save:"‰øùÂ≠ò",
      code_title:"Ê∏∏ÊàèÈìæÊé•",
      code_desc_plain:"ËøôÊòØÊ∏∏ÊàèÈìæÊé•„ÄÇÂèØÂú® GeniallyÔºàiframeÔºâÊàñÂÖ∂‰ªñÂú∞ÊñπÂµåÂÖ•„ÄÇ",
      code_link_label:"ÈìæÊé•",
      code_iframe_label:"iframeÔºàÂèØÈÄâÔºâ",
      code_copy_link:"Â§çÂà∂ÈìæÊé•",
      code_copy_iframe:"Â§çÂà∂ iframe",
      code_download:"‰∏ãËΩΩÊ∏∏Êàè (HTML)",
      toast_copied:"Â∑≤Â§çÂà∂",
    }
  };

  // --- Hard override for translations (prevents mixed languages) ---
  (function patchI18N(){
    const P = {
      ru:{
        app_title:"–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ë–∞—à–Ω—è¬ª",
        ui_title_label:"–ù–∞–∑–≤–∞–Ω–∏–µ",
        ui_title_hint:"–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∏–≥—Ä–µ",
        ui_lang_label:"–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞",
        ui_lang_hint:"–í—ã–±—Ä–∞—Ç—å —è–∑—ã–∫",
        sec_questions_title:"–í–æ–ø—Ä–æ—Å—ã",
        btn_add:"–î–æ–±–∞–≤–∏—Ç—å",
        btn_clear:"–û—á–∏—Å—Ç–∏—Ç—å",
        qs_help:"–°—Ç—Ä–æ–≥–æ <b>9 –≤–æ–ø—Ä–æ—Å–æ–≤</b>. –ú–æ–∂–Ω–æ: <b>–≤—ã–±–æ—Ä</b> –∏–ª–∏ <b>–≤–≤–æ–¥</b> (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤).",
        qs_empty:"–ü–æ–∫–∞ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤. –ù–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ 9 –≤–æ–ø—Ä–æ—Å–æ–≤.",
        sec_feedback:"–§–∏–¥–±–µ–∫ –≤ –∫–æ–Ω—Ü–µ",
        ui_feedback_ph:"–ú–æ–ª–æ–¥–µ—Ü! –¢–æ–±–æ–π –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ _________ –±–∞–ª–ª–æ–≤",
        sec_export:"–≠–∫—Å–ø–æ—Ä—Ç –≤ Genially",
        export_hint:"–ù–∞–∂–º–∏ ¬´üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe¬ª ‚Äî –≤ –±—É—Ñ–µ—Ä–µ –±—É–¥–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–¥ –≤–∏–¥–∞:",
        toast_copied:"–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ",

        modal_add_q:"–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å",
        modal_edit_q:"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å",
        modal_close:"–ó–∞–∫—Ä—ã—Ç—å",
        modal_q_type:"–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞",
        modal_type_choice:"–° –≤—ã–±–æ—Ä–æ–º –æ—Ç–≤–µ—Ç–∞",
        modal_type_text:"–° –≤–≤–æ–¥–æ–º –æ—Ç–≤–µ—Ç–∞",
        modal_question:"–í–æ–ø—Ä–æ—Å",
        modal_question_ph:"–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å‚Ä¶",
        modal_timer_title:"–¢–∞–π–º–µ—Ä –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞",
        modal_timer_desc_plain:"–ú–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –≤—Ä–µ–º—è –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ (–ø—É—Å—Ç–æ = –±–µ–∑ —Ç–∞–π–º–µ—Ä–∞/–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é).",
        modal_seconds_label:"–°–µ–∫—É–Ω–¥ –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å",
        modal_seconds_ph:"–Ω–∞–ø—Ä–∏–º–µ—Ä 20",
        modal_media_title:"–ú–µ–¥–∏–∞ (—Å—Å—ã–ª–∫–∏)",
        modal_media_desc_plain:"–í—Å—Ç–∞–≤—å—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É (URL) –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–ª–∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª.",
        modal_img_title:"–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É",
        modal_audio_title:"–°—Å—ã–ª–∫–∞ –Ω–∞ –∞—É–¥–∏–æ",
        modal_img_ph:"https://.../image.jpg",
        modal_audio_ph:"https://.../audio.mp3",
        modal_clear_img:"–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É",
        modal_clear_audio:"–£–¥–∞–ª–∏—Ç—å –∞—É–¥–∏–æ",
        modal_answers_title:"–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞",
        modal_answers_desc_plain:"–ú–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞. –û—Ç–º–µ—Ç—å –≤–µ—Ä–Ω—ã–π —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–æ–π.",
        modal_text_answers_title:"–í–µ—Ä–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–≤–≤–æ–¥)",
        modal_text_answers_desc_plain:"–ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –ª—é–±–æ–π.",
        modal_add_option:"–î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç",
        modal_preview:"–ü–æ–∫–∞–∑–∞—Ç—å –≤ –ø—Ä–µ–≤—å—é",
        modal_save:"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
        code_title:"–°—Å—ã–ª–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã",
        code_desc_plain:"–≠—Ç–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–≥—Ä—É. –ï—ë –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å –≤ Genially (—á–µ—Ä–µ–∑ iframe) –∏ –∫—É–¥–∞ —É–≥–æ–¥–Ω–æ.",
        code_link_label:"–°—Å—ã–ª–∫–∞",
        code_iframe_label:"iframe (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)",
        code_copy_link:"–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É",
        code_copy_iframe:"–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe",
        code_download:"–°–∫–∞—á–∞—Ç—å –∏–≥—Ä—É (HTML)"
      },
      en:{
        app_title:"Tower Editor",
        ui_title_label:"Title",
        ui_title_hint:"Game title",
        ui_lang_label:"Interface language",
        ui_lang_hint:"Choose language",
        sec_questions_title:"Questions",
        btn_add:"Add",
        btn_clear:"Clear",
        qs_help:"Exactly <b>9 questions</b>. Types: <b>choice</b> or <b>input</b> (multiple correct answers allowed).",
        qs_empty:"No questions yet. Click ‚ÄúAdd‚Äù and fill in 9 questions.",
        sec_feedback:"Final feedback",
        ui_feedback_ph:"Well done! You scored _________ points.",
        sec_export:"Export to Genially",
        export_hint:"Click ‚Äúüìã Copy iframe‚Äù ‚Äî you will get a short code like:",
        toast_copied:"Copied",

        modal_add_q:"Add question",
        modal_edit_q:"Edit question",
        modal_close:"Close",
        modal_q_type:"Question type",
        modal_type_choice:"Multiple choice",
        modal_type_text:"Text input",
        modal_question:"Question",
        modal_question_ph:"Type your question‚Ä¶",
        modal_timer_title:"Timer for this question",
        modal_timer_desc_plain:"You can set time for this question (empty = no timer / default).",
        modal_seconds_label:"Seconds for this question",
        modal_seconds_ph:"e.g. 20",
        modal_media_title:"Media (links)",
        modal_media_desc_plain:"Paste direct URL to an image or an audio file.",
        modal_img_title:"Image link",
        modal_audio_title:"Audio link",
        modal_img_ph:"https://.../image.jpg",
        modal_audio_ph:"https://.../audio.mp3",
        modal_clear_img:"Remove image",
        modal_clear_audio:"Remove audio",
        modal_answers_title:"Answer options",
        modal_answers_desc_plain:"Minimum 2 options. Mark the correct one with the radio button.",
        modal_text_answers_title:"Correct answers (text)",
        modal_text_answers_desc_plain:"You can add several variants ‚Äî any of them will be accepted.",
        modal_add_option:"Add option",
        modal_preview:"Show in preview",
        modal_save:"Save",
        code_title:"Game launch link",
        code_desc_plain:"This is the game link. You can embed it in Genially (via iframe) and anywhere else.",
        code_link_label:"Link",
        code_iframe_label:"iframe (if needed)",
        code_copy_link:"Copy link",
        code_copy_iframe:"Copy iframe",
        code_download:"Download game (HTML)"
      },
      de:{
        app_title:"Tower Editor",
        ui_title_label:"Titel",
        ui_title_hint:"Spieltitel",
        ui_lang_label:"Sprache",
        ui_lang_hint:"Sprache w√§hlen",
        sec_questions_title:"Fragen",
        btn_add:"Hinzuf√ºgen",
        btn_clear:"Leeren",
        qs_help:"Genau <b>9 Fragen</b>. Typen: <b>Auswahl</b> oder <b>Eingabe</b> (mehrere richtige Antworten m√∂glich).",
        qs_empty:"Noch keine Fragen. Klicke auf ‚ÄûHinzuf√ºgen‚Äú und f√ºlle 9 Fragen aus.",
        sec_feedback:"Abschlussfeedback",
        ui_feedback_ph:"Super! Du hast _________ Punkte erzielt.",
        sec_export:"Export nach Genially",
        export_hint:"Klicke ‚Äûüìã Copy iframe‚Äú ‚Äî du erh√§ltst einen kurzen Code wie:",
        toast_copied:"Kopiert",
        modal_add_q:"Frage hinzuf√ºgen",
        modal_edit_q:"Frage bearbeiten",
        modal_close:"Schlie√üen",
        modal_q_type:"Fragetyp",
        modal_type_choice:"Multiple Choice",
        modal_type_text:"Texteingabe",
        modal_question:"Frage",
        modal_question_ph:"Gib deine Frage ein‚Ä¶",
        modal_timer_title:"Timer f√ºr diese Frage",
        modal_timer_desc_plain:"Du kannst die Zeit f√ºr diese Frage setzen (leer = kein Timer / Standard).",
        modal_seconds_label:"Sekunden f√ºr diese Frage",
        modal_seconds_ph:"z.B. 20",
        modal_media_title:"Medien (Links)",
        modal_media_desc_plain:"F√ºge eine direkte URL zu einem Bild oder einer Audiodatei ein.",
        modal_img_title:"Bild-Link",
        modal_audio_title:"Audio-Link",
        modal_img_ph:"https://.../bild.jpg",
        modal_audio_ph:"https://.../audio.mp3",
        modal_clear_img:"Bild entfernen",
        modal_clear_audio:"Audio entfernen",
        modal_answers_title:"Antwortoptionen",
        modal_answers_desc_plain:"Mindestens 2 Optionen. Markiere die richtige mit dem Radiobutton.",
        modal_text_answers_title:"Richtige Antworten (Text)",
        modal_text_answers_desc_plain:"Du kannst mehrere Varianten hinzuf√ºgen ‚Äî jede wird akzeptiert.",
        modal_add_option:"Option hinzuf√ºgen",
        modal_preview:"In Vorschau zeigen",
        modal_save:"Speichern",
        code_title:"Spiel-Link",
        code_desc_plain:"Das ist der Spiel-Link. Du kannst ihn in Genially (per iframe) und √ºberall einbetten.",
        code_link_label:"Link",
        code_iframe_label:"iframe (optional)",
        code_copy_link:"Link kopieren",
        code_copy_iframe:"iframe kopieren",
        code_download:"Spiel herunterladen (HTML)"
      },
      zh:{
        app_title:"Â°îÁºñËæëÂô®",
        ui_title_label:"Ê†áÈ¢ò",
        ui_title_hint:"Ê∏∏ÊàèÊ†áÈ¢ò",
        ui_lang_label:"ÁïåÈù¢ËØ≠Ë®Ä",
        ui_lang_hint:"ÈÄâÊã©ËØ≠Ë®Ä",
        sec_questions_title:"È¢òÁõÆ",
        btn_add:"Ê∑ªÂä†",
        btn_clear:"Ê∏ÖÁ©∫",
        qs_help:"ÂøÖÈ°ª <b>9 ÈÅìÈ¢ò</b>„ÄÇÁ±ªÂûãÔºö<b>ÈÄâÊã©</b> Êàñ <b>ËæìÂÖ•</b>ÔºàÂÖÅËÆ∏Â§ö‰∏™Ê≠£Á°ÆÁ≠îÊ°àÔºâ„ÄÇ",
        qs_empty:"ËøòÊ≤°ÊúâÈ¢òÁõÆ„ÄÇÁÇπÂáª‚ÄúÊ∑ªÂä†‚ÄùÂπ∂Â°´ÂÜô 9 ÈÅìÈ¢ò„ÄÇ",
        sec_feedback:"ÁªìÂ∞æÂèçÈ¶à",
        ui_feedback_ph:"ÂÅöÂæóÂ•ΩÔºÅ‰Ω†Ëé∑Âæó‰∫Ü _________ ÂàÜ„ÄÇ",
        sec_export:"ÂØºÂá∫Âà∞ Genially",
        export_hint:"ÁÇπÂáª‚Äúüìã Copy iframe‚Äù ‚Äî ‰Ω†‰ºöÂæóÂà∞Á±ª‰ººËøôÊ†∑ÁöÑÁü≠‰ª£Á†ÅÔºö",
        toast_copied:"Â∑≤Â§çÂà∂",
        modal_add_q:"Ê∑ªÂä†È¢òÁõÆ",
        modal_edit_q:"ÁºñËæëÈ¢òÁõÆ",
        modal_close:"ÂÖ≥Èó≠",
        modal_q_type:"È¢òÁõÆÁ±ªÂûã",
        modal_type_choice:"ÈÄâÊã©È¢ò",
        modal_type_text:"ËæìÂÖ•È¢ò",
        modal_question:"È¢òÁõÆ",
        modal_question_ph:"ËØ∑ËæìÂÖ•È¢òÁõÆ‚Ä¶",
        modal_timer_title:"Êú¨È¢òËÆ°Êó∂Âô®",
        modal_timer_desc_plain:"ÂèØ‰∏∫Êú¨È¢òËÆæÁΩÆÊó∂Èó¥ÔºàÁïôÁ©∫ = Êó†ËÆ°Êó∂/ÈªòËÆ§Ôºâ„ÄÇ",
        modal_seconds_label:"Êú¨È¢òÁßíÊï∞",
        modal_seconds_ph:"‰æãÂ¶Ç 20",
        modal_media_title:"Â™í‰ΩìÔºàÈìæÊé•Ôºâ",
        modal_media_desc_plain:"Á≤òË¥¥ÂõæÁâáÊàñÈü≥È¢ëÊñá‰ª∂ÁöÑÁõ¥Êé•ÈìæÊé•ÔºàURLÔºâ„ÄÇ",
        modal_img_title:"ÂõæÁâáÈìæÊé•",
        modal_audio_title:"Èü≥È¢ëÈìæÊé•",
        modal_img_ph:"https://.../image.jpg",
        modal_audio_ph:"https://.../audio.mp3",
        modal_clear_img:"Âà†Èô§ÂõæÁâá",
        modal_clear_audio:"Âà†Èô§Èü≥È¢ë",
        modal_answers_title:"Á≠îÊ°àÈÄâÈ°π",
        modal_answers_desc_plain:"Ëá≥Â∞ë 2 ‰∏™ÈÄâÈ°πÔºåÁî®ÂçïÈÄâÊåâÈíÆÊ†áËÆ∞Ê≠£Á°ÆÁ≠îÊ°à„ÄÇ",
        modal_text_answers_title:"Ê≠£Á°ÆÁ≠îÊ°àÔºàËæìÂÖ•Ôºâ",
        modal_text_answers_desc_plain:"ÂèØÊ∑ªÂä†Â§ö‰∏™Á≠îÊ°àÔºå‰ªªÊÑè‰∏Ä‰∏™ÈÉΩÁÆóÊ≠£Á°Æ„ÄÇ",
        modal_add_option:"Ê∑ªÂä†ÈÄâÈ°π",
        modal_preview:"Âú®È¢ÑËßà‰∏≠ÊòæÁ§∫",
        modal_save:"‰øùÂ≠ò",
        code_title:"Ê∏∏ÊàèÈìæÊé•",
        code_desc_plain:"ËøôÊòØÊ∏∏ÊàèÈìæÊé•„ÄÇÂèØÂú® GeniallyÔºàiframeÔºâÊàñÂÖ∂‰ªñÂú∞ÊñπÂµåÂÖ•„ÄÇ",
        code_link_label:"ÈìæÊé•",
        code_iframe_label:"iframeÔºàÂèØÈÄâÔºâ",
        code_copy_link:"Â§çÂà∂ÈìæÊé•",
        code_copy_iframe:"Â§çÂà∂ iframe",
        code_download:"‰∏ãËΩΩÊ∏∏Êàè (HTML)"
      }
    };
    ["ru","en","de","zh"].forEach(l=>{
      if(!I18N[l]) I18N[l]={};
      Object.assign(I18N[l], P[l]);
    });
  })();


  function t(key){
    const lang = Editor.lang || "ru";
    return (I18N[lang] && I18N[lang][key]) ? I18N[lang][key] : (I18N.ru[key] || key);
  }
  function applyLangEditor(){
    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const k = el.getAttribute("data-i18n");
      if(!k) return;
      const val = t(k);
      if(val==null) return;
      const s = String(val);
      // if translation contains markup (<b>, <br>, etc.) keep it
      if(s.includes("<") && s.includes(">")) el.innerHTML = s;
      else el.textContent = s;
    });
    document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
      const k = el.getAttribute("data-i18n-placeholder");
      if(!k) return;
      const val = t(k);
      if(val==null) return;
      el.setAttribute("placeholder", String(val));
    });
    try{ applyLangModals(); }catch(e){}
  }

  function applyLangModals(){
    const roots = [document.getElementById("modalBackdrop"), document.getElementById("codeBackdrop")].filter(Boolean);
    for(const root of roots){
      root.querySelectorAll("[data-i18n]").forEach(el=>{
        const k = el.getAttribute("data-i18n");
        const val = t(k);
        // allow small HTML (<b>, etc.)
        el.innerHTML = val;
      
    // dynamic placeholders inside modal (options / answers)
    try{
      const optInputs = document.querySelectorAll("#modalBackdrop .optText, #modalBackdrop input[data-role='optText']");
      optInputs.forEach((inp,i)=>{ if(inp && inp.tagName==="INPUT") inp.placeholder = `${t("modal_option_ph")} ${i+1}`; });
      const ansInputs = document.querySelectorAll("#modalBackdrop .ansText, #modalBackdrop input[data-role='ansText']");
      ansInputs.forEach((inp,i)=>{ if(inp && inp.tagName==="INPUT") inp.placeholder = `${t("modal_answer_ph")} ${i+1}`; });
    }catch(e){}
});
      root.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
        const k = el.getAttribute("data-i18n-placeholder");
        const val = t(k);
        if("placeholder" in el) el.placeholder = val;
      });
    }

    const modal = document.querySelector("#modalBackdrop .modal-body");
    if(modal){
      const labels = modal.querySelectorAll("label");
      if(labels[0]) labels[0].textContent = t("modal_q_type");
      if(labels[1]) labels[1].textContent = t("modal_question");
      if(labels[2]) labels[2].textContent = t("modal_seconds_label");
    }
    if($("inpPrompt")) $("inpPrompt").setAttribute("placeholder", t("modal_question_ph"));
    if($("inpQSeconds")) $("inpQSeconds").setAttribute("placeholder", t("modal_seconds_ph"));

    const heads = document.querySelectorAll("#modalBackdrop .choiceBlock > div:first-child");
    if(heads[0]) heads[0].textContent = t("modal_timer_title");
    if(heads[1]) heads[1].textContent = t("modal_media_title");
    if(heads[2]) heads[2].textContent = t("modal_answers_title");
    if(heads[3]) heads[3].textContent = t("modal_text_answers_title");

    const muteds = document.querySelectorAll("#modalBackdrop .choiceBlock .muted");
    if(muteds[0]) muteds[0].textContent = t("modal_timer_desc_plain");
    if(muteds[1]) muteds[1].textContent = t("modal_media_desc_plain");
    if(muteds[2]) muteds[2].textContent = t("modal_answers_desc_plain");
    if(muteds[3]) muteds[3].textContent = t("modal_text_answers_desc_plain");

    if($("inpQImage")) $("inpQImage").setAttribute("placeholder", t("modal_img_ph"));
    if($("inpQAudio")) $("inpQAudio").setAttribute("placeholder", t("modal_audio_ph"));

    document.querySelectorAll('#modalBackdrop .answerRow span').forEach(sp=>{
      const t0 = sp.getAttribute("title")||"";
      if(t0.includes("–∫–∞—Ä—Ç–∏–Ω") || t0.toLowerCase().includes("image")) sp.setAttribute("title", t("modal_img_title"));
      if(t0.includes("–∞—É–¥–∏–æ") || t0.toLowerCase().includes("audio")) sp.setAttribute("title", t("modal_audio_title"));
    });
    if($("btnClearImage")) $("btnClearImage").setAttribute("title", t("modal_clear_img"));
    if($("btnClearAudio")) $("btnClearAudio").setAttribute("title", t("modal_clear_audio"));

    if($("btnAddChoice")) $("btnAddChoice").textContent = "‚ûï " + t("modal_add_option");
    if($("btnAddText")) $("btnAddText").textContent = "‚ûï " + t("modal_add_option");

    if($("btnPreviewDraft")) $("btnPreviewDraft").textContent = "üëÅ " + t("modal_preview");
    if($("btnSaveQ")) $("btnSaveQ").textContent = "üíæ " + t("modal_save");

    if($("codeTitle")) $("codeTitle").textContent = t("code_title");
    if($("btnCloseCode")) $("btnCloseCode").textContent = t("modal_close");

    const codeMuted = document.querySelector("#codeBackdrop .modal-body .muted");
    if(codeMuted) codeMuted.textContent = t("code_desc_plain");

    const codeLabels = document.querySelectorAll("#codeBackdrop .modal-body label");
    if(codeLabels[0]) codeLabels[0].textContent = t("code_link_label");
    if(codeLabels[1]) codeLabels[1].textContent = t("code_iframe_label");

    if($("btnCopyFromModal")) $("btnCopyFromModal").textContent = "üìã " + t("code_copy_link");
    if($("btnCopyIframe")) $("btnCopyIframe").textContent = "üìé " + t("code_copy_iframe");
    if($("btnDownloadGame")) $("btnDownloadGame").textContent = "‚¨á " + t("code_download");

    if($("toast")) $("toast").textContent = t("toast_copied");
  }

  function applyLangSelectLabels(){
    const sel = $("selLang"); if(!sel) return;
    const map = {
      ru: {ru:"–†—É—Å—Å–∫–∏–π", en:"English", de:"Deutsch", zh:"‰∏≠Êñá"},
      en: {ru:"Russian", en:"English", de:"German", zh:"Chinese"},
      de: {ru:"Russisch", en:"Englisch", de:"Deutsch", zh:"Chinesisch"},
      zh: {ru:"‰øÑËØ≠", en:"Ëã±ËØ≠", de:"Âæ∑ËØ≠", zh:"‰∏≠Êñá"}
    };
    const lang = Editor.lang || "ru";
    Array.from(sel.options).forEach(opt=>{
      const v = opt.value;
      if(map[lang] && map[lang][v]) opt.textContent = map[lang][v];
    });
  }

  // call after applying labels
  try{ applyLangSelectLabels(); }catch(e){}

  if($("selLang")){
    $("selLang").addEventListener("change", ()=>{
      Editor.lang = $("selLang").value;
      applyLangEditor();
      try{ applyLangSelectLabels(); }catch(e){}
      try{ applyLangModals(); }catch(e){}
      updatePreview(false);
    });
  }


  if($("chkUseImages")) $("chkUseImages").addEventListener("change", ()=>{ Editor.useImages = true; $("chkUseImages").checked = true; updatePreview(false); });
  if($("chkUseLatex")) $("chkUseLatex").addEventListener("change", ()=>{ Editor.useLatex = $("chkUseLatex").checked; updatePreview(false); });
  if($("chkTimer")) $("chkTimer").addEventListener("change", ()=>{ Editor.timer.enabled = isChecked("chkTimer"); updatePreview(false); });
  if($("inpSeconds")) $("inpSeconds").addEventListener("input", ()=>{ Editor.timer.seconds = Number($("inpSeconds").value || 30); updatePreview(false); });
  $("btnAddQ").addEventListener("click", ()=>{ if(Editor.questions.length >= 9){ toast("–í–æ–ø—Ä–æ—Å–æ–≤ —É–∂–µ 9 üôÇ"); return; } openModal(null); });
  $("btnClearQs").addEventListener("click", ()=>{ Editor.questions = []; renderList(); updatePreview(false); toast("–û—á–∏—â–µ–Ω–æ"); });
  $("btnCloseModal").addEventListener("click", ()=>{ Editor.draft=null; Editor.editingId=null; hideModal(); });
  $("modalBackdrop").addEventListener("click", (e)=>{ if(e.target === $("modalBackdrop")){ Editor.draft=null; Editor.editingId=null; hideModal(); } });
  $("selType").addEventListener("change", ()=>{
    const q = Editor.draft; if(!q) return; q.type = $("selType").value; syncModalType();
    if(q.type === "choice"){ q.options = q.options || ["",""]; if(typeof q.correctIndex !== "number") q.correctIndex = 0; renderChoiceUI(); } 
    else { q.accepts = q.accepts || [""]; renderTextUI(); }
  });
  
  if($("btnClearImage")) $("btnClearImage").addEventListener("click", () => { $("inpQImage").value = ""; });
  if($("btnClearAudio")) $("btnClearAudio").addEventListener("click", () => { $("inpQAudio").value = ""; });
  
  $("btnAddChoice").addEventListener("click", ()=>{ const q = Editor.draft; if(!q) return; q.options = q.options || ["",""]; q.options.push(""); renderChoiceUI(); });
  $("btnAddText").addEventListener("click", ()=>{ const q = Editor.draft; if(!q) return; q.accepts = q.accepts || [""]; q.accepts.push(""); renderTextUI(); });

  $("btnPreviewDraft").addEventListener("click", ()=>{ getDraftFromModal(); updatePreview(true); toast("–ß–µ—Ä–Ω–æ–≤–∏–∫ –ø–æ–∫–∞–∑–∞–Ω –≤ –ø—Ä–µ–≤—å—é"); });
  $("btnSaveQ").addEventListener("click", ()=>{
    const q = getDraftFromModal(); const err = validateQuestion(q);
    if(err){ toast(err); return; }
    if(Editor.editingId){
      const idx = Editor.questions.findIndex(x=>x.id === Editor.editingId);
      if(idx >= 0){ q.id = Editor.editingId; Editor.questions[idx] = q; toast("–í–æ–ø—Ä–æ—Å –æ–±–Ω–æ–≤–ª—ë–Ω"); } 
      else { Editor.questions.push(q); toast("–í–æ–ø—Ä–æ—Å –¥–æ–±–∞–≤–ª–µ–Ω"); }
    } else { Editor.questions.push(q); toast("–í–æ–ø—Ä–æ—Å –¥–æ–±–∞–≤–ª–µ–Ω"); }
    Editor.draft=null; Editor.editingId=null; hideModal(); renderList(); updatePreview(false);
  });
  $("btnCopyCode").addEventListener("click", async ()=>{
    const payload = buildPayload(false); const url = buildGameUrl(payload); const iframeCode = buildIframeFromUrl(url);
    const ok = await copyToClipboard(iframeCode); toast(ok ? t("toast_iframe_ok") : t("toast_iframe_fail"));
  });

  function hideCodeModal(){
    if(!$("codeBackdrop")) return; $("codeBackdrop").style.display = "none"; $("codeBackdrop").setAttribute("aria-hidden","true");
  }
  if ($("btnCloseCode")) $("btnCloseCode").addEventListener("click", hideCodeModal);
  if ($("codeBackdrop")) { $("codeBackdrop").addEventListener("click", (e)=>{ if(e.target === $("codeBackdrop")) hideCodeModal(); }); }
  if ($("btnCopyFromModal")) {
    $("btnCopyFromModal").addEventListener("click", async ()=>{
      const text = ($("taIframe")?.value || "").trim(); if(!text){ toast("–ü—É—Å—Ç–æ"); return; }
      const ok = await copyToClipboard(text); toast(ok ? "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ" : "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
    });
    if ($("btnCopyIframe")) {
      $("btnCopyIframe").addEventListener("click", async ()=>{
        const text = ($("taIframe2")?.value || "").trim(); if(!text){ toast("–ü—É—Å—Ç–æ"); return; }
        const ok = await copyToClipboard(text); toast(ok ? t("toast_iframe_ok") : t("toast_iframe_fail"));
      });
    }
  }

  if ($("btnDownloadGame")) {
    $("btnDownloadGame").addEventListener("click", ()=>{
      try{
        const payload = buildPayload(true); const safeJson = JSON.stringify(payload).replace(/</g, "\\u003c");
        const embed = `<script>window.__EMBEDDED_CFG__=${safeJson};<\/script>\n`;
        const full = "<!doctype html>\n" + document.documentElement.outerHTML;
        const out = full.replace("<script>\n(() => {", embed + "<script>\n(() => {");
        const blob = new Blob([out], {type:"text/html;charset=utf-8"});
        const a = document.createElement("a"); const ts = new Date(); const pad = (n)=> String(n).padStart(2,"0");
        const name = `tower_game_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}.html`;
        a.href = URL.createObjectURL(blob); a.download = name; document.body.appendChild(a); a.click();
        setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0); toast("–ò–≥—Ä–∞ —Å–∫–∞—á–∞–Ω–∞ ‚úÖ");
      }catch(e){ showErr(e?.stack || e?.message || String(e)); toast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å üòï"); }
    });
  }

  function bootGameOnly(cfg){
    document.body.setAttribute("data-mode","game"); document.body.classList.add("gameOnly");
    $("editorRoot").style.display = "none"; $("modalBackdrop").style.display = "none";
    if($("codeBackdrop")) $("codeBackdrop").style.display = "none";
    $("gameRoot").style.display = "block";
    injectCanvasGame(cfg);
  }

  const qp = parseQueryParams(); const hp = parseHashParams();
  const gameParam = qp.game || hp.game; const cfgKeyParam = qp.cfgkey || hp.cfgkey;

  if (window.__EMBEDDED_CFG__) {
    try{ bootGameOnly(normalizeCfg(window.__EMBEDDED_CFG__)); }
    catch(e){ $("gameHost").innerHTML = `<div style="padding:16px;color:#ffd6d6;font-weight:900">–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ üòï</div>`; }
    return;
  }
  if(gameParam){
    try{ const raw = JSON.parse(b64urlDecode(gameParam)); bootGameOnly(normalizeCfg(raw)); }
    catch(e){ $("gameHost").innerHTML = `<div style="padding:16px;color:#ffd6d6;font-weight:900">–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ –∏–∑ iframe üòï</div>`; }
    return;
  }
  if(cfgKeyParam){
    try{
      const rawStr = localStorage.getItem(cfgKeyParam) || sessionStorage.getItem(cfgKeyParam);
      if(!rawStr) throw new Error("cfgkey not found in storage");
      const raw = JSON.parse(rawStr); bootGameOnly(normalizeCfg(raw));
    }catch(e){ $("gameHost").innerHTML = `<div style="padding:16px;color:#ffd6d6;font-weight:900">–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ (cfgkey) üòï</div>`; }
    return;
  }

  Editor.title = $("inpTitle").value || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π";
  Editor.timer.enabled = isChecked("chkTimer"); Editor.timer.seconds = Number($("inpSeconds").value || 30);
  Editor.useImages = true; if($("chkUseImages")) $("chkUseImages").checked = true;
  if($("chkUseLatex")) Editor.useLatex = $("chkUseLatex").checked;
  Editor.useRepoBg = true;

  renderList(); updatePreview(false);

  try{
    const titles = Array.from(document.querySelectorAll(".section .title"));
    const t = titles.find(x=>x.textContent.trim()==="–≠–∫—Å–ø–æ—Ä—Ç –≤ Genially");
    if(t){ const sec = t.closest(".section"); if(sec) sec.style.display="none"; }
  }catch(e){}

})();
</script>

  <div id="versionBadge">–í–µ—Ä—Å–∏—è 15</div>
</body>
</html>
