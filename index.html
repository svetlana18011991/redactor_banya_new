<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gold Tower Editor (Original Engine)</title>
<style>
  /* --- –¢–ï–ú–ê –†–ï–î–ê–ö–¢–û–†–ê: –ó–û–õ–û–¢–û –ù–ê –ß–ï–†–ù–û–ú --- */
  :root { --bg: #050505; --panel: #0f1219; --gold: #d4af37; --gold-glow: rgba(212, 175, 55, 0.3); --border: #333; --text: #e2e8f0; }
  body { margin:0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }
  ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: var(--panel); } ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

  /* EDITOR SIDE */
  .editor-col { width: 460px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; box-shadow: 10px 0 40px #000; }
  .header { padding: 20px; border-bottom: 1px solid var(--gold); display: flex; justify-content: space-between; align-items: center; background: #0f1219; }
  .logo { font-weight: 800; color: var(--gold); letter-spacing: 2px; font-size: 18px; text-transform: uppercase; text-shadow: 0 0 15px var(--gold-glow); }
  .scroll-wrap { flex: 1; overflow-y: auto; padding: 20px; }
  .section { margin-bottom: 25px; border: 1px solid #222; padding: 15px; border-radius: 8px; background: #0a0c10; }
  .sec-head { color: var(--gold); font-size: 11px; text-transform: uppercase; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }

  /* BUTTONS */
  button { cursor: pointer; border: none; font-weight: bold; transition: 0.2s; border-radius: 4px; font-family: inherit; }
  .btn-gold { background: linear-gradient(135deg, #b8860b, #d4af37); color: #000; padding: 8px 16px; font-size: 12px; text-transform: uppercase; box-shadow: 0 0 15px var(--gold-glow); }
  .btn-gold:hover { filter: brightness(1.2); }
  .btn-add { background: rgba(212, 175, 55, 0.1); border: 1px dashed var(--gold); color: var(--gold); width: 100%; padding: 12px; margin-top: 5px; }
  .btn-add:hover { background: var(--gold); color: #000; }
  .icon-btn { background: transparent; color: #666; font-size: 16px; padding: 5px; }
  .icon-btn:hover { color: #fff; }
  .icon-btn.del:hover { color: #ef4444; }

  /* UPLOAD */
  .upload-row { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 4px; border: 1px dashed #444; }
  .file-label { font-size: 11px; color: #aaa; cursor: pointer; display: flex; align-items: center; gap: 10px; width: 100%; }
  .file-label:hover { color: var(--gold); }
  
  /* LIST */
  .q-item { background: #151921; padding: 10px; border-radius: 4px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; border-left: 2px solid transparent; }
  .q-item:hover { border-left-color: var(--gold); background: #1a1d26; }
  .q-txt { font-size: 13px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 250px; }

  /* PREVIEW */
  .preview-col { flex: 1; background: #000; position: relative; display: flex; flex-direction: column; }
  .preview-bar { height: 30px; background: #111; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: center; color: #555; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; }
  iframe { flex: 1; border: none; width: 100%; background: #000; }

  /* MODAL */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 999; display: none; align-items: center; justify-content: center; }
  .modal { background: #0f1219; width: 550px; border: 1px solid var(--gold); border-radius: 8px; box-shadow: 0 0 50px var(--gold-glow); display: flex; flex-direction: column; max-height: 90vh; }
  .modal-head { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
  .modal-head h3 { margin: 0; color: var(--gold); font-size: 14px; text-transform: uppercase; }
  .modal-body { padding: 20px; overflow-y: auto; }
  .modal-foot { padding: 15px; border-top: 1px solid #333; text-align: right; }

  input, select, textarea { width: 100%; background: #050505; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 4px; box-sizing: border-box; font-size: 13px; margin-bottom: 10px; }
  input:focus, select:focus, textarea:focus { border-color: var(--gold); outline: none; }
  
  .opt-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; }
  .radio { width: 20px; height: 20px; accent-color: var(--gold); cursor: pointer; }
  
  .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--gold); color: #000; padding: 10px 30px; border-radius: 30px; font-weight: bold; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000; }
  .toast.show { opacity: 1; bottom: 50px; }
</style>
</head>
<body>

<div class="editor-col">
  <div class="header">
    <div class="logo">GOLD TOWER</div>
    <button class="btn-gold" onclick="generateCode()">–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î</button>
  </div>
  
  <div class="scroll-wrap">
    
    <div class="section">
      <div class="sec-head">–§–æ–Ω –ò–≥—Ä—ã</div>
      <div class="upload-row">
        <label class="file-label">
          <span style="font-size:20px">üñºÔ∏è</span>
          <div style="display:flex; flex-direction:column">
            <span id="bgStatus" style="color:#fff; font-weight:bold">–ó–ê–ì–†–£–ó–ò–¢–¨</span>
            <span style="font-size:9px; color:#666">–ò–ª–∏ –±—É–¥–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π</span>
          </div>
          <input type="file" accept="image/*" style="display:none" onchange="uploadBg(this)">
        </label>
        <button class="icon-btn" onclick="clearBg()" title="–°–±—Ä–æ—Å–∏—Ç—å">‚úï</button>
      </div>
    </div>

    <div class="section">
      <div class="sec-head">–í–æ–ø—Ä–æ—Å—ã (<span id="qCount">0</span>/9)</div>
      <div id="qList" class="q-list"></div>
      <button class="btn-add" onclick="openModal()">+ –î–û–ë–ê–í–ò–¢–¨ –í–û–ü–†–û–°</button>
      <button style="width:100%; background:transparent; color:#555; margin-top:5px; font-size:10px" onclick="resetQs()">–°–ë–†–û–°–ò–¢–¨ –í–°–Å</button>
    </div>

  </div>
</div>

<div class="preview-col">
  <div class="preview-bar">LIVE PREVIEW</div>
  <iframe id="previewFrame"></iframe>
</div>

<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-head">
      <h3>–†–µ–¥–∞–∫—Ç–æ—Ä –í–æ–ø—Ä–æ—Å–∞</h3>
      <button onclick="closeModal()" class="icon-btn">‚úï</button>
    </div>
    <div class="modal-body">
      <div style="display:flex; gap:15px">
        <div style="flex:1">
          <label style="font-size:10px; color:#888; text-transform:uppercase">–¢–∏–ø</label>
          <select id="mType" onchange="renderOpts()">
            <option value="choice">–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä</option>
            <option value="text">–í–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞</option>
          </select>
        </div>
        <div style="flex:1">
          <label style="font-size:10px; color:#888; text-transform:uppercase">–¢–∞–π–º–µ—Ä (—Å–µ–∫)</label>
          <div style="display:flex; align-items:center; gap:5px">
            <input type="checkbox" id="mTimerOn" onchange="toggleTimer()" style="width:20px; height:20px; margin:0; accent-color:var(--gold)">
            <input type="number" id="mTimerVal" value="30" disabled style="margin:0">
          </div>
        </div>
      </div>

      <label style="font-size:10px; color:#888; text-transform:uppercase">–¢–µ–∫—Å—Ç</label>
      <textarea id="mText" rows="2"></textarea>

      <label style="font-size:10px; color:#888; text-transform:uppercase">–ú–µ–¥–∏–∞</label>
      <div class="upload-row" style="margin-bottom:10px">
        <label class="file-label">
          <span>üìÅ</span> <span id="mMediaStatus">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª (–ö–∞—Ä—Ç–∏–Ω–∫–∞/–ê—É–¥–∏–æ)</span>
          <input type="file" accept="image/*,audio/*" style="display:none" onchange="uploadMedia(this)">
        </label>
        <button class="icon-btn" onclick="clearMedia()">‚úï</button>
      </div>

      <div id="mOptsArea" style="border-top:1px solid #333; padding-top:15px; margin-top:10px"></div>
    </div>
    <div class="modal-foot">
      <button class="btn-gold" onclick="saveQ()">–°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!</div>

<script id="gameTemplate" type="text/plain">
<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{ --text:#eaf0ff; --muted:#a9b6e6; --border: rgba(255,255,255,.10); --gold:#f59e0b; }
  *{box-sizing:border-box;font-family:system-ui,sans-serif}
  body{margin:0;color:var(--text);background:#050505;overflow:hidden;}
  
  /* START SCREEN */
  #startScreen, #endScreen { position:absolute; inset:0; background:rgba(5,5,5,0.95); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:100; }
  .play-btn { padding:15px 50px; background:linear-gradient(135deg, #b45309, #f59e0b); border:none; border-radius:50px; font-weight:900; font-size:24px; color:#000; cursor:pointer; box-shadow:0 0 30px rgba(245,158,11,0.4); text-transform:uppercase; transition:0.3s; }
  .play-btn:hover { transform:scale(1.05); }

  .stage{position:relative;width:100%;height:100vh;overflow:hidden;background:radial-gradient(circle at center, #1e293b 0%, #000 100%);}
  .bg{position:absolute;inset:0;background-size:cover;background-position:center;opacity:0.6;}
  
  .topbar{position:absolute;top:10px;left:10px;right:10px;display:flex;justify-content:space-between;z-index:20;}
  .pill{background:rgba(0,0,0,0.7);border:1px solid #333;padding:8px 15px;border-radius:20px;font-weight:bold;color:var(--gold);}

  .towerArea{position:absolute;inset:0;display:flex;align-items:flex-end;justify-content:center;padding-bottom:80px;pointer-events:none;}
  .tower{position:relative;width:300px;height:100%;display:flex;align-items:flex-end;justify-content:center;}
  
  .imgBlock{position:absolute;left:50%;transform:translateX(-50%);filter:drop-shadow(0 10px 10px rgba(0,0,0,0.5));}
  .burning{filter:grayscale(1) brightness(0.5) sepia(1) hue-rotate(-50deg) saturate(5) !important; transition:0.5s;}
  
  /* CARD */
  .cardBack{position:absolute;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:50;pointer-events:auto;}
  .card{width:90%;max-width:400px;background:#111;border:2px solid var(--gold);border-radius:20px;padding:20px;text-align:center;box-shadow:0 0 50px rgba(245,158,11,0.2);}
  #qImg{max-width:100%;max-height:150px;border-radius:8px;margin-bottom:10px;display:none;}
  #qText{font-size:18px;margin-bottom:20px;line-height:1.4;}
  
  .btn{display:block;width:100%;background:#222;border:1px solid #444;padding:12px;color:#fff;border-radius:8px;margin-bottom:8px;cursor:pointer;text-align:left;}
  .btn:hover{border-color:var(--gold);background:#333;}
  input.inp{width:100%;padding:12px;background:#000;border:1px solid #444;color:var(--gold);border-radius:8px;text-align:center;font-size:16px;outline:none;margin-bottom:10px;}
  
  /* EFFECTS */
  .spark{position:absolute;width:6px;height:6px;background:#ffcc00;border-radius:50%;pointer-events:none;z-index:40;animation:fly 0.8s ease-out forwards;}
  @keyframes fly{to{transform:translate(var(--dx),var(--dy)) scale(0);opacity:0;}}
  
  .nextWrap{position:absolute;bottom:20px;left:0;right:0;text-align:center;z-index:30;pointer-events:auto;}
  .btn-next{background:var(--gold);color:#000;border:none;padding:12px 30px;border-radius:30px;font-weight:bold;font-size:16px;cursor:pointer;display:none;}
</style>
</head>
<body>

<div id="startScreen">
  <h1 style="color:#d4af37; margin-bottom:40px; font-size:40px">–ë–ê–®–ù–Ø</h1>
  <button class="play-btn" onclick="startGame()">–ù–ê–ß–ê–¢–¨</button>
</div>

<div id="endScreen" style="display:none">
  <h1 id="endTitle" style="color:#d4af37; margin-bottom:20px">–§–ò–ù–ê–õ</h1>
  <p style="font-size:24px; margin-bottom:40px">–°—á—ë—Ç: <span id="endScore">0</span></p>
  <button class="play-btn" onclick="location.reload()">–ï–©–ï –†–ê–ó</button>
</div>

<div class="stage" id="stage">
  <div class="bg" id="bg"></div>
  
  <div class="topbar">
    <div class="pill">–≠—Ç–∞–∂: <span id="hTxt">0</span></div>
    <div class="pill">–°—á—ë—Ç: <span id="sTxt">0</span></div>
  </div>

  <div class="towerArea"><div class="tower" id="tower"></div></div>
  
  <div class="nextWrap"><button class="btn-next" id="btnNext" onclick="spawnNext()">–î–ê–õ–ï–ï</button></div>

  <div class="cardBack" id="cardBack">
    <div class="card">
      <img id="qImg">
      <div id="audioBox"></div>
      <div id="qText"></div>
      <div id="ansArea"></div>
      <div id="msg" style="height:20px;margin-top:10px;font-weight:bold"></div>
    </div>
  </div>
</div>

<script>
// === INJECTED CONFIG ===
const cfg = {{CONFIG}};
// =======================

// --- PATH FINDER ---
function getBaseUrl() { let p = window.location.href; return p.substring(0, p.lastIndexOf('/')+1); }
const BASE = getBaseUrl();

// RESOURCES
const IMAGES = {};
const BLOCKS = ["3.png","4.png","5.png","6.png","7.png","8.png","9.png","10.png","11.png"];

// STATE
let state = { running:false, tower:[], falling:null, qIdx:0, score:0, camY:0 };
const towerEl = document.getElementById("tower");

// LOAD
async function loadImg(src) {
  return new Promise(r => {
    if(!src) { r(null); return; }
    const i = new Image();
    i.crossOrigin = "Anonymous";
    i.onload = () => r(i.src);
    i.onerror = () => r(null);
    i.src = src;
  });
}

// INIT
async function startGame() {
  document.getElementById("startScreen").style.display = "none";
  
  // BG Load
  let bgSrc = cfg.bgUser || (BASE + "1.png");
  let bgUrl = await loadImg(bgSrc);
  if(bgUrl) document.getElementById("bg").style.backgroundImage = `url('${bgUrl}')`;

  // Start Loop
  state.running = true;
  spawnNext();
  loop();
}

function spawnNext() {
  document.getElementById("btnNext").style.display = "none";
  if(state.qIdx >= cfg.qs.length) { winGame(); return; }
  
  // Create falling block
  let bName = BLOCKS[state.qIdx % BLOCKS.length];
  let bSrc = BASE + bName; // Always from repo
  
  let el = document.createElement("img");
  el.className = "imgBlock";
  el.src = bSrc;
  // Fallback if image fails (colored rect)
  el.onerror = () => { el.src=""; el.style.backgroundColor="#38bdf8"; el.style.width="200px"; el.style.height="60px"; };
  
  // Width logic
  let w = state.tower.length ? state.tower[state.tower.length-1].w : 280;
  el.style.width = w + "px";
  
  towerEl.appendChild(el);
  
  state.falling = {
    el: el,
    y: -100, // Start above
    targetY: getTargetY(),
    w: w,
    speed: 5 + (state.qIdx*0.5),
    dir: 1,
    x: 0, // Relative center offset
    phase: 'drop'
  };
}

function getTargetY() {
  return (state.tower.length * 60); // Simple stacking height
}

function loop() {
  if(!state.running) return;
  requestAnimationFrame(loop);
  
  if(state.falling && state.falling.phase === 'drop') {
    let f = state.falling;
    
    // Horizontal Move
    let maxX = (window.innerWidth/2) - (f.w/2);
    f.x += f.speed * f.dir;
    if(Math.abs(f.x) > 150) f.dir *= -1; // Bounce bounds
    f.el.style.transform = `translateX(calc(-50% + ${f.x}px))`;
    
    // Vertical Drop (Visual only, Logic handles "hit")
    // In this simplified view, we just animate X until click
  }
  
  // Camera
  let camTarget = Math.max(0, (state.tower.length * 60) - (window.innerHeight * 0.4));
  state.camY += (camTarget - state.camY) * 0.1;
  towerEl.style.transform = `translateY(${state.camY}px)`;
}

// CLICK HANDLER
document.addEventListener("pointerdown", (e) => {
  if(e.target.tagName==="BUTTON" || e.target.tagName==="INPUT") return;
  if(state.falling && state.falling.phase === 'drop') {
    state.falling.phase = 'wait';
    showQuestion();
  }
});

function showQuestion() {
  let q = cfg.qs[state.qIdx];
  let card = document.getElementById("cardBack");
  let area = document.getElementById("ansArea");
  let img = document.getElementById("qImg");
  let aud = document.getElementById("audioBox");
  
  document.getElementById("qText").innerText = q.q;
  document.getElementById("msg").innerText = "";
  area.innerHTML = "";
  img.style.display="none"; aud.innerHTML="";
  
  // Media
  if(q.media) {
    if(q.media.startsWith("data:audio")) aud.innerHTML=`<audio controls autoplay src="${q.media}"></audio>`;
    else { img.src=q.media; img.style.display="block"; }
  }
  
  card.style.display = "flex";
  
  if(q.type === 'choice') {
    q.o.forEach(opt => {
      let b = document.createElement("button");
      b.className = "btn"; b.innerText = opt;
      b.onclick = () => check(opt);
      area.appendChild(b);
    });
  } else {
    let i = document.createElement("input");
    i.className="inp"; i.placeholder="–û—Ç–≤–µ—Ç...";
    let b = document.createElement("button");
    b.className="btn"; b.style.textAlign="center"; b.style.background="#d4af37"; b.style.color="#000"; b.innerText="OK";
    b.onclick = () => check(i.value);
    area.appendChild(i); area.appendChild(b);
  }
}

function check(val) {
  let q = cfg.qs[state.qIdx];
  let isOk = false;
  if(Array.isArray(q.a)) isOk = q.a.some(x => x.toLowerCase().trim() == String(val).toLowerCase().trim());
  else isOk = String(q.a).toLowerCase().trim() == String(val).toLowerCase().trim();
  
  let msg = document.getElementById("msg");
  if(isOk) {
    msg.style.color="#4ade80"; msg.innerText="–í–ï–†–ù–û!";
    setTimeout(() => {
      document.getElementById("cardBack").style.display="none";
      landBlock();
    }, 1000);
  } else {
    msg.style.color="#ef4444"; msg.innerText="–û–®–ò–ë–ö–ê!";
    setTimeout(() => { failGame(); }, 1000);
  }
}

function landBlock() {
  let f = state.falling;
  let prev = state.tower.length ? state.tower[state.tower.length-1] : {x:0, w:300}; // Prev center is 0
  
  // Simple intersection logic (simplified for stability)
  let overlap = f.w - Math.abs(f.x - prev.x);
  
  if(overlap > 0) {
    // Success land
    f.el.style.bottom = (state.tower.length * 60) + "px"; // Stack up
    f.el.style.position = "absolute"; // Fix position
    
    // Visual Sparks
    makeSparks(window.innerWidth/2 + f.x, window.innerHeight - 100); // Approx pos
    
    state.tower.push({el:f.el, x:f.x, w:f.w}); // Store state
    state.score += 100;
    document.getElementById("sTxt").innerText = state.score;
    document.getElementById("hTxt").innerText = state.tower.length;
    
    state.falling = null;
    state.qIdx++;
    
    document.getElementById("btnNext").style.display = "inline-block";
  } else {
    failGame();
  }
}

function makeSparks(x, y) {
  for(let i=0; i<10; i++) {
    let s = document.createElement("div");
    s.className="spark";
    s.style.left = "50%"; s.style.top = "50%"; // Centered relative to screen for now
    let dx = (Math.random()-0.5)*100 + "px";
    let dy = (Math.random()-0.5)*100 + "px";
    s.style.setProperty('--dx', dx);
    s.style.setProperty('--dy', dy);
    document.getElementById("tower").appendChild(s); // Append to tower container
    setTimeout(()=>s.remove(), 800);
  }
}

function failGame() {
  if(state.falling) state.falling.el.classList.add("burning");
  setTimeout(() => {
    document.getElementById("cardBack").style.display="none";
    document.getElementById("endScreen").style.display="flex";
    document.getElementById("endTitle").innerText="–ù–ï–£–î–ê–ß–ê";
    document.getElementById("endScore").innerText=state.score;
  }, 1000);
}

function winGame() {
  document.getElementById("endScreen").style.display="flex";
  document.getElementById("endTitle").innerText="–ü–û–ë–ï–î–ê!";
  document.getElementById("endScore").innerText=state.score;
}

</script>
</body>
</html>
</script>

<script>
// ==========================================
// –õ–û–ì–ò–ö–ê –†–ï–î–ê–ö–¢–û–†–ê
// ==========================================
let config = { bgUser: null, qs: [] };
let editId = null;
let tempMedia = null;

function init() { renderList(); updatePreview(); }

function updatePreview() {
  const tmpl = document.getElementById("gameTemplate").textContent;
  const html = tmpl.replace("{{CONFIG}}", JSON.stringify(config));
  // MAGIC BASE TAG FIX
  const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
  const fixedHtml = html.replace('<head>', `<head><base href="${baseUrl}">`);
  const blob = new Blob([fixedHtml], {type: 'text/html'});
  document.getElementById("previewFrame").src = URL.createObjectURL(blob);
}

// UPLOADERS
function uploadBg(inp) {
  const f = inp.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = e => { config.bgUser = e.target.result; document.getElementById("bgStatus").innerText="–ó–ê–ì–†–£–ñ–ï–ù–û"; updatePreview(); };
  r.readAsDataURL(f);
}
function clearBg() { config.bgUser=null; document.getElementById("bgStatus").innerText="–ó–ê–ì–†–£–ó–ò–¢–¨"; updatePreview(); }

function uploadMedia(inp) {
  const f = inp.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = e => { tempMedia = e.target.result; document.getElementById("mMediaStatus").innerText="–§–∞–π–ª –≤—ã–±—Ä–∞–Ω"; };
  r.readAsDataURL(f);
}
function clearMedia() { tempMedia=null; document.getElementById("mMediaStatus").innerText="–ó–∞–≥—Ä—É–∑–∏—Ç—å..."; }

// LIST
function renderList() {
  const l = document.getElementById("qList"); l.innerHTML="";
  document.getElementById("qCount").innerText = config.qs.length;
  if(!config.qs.length) { l.innerHTML="<div style='text-align:center;color:#444;font-size:11px;padding:10px'>–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>"; return; }
  
  config.qs.forEach((q,i) => {
    let d = document.createElement("div"); d.className="q-item";
    d.innerHTML=`<div class="q-txt"><span class="q-badge">${i+1}</span> ${q.q}</div><div><button class="icon-btn" onclick="editQ(${i})">‚úèÔ∏è</button><button class="icon-btn del" onclick="delQ(${i})">üóë</button></div>`;
    l.appendChild(d);
  });
}

// MODAL
function openModal() { 
  editId=null; document.getElementById("modal").style.display="flex"; 
  document.getElementById("mText").value=""; tempMedia=null; 
  document.getElementById("mTimerOn").checked=false; document.getElementById("mTimerVal").disabled=true;
  clearMedia(); renderOpts(); 
}
function closeModal() { document.getElementById("modal").style.display="none"; }

function renderOpts() {
  const t = document.getElementById("mType").value;
  const c = document.getElementById("mOptsArea"); c.innerHTML="";
  if(t==="choice") {
    c.innerHTML = `<div style="display:flex;justify-content:space-between;margin-bottom:5px"><label>–í–∞—Ä–∏–∞–Ω—Ç—ã</label><button onclick="addOpt()" style="background:none;color:var(--gold);font-size:10px">+ –î–û–ë–ê–í–ò–¢–¨</button></div><div id="optsList"></div>`;
    if(editId===null) { addOpt(); addOpt(); }
  } else c.innerHTML = `<label>–û—Ç–≤–µ—Ç (—Ç–µ–∫—Å—Ç)</label><input type="text" id="mInp">`;
}

function addOpt(val="", ok=false) {
  const l = document.getElementById("optsList"); if(!l) return;
  let d = document.createElement("div"); d.className="opt-row";
  d.innerHTML=`<input type="radio" name="ok" class="radio" ${ok?'checked':''}><input type="text" class="opt-val" value="${val}"><button class="icon-btn del" onclick="this.parentElement.remove()">‚úï</button>`;
  l.appendChild(d);
}

function editQ(i) {
  editId=i; const q=config.qs[i];
  document.getElementById("modal").style.display="flex";
  document.getElementById("mText").value=q.q;
  document.getElementById("mType").value=q.type;
  if(q.timer) { document.getElementById("mTimerOn").checked=true; document.getElementById("mTimerVal").disabled=false; document.getElementById("mTimerVal").value=q.timer; }
  tempMedia=q.media; if(tempMedia) document.getElementById("mMediaStatus").innerText="–§–∞–π–ª –µ—Å—Ç—å";
  renderOpts();
  if(q.type==='choice') {
    document.getElementById("optsList").innerHTML="";
    q.o.forEach(opt => addOpt(opt, q.a.includes(opt)));
  } else document.getElementById("mInp").value = q.a.join(", ");
}

function toggleTimer() { document.getElementById("mTimerVal").disabled = !document.getElementById("mTimerOn").checked; }

function saveQ() {
  const txt = document.getElementById("mText").value;
  const type = document.getElementById("mType").value;
  if(!txt) return;
  
  let o = {type:type, q:txt, a:[], media:tempMedia, timer:0};
  if(document.getElementById("mTimerOn").checked) o.timer = parseInt(document.getElementById("mTimerVal").value)||30;
  
  if(type==='choice') {
    o.o=[];
    document.querySelectorAll(".opt-row").forEach(r=>{
      let v = r.querySelector(".opt-val").value;
      if(v) { o.o.push(v); if(r.querySelector(".radio").checked) o.a.push(v); }
    });
    if(!o.a.length) { alert("–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç!"); return; }
  } else o.a = document.getElementById("mInp").value.split(",").map(x=>x.trim()).filter(Boolean);
  
  if(editId!==null) config.qs[editId]=o; else config.qs.push(o);
  closeModal(); renderList(); updatePreview();
}

function delQ(i) { config.qs.splice(i,1); renderList(); updatePreview(); }
function resetQs() { config.qs=[]; renderList(); updatePreview(); }

function generateCode() {
  const tmpl = document.getElementById("gameTemplate").textContent;
  const html = tmpl.replace("{{CONFIG}}", JSON.stringify(config));
  const b64 = btoa(unescape(encodeURIComponent(html)));
  const embed = `<iframe src="data:text/html;base64,${b64}" width="100%" height="600" style="border:0"></iframe>`;
  navigator.clipboard.writeText(embed).then(()=> {
    const t = document.getElementById("toast"); t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2000);
  });
}

init();
</script>
</body>
</html>
