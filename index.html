<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gold Tower Editor (Fixed Preview)</title>
<style>
  /* --- –°–¢–ò–õ–ò –†–ï–î–ê–ö–¢–û–†–ê --- */
  :root { --bg: #050505; --panel: #0f1219; --gold: #d4af37; --text: #e2e8f0; --border: #333; }
  body { margin:0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }
  
  /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å */
  .editor { width: 420px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; box-shadow: 5px 0 30px #000; }
  .header { padding: 15px; background: #080a0f; border-bottom: 1px solid var(--gold); display:flex; justify-content:space-between; align-items:center; }
  .logo { font-weight: 800; color: var(--gold); letter-spacing: 1px; font-size: 16px; text-transform: uppercase; }
  
  .scroll-area { flex: 1; overflow-y: auto; padding: 15px; }
  .section { margin-bottom: 20px; border: 1px solid #222; padding: 10px; border-radius: 6px; background: rgba(255,255,255,0.02); }
  .label { color: #888; font-size: 10px; text-transform: uppercase; font-weight: bold; display: block; margin-bottom: 5px; }

  /* –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
  input, textarea, select { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px; box-sizing: border-box; font-size: 13px; margin-bottom: 8px; }
  input:focus { border-color: var(--gold); outline: none; }
  
  button { cursor: pointer; border: none; font-weight: bold; border-radius: 4px; transition:0.2s; }
  .btn-gold { background: linear-gradient(135deg, #b8860b, #d4af37); color: #000; padding: 8px 15px; font-size: 11px; text-transform: uppercase; }
  .btn-add { background: rgba(212, 175, 55, 0.1); border: 1px dashed var(--gold); color: var(--gold); width: 100%; padding: 10px; font-size: 12px; }
  .btn-add:hover { background: var(--gold); color: #000; }
  
  .file-row { display: flex; gap: 10px; align-items: center; background: #111; padding: 5px; border: 1px dashed #444; border-radius: 4px; }
  .file-row label { cursor: pointer; color: var(--gold); font-size: 11px; flex: 1; text-align: center; }
  .file-row input { display: none; }

  /* –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ */
  .q-item { background: #1a1d26; padding: 8px; border-radius: 4px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; border-left: 2px solid transparent; font-size: 12px; }
  .q-item:hover { border-left-color: var(--gold); background: #222; }

  /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (–ü—Ä–µ–≤—å—é) */
  .preview { flex: 1; background: #000; position: relative; display: flex; flex-direction: column; }
  .preview-head { height: 25px; background: #111; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: center; color: #666; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; }
  iframe { flex: 1; width: 100%; border: none; background: #000; display: block; }

  /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999; display: none; align-items: center; justify-content: center; }
  .modal { background: #0f1219; width: 500px; border: 1px solid var(--gold); padding: 20px; border-radius: 8px; box-shadow: 0 0 50px rgba(212,175,55,0.3); }
  
  .opt-row { display: flex; gap: 5px; margin-bottom: 5px; }
  .radio { width: 20px; accent-color: var(--gold); }

  .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--gold); color: #000; padding: 10px 20px; border-radius: 20px; font-weight: bold; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000; }
  .toast.show { opacity: 1; bottom: 50px; }
</style>
</head>
<body>

<div class="editor">
  <div class="header">
    <span class="logo">üèóÔ∏è GOLD EDITOR</span>
    <button class="btn-gold" onclick="generateCode()">–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î</button>
  </div>
  
  <div class="scroll-area">
    <div class="section">
      <span class="label">1. –§–æ–Ω –∏–≥—Ä—ã</span>
      <div class="file-row">
        <label>
          <span id="bgStatus">–ó–ê–ì–†–£–ó–ò–¢–¨ –ö–ê–†–¢–ò–ù–ö–£</span>
          <input type="file" accept="image/*" onchange="uploadBg(this)">
        </label>
        <button onclick="clearBg()" style="background:none; color:#ef4444; font-size:14px">‚úï</button>
      </div>
    </div>

    <div class="section">
      <span class="label">2. –í–æ–ø—Ä–æ—Å—ã (<span id="qCount">0</span>/9)</span>
      <div id="qList"></div>
      <button class="btn-add" onclick="openModal()">+ –î–û–ë–ê–í–ò–¢–¨ –í–û–ü–†–û–°</button>
      <button onclick="config.qs=[];renderList();updatePreview()" style="width:100%; background:none; color:#666; font-size:10px; margin-top:5px">–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
    </div>
  </div>
</div>

<div class="preview">
  <div class="preview-head">–ñ–ò–í–û–ô –ü–†–û–°–ú–û–¢–†</div>
  <iframe id="previewFrame"></iframe>
</div>

<div class="modal-overlay" id="modal">
  <div class="modal">
    <h3 style="color:var(--gold); margin-top:0">–†–ï–î–ê–ö–¢–û–†</h3>
    
    <label class="label">–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞</label>
    <select id="mType" onchange="renderOpts()">
      <option value="choice">–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞</option>
      <option value="input">–í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞</option>
    </select>

    <label class="label">–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</label>
    <textarea id="mText" rows="2"></textarea>

    <label class="label">–ú–µ–¥–∏–∞ (–ö–∞—Ä—Ç–∏–Ω–∫–∞/–ó–≤—É–∫)</label>
    <div class="file-row" style="margin-bottom:15px">
      <label>
        <span id="mMediaStatus">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª...</span>
        <input type="file" accept="image/*,audio/*" onchange="uploadMedia(this)">
      </label>
      <button onclick="clearMedia()" style="background:none; color:#ef4444">‚úï</button>
    </div>

    <div id="mOptsArea" style="border-top:1px solid #333; padding-top:10px"></div>

    <div style="text-align:right; margin-top:15px">
      <button class="btn-gold" onclick="saveQ()">–°–û–•–†–ê–ù–ò–¢–¨</button>
      <button onclick="closeModal()" style="background:none; color:#fff; margin-left:10px">–û–¢–ú–ï–ù–ê</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!</div>

<script id="gameTemplate" type="text/template">
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<style>
  :root { --gold: #d4af37; --bg: #050505; }
  body { margin:0; overflow:hidden; background: var(--bg); font-family: 'Segoe UI', sans-serif; user-select:none; }
  
  /* –°—Ü–µ–Ω–∞ */
  #stage { 
    position: absolute; inset: 0; overflow: hidden; 
    transition: transform 0.5s ease; /* –ü–ª–∞–≤–Ω—ã–π –∑—É–º */
    transform-origin: center bottom;
  }
  #bg { position: absolute; inset: 0; background-size: cover; background-position: center; opacity: 0.5; }
  
  /* –ë–∞—à–Ω—è */
  .block { 
    position: absolute; height: 50px; 
    background: linear-gradient(to bottom, #fde68a, #d4af37);
    border: 1px solid #fff; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    border-radius: 4px;
    background-size: 100% 100%; /* –î–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ */
  }
  .base {
    position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
    width: 350px; height: 40px; background: #333; 
    border-top: 3px solid var(--gold); border-radius: 4px 4px 0 0;
    z-index: 10;
  }

  /* HUD */
  .hud { position: fixed; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; z-index: 50; pointer-events:none; }
  .pill { background: rgba(0,0,0,0.8); color: var(--gold); padding: 5px 15px; border-radius: 20px; border: 1px solid var(--gold); font-weight: bold; font-size: 14px; }

  /* –≠–∫—Ä–∞–Ω—ã */
  .screen { position: fixed; inset: 0; background: rgba(5,5,5,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
  h1 { font-size: 40px; color: var(--gold); margin-bottom: 20px; letter-spacing: 3px; text-transform: uppercase; }
  
  .btn-big { 
    padding: 15px 50px; background: var(--gold); color: #000; border: none; 
    border-radius: 50px; font-size: 20px; font-weight: 900; cursor: pointer; 
    box-shadow: 0 0 20px rgba(212,175,55,0.5); animation: pulse 2s infinite;
  }
  @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }

  /* –ö–∞—Ä—Ç–æ—á–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ */
  #card { 
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); 
    width: 90%; max-width: 400px; background: #111; border: 2px solid var(--gold); 
    border-radius: 15px; padding: 20px; text-align: center; z-index: 90; 
    opacity: 0; pointer-events: none; transition: 0.3s; box-shadow: 0 0 50px #000;
  }
  #card.show { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }
  #cardOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 80; display: none; }

  .ans-btn { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: #fff; margin-bottom: 8px; border-radius: 8px; cursor: pointer; text-align: left; transition:0.2s; font-size: 14px; }
  .ans-btn:hover { border-color: var(--gold); background: #333; }
  input.inp { width: 100%; padding: 12px; background: #000; border: 1px solid var(--gold); color: #fff; margin-bottom: 10px; text-align: center; font-size: 16px; outline: none; }
  
  #mediaBox img { max-width: 100%; max-height: 150px; border-radius: 5px; margin-bottom: 10px; border: 1px solid #333; }
  #qText { font-size: 18px; color: #fff; margin-bottom: 15px; font-weight: bold; line-height: 1.4; }

</style>
</head>
<body>

<div id="stage">
  <div id="bg"></div>
  <div class="base"></div>
</div>

<div class="hud">
  <div class="pill">–û—á–∫–∏: <span id="score">0</span></div>
  <div class="pill">–≠—Ç–∞–∂: <span id="level">0</span></div>
</div>

<div id="startScreen" class="screen">
  <h1>–ë–ê–®–ù–Ø</h1>
  <button class="btn-big" id="startBtn">–ù–ê–ß–ê–¢–¨</button>
</div>

<div id="endScreen" class="screen" style="display:none">
  <h1 id="endTitle">–§–ò–ù–ê–õ</h1>
  <p style="color:#fff; font-size:18px; margin-bottom:30px">–°—á—ë—Ç: <span id="finalScore">0</span></p>
  <button class="btn-big" onclick="location.reload()">–ï–©–ï –†–ê–ó</button>
</div>

<div id="cardOverlay"></div>
<div id="card">
  <div id="mediaBox"></div>
  <div id="qText"></div>
  <div id="ansArea"></div>
  <div id="feedback" style="height:20px; font-weight:bold; margin-top:10px"></div>
</div>

<script>
// === –°–Æ–î–ê –ë–£–î–ï–¢ –í–°–¢–ê–í–õ–ï–ù –ö–û–ù–§–ò–ì –ò–ó –†–ï–î–ê–ö–¢–û–†–ê ===
const CFG = {{CONFIG}}; 
// ===============================================

// –ê–í–¢–û-–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–£–¢–ò (–ß—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Å –ì–∏—Ç—Ö–∞–±–∞)
function getBaseUrl() {
  const url = window.location.href;
  if(url.startsWith('blob:')) return CFG.repo || ''; // –ï—Å–ª–∏ blob, –±–µ—Ä–µ–º –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
  return url.substring(0, url.lastIndexOf('/') + 1);
}
const BASE = getBaseUrl();

// –ò–ú–ï–ù–ê –ë–õ–û–ö–û–í
const BLOCK_FILES = ["3.png","4.png","5.png","6.png","7.png","8.png","9.png","10.png","11.png"];

// –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê
const game = {
  running: false,
  level: 0,
  width: 300, // –ù–∞—á–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ (—á—É—Ç—å –º–µ–Ω—å—à–µ –±–∞–∑—ã 350)
  pos: 0,     // –ü–æ–∑–∏—Ü–∏—è X —Ç–µ–∫—É—â–µ–≥–æ –±–ª–æ–∫–∞
  speed: 4,
  dir: 1,
  current: null, // DOM —ç–ª–µ–º–µ–Ω—Ç
  
  start: function() {
    document.getElementById('startScreen').style.display = 'none';
    
    // –§–æ–Ω
    let bgUrl = CFG.bg || (BASE + "1.png");
    document.getElementById('bg').style.backgroundImage = `url('${bgUrl}')`;

    this.running = true;
    this.level = 0;
    this.width = 300;
    this.spawn();
    this.loop();
  },

  spawn: function() {
    if(this.level >= 9 || this.level >= CFG.qs.length) {
      this.over(true);
      return;
    }

    // –°–æ–∑–¥–∞–µ–º –±–ª–æ–∫
    const el = document.createElement('div');
    el.className = 'block';
    el.style.width = this.width + 'px';
    // –ü–æ–∑–∏—Ü–∏—è Y: –±–∞–∑–∞(40) + —É—Ä–æ–≤–µ–Ω—å*50
    el.style.bottom = (40 + this.level * 50) + 'px'; 
    el.style.left = '50%';
    
    // –ö–∞—Ä—Ç–∏–Ω–∫–∞ –±–ª–æ–∫–∞
    const imgName = BLOCK_FILES[this.level % BLOCK_FILES.length];
    const imgUrl = BASE + imgName;
    
    // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É, –µ—Å–ª–∏ –Ω–µ—Ç - –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≥—Ä–∞–¥–∏–µ–Ω—Ç
    const img = new Image();
    img.onload = () => { el.style.backgroundImage = `url('${imgUrl}')`; el.style.border='none'; };
    img.src = imgUrl;

    document.getElementById('stage').appendChild(el);
    
    this.current = el;
    this.pos = -250; // –°—Ç–∞—Ä—Ç —Å–ª–µ–≤–∞
    this.dir = 1;
    this.running = true;
    
    this.fitCamera();
  },

  loop: function() {
    if(!game.running || !game.current) return;
    
    game.pos += game.speed * game.dir;
    // –ì—Ä–∞–Ω–∏—Ü—ã –¥–≤–∏–∂–µ–Ω–∏—è
    if(game.pos > 250) game.dir = -1;
    if(game.pos < -250) game.dir = 1;
    
    game.current.style.transform = `translateX(calc(-50% + ${game.pos}px))`;
    
    requestAnimationFrame(game.loop);
  },

  stop: function() {
    if(!this.running || !this.current) return;
    this.running = false; // –ü–∞—É–∑–∞
    this.showQuestion();
  },

  showQuestion: function() {
    const q = CFG.qs[this.level];
    const card = document.getElementById('card');
    const over = document.getElementById('cardOverlay');
    const area = document.getElementById('ansArea');
    const media = document.getElementById('mediaBox');
    
    document.getElementById('qText').innerText = q.q;
    document.getElementById('feedback').innerText = '';
    area.innerHTML = '';
    media.innerHTML = '';

    // –ú–µ–¥–∏–∞
    if(q.media) {
      if(q.media.startsWith('data:audio')) media.innerHTML = `<audio controls autoplay src="${q.media}"></audio>`;
      else media.innerHTML = `<img src="${q.media}">`;
    }

    // –ö–Ω–æ–ø–∫–∏
    if(q.type === 'choice') {
      q.o.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'ans-btn';
        btn.innerText = opt;
        btn.onclick = () => this.check(opt);
        area.appendChild(btn);
      });
    } else {
      const inp = document.createElement('input');
      inp.className = 'inp'; inp.placeholder = '–û—Ç–≤–µ—Ç...';
      const btn = document.createElement('button');
      btn.className = 'ans-btn';
      btn.style.textAlign='center'; btn.innerText='–û–¢–í–ï–¢–ò–¢–¨';
      btn.onclick = () => this.check(inp.value);
      area.appendChild(inp); area.appendChild(btn);
    }

    over.style.display = 'block';
    card.classList.add('show');
  },

  check: function(val) {
    const q = CFG.qs[this.level];
    let ok = false;
    if(Array.isArray(q.a)) ok = q.a.some(x => x.toLowerCase().trim() == String(val).toLowerCase().trim());
    else ok = String(q.a).toLowerCase().trim() == String(val).toLowerCase().trim();

    const fb = document.getElementById('feedback');
    if(ok) {
      fb.innerText = "–í–ï–†–ù–û!";
      fb.style.color = "#4ade80";
      setTimeout(() => {
        document.getElementById('cardOverlay').style.display='none';
        document.getElementById('card').classList.remove('show');
        this.placeBlock();
      }, 1000);
    } else {
      fb.innerText = "–û–®–ò–ë–ö–ê!";
      fb.style.color = "#ef4444";
      setTimeout(() => this.over(false), 1000);
    }
  },

  placeBlock: function() {
    // –†–∞—Å—á–µ—Ç –Ω–∞–ª–æ–∂–µ–Ω–∏—è (Stack logic)
    // –ü—Ä–µ–¥—ã–¥—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è X (—Ü–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞ = 0)
    // –£ –Ω–∞—Å pos - —ç—Ç–æ —Å–º–µ—â–µ–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞.
    // –ï—Å–ª–∏ —É—Ä–æ–≤–µ–Ω—å 0, —Ü–µ–Ω—Ç—Ä 0. –ò–Ω–∞—á–µ –±–µ—Ä–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π x.
    
    // –ù–æ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è: –º—ã –≤—Å–µ–≥–¥–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –±–ª–æ–∫ –≤–∏–∑—É–∞–ª—å–Ω–æ?
    // –ù–µ—Ç, —ç—Ç–æ "Stack". –ù—É–∂–Ω–æ –æ–±—Ä–µ–∑–∞—Ç—å.
    
    // –ù–µ–º–Ω–æ–≥–æ —É–ø—Ä–æ—Å—Ç–∏–º –ª–æ–≥–∏–∫—É: 
    // –ï—Å–ª–∏ pos > width/2 -> –ø—Ä–æ–º–∞—Ö.
    // –ò–Ω–∞—á–µ —É–º–µ–Ω—å—à–∞–µ–º width.
    
    const offset = Math.abs(this.pos);
    
    if(offset > this.width) {
      this.over(false);
      return;
    }
    
    // –û–±—Ä–µ–∑–∞–µ–º
    const newWidth = this.width - offset;
    this.width = newWidth;
    
    // –í–∏–∑—É–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –±–ª–æ–∫
    this.current.style.width = newWidth + 'px';
    // –°–¥–≤–∏–≥–∞–µ–º –µ–≥–æ, —á—Ç–æ–±—ã –∫—Ä–∞–π —Å–æ–≤–ø–∞–¥–∞–ª
    // (–í –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏ Stack –Ω–∞–¥–æ —Å–¥–≤–∏–≥–∞—Ç—å —Ü–µ–Ω—Ç—Ä, —Ç—É—Ç –æ—Å—Ç–∞–≤–∏–º —Ü–µ–Ω—Ç—Ä–æ–≤–∫—É –ø–æ pos –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –≤–∏–∑—É–∞–ª–∞, 
    // —Ç–∞–∫ –∫–∞–∫ –º—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º X –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤ —ç—Ç–æ–π —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏, –∞ –ø—Ä–æ—Å—Ç–æ —Å—É–∂–∞–µ–º)
    
    this.level++;
    this.speed += 0.2;
    
    document.getElementById('score').innerText = this.level * 100;
    document.getElementById('level').innerText = this.level;
    
    setTimeout(() => this.spawn(), 300);
  },

  over: function(win) {
    document.getElementById('cardOverlay').style.display='none';
    document.getElementById('card').classList.remove('show');
    document.getElementById('endScreen').style.display='flex';
    const t = document.getElementById('endTitle');
    
    if(win) { t.innerText="–ü–û–ë–ï–î–ê!"; t.style.color="#4ade80"; }
    else { t.innerText="–£–ü–ê–õ–ê..."; t.style.color="#ef4444"; }
    
    document.getElementById('finalScore').innerText = this.level * 100;
  },

  fitCamera: function() {
    // –ó—É–º —á—Ç–æ–±—ã –≤–ª–µ–∑–∞–ª–æ
    const h = (this.level + 2) * 50;
    const wh = window.innerHeight;
    if(h > wh * 0.7) {
      const s = (wh * 0.7) / h;
      document.getElementById('stage').style.transform = `scale(${s})`;
    }
  }
};

// Start handler
document.getElementById('startBtn').addEventListener('click', () => game.start());

// Click handler (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ UI)
document.addEventListener('pointerdown', (e) => {
  if(e.target.closest('button') || e.target.closest('input') || e.target.closest('.screen') || e.target.closest('#card')) return;
  if(game.running && game.current) game.stop();
});

</script>
</body>
</html>
</script>

<script>
// ==========================================
// –°–ö–†–ò–ü–¢ –†–ï–î–ê–ö–¢–û–†–ê
// ==========================================
let config = { bg: null, qs: [], repo: "" };
let editId = null;
let tempMedia = null;

// –ê–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ä–µ–ø–æ
const repoUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
config.repo = repoUrl;

function init() { renderList(); updatePreview(); }

// –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ü–†–ï–í–¨–Æ (–°–ê–ú–ê–Ø –í–ê–ñ–ù–ê–Ø –ß–ê–°–¢–¨)
function updatePreview() {
  const tmpl = document.getElementById("gameTemplate").innerHTML; // –ë–µ—Ä–µ–º HTML –∏–∑ —à–∞–±–ª–æ–Ω–∞
  // –í—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥
  const finalHtml = tmpl.replace("{{CONFIG}}", JSON.stringify(config));
  
  const frame = document.getElementById("previewFrame");
  const doc = frame.contentWindow.document;
  
  doc.open();
  doc.write(finalHtml); // –ü—Ä—è–º–∞—è –∑–∞–ø–∏—Å—å –≤ iframe!
  doc.close();
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ–Ω–∞
function uploadBg(inp) {
  const f = inp.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = e => { config.bg = e.target.result; document.getElementById("bgStatus").innerText="–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω"; updatePreview(); };
  r.readAsDataURL(f);
}
function clearBg() { config.bg=null; document.getElementById("bgStatus").innerText="–ó–ê–ì–†–£–ó–ò–¢–¨ –ö–ê–†–¢–ò–ù–ö–£"; updatePreview(); }

// –í–æ–ø—Ä–æ—Å—ã
function renderList() {
  const l = document.getElementById("qList"); l.innerHTML="";
  document.getElementById("qCount").innerText = config.qs.length;
  if(!config.qs.length) { l.innerHTML="<div style='text-align:center;color:#444;font-size:11px;padding:10px'>–ü—É—Å—Ç–æ</div>"; return; }
  
  config.qs.forEach((q,i) => {
    let d = document.createElement("div"); d.className="q-item";
    d.innerHTML=`<div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:200px"><span style="color:var(--gold);font-weight:bold;margin-right:5px">#${i+1}</span> ${q.q}</div>
    <div style="display:flex;gap:5px"><button onclick="editQ(${i})" style="background:none;color:#aaa">‚úèÔ∏è</button><button onclick="delQ(${i})" style="background:none;color:#ef4444">üóë</button></div>`;
    l.appendChild(d);
  });
}

function openModal() { editId=null; document.getElementById("modal").style.display="flex"; document.getElementById("mText").value=""; tempMedia=null; renderMediaUI(); renderOpts(); }
function closeModal() { document.getElementById("modal").style.display="none"; }

function uploadMedia(inp) {
  const f = inp.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = e => { tempMedia = e.target.result; renderMediaUI(); };
  r.readAsDataURL(f);
}
function clearMedia() { tempMedia=null; renderMediaUI(); }
function renderMediaUI() {
  const st = document.getElementById("mMediaStatus");
  if(tempMedia) { st.innerText="–§–∞–π–ª –≥–æ—Ç–æ–≤"; st.style.color="#4ade80"; } 
  else { st.innerText="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª..."; st.style.color="#aaa"; }
}

function renderOpts() {
  const t = document.getElementById("mType").value;
  const c = document.getElementById("mOptsArea"); c.innerHTML="";
  if(t==="choice") {
    c.innerHTML = `<div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:11px;color:#888"><span>–í–ê–†–ò–ê–ù–¢–´</span><span onclick="addOpt()" style="cursor:pointer;color:var(--gold)">+ –î–û–ë–ê–í–ò–¢–¨</span></div><div id="optsList"></div>`;
    if(editId===null) { addOpt(); addOpt(); }
  } else c.innerHTML = `<label class="label">–û–¢–í–ï–¢</label><input type="text" id="mInp">`;
}

function addOpt(val="", ok=false) {
  const l = document.getElementById("optsList"); if(!l) return;
  let d = document.createElement("div"); d.className="opt-row";
  d.innerHTML=`<input type="radio" name="ok" class="radio" ${ok?'checked':''}><input type="text" class="opt-val" value="${val}"><button onclick="this.parentElement.remove()" style="background:none;color:#666">‚úï</button>`;
  l.appendChild(d);
}

function editQ(i) {
  editId=i; const q=config.qs[i];
  document.getElementById("modal").style.display="flex";
  document.getElementById("mText").value=q.q;
  document.getElementById("mType").value=q.type;
  tempMedia=q.media; renderMediaUI(); renderOpts();
  if(q.type==='choice') {
    document.getElementById("optsList").innerHTML="";
    q.o.forEach(opt => addOpt(opt, q.a.includes(opt)));
  } else document.getElementById("mInp").value = q.a.join(", ");
}

function saveQ() {
  const txt = document.getElementById("mText").value;
  const type = document.getElementById("mType").value;
  if(!txt) return;
  let o = {type:type, q:txt, a:[], media:tempMedia};
  if(type==='choice') {
    o.o=[];
    document.querySelectorAll(".opt-row").forEach(r=>{
      let v = r.querySelector(".opt-val").value;
      if(v) { o.o.push(v); if(r.querySelector(".radio").checked) o.a.push(v); }
    });
    if(!o.a.length) { alert("–í—ã–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π!"); return; }
  } else o.a = document.getElementById("mInp").value.split(",").map(x=>x.trim()).filter(Boolean);
  
  if(editId!==null) config.qs[editId]=o; else config.qs.push(o);
  closeModal(); renderList(); updatePreview();
}

function delQ(i) { config.qs.splice(i,1); renderList(); updatePreview(); }

// –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –î–õ–Ø GENIALLY
function generateCode() {
  const tmpl = document.getElementById("gameTemplate").innerHTML;
  const finalHtml = tmpl.replace("{{CONFIG}}", JSON.stringify(config));
  const b64 = btoa(unescape(encodeURIComponent(finalHtml)));
  const embed = `<iframe src="data:text/html;base64,${b64}" width="100%" height="600" style="border:0"></iframe>`;
  
  navigator.clipboard.writeText(embed).then(()=> {
    const t = document.getElementById("toast"); t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"),2000);
  });
}

init();
</script>
</body>
</html>
