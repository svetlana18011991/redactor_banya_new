<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gold Tower Editor</title>
<style>
  /* --- –¢–ï–ú–ê: –ó–û–õ–û–¢–û –ù–ê –ß–ï–†–ù–û–ú --- */
  :root { 
    --bg: #050505; 
    --panel: #0f1219; 
    --gold: #d4af37; 
    --gold-glow: rgba(212, 175, 55, 0.3);
    --gold-text: #f3e5ab;
    --border: #333; 
    --text: #e2e8f0;
  }
  
  body { margin:0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }
  
  /* –°–ö–†–û–õ–õ–ë–ê–† */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--panel); }
  ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--gold); }

  /* --- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê (–†–ï–î–ê–ö–¢–û–†) --- */
  .editor-col { width: 450px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; box-shadow: 10px 0 50px rgba(0,0,0,0.8); }
  
  .header { padding: 20px; border-bottom: 1px solid var(--gold); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(to right, #0f1219, #1a1d26); }
  .logo { font-weight: 800; color: var(--gold); letter-spacing: 2px; text-transform: uppercase; font-size: 18px; text-shadow: 0 0 15px var(--gold-glow); }
  
  .scroll-wrap { flex: 1; overflow-y: auto; padding: 20px; }
  
  .section { margin-bottom: 25px; }
  .sec-head { color: var(--gold); font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }

  /* –ö–ù–û–ü–ö–ò */
  button { cursor: pointer; border: none; font-family: inherit; font-weight: 600; transition: 0.3s; border-radius: 4px; }
  
  .btn-gold { 
    background: linear-gradient(135deg, #b8860b, #d4af37); 
    color: #000; padding: 8px 16px; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; 
    box-shadow: 0 0 15px var(--gold-glow);
  }
  .btn-gold:hover { filter: brightness(1.2); box-shadow: 0 0 25px var(--gold-glow); }
  
  .btn-add { background: rgba(212, 175, 55, 0.1); border: 1px dashed var(--gold); color: var(--gold); width: 100%; padding: 12px; margin-top: 10px; }
  .btn-add:hover { background: var(--gold); color: #000; }

  .btn-small { padding: 4px 8px; font-size: 11px; background: #333; color: #aaa; margin-left: 5px; }
  .btn-small:hover { color: #fff; }

  /* –°–ü–ò–°–û–ö –í–û–ü–†–û–°–û–í */
  .q-list { display: flex; flex-direction: column; gap: 8px; }
  .q-item { 
    background: rgba(255,255,255,0.03); padding: 12px; border-radius: 6px; 
    display: flex; justify-content: space-between; align-items: center; 
    border-left: 2px solid transparent; transition: 0.2s; 
  }
  .q-item:hover { background: rgba(255,255,255,0.07); border-left-color: var(--gold); }
  
  .q-info { display: flex; align-items: center; gap: 10px; overflow: hidden; }
  .q-type { font-size: 9px; background: #000; color: #888; padding: 2px 5px; border-radius: 3px; border: 1px solid #333; text-transform: uppercase; }
  .q-text { font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 280px; }

  .icon-btn { background: transparent; color: #666; font-size: 16px; padding: 5px; }
  .icon-btn:hover { color: #fff; }
  .icon-btn.del:hover { color: #ef4444; }

  /* --- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê (–ü–†–ï–í–¨–Æ) --- */
  .preview-col { flex: 1; background: #000; position: relative; overflow: hidden; display: flex; flex-direction: column; }
  .preview-header { 
    position: absolute; top: 0; left: 0; right: 0; height: 30px; 
    background: rgba(0,0,0,0.8); z-index: 5; display: flex; align-items: center; justify-content: center;
    color: #555; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; border-bottom: 1px solid #222;
  }
  iframe { width: 100%; height: 100%; border: none; display: block; background: #000; }

  /* --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û --- */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
  .modal { background: #151921; width: 600px; max-height: 90vh; border-radius: 12px; border: 1px solid var(--gold); box-shadow: 0 0 60px rgba(212, 175, 55, 0.15); display: flex; flex-direction: column; }
  
  .modal-head { padding: 15px 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
  .modal-head h3 { margin: 0; color: var(--gold-text); font-size: 16px; text-transform: uppercase; letter-spacing: 1px; }
  
  .modal-body { padding: 20px; overflow-y: auto; }
  
  .row { display: flex; gap: 15px; margin-bottom: 15px; }
  .col { flex: 1; }
  
  label { display: block; color: #888; font-size: 11px; text-transform: uppercase; margin-bottom: 6px; font-weight: bold; }
  
  input, select, textarea { 
    width: 100%; background: #0a0c10; border: 1px solid #333; color: #fff; padding: 10px; 
    border-radius: 6px; box-sizing: border-box; font-size: 14px; font-family: inherit;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--gold); outline: none; }

  /* Media Input */
  .media-box { border: 1px dashed #444; padding: 10px; border-radius: 6px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; position: relative; }
  .media-box:hover { border-color: var(--gold); background: rgba(255,255,255,0.02); }
  .media-box input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .media-label { font-size: 12px; color: #aaa; }
  
  .preview-media { margin-top: 10px; max-height: 100px; border: 1px solid #333; border-radius: 4px; display: none; }

  /* Answer Options */
  .opt-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; animation: slideIn 0.2s; }
  @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
  
  .radio-wrap { width: 20px; display: flex; justify-content: center; }
  input[type="radio"] { width: 16px; height: 16px; accent-color: var(--gold); cursor: pointer; }

  .modal-foot { padding: 15px 20px; border-top: 1px solid #333; text-align: right; }

  .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--gold); color: #000; padding: 12px 30px; border-radius: 30px; font-weight: bold; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000; box-shadow: 0 0 20px var(--gold-glow); }
  .toast.show { opacity: 1; bottom: 50px; }
</style>
</head>
<body>

<div class="editor-col">
  <div class="header">
    <div class="logo">üèõÔ∏è GOLD TOWER</div>
    <button class="btn-gold" onclick="generateCode()">–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î</button>
  </div>
  
  <div class="scroll-wrap">
    <div class="section">
      <div class="sec-head">–§–æ–Ω –ò–≥—Ä—ã (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</div>
      <div class="media-box">
        <span style="font-size: 18px;">üñºÔ∏è</span>
        <span class="media-label" id="bgName">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (—Å GitHub)</span>
        <input type="file" accept="image/*" onchange="uploadBg(this)">
      </div>
      <button class="btn-small" style="width:100%; margin: 5px 0 0 0; background:transparent; text-align:right" onclick="clearBg()">–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π</button>
    </div>

    <div class="section">
      <div class="sec-head">–í–æ–ø—Ä–æ—Å—ã (<span id="qCount">0</span>/9)</div>
      <div id="qList" class="q-list"></div>
      
      <button class="btn-add" onclick="openModal()">+ –î–û–ë–ê–í–ò–¢–¨ –í–û–ü–†–û–°</button>
      <button style="background:transparent; color:#555; width:100%; margin-top:10px; font-size:11px" onclick="if(confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ?')){config.qs=[];renderList();updatePreview()}">–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
    </div>
  </div>
</div>

<div class="preview-col">
  <div class="preview-header">LIVE PREVIEW</div>
  <iframe id="previewFrame"></iframe>
</div>

<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-head">
      <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–æ–ø—Ä–æ—Å–∞</h3>
      <button onclick="closeModal()" style="background:transparent; color:#666; font-size:20px">‚úï</button>
    </div>
    
    <div class="modal-body">
      <div class="row">
        <div class="col">
          <label>–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞</label>
          <select id="mType" onchange="renderOpts()">
            <option value="choice">–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä</option>
            <option value="input">–í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞</option>
          </select>
        </div>
        <div class="col">
          <label>–¢–∞–π–º–µ—Ä (—Å–µ–∫)</label>
          <div style="display:flex; gap:10px; align-items:center">
            <input type="checkbox" id="mTimerOn" onchange="toggleTimer()" style="width:20px; margin:0">
            <input type="number" id="mTimerVal" value="30" disabled>
          </div>
        </div>
      </div>

      <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</label>
      <textarea id="mText" rows="2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å..."></textarea>

      <label style="margin-top:10px">–ú–µ–¥–∏–∞ (–ö–∞—Ä—Ç–∏–Ω–∫–∞ –∏–ª–∏ –ê—É–¥–∏–æ)</label>
      <div class="media-box">
        <span style="font-size:18px">üìÅ</span>
        <span class="media-label" id="mMediaLabel">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞...</span>
        <input type="file" accept="image/*,audio/*" onchange="uploadMedia(this)">
      </div>
      <img id="mImgPrev" class="preview-media">
      <div id="mAudioPrev" style="display:none; color:var(--gold); font-size:12px; margin-top:5px">üéµ –ê—É–¥–∏–æ —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω</div>
      <button onclick="clearMedia()" style="background:transparent; color:#ef4444; font-size:11px; margin-top:5px">–£–¥–∞–ª–∏—Ç—å –º–µ–¥–∏–∞</button>

      <div style="margin-top:20px; padding-top:15px; border-top:1px solid #333">
        <div id="mOptsArea"></div>
      </div>
    </div>

    <div class="modal-foot">
      <button class="btn-gold" onclick="saveQ()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!</div>

<script id="gameTemplate" type="text/plain">
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<style>
  body{margin:0;overflow:hidden;background:#000;font-family:'Segoe UI',sans-serif;color:#f3e5ab;user-select:none;}
  canvas{display:block;width:100%;height:100%;}
  
  /* HUD */
  #hud{position:absolute;top:20px;left:20px;right:20px;display:flex;justify-content:space-between;pointer-events:none;z-index:10;}
  .pill{
    background:rgba(15, 18, 25, 0.9); border:1px solid #d4af37; color:#d4af37; 
    padding:10px 20px; border-radius:30px; font-weight:800; font-size:14px; 
    text-transform:uppercase; letter-spacing:1px; box-shadow:0 0 15px rgba(212,175,55,0.2);
  }
  
  /* OVERLAY */
  #overlay{position:absolute;inset:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;z-index:20;pointer-events:auto;}
  #card{
    width:90%; max-width:500px; background:#0f1219; padding:30px; border-radius:20px; 
    border:2px solid #d4af37; text-align:center; box-shadow:0 0 80px rgba(212,175,55,0.2); 
    transform:scale(0.9); opacity:0; transition:0.3s; position:relative;
  }
  #card.show{transform:scale(1); opacity:1;}
  
  /* CONTENT */
  #qImg{max-width:100%; max-height:200px; border-radius:8px; margin-bottom:15px; border:1px solid #333; display:none; margin-left:auto; margin-right:auto;}
  #qText{font-size:22px; margin-bottom:25px; line-height:1.4; color:#fff; font-weight:bold;}
  
  #timerLine{width:100%; height:4px; background:#222; margin-bottom:20px; border-radius:2px; display:none; overflow:hidden;}
  #timerFill{width:100%; height:100%; background:#d4af37; transition:width 1s linear;}

  /* BUTTONS */
  .ans-btn{
    display:block; width:100%; background:linear-gradient(90deg, #1a1d26, #252836); 
    border:1px solid #444; padding:16px; color:#e2e8f0; border-radius:12px; 
    margin-bottom:10px; cursor:pointer; font-size:16px; text-align:left; transition:0.2s;
  }
  .ans-btn:hover{border-color:#d4af37; background:#2a2d38; box-shadow:0 0 15px rgba(212,175,55,0.15);}
  .ans-btn:active{transform:scale(0.98);}
  
  .inp-field{
    width:100%; padding:16px; background:#050505; border:1px solid #444; color:#d4af37; 
    border-radius:12px; margin-bottom:15px; box-sizing:border-box; font-size:18px; 
    text-align:center; font-weight:bold; outline:none;
  }
  .inp-field:focus{border-color:#d4af37;}
  
  .main-btn{
    padding:16px; width:100%; background:#d4af37; color:#000; border:none; 
    border-radius:12px; font-weight:900; font-size:16px; cursor:pointer; text-transform:uppercase;
  }
  
  #msg{height:30px; margin-top:15px; font-weight:800; font-size:20px; letter-spacing:1px;}
  
  /* SCREENS */
  #startScreen, #endScreen{position:absolute;inset:0;background:#050505;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:30;pointer-events:auto;}
  h1{margin:0 0 20px; background:linear-gradient(135deg, #d4af37, #fffbeb); -webkit-background-clip:text; color:transparent; font-size:48px; text-transform:uppercase; letter-spacing:4px;}
  
  .big-btn{
    padding:18px 60px; border-radius:60px; background:linear-gradient(90deg, #b8860b, #d4af37); 
    color:#000; border:none; font-weight:900; font-size:22px; cursor:pointer; 
    box-shadow:0 0 40px rgba(212,175,55,0.4); text-transform:uppercase; letter-spacing:2px; transition:0.3s;
  }
  .big-btn:hover{transform:scale(1.05); filter:brightness(1.1);}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="c"></canvas>
  
  <div id="hud">
    <div class="pill">–≠—Ç–∞–∂: <span id="hTxt">0</span></div>
    <div class="pill">–°—á—ë—Ç: <span id="sTxt">0</span></div>
  </div>
  
  <div id="overlay">
    <div id="card">
      <div id="timerLine"><div id="timerFill"></div></div>
      <img id="qImg">
      <div id="audioBox"></div>
      <div id="qText"></div>
      <div id="ansArea"></div>
      <div id="msg"></div>
    </div>
  </div>

  <div id="startScreen">
    <h1>–ë–ê–®–ù–Ø</h1>
    <p style="color:#d4af37; margin-bottom:50px; font-size:14px; text-transform:uppercase; letter-spacing:3px;">–ü–æ—Å—Ç—Ä–æ–π —Å–≤–æ–π –ø—É—Ç—å –∫ –≤–µ—Ä—à–∏–Ω–µ</p>
    <button class="big-btn" onclick="startGame()">–ù–ê–ß–ê–¢–¨</button>
  </div>

  <div id="endScreen" style="display:none">
    <h1 id="endTitle">–§–ò–ù–ê–õ</h1>
    <p style="font-size:24px; margin-bottom:40px; color:#fff">–°—á—ë—Ç: <span id="finalScore" style="color:#d4af37">0</span></p>
    <button class="big-btn" onclick="location.reload()">–ï–©–ï –†–ê–ó</button>
  </div>
</div>

<script>
// === CONFIG INJECTION ===
const CONFIG = {{CONFIG}};
// ========================

const cvs = document.getElementById("c");
const ctx = cvs.getContext("2d");
let W, H, DPR;
const IMAGES = {};
const BLOCKS = ["3.png","4.png","5.png","6.png","7.png","8.png","9.png","10.png","11.png"];

let state = { running:false, tower:[], current:null, qIdx:0, score:0, camY:0, phase:'menu', timer:null };

// --- AUTO DETECT URL ---
// –ò–≥—Ä–∞ —Å–∞–º–∞ –ø–æ–Ω–∏–º–∞–µ—Ç, –≥–¥–µ –æ–Ω–∞ –ª–µ–∂–∏—Ç, –∏ –∏—â–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Ç–∞–º –∂–µ
function getBaseUrl() {
  // –ï—Å–ª–∏ –∑–∞–¥–∞–Ω –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–æ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –¥–ª—è —Ñ–æ–Ω–∞, –Ω–æ –¥–ª—è –±–ª–æ–∫–æ–≤ –Ω—É–∂–µ–Ω –ø—É—Ç—å
  // –ë–µ—Ä–µ–º —Ç–µ–∫—É—â–∏–π URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞–∫ –±–∞–∑—É
  let path = window.location.href;
  return path.substring(0, path.lastIndexOf('/') + 1);
}

function loadImg(src) {
  return new Promise(r => {
    if(!src) { r(null); return; }
    const i = new Image();
    i.crossOrigin = "Anonymous";
    i.onload = () => r(i);
    i.onerror = () => r(null);
    i.src = src;
  });
}

async function init() {
  resize();
  const baseUrl = getBaseUrl();
  
  // –§–æ–Ω: –ª–∏–±–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π base64, –ª–∏–±–æ 1.png —Å —Ç–µ–∫—É—â–µ–≥–æ –¥–æ–º–µ–Ω–∞
  IMAGES.bg = await loadImg(CONFIG.bgUser || (baseUrl + "1.png"));
  
  // –ë–ª–æ–∫–∏: –≤—Å–µ–≥–¥–∞ —Å —Ç–µ–∫—É—â–µ–≥–æ –¥–æ–º–µ–Ω–∞
  for(let b of BLOCKS) {
    IMAGES[b] = await loadImg(baseUrl + b);
  }
}

function resize() {
  DPR = window.devicePixelRatio || 1;
  W = window.innerWidth; H = window.innerHeight;
  cvs.width = W*DPR; cvs.height = H*DPR;
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
window.onresize = resize;

function startGame() {
  document.getElementById("startScreen").style.display="none";
  state = { running:true, tower:[], current:null, qIdx:0, score:0, camY:0, phase:'spawn', timer:null };
  spawn();
  loop();
}

function spawn() {
  if(state.qIdx >= CONFIG.qs.length) { win(); return; }
  
  const w = state.tower.length ? state.tower[state.tower.length-1].w : 300;
  const imgKey = BLOCKS[state.qIdx % BLOCKS.length];
  
  state.current = {
    x: -w, y: H - 100 - (state.tower.length*60) + state.camY,
    w: w, h: 60, dir: 1, speed: 5 + (state.qIdx*0.5),
    img: IMAGES[imgKey]
  };
  state.phase = 'drop';
}

function update() {
  if(!state.running) return;
  if(state.phase === 'drop') {
    const b = state.current;
    b.x += b.speed * b.dir;
    if(b.x + b.w > W && b.dir > 0) b.dir = -1;
    if(b.x < 0 && b.dir < 0) b.dir = 1;
  }
  state.camY += (Math.max(0, (state.tower.length*60)-(H*0.4)) - state.camY)*0.1;
}

function draw() {
  // BG
  if(IMAGES.bg) {
    const s = Math.max(W/IMAGES.bg.width, H/IMAGES.bg.height);
    ctx.drawImage(IMAGES.bg, (W-IMAGES.bg.width*s)/2, (H-IMAGES.bg.height*s)/2, IMAGES.bg.width*s, IMAGES.bg.height*s);
  } else {
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,"#050505"); g.addColorStop(1,"#0f1219");
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
  }

  ctx.save();
  ctx.translate(0, state.camY);
  
  // Base
  ctx.fillStyle="#333"; ctx.fillRect((W-300)/2, H-100, 300, 20);

  // Tower
  state.tower.forEach(b => {
    if(b.img) ctx.drawImage(b.img, b.x, b.y, b.w, b.h);
    else { ctx.fillStyle="#d4af37"; ctx.fillRect(b.x,b.y,b.w,b.h); ctx.strokeStyle="#fff"; ctx.strokeRect(b.x,b.y,b.w,b.h); }
  });

  // Current
  if(state.current && state.phase==='drop') {
    const b = state.current;
    if(b.img) ctx.drawImage(b.img, b.x, b.y, b.w, b.h);
    else { ctx.fillStyle="#fff"; ctx.fillRect(b.x,b.y,b.w,b.h); }
  }
  ctx.restore();
}

function loop() {
  if(state.running) requestAnimationFrame(loop);
  update();
  draw();
}

document.addEventListener("pointerdown", (e) => {
  if(e.target.tagName==="BUTTON" || e.target.tagName==="INPUT") return;
  if(state.phase==='drop') { state.phase='wait'; showQ(); }
});

function showQ() {
  const q = CONFIG.qs[state.qIdx];
  const overlay = document.getElementById("overlay");
  const area = document.getElementById("ansArea");
  const imgEl = document.getElementById("qImg");
  const audioDiv = document.getElementById("audioBox");
  const tLine = document.getElementById("timerLine");
  
  // Reset
  document.getElementById("qText").textContent = q.q;
  document.getElementById("msg").innerHTML = "";
  area.innerHTML = "";
  imgEl.style.display = "none";
  audioDiv.innerHTML = "";
  tLine.style.display = "none";
  
  // Media
  if(q.media) {
    if(q.media.startsWith("data:audio")) {
      audioDiv.innerHTML = `<audio controls autoplay src="${q.media}" style="width:100%; margin-bottom:15px"></audio>`;
    } else {
      imgEl.src = q.media;
      imgEl.style.display = "block";
    }
  }

  // Timer
  if(q.timer && q.timer > 0) {
    tLine.style.display = "block";
    document.getElementById("timerFill").style.width = "100%";
    let timeLeft = q.timer;
    state.timer = setInterval(() => {
      timeLeft--;
      document.getElementById("timerFill").style.width = (timeLeft / q.timer * 100) + "%";
      if(timeLeft <= 0) {
        clearInterval(state.timer);
        fail("–í—Ä–µ–º—è –≤—ã—à–ª–æ!");
      }
    }, 1000);
  }

  overlay.style.display = "flex";
  setTimeout(()=>document.getElementById("card").classList.add("show"), 10);

  // Options
  if(q.type==='choice') {
    q.o.forEach(opt => {
      const b = document.createElement("button");
      b.className="ans-btn"; b.textContent=opt;
      b.onclick = ()=>check(opt);
      area.appendChild(b);
    });
  } else {
    const i = document.createElement("input");
    i.className="inp-field"; i.placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç...";
    const b = document.createElement("button");
    b.className="main-btn"; b.textContent="–ü–†–û–í–ï–†–ò–¢–¨";
    b.onclick = ()=>check(i.value);
    area.appendChild(i); area.appendChild(b);
  }
}

function check(val) {
  if(state.timer) clearInterval(state.timer);
  
  const q = CONFIG.qs[state.qIdx];
  let ok = false;
  if(Array.isArray(q.a)) ok = q.a.some(x => x.toLowerCase().trim() === String(val).toLowerCase().trim());
  else ok = String(q.a).toLowerCase().trim() === String(val).toLowerCase().trim();

  const msg = document.getElementById("msg");
  if(ok) {
    msg.style.color="#4ade80"; msg.textContent="–í–ï–†–ù–û!";
    setTimeout(()=>{
      document.getElementById("card").classList.remove("show");
      document.getElementById("overlay").style.display="none";
      land();
    }, 1000);
  } else {
    msg.style.color="#ef4444"; msg.textContent="–û–®–ò–ë–ö–ê!";
    setTimeout(()=>{ fail("–ë–∞—à–Ω—è —Ä—É—Ö–Ω—É–ª–∞!"); }, 1200);
  }
}

function land() {
  const b = state.current;
  const prev = state.tower.length ? state.tower[state.tower.length-1] : {x:(W-300)/2, w:300};
  const l = Math.max(b.x, prev.x);
  const r = Math.min(b.x+b.w, prev.x+prev.w);
  const w = r-l;
  if(w>0) {
    b.x=l; b.w=w; state.tower.push(b);
    state.score+=100;
    document.getElementById("sTxt").textContent=state.score;
    document.getElementById("hTxt").textContent=state.tower.length;
    state.qIdx++; spawn();
  } else fail("–ü—Ä–æ–º–∞—Ö!");
}

function fail(txt) {
  state.running=false;
  document.getElementById("overlay").style.display="none";
  document.getElementById("finalScore").textContent=state.score;
  const end = document.getElementById("endScreen");
  end.style.display="flex";
  document.getElementById("endTitle").innerText = "–ù–ï–£–î–ê–ß–ê";
}

function win() {
  state.running=false;
  document.getElementById("overlay").style.display="none";
  document.getElementById("finalScore").textContent=state.score;
  document.getElementById("endScreen").style.display="flex";
  document.getElementById("endTitle").innerText = "–ü–û–ë–ï–î–ê!";
}

init();
</script>
</body>
</html>
</script>

<script>
// ==========================================
// –õ–û–ì–ò–ö–ê –†–ï–î–ê–ö–¢–û–†–ê
// ==========================================
let config = { bgUser: null, qs: [] }; // –°—Ç–∞—Ä—Ç—É–µ–º —Å –ø—É—Å—Ç—ã–º —Å–ø–∏—Å–∫–æ–º
let editId = null;
let tempMedia = null; 

function init() { renderList(); updatePreview(); }

// 1. –ü–†–ï–í–¨–Æ
function updatePreview() {
  const tmpl = document.getElementById("gameTemplate").textContent;
  const html = tmpl.replace("{{CONFIG}}", JSON.stringify(config));
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º BLOB URL - —Ä–∞–±–æ—Ç–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∏ –±–µ–∑ –æ—à–∏–±–æ–∫
  const blob = new Blob([html], {type: 'text/html'});
  document.getElementById("previewFrame").src = URL.createObjectURL(blob);
}

// 2. –§–û–ù
function uploadBg(inp) {
  const f = inp.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = e => { 
    config.bgUser = e.target.result; 
    document.getElementById("bgName").innerText = "–ó–∞–≥—Ä—É–∂–µ–Ω: " + f.name;
    document.getElementById("bgName").style.color = "#d4af37";
    updatePreview(); 
  };
  r.readAsDataURL(f);
}
function clearBg() {
  config.bgUser = null;
  document.getElementById("bgName").innerText = "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (—Å GitHub)";
  document.getElementById("bgName").style.color = "#94a3b8";
  updatePreview();
}

// 3. –í–û–ü–†–û–°–´
function renderList() {
  const l = document.getElementById("qList"); l.innerHTML = "";
  document.getElementById("qCount").textContent = config.qs.length;
  
  if(config.qs.length === 0) {
    l.innerHTML = "<div style='text-align:center; color:#444; font-size:12px; padding:20px'>–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>";
    return;
  }

  config.qs.forEach((q, i) => {
    const d = document.createElement("div"); d.className = "q-item";
    let typeTxt = q.type === 'choice' ? '–í–´–ë–û–†' : '–í–í–û–î';
    d.innerHTML = `
      <div class="q-info">
        <span class="q-type">${typeTxt}</span>
        <span class="q-text">${q.q}</span>
      </div>
      <div>
        <button class="icon-btn" onclick="editQ(${i})">‚úèÔ∏è</button>
        <button class="icon-btn del" onclick="delQ(${i})">üóë</button>
      </div>
    `;
    l.appendChild(d);
  });
}

// --- –ú–û–î–ê–õ–ö–ê ---
function openModal() { 
  editId=null; 
  document.getElementById("modal").style.display="flex"; 
  document.getElementById("mText").value="";
  tempMedia = null;
  document.getElementById("mTimerOn").checked = false;
  toggleTimer();
  renderMediaUI();
  renderOpts(); 
}
function closeModal() { document.getElementById("modal").style.display="none"; }

function toggleTimer() {
  document.getElementById("mTimerVal").disabled = !document.getElementById("mTimerOn").checked;
}

function uploadMedia(inp) {
  const f = inp.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = e => { tempMedia = e.target.result; renderMediaUI(); };
  r.readAsDataURL(f);
}
function clearMedia() { tempMedia = null; renderMediaUI(); }

function renderMediaUI() {
  const lbl = document.getElementById("mMediaLabel");
  const img = document.getElementById("mImgPrev");
  const aud = document.getElementById("mAudioPrev");
  
  if(!tempMedia) {
    lbl.innerText = "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª..."; lbl.style.color="#aaa";
    img.style.display="none"; aud.style.display="none";
  } else {
    lbl.innerText = "–§–∞–π–ª –≤—ã–±—Ä–∞–Ω"; lbl.style.color="#4ade80";
    if(tempMedia.startsWith("data:image")) {
      img.src = tempMedia; img.style.display="block"; aud.style.display="none";
    } else {
      img.style.display="none"; aud.style.display="block";
    }
  }
}

function renderOpts() {
  const t = document.getElementById("mType").value;
  const c = document.getElementById("mOptsArea"); c.innerHTML="";
  
  if(t==="choice") {
    c.innerHTML = `
      <div style="display:flex; justify-content:space-between; margin-bottom:10px">
        <label>–í–ê–†–ò–ê–ù–¢–´ –û–¢–í–ï–¢–û–í</label>
        <button class="btn-small" onclick="addOpt()">+ –î–û–ë–ê–í–ò–¢–¨</button>
      </div>
      <div id="optsList"></div>
    `;
    if(editId===null) { addOpt(); addOpt(); } // Default 2 rows
  } else {
    c.innerHTML=`<label>–ü–†–ê–í–ò–õ–¨–ù–´–ô –û–¢–í–ï–¢ (–ò–õ–ò –ù–ï–°–ö–û–õ–¨–ö–û –ß–ï–†–ï–ó –ó–ê–ü–Ø–¢–£–Æ)</label><input type="text" id="mInp">`;
  }
}

function addOpt(val="", isOk=false) {
  const list = document.getElementById("optsList");
  if(!list) return;
  const d = document.createElement("div"); d.className="opt-row";
  d.innerHTML = `
    <div class="radio-wrap"><input type="radio" name="ok" ${isOk?'checked':''}></div>
    <input type="text" class="opt-val" value="${val}" placeholder="–û—Ç–≤–µ—Ç" style="margin:0">
    <button class="icon-btn del" onclick="this.parentElement.remove()">‚úï</button>
  `;
  list.appendChild(d);
}

function editQ(i) {
  editId=i; const q=config.qs[i];
  document.getElementById("modal").style.display="flex";
  document.getElementById("mText").value=q.q;
  document.getElementById("mType").value=q.type;
  
  if(q.timer) {
    document.getElementById("mTimerOn").checked = true;
    document.getElementById("mTimerVal").value = q.timer;
  } else {
    document.getElementById("mTimerOn").checked = false;
  }
  toggleTimer();

  tempMedia = q.media || null;
  renderMediaUI();
  renderOpts();
  
  if(q.type==='choice') {
    document.getElementById("optsList").innerHTML="";
    q.o.forEach(opt => addOpt(opt, q.a.includes(opt)));
  } else {
    document.getElementById("mInp").value = q.a.join(", ");
  }
}

function saveQ() {
  const qTxt = document.getElementById("mText").value;
  const type = document.getElementById("mType").value;
  if(!qTxt) return;
  
  let o = { type:type, q:qTxt, a:[], media: tempMedia, timer: 0 };
  
  if(document.getElementById("mTimerOn").checked) {
    o.timer = parseInt(document.getElementById("mTimerVal").value) || 30;
  }

  if(type==='choice') {
    o.o = [];
    document.querySelectorAll(".opt-row").forEach(r=>{
      const val = r.querySelector(".opt-val").value;
      if(val) { 
        o.o.push(val); 
        if(r.querySelector("input[type=radio]").checked) o.a.push(val); 
      }
    });
    if(!o.a.length) { alert("–û—Ç–º–µ—Ç—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç!"); return; }
  } else {
    o.a = document.getElementById("mInp").value.split(",").map(x=>x.trim()).filter(Boolean);
  }
  
  if(editId!==null) config.qs[editId]=o; else config.qs.push(o);
  closeModal(); renderList(); updatePreview();
}

function delQ(i) { config.qs.splice(i,1); renderList(); updatePreview(); }

// 4. –ì–ï–ù–ï–†–ê–¶–ò–Ø –î–õ–Ø GENIALLY
function generateCode() {
  const tmpl = document.getElementById("gameTemplate").textContent;
  const html = tmpl.replace("{{CONFIG}}", JSON.stringify(config));
  const b64 = btoa(unescape(encodeURIComponent(html)));
  const embed = `<iframe src="data:text/html;base64,${b64}" width="100%" height="600" style="border:0"></iframe>`;
  
  navigator.clipboard.writeText(embed).then(() => {
    const t = document.getElementById("toast");
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"),2000);
  });
}

init();
</script>
</body>
</html>
