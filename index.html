<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ë–∞—à–Ω—è ‚Äî Editor + Game (–æ–¥–∏–Ω —Ñ–∞–π–ª) [v13-20260210-054618]</title>

  <style>
    html, body{height:100%}

    :root{
      --text:#eaf0ff;
      --muted:#a9b6e6;
      --border: rgba(255,255,255,.10);
      --shadow2: 0 12px 34px rgba(0,0,0,.40);
      --radius: 18px;
      --radius2: 22px;

      --neon:#d6b14a;
      --neon2:#f2d37a;
      --danger:#ff4d4d;
      --ok:#2dd27d;
    }

    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    body{
      margin:0;color:var(--text);
      background:
        radial-gradient(1100px 700px at 12% 18%, rgba(35,82,200,.28) 0%, rgba(5,8,22,0) 58%),
        radial-gradient(900px 640px at 88% 16%, rgba(20,160,255,.18) 0%, rgba(5,8,22,0) 62%),
        radial-gradient(1000px 780px at 55% 112%, rgba(214,177,74,.14) 0%, rgba(5,8,22,0) 58%),
        linear-gradient(180deg, rgba(4,10,32,.92), rgba(3,6,18,1));
      min-height:100vh;
    }
    body.gameOnly{background:transparent}

    .app{
      display:grid;
      grid-template-columns: 460px 1fr;
      gap:14px;
      padding:14px;
      max-width: 1540px;
      margin: 0 auto;
    }
    @media (max-width: 1020px){
      .app{grid-template-columns:1fr}
    }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid var(--border);
      border-radius:var(--radius2);
      box-shadow:var(--shadow2);
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
    }

    .panel-header{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .panel-header .h{font-weight:950;letter-spacing:.2px}
    .panel-body{padding:14px}

    .settings{
      height: calc(100vh - 28px);
      display:flex;
      flex-direction:column;
      min-height: 560px;
    }
    .settings .panel-body{
      overflow:auto;
      padding:14px;
    }

    [data-section="timer"]{display:none !important}
    [data-hide="blocks"]{display:none !important}

    .section{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      margin-bottom:12px;
    }
    .section .title{
      font-weight:950;
      font-size:13.5px;
      margin-bottom:10px;
      color:rgba(255,255,255,.92);
      display:flex;align-items:center;justify-content:space-between;gap:8px;
    }

    .muted{color:var(--muted); font-size:12.5px; line-height:1.35}

    label{
      display:block;
      font-size:12.5px;
      color:rgba(255,255,255,.86);
      margin:10px 0 6px
    }

    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      border-radius:14px;
      padding:10px 11px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:84px; resize:vertical}

    input[type="file"]{
      width:100%;
      border-radius:14px;
      padding:10px 11px;
      border:1px dashed rgba(255,255,255,.22);
      background:rgba(0,0,0,.18);
      color:var(--muted);
    }

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1; min-width:170px}

    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      margin-top:8px;
    }
    .toggle input{width:18px; height:18px}

    .btn{
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-weight:950;
      font-size:14px;
      transition:transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .2s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.24)}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.45; cursor:not-allowed}

    .btn.primary{
      background:linear-gradient(90deg, rgba(214,177,74,.35), rgba(242,211,122,.22));
      border-color:rgba(214,177,74,.40);
      box-shadow: 0 10px 26px rgba(214,177,74,.18);
    }
    .btn.danger{border-color:rgba(255,77,77,.35); background:rgba(255,77,77,.08)}
    .btn.small{padding:8px 10px; font-size:12.5px; border-radius:12px}

    .q-list{display:flex; flex-direction:column; gap:10px;}
    .q-item{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .q-item .meta{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
      padding-top:3px;
    }
    .q-item .meta .t{
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis
    }
    .q-item .meta .s{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(255,255,255,.92);
    }

    .preview{
      min-height: calc(100vh - 28px);
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:0;
      overflow:hidden;
    }
    .preview-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
    }
    .preview-top .name{font-weight:950; letter-spacing:.2px}
    .preview-top .hint{color:var(--muted); font-size:12.5px}

    .preview-stage{
      position:relative;
      border-radius:var(--radius2);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      min-height: 720px; height: calc(100vh - 120px);
      background:rgba(0,0,0,.18);
      box-shadow: var(--shadow2);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 24px rgba(0,0,0,.3);
      z-index:99999;
      opacity:0;
      transition:opacity .2s ease-in-out;
      font-weight:900;
    }
    .toast.show{opacity:1}

    .modal{
      display:none; position:fixed; inset:0;
      background:rgba(0,0,0,.70);
      backdrop-filter: blur(6px);
      z-index:1000;
      align-items:center;
      justify-content:center;
      padding:20px;
      overflow-y:auto;
    }
    .modal.show{display:flex}
    .modal-box{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid var(--border);
      border-radius:var(--radius2);
      box-shadow:var(--shadow2);
      max-width: 700px;
      width:100%;
      max-height: 95vh;
      overflow-y:auto;
      position:relative;
    }
    .modal-header{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      font-weight:950;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modal-body{padding:16px}
    .modal-footer{
      padding:14px 16px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      gap:10px;
      justify-content:flex-end;
    }

    .sep{border-top:1px solid rgba(255,255,255,.10); margin: 12px 0}

    .modal-preview{
      background:rgba(0,0,0,.15);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px;
      margin-top:10px;
      color:var(--muted);
      font-size:12.5px;
    }
  </style>
</head>

<body>
  <div class="toast" id="toastEl"></div>

  <!-- editor view -->
  <div id="editorRoot">
    <div class="app">
      <div class="panel settings">
        <div class="panel-header">
          <div class="h">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        </div>
        <div class="panel-body">

          <div class="section">
            <div class="title">–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã</div>
            <input id="inpTitle" type="text" placeholder="–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π" />
          </div>

          <div class="section" data-section="timer">
            <div class="title">–¢–∞–π–º–µ—Ä –Ω–∞ –≤–æ–ø—Ä–æ—Å</div>
            <div class="toggle">
              <input id="chkTimer" type="checkbox">
              <label for="chkTimer" style="margin:0">–í–∫–ª—é—á–∏—Ç—å —Ç–∞–π–º–µ—Ä</label>
            </div>
            <label>–°–µ–∫—É–Ω–¥—ã</label>
            <input id="inpSeconds" type="number" placeholder="30" min="5" value="30" />
          </div>

          <div class="section" data-hide="blocks">
            <div class="title">–ö–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–∞ –±–ª–æ–∫–∞—Ö</div>
            <div class="toggle">
              <input id="chkUseImages" type="checkbox" checked>
              <label for="chkUseImages" style="margin:0">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–∞ –±–ª–æ–∫–∞—Ö</label>
            </div>
          </div>

          <div class="section">
            <div class="title">–í–æ–ø—Ä–æ—Å—ã <span style="color:var(--muted);font-weight:400" id="qCount">(0)</span></div>
            <div id="qList" class="q-list"></div>
            <button id="btnAddQ" class="btn primary" style="margin-top:12px; width:100%">+ –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
          </div>

          <div class="section">
            <div class="title">
              <span>–≠–∫—Å–ø–æ—Ä—Ç –∏–≥—Ä—ã</span>
            </div>
            <p class="muted" style="margin:0 0 10px">
              –°–∫–∞—á–∞–π—Ç–µ –∏–≥—Ä—É –æ—Ç–¥–µ–ª—å–Ω—ã–º HTML-—Ñ–∞–π–ª–æ–º –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–ª–∏ –≤—Å—Ç–∞–≤–∫–∏ –≤ Genially.
            </p>
            <button id="btnDownloadGame" class="btn" style="width:100%">
              ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å HTML
            </button>
          </div>

          <div class="section">
            <div class="title">–≠–∫—Å–ø–æ—Ä—Ç –≤ Genially</div>
            <p class="muted" style="margin:0 0 10px">
              –°–∫–æ–ø–∏—Ä—É–π—Ç–µ iframe-–∫–æ–¥ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ Genially —á–µ—Ä–µ–∑ ¬´Embed¬ª.
            </p>
            <button id="btnCopyCode" class="btn" style="width:100%">
              üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å iframe
            </button>
          </div>

        </div>
      </div>

      <div class="panel preview">
        <div class="preview-top">
          <div class="name">–ü—Ä–µ–≤—å—é</div>
          <div class="hint">–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–Ω—ã —Å—Ä–∞–∑—É</div>
        </div>
        <div class="preview-stage" id="previewFrame"></div>
      </div>
    </div>
  </div>

  <!-- question editor modal -->
  <div id="modalBackdrop" class="modal">
    <div class="modal-box">
      <div class="modal-header">
        <div>–†–µ–¥–∞–∫—Ç–æ—Ä –≤–æ–ø—Ä–æ—Å–∞</div>
        <button id="btnCloseModal" class="btn small" style="padding:6px 10px">‚úï</button>
      </div>
      <div class="modal-body">

        <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</label>
        <textarea id="inpQText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞..."></textarea>

        <label style="margin-top:12px">–ú–µ–¥–∏–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
          <button id="btnPickQImage" class="btn small">üñº –ö–∞—Ä—Ç–∏–Ω–∫–∞</button>
          <button id="btnPickQAudio" class="btn small">üéµ –ó–≤—É–∫</button>
        </div>
        <input id="fileQImage" type="file" accept="image/*" style="display:none">
        <input id="fileQAudio" type="file" accept="audio/*" style="display:none">
        <div id="qMediaPreview" class="modal-preview">–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ.</div>

        <div class="sep"></div>

        <label>–¢–∏–ø –æ—Ç–≤–µ—Ç–∞</label>
        <select id="selType">
          <option value="choice">–í—ã–±–æ—Ä –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (choice)</option>
          <option value="text">–¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç (text)</option>
        </select>

        <div id="choicePanel" style="display:none; margin-top:12px">
          <label>–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞</label>
          <div id="choiceList"></div>
          <button id="btnAddChoice" class="btn small" style="margin-top:8px">+ –ï—â—ë –≤–∞—Ä–∏–∞–Ω—Ç</button>
        </div>

        <div id="textPanel" style="display:none; margin-top:12px">
          <label>–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–ª—é–±–æ–π –ø–æ–¥—Ö–æ–¥–∏—Ç)</label>
          <div id="textList"></div>
          <button id="btnAddText" class="btn small" style="margin-top:8px">+ –ï—â—ë –≤–∞—Ä–∏–∞–Ω—Ç</button>
        </div>

        <div class="sep"></div>

        <label>–ë–∞–ª–ª–æ–≤ –∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</label>
        <input id="inpPoints" type="number" placeholder="10" min="1" value="10" />

      </div>
      <div class="modal-footer">
        <button id="btnPreviewDraft" class="btn">üëÅ –ü—Ä–µ–≤—å—é</button>
        <button id="btnSaveQ" class="btn primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- iframe code modal -->
  <div id="codeBackdrop" class="modal">
    <div class="modal-box">
      <div class="modal-header">
        <div>iframe-–∫–æ–¥ –¥–ª—è Genially</div>
        <button id="btnCloseCode" class="btn small" style="padding:6px 10px">‚úï</button>
      </div>
      <div class="modal-body">
        <p class="muted" style="margin:0 0 10px">
          –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –Ω–∏–∂–µ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ Genially —á–µ—Ä–µ–∑ –±–ª–æ–∫ ¬´Embed¬ª.
        </p>
        <textarea id="taIframe" readonly style="min-height:150px; font-family:monospace; font-size:12px"></textarea>
      </div>
      <div class="modal-footer">
        <button id="btnCopyFromModal" class="btn primary">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- standalone game view -->
  <div id="gameRoot" style="display:none">
    <div id="gameHost"></div>
  </div>

<script>
(() => {

  const $ = (id) => document.getElementById(id);

  // ======== EDITOR STATE ========
  const Editor = {
    title: "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π",
    questions: [],
    draft: null,
    editingId: null,
    timer: { enabled: false, seconds: 30 },
    useImages: true,
    useRepoBg: true,
  };

  // ======== HELPERS ========
  function toast(msg){
    const t = $("toastEl");
    if(!t) return;
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }

  function showErr(msg){
    const el = document.createElement("div");
    el.style.cssText = "position:fixed;top:20px;left:20px;background:#ff4d4d;color:#fff;padding:14px;border-radius:12px;z-index:99999;max-width:500px;font-weight:900";
    el.textContent = "ERROR: " + msg;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(), 5000);
  }

  function parseQueryParams(){
    const obj = {};
    const s = window.location.search.slice(1);
    if(!s) return obj;
    s.split("&").forEach(p=>{
      const [k, v] = p.split("=");
      if(k) obj[decodeURIComponent(k)] = decodeURIComponent(v || "");
    });
    return obj;
  }
  function parseHashParams(){
    const obj = {};
    const h = window.location.hash.slice(1);
    if(!h) return obj;
    h.split("&").forEach(p=>{
      const [k, v] = p.split("=");
      if(k) obj[decodeURIComponent(k)] = decodeURIComponent(v || "");
    });
    return obj;
  }

  function b64urlEncode(s){
    return btoa(unescape(encodeURIComponent(s))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
  }
  function b64urlDecode(s){
    s = s.replace(/-/g,"+").replace(/_/g,"/");
    while(s.length % 4) s+="=";
    return decodeURIComponent(escape(atob(s)));
  }

  async function copyToClipboard(text){
    if(navigator.clipboard && navigator.clipboard.writeText){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        return false;
      }
    }
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.cssText = "position:fixed;top:-999px;left:-999px";
    document.body.appendChild(ta);
    ta.select();
    const ok = document.execCommand("copy");
    ta.remove();
    return ok;
  }

  function fileToDataUrl(file){
    return new Promise((res,rej)=>{
      const r = new FileReader();
      r.onload = ()=>res(r.result);
      r.onerror = ()=>rej(new Error("file read failed"));
      r.readAsDataURL(file);
    });
  }

  // ======== VALIDATION ========
  function validateQuestion(q){
    if(!q.text || !q.text.trim()) return "–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º";
    if(q.type === "choice"){
      if(!q.options || q.options.length < 2) return "–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞";
      if(!q.options.some(o=>o.trim())) return "–•–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω";
      if(q.correct == null || q.correct < 0) return "–ù–µ –≤—ã–±—Ä–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç";
    } else if(q.type === "text"){
      if(!q.accepts || q.accepts.length === 0) return "–ù—É–∂–Ω–æ —Ö–æ—Ç—è –±—ã 1 –≤–æ–∑–º–æ–∂–Ω—ã–π –æ—Ç–≤–µ—Ç";
      if(!q.accepts.some(a=>a.trim())) return "–•–æ—Ç—è –±—ã –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω";
    }
    return null;
  }

  // ======== MODAL ========
  function showModal(){
    if(!$("modalBackdrop")) return;
    $("modalBackdrop").classList.add("show");
    $("modalBackdrop").setAttribute("aria-hidden","false");
  }
  function hideModal(){
    if(!$("modalBackdrop")) return;
    $("modalBackdrop").classList.remove("show");
    $("modalBackdrop").setAttribute("aria-hidden","true");
  }

  function openNewQuestion(){
    // –í–ê–ñ–ù–û: –æ—á–∏—â–∞–µ–º draft –∏ –º–µ–¥–∏–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    Editor.draft = {
      id: Date.now(),
      type: "choice",
      text: "",
      options: ["",""],
      correct: 0,
      points: 10,
      // –û—á–∏—â–∞–µ–º –º–µ–¥–∏–∞
      imgDataUrl: null,
      audioDataUrl: null
    };
    Editor.editingId = null;
    
    // –û—á–∏—â–∞–µ–º file inputs
    if($("fileQImage")) $("fileQImage").value = "";
    if($("fileQAudio")) $("fileQAudio").value = "";
    
    fillModalFromDraft();
    showModal();
  }

  function openEditQuestion(qid){
    const q = Editor.questions.find(x=>x.id === qid);
    if(!q) return;
    Editor.draft = JSON.parse(JSON.stringify(q));
    Editor.editingId = qid;
    
    // –û—á–∏—â–∞–µ–º file inputs –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    if($("fileQImage")) $("fileQImage").value = "";
    if($("fileQAudio")) $("fileQAudio").value = "";
    
    fillModalFromDraft();
    showModal();
  }

  function fillModalFromDraft(){
    const q = Editor.draft;
    if(!q) return;
    $("inpQText").value = q.text || "";
    $("inpPoints").value = q.points || 10;
    $("selType").value = q.type || "choice";
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é –º–µ–¥–∏–∞
    updateMediaPreview();
    
    toggleTypePanel();
    if(q.type === "choice"){
      q.options = q.options || ["",""];
      renderChoiceUI();
    } else {
      q.accepts = q.accepts || [""];
      renderTextUI();
    }
  }

  function updateMediaPreview(){
    if(!$("qMediaPreview")) return;
    const q = Editor.draft;
    if(!q) return;
    
    const parts = [];
    if(q.imgDataUrl) parts.push("üñº –∫–∞—Ä—Ç–∏–Ω–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞");
    if(q.audioDataUrl) parts.push("üéµ –∑–≤—É–∫ –¥–æ–±–∞–≤–ª–µ–Ω");
    $("qMediaPreview").textContent = parts.length ? parts.join(" ‚Ä¢ ") : "–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ.";
  }

  function getDraftFromModal(){
    const q = Editor.draft || {};
    q.text = $("inpQText").value || "";
    q.points = Number($("inpPoints").value || 10);
    q.type = $("selType").value || "choice";
    if(q.type === "choice"){
      q.options = [];
      const els = Array.from(document.querySelectorAll("#choiceList input[type='text']"));
      els.forEach(e=>q.options.push(e.value));
      const rad = document.querySelector("#choiceList input[type='radio']:checked");
      q.correct = rad ? Number(rad.value) : 0;
    } else {
      q.accepts = [];
      const els = Array.from(document.querySelectorAll("#textList input[type='text']"));
      els.forEach(e=>q.accepts.push(e.value));
    }
    Editor.draft = q;
    return q;
  }

  function toggleTypePanel(){
    const t = $("selType").value;
    $("choicePanel").style.display = (t === "choice") ? "block" : "none";
    $("textPanel").style.display = (t === "text") ? "block" : "none";
  }

  function renderChoiceUI(){
    const q = Editor.draft;
    if(!q || !q.options) return;
    const cont = $("choiceList");
    cont.innerHTML = "";
    q.options.forEach((opt, i)=>{
      const div = document.createElement("div");
      div.style.cssText = "display:flex;gap:8px;margin-bottom:8px;align-items:center";
      const rad = document.createElement("input");
      rad.type = "radio";
      rad.name = "correctChoice";
      rad.value = i;
      rad.checked = (i === q.correct);
      const inp = document.createElement("input");
      inp.type = "text";
      inp.value = opt;
      inp.placeholder = `–í–∞—Ä–∏–∞–Ω—Ç ${i+1}`;
      inp.style.flex = "1";
      const btnDel = document.createElement("button");
      btnDel.className = "btn small danger";
      btnDel.textContent = "‚úï";
      btnDel.addEventListener("click", ()=>{
        q.options.splice(i, 1);
        if(q.correct >= q.options.length) q.correct = Math.max(0, q.options.length - 1);
        renderChoiceUI();
      });
      div.appendChild(rad);
      div.appendChild(inp);
      if(q.options.length > 2) div.appendChild(btnDel);
      cont.appendChild(div);
    });
  }

  function renderTextUI(){
    const q = Editor.draft;
    if(!q || !q.accepts) return;
    const cont = $("textList");
    cont.innerHTML = "";
    q.accepts.forEach((val, i)=>{
      const div = document.createElement("div");
      div.style.cssText = "display:flex;gap:8px;margin-bottom:8px;align-items:center";
      const inp = document.createElement("input");
      inp.type = "text";
      inp.value = val;
      inp.placeholder = `–û—Ç–≤–µ—Ç ${i+1}`;
      inp.style.flex = "1";
      const btnDel = document.createElement("button");
      btnDel.className = "btn small danger";
      btnDel.textContent = "‚úï";
      btnDel.addEventListener("click", ()=>{
        q.accepts.splice(i, 1);
        renderTextUI();
      });
      div.appendChild(inp);
      if(q.accepts.length > 1) div.appendChild(btnDel);
      cont.appendChild(div);
    });
  }

  // ======== QUESTIONS LIST ========
  function renderList(){
    const cont = $("qList");
    if(!cont) return;
    cont.innerHTML = "";
    if(Editor.questions.length === 0){
      cont.innerHTML = `<div class="muted" style="text-align:center;padding:16px">–ü–æ–∫–∞ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤</div>`;
    } else {
      Editor.questions.forEach((q, idx)=>{
        const div = document.createElement("div");
        div.className = "q-item";

        const meta = document.createElement("div");
        meta.className = "meta";
        const t = document.createElement("div");
        t.className = "t";
        t.textContent = q.text || "(–±–µ–∑ —Ç–µ–∫—Å—Ç–∞)";
        const s = document.createElement("div");
        s.className = "s";
        s.textContent = `${q.type} ‚Ä¢ ${q.points || 0} –±–∞–ª–ª–æ–≤`;
        meta.appendChild(t);
        meta.appendChild(s);

        const acts = document.createElement("div");
        acts.style.cssText = "display:flex;gap:6px";

        const btnEdit = document.createElement("button");
        btnEdit.className = "btn small";
        btnEdit.textContent = "‚úèÔ∏è";
        btnEdit.addEventListener("click", ()=>openEditQuestion(q.id));

        const btnDel = document.createElement("button");
        btnDel.className = "btn small danger";
        btnDel.textContent = "üóë";
        btnDel.addEventListener("click", ()=>{
          if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å?")){
            Editor.questions.splice(idx, 1);
            renderList();
            updatePreview(false);
            toast("–í–æ–ø—Ä–æ—Å —É–¥–∞–ª—ë–Ω");
          }
        });

        acts.appendChild(btnEdit);
        acts.appendChild(btnDel);

        div.appendChild(meta);
        div.appendChild(acts);
        cont.appendChild(div);
      });
    }
    if($("qCount")) $("qCount").textContent = `(${Editor.questions.length})`;
  }

  // ======== PREVIEW ========
  function buildPayload(includeDraft){
    const payload = {
      title: Editor.title || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π",
      timer: Editor.timer,
      useImages: Editor.useImages,
      useRepoBg: Editor.useRepoBg,
      questions: [...Editor.questions],
    };
    if(includeDraft && Editor.draft){
      payload.questions = [...Editor.questions, Editor.draft];
    }
    return payload;
  }

  function normalizeCfg(raw){
    const cfg = {
      title: raw.title || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π",
      timer: raw.timer || { enabled: false, seconds: 30 },
      useImages: raw.useImages !== false,
      useRepoBg: raw.useRepoBg !== false,
      questions: (raw.questions || []).map(q=>({
        id: q.id || Date.now() + Math.random(),
        type: q.type || "choice",
        text: q.text || "",
        options: q.options || [],
        correct: q.correct ?? 0,
        accepts: q.accepts || [],
        points: q.points || 10,
        imgDataUrl: q.imgDataUrl || null,
        audioDataUrl: q.audioDataUrl || null,
      })),
    };
    return cfg;
  }

  function buildGameUrl(payload){
    const json = JSON.stringify(payload);
    const enc = b64urlEncode(json);
    const base = window.location.origin + window.location.pathname;
    return base + "?game=" + enc;
  }

  function buildIframeFromUrl(url){
    return `<iframe src="${url}" width="100%" height="800" frameborder="0" allowfullscreen></iframe>`;
  }

  function updatePreview(showDraft){
    Editor.title = $("inpTitle").value || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π";
    Editor.timer.enabled = $("chkTimer").checked;
    Editor.timer.seconds = Number($("inpSeconds").value || 30);
    if($("chkUseImages")) Editor.useImages = $("chkUseImages").checked;

    const payload = buildPayload(showDraft);
    const key = "livePreview_" + Date.now();
    sessionStorage.setItem(key, JSON.stringify(payload));

    const base = window.location.origin + window.location.pathname;
    const url = base + "?cfgkey=" + encodeURIComponent(key);

    const frame = $("previewFrame");
    if(!frame) return;
    frame.innerHTML = `<iframe src="${url}" style="border:none;width:100%;height:100%"></iframe>`;
  }

  // ======== GAME (injected) ========
  function injectCanvasGame(cfg){
    const host = $("gameHost");
    if(!host) return;

    const gameHtml = `
      <div id="towerGame" style="margin:0; height:100vh; display:flex; align-items:center; justify-content:center; overflow:hidden">
        <canvas id="gameCanvas" style="display:block; max-width:100%; max-height:100vh; border:none"></canvas>
      </div>
    `;
    host.innerHTML = gameHtml;

    setTimeout(()=>{
      const canvas = document.getElementById("gameCanvas");
      if(!canvas) return;
      const ctx = canvas.getContext("2d");

      let W = 900;
      let H = 700;
      canvas.width = W;
      canvas.height = H;

      const state = {
        phase: "menu",
        qi: 0,
        score: 0,
        playerAns: null,
        timer: 0,
        timerMax: cfg.timer.enabled ? cfg.timer.seconds : 0,
        audioEl: null,
      };

      const images = {};
      const audioBuffers = {};

      function loadImagesAndAudio(){
        const promises = [];
        if(cfg.useRepoBg){
          const bgImg = new Image();
          bgImg.src = "https://raw.githubusercontent.com/aeeilllmrx/bashnya/main/bg7.webp";
          images.bg = bgImg;
          promises.push(new Promise(r=>{
            bgImg.onload = ()=>r();
            bgImg.onerror = ()=>r();
          }));
        }
        if(cfg.useImages){
          for(let i = 1; i <= 12; i++){
            const img = new Image();
            img.src = `https://raw.githubusercontent.com/aeeilllmrx/bashnya/main/${i}.webp`;
            images["block"+i] = img;
            promises.push(new Promise(r=>{
              img.onload = ()=>r();
              img.onerror = ()=>r();
            }));
          }
        }

        cfg.questions.forEach((q, idx)=>{
          if(q.imgDataUrl){
            const img = new Image();
            img.src = q.imgDataUrl;
            images["q"+idx] = img;
            promises.push(new Promise(r=>{
              img.onload = ()=>r();
              img.onerror = ()=>r();
            }));
          }
        });

        return Promise.all(promises);
      }

      loadImagesAndAudio().then(()=>{
        requestAnimationFrame(loop);
      });

      function loop(){
        draw();
        requestAnimationFrame(loop);
      }

      function draw(){
        ctx.clearRect(0, 0, W, H);

        if(images.bg && images.bg.complete){
          ctx.drawImage(images.bg, 0, 0, W, H);
        } else {
          const grad = ctx.createLinearGradient(0,0,0,H);
          grad.addColorStop(0, "rgba(4,10,32,1)");
          grad.addColorStop(1, "rgba(3,6,18,1)");
          ctx.fillStyle = grad;
          ctx.fillRect(0,0,W,H);
        }

        if(state.phase === "menu"){
          drawMenu();
        } else if(state.phase === "question"){
          drawQuestion();
        } else if(state.phase === "result"){
          drawResult();
        } else if(state.phase === "finish"){
          drawFinish();
        }
      }

      function drawMenu(){
        ctx.fillStyle = "#fff";
        ctx.font = "900 48px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(cfg.title, W/2, 180);

        ctx.font = "400 18px sans-serif";
        ctx.fillStyle = "#a9b6e6";
        ctx.fillText("–ù–∞–∂–º–∏—Ç–µ –°–¢–ê–†–¢ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å", W/2, 240);

        drawButton(W/2 - 100, 300, 200, 50, "–°–¢–ê–†–¢", ()=>{
          state.phase = "question";
          state.qi = 0;
          state.score = 0;
          startQuestion();
        });
      }

      function startQuestion(){
        state.playerAns = null;
        if(cfg.timer.enabled){
          state.timer = state.timerMax;
        }
        const q = cfg.questions[state.qi];
        if(q && q.audioDataUrl){
          if(state.audioEl) state.audioEl.pause();
          state.audioEl = new Audio(q.audioDataUrl);
          state.audioEl.play().catch(e=>{});
        }
      }

      function drawQuestion(){
        const q = cfg.questions[state.qi];
        if(!q){
          state.phase = "finish";
          return;
        }

        const blocks = state.qi + 1;
        const bH = 60;
        const bW = 140;
        const startY = H - 100 - (blocks * bH);

        for(let i = 0; i < blocks; i++){
          const y = startY + (i * bH);
          const x = W/2 - bW/2;

          ctx.fillStyle = "rgba(214,177,74,0.3)";
          ctx.fillRect(x, y, bW, bH - 4);
          ctx.strokeStyle = "rgba(214,177,74,0.5)";
          ctx.lineWidth = 2;
          ctx.strokeRect(x, y, bW, bH - 4);

          if(cfg.useImages){
            const imgKey = "block" + ((i % 12) + 1);
            const img = images[imgKey];
            if(img && img.complete){
              ctx.drawImage(img, x, y, bW, bH - 4);
            }
          }
        }

        ctx.fillStyle = "#fff";
        ctx.font = "900 20px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(`–í–æ–ø—Ä–æ—Å ${state.qi + 1} –∏–∑ ${cfg.questions.length}`, W/2, 60);

        if(q.imgDataUrl){
          const qImg = images["q"+state.qi];
          if(qImg && qImg.complete){
            const maxW = 300;
            const maxH = 200;
            let iw = qImg.width;
            let ih = qImg.height;
            const ratio = Math.min(maxW/iw, maxH/ih);
            iw *= ratio;
            ih *= ratio;
            const ix = W/2 - iw/2;
            const iy = 100;
            ctx.drawImage(qImg, ix, iy, iw, ih);
            ctx.fillStyle = "#eaf0ff";
            ctx.font = "400 16px sans-serif";
            wrapText(ctx, q.text, W/2, iy + ih + 30, 700, 22);
          }
        } else {
          ctx.fillStyle = "#eaf0ff";
          ctx.font = "400 18px sans-serif";
          wrapText(ctx, q.text, W/2, 120, 700, 24);
        }

        if(cfg.timer.enabled){
          ctx.fillStyle = "#fff";
          ctx.font = "900 16px sans-serif";
          ctx.textAlign = "left";
          ctx.fillText(`‚è± ${Math.ceil(state.timer)}s`, 20, 40);
        }

        if(q.type === "choice"){
          const opts = q.options || [];
          const bY = 350;
          opts.forEach((o, i)=>{
            const x = W/2 - 160;
            const y = bY + (i * 60);
            const picked = (state.playerAns === i);
            drawButton(x, y, 320, 50, o, ()=>{
              state.playerAns = i;
              checkAnswer();
            }, picked);
          });
        } else {
          ctx.fillStyle = "#a9b6e6";
          ctx.font = "400 14px sans-serif";
          ctx.textAlign = "center";
          ctx.fillText("–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –≤ –∫–æ–Ω—Å–æ–ª—å / alert –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ", W/2, 400);
        }
      }

      function checkAnswer(){
        const q = cfg.questions[state.qi];
        let correct = false;
        if(q.type === "choice"){
          correct = (state.playerAns === q.correct);
        }
        if(correct) state.score += (q.points || 10);
        state.phase = "result";
        state.resultCorrect = correct;
        setTimeout(()=>{
          state.qi++;
          if(state.qi < cfg.questions.length){
            state.phase = "question";
            startQuestion();
          } else {
            state.phase = "finish";
          }
        }, 1500);
      }

      function drawResult(){
        const msg = state.resultCorrect ? "–ü—Ä–∞–≤–∏–ª—å–Ω–æ!" : "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!";
        ctx.fillStyle = state.resultCorrect ? "#2dd27d" : "#ff4d4d";
        ctx.font = "900 36px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(msg, W/2, H/2);
      }

      function drawFinish(){
        ctx.fillStyle = "#fff";
        ctx.font = "900 42px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!", W/2, 180);

        ctx.font = "400 24px sans-serif";
        ctx.fillStyle = "#a9b6e6";
        ctx.fillText(`–í–∞—à —Å—á—ë—Ç: ${state.score}`, W/2, 240);

        drawButton(W/2 - 100, 300, 200, 50, "–ó–∞–Ω–æ–≤–æ", ()=>{
          state.phase = "menu";
        });
      }

      function drawButton(x, y, w, h, text, onClick, active){
        const hover = isHover(x, y, w, h);
        ctx.fillStyle = active ? "rgba(214,177,74,0.4)" : (hover ? "rgba(255,255,255,0.15)" : "rgba(255,255,255,0.08)");
        ctx.fillRect(x, y, w, h);
        ctx.strokeStyle = active ? "rgba(214,177,74,0.6)" : "rgba(255,255,255,0.2)";
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, w, h);

        ctx.fillStyle = "#fff";
        ctx.font = "900 16px sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(text, x + w/2, y + h/2);

        if(hover){
          canvas.style.cursor = "pointer";
          canvas.onclick = ()=>onClick();
        }
      }

      function isHover(x, y, w, h){
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const mx = (lastMouse.x - rect.left) * scaleX;
        const my = (lastMouse.y - rect.top) * scaleY;
        return mx >= x && mx <= x + w && my >= y && my <= y + h;
      }

      const lastMouse = {x: 0, y: 0};
      canvas.addEventListener("mousemove", (e)=>{
        lastMouse.x = e.clientX;
        lastMouse.y = e.clientY;
      });

      function wrapText(ctx, text, x, y, maxW, lineH){
        const words = text.split(" ");
        let line = "";
        let yy = y;
        for(let i = 0; i < words.length; i++){
          const test = line + words[i] + " ";
          const m = ctx.measureText(test);
          if(m.width > maxW && i > 0){
            ctx.fillText(line, x, yy);
            line = words[i] + " ";
            yy += lineH;
          } else {
            line = test;
          }
        }
        ctx.fillText(line, x, yy);
      }

    }, 100);
  }

  // ======== EVENT LISTENERS ========
  $("btnAddQ").addEventListener("click", openNewQuestion);

  $("btnCloseModal").addEventListener("click", hideModal);
  $("modalBackdrop").addEventListener("click", (e)=>{
    if(e.target === $("modalBackdrop")) hideModal();
  });

  $("selType").addEventListener("change", ()=>{
    const q = Editor.draft;
    if(!q) return;
    q.type = $("selType").value;
    if(q.type === "choice"){
      q.options = q.options || ["",""];
      renderChoiceUI();
    } else {
      q.accepts = q.accepts || [""];
      renderTextUI();
    }
  });

  $("btnAddChoice").addEventListener("click", ()=>{
    const q = Editor.draft;
    if(!q) return;
    q.options = q.options || ["",""];
    q.options.push("");
    renderChoiceUI();
  });

  $("btnAddText").addEventListener("click", ()=>{
    const q = Editor.draft;
    if(!q) return;
    q.accepts = q.accepts || [""];
    q.accepts.push("");
    renderTextUI();
  });

  
  // per-question media uploads
  
  // Media icon buttons (beside the question text)
  if ($("btnPickQImage") && $("fileQImage")) {
    $("btnPickQImage").addEventListener("click", ()=> $("fileQImage").click());
  }
  if ($("btnPickQAudio") && $("fileQAudio")) {
    $("btnPickQAudio").addEventListener("click", ()=> $("fileQAudio").click());
  }

if ($("fileQImage")) {
    $("fileQImage").addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      try{
        Editor.draft = Editor.draft || {};
        Editor.draft.imgDataUrl = await fileToDataUrl(f);
        updateMediaPreview();
        toast("–ö–∞—Ä—Ç–∏–Ω–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞");
      }catch(err){ toast("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É"); }
    });
  }
  if ($("fileQAudio")) {
    $("fileQAudio").addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      try{
        Editor.draft = Editor.draft || {};
        Editor.draft.audioDataUrl = await fileToDataUrl(f);
        updateMediaPreview();
        toast("–ó–≤—É–∫ –¥–æ–±–∞–≤–ª–µ–Ω");
      }catch(err){ toast("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–≤—É–∫"); }
    });
  }

$("btnPreviewDraft").addEventListener("click", ()=>{
    getDraftFromModal();
    updatePreview(true);
    toast("–ß–µ—Ä–Ω–æ–≤–∏–∫ –ø–æ–∫–∞–∑–∞–Ω –≤ –ø—Ä–µ–≤—å—é");
  });

  $("btnSaveQ").addEventListener("click", ()=>{
    const q = getDraftFromModal();
    const err = validateQuestion(q);
    if(err){ toast(err); return; }

    if(Editor.editingId){
      const idx = Editor.questions.findIndex(x=>x.id === Editor.editingId);
      if(idx >= 0){
        q.id = Editor.editingId;
        Editor.questions[idx] = q;
        toast("–í–æ–ø—Ä–æ—Å –æ–±–Ω–æ–≤–ª—ë–Ω");
      } else {
        Editor.questions.push(q);
        toast("–í–æ–ø—Ä–æ—Å –¥–æ–±–∞–≤–ª–µ–Ω");
      }
    } else {
      Editor.questions.push(q);
      toast("–í–æ–ø—Ä–æ—Å –¥–æ–±–∞–≤–ª–µ–Ω");
    }

    Editor.draft=null; Editor.editingId=null;
    hideModal();
    renderList();
    updatePreview(false);
  });

  $("btnCopyCode").addEventListener("click", async ()=>{
    const payload = buildPayload(false);
    const url = buildGameUrl(payload);
    const iframeCode = buildIframeFromUrl(url);

    const ok = await copyToClipboard(iframeCode);
    toast(ok ? "iframe —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω ‚úÖ" : "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
  });

  
  // iframe code modal
  function hideCodeModal(){
    if(!$("codeBackdrop")) return;
    $("codeBackdrop").style.display = "none";
    $("codeBackdrop").setAttribute("aria-hidden","true");
  }
  if ($("btnCloseCode")) $("btnCloseCode").addEventListener("click", hideCodeModal);
  if ($("codeBackdrop")) {
    $("codeBackdrop").addEventListener("click", (e)=>{
      if(e.target === $("codeBackdrop")) hideCodeModal();
    });
  }
  if ($("btnCopyFromModal")) {
    $("btnCopyFromModal").addEventListener("click", async ()=>{
      const text = ($("taIframe")?.value || "").trim();
      if(!text){ toast("–ü—É—Å—Ç–æ"); return; }
      const ok = await copyToClipboard(text);
      toast(ok ? "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ" : "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
    });
  
  if ($("btnCopyIframe")) {
    $("btnCopyIframe").addEventListener("click", async ()=>{
      const text = ($("taIframe2")?.value || "").trim();
      if(!text){ toast("–ü—É—Å—Ç–æ"); return; }
      const ok = await copyToClipboard(text);
      toast(ok ? "iframe —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω ‚úÖ" : "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
    });
  }
}


  // ===== download standalone game (HTML with embedded config + media) =====
  if ($("btnDownloadGame")) {
    $("btnDownloadGame").addEventListener("click", ()=>{
      try{
        const payload = buildPayload(true); // include draft so user gets what sees
        const safeJson = JSON.stringify(payload).replace(/</g, "\\u003c");
        const embed = `<script>window.__EMBEDDED_CFG__=${safeJson};<\/script>\n`;

        // Embed before the main script IIFE (first <script>)
        const full = "<!doctype html>\n" + document.documentElement.outerHTML;
        const out = full.replace("<script>\n(() => {", embed + "<script>\n(() => {");

        const blob = new Blob([out], {type:"text/html;charset=utf-8"});
        const a = document.createElement("a");
        const ts = new Date();
        const pad = (n)=> String(n).padStart(2,"0");
        const name = `tower_game_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}.html`;
        a.href = URL.createObjectURL(blob);
        a.download = name;
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
        toast("–ò–≥—Ä–∞ —Å–∫–∞—á–∞–Ω–∞ ‚úÖ");
      }catch(e){
        showErr(e?.stack || e?.message || String(e));
        toast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å üòï");
      }
    });
  }

// ===== game-only mode =====
  function bootGameOnly(cfg){
    document.body.setAttribute("data-mode","game");
    document.body.classList.add("gameOnly");
    $("editorRoot").style.display = "none";
    $("modalBackdrop").style.display = "none";
    if($("codeBackdrop")) $("codeBackdrop").style.display = "none";
    $("gameRoot").style.display = "block";
    injectCanvasGame(cfg);
  }

  // init (decide mode by hash)
  const qp = parseQueryParams();
  const hp = parseHashParams();
  const gameParam = qp.game || hp.game;
  const cfgKeyParam = qp.cfgkey || hp.cfgkey;

  // 0) embedded export (standalone HTML)
  if (window.__EMBEDDED_CFG__) {
    try{
      bootGameOnly(normalizeCfg(window.__EMBEDDED_CFG__));
    }catch(e){
      const host = $("gameHost");
      $("editorRoot").style.display = "none";
      $("gameRoot").style.display = "block";
      host.innerHTML = `<div style="padding:16px;color:#ffd6d6;font-weight:900">–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ üòï</div>`;
    }
    return;
  }

  // 1) legacy URL param: ?game=... or #game=...
  if(gameParam){
    try{
      const raw = JSON.parse(b64urlDecode(gameParam));
      bootGameOnly(normalizeCfg(raw));
    }catch(e){
      const host = $("gameHost");
      $("editorRoot").style.display = "none";
      $("gameRoot").style.display = "block";
      host.innerHTML = `<div style="padding:16px;color:#ffd6d6;font-weight:900">–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ –∏–∑ iframe üòï</div>`;
    }
    return;
  }

  // 2) preview/local mode: ?cfgkey=... or #cfgkey=...
  if(cfgKeyParam){
    try{
      const rawStr = localStorage.getItem(cfgKeyParam) || sessionStorage.getItem(cfgKeyParam);
      if(!rawStr) throw new Error("cfgkey not found in storage");
      const raw = JSON.parse(rawStr);
      bootGameOnly(normalizeCfg(raw));
    }catch(e){
      const host = $("gameHost");
      $("editorRoot").style.display = "none";
      $("gameRoot").style.display = "block";
      host.innerHTML = `<div style="padding:16px;color:#ffd6d6;font-weight:900">–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ (cfgkey) üòï</div>`;
    }
    return;
  }

  // editor init
  Editor.title = $("inpTitle").value || "–ë–∞—à–Ω—è –∑–Ω–∞–Ω–∏–π";
  Editor.timer.enabled = $("chkTimer").checked;
  Editor.timer.seconds = Number($("inpSeconds").value || 30);
  Editor.useImages = true; if($("chkUseImages")) $("chkUseImages").checked = true;
  Editor.useRepoBg = true;

  renderList();
  updatePreview(false);

  // Hide export section (we copy iframe from top button; no need to show this block)
  try{
    const titles = Array.from(document.querySelectorAll(".section .title"));
    const t = titles.find(x=>x.textContent.trim()==="–≠–∫—Å–ø–æ—Ä—Ç –≤ Genially");
    if(t){
      const sec = t.closest(".section");
      if(sec) sec.style.display="none";
    }
  }catch(e){}

})();
</script>
</body>
</html>
