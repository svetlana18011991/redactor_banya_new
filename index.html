<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gold Tower Editor (Final Fix)</title>
<style>
  /* –¢–ï–ú–ê */
  :root { --bg: #050505; --panel: #0f1219; --gold: #d4af37; --gold-glow: rgba(212, 175, 55, 0.3); --border: #333; --text: #e2e8f0; }
  body { margin:0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }
  
  /* –†–ï–î–ê–ö–¢–û–† (–°–õ–ï–í–ê) */
  .editor-col { width: 450px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; box-shadow: 5px 0 30px #000; }
  .header { padding: 20px; border-bottom: 1px solid var(--gold); display: flex; justify-content: space-between; align-items: center; background: #0f1219; }
  .logo { font-weight: 800; color: var(--gold); letter-spacing: 2px; font-size: 18px; text-shadow: 0 0 15px var(--gold-glow); }
  
  .scroll-wrap { flex: 1; overflow-y: auto; padding: 20px; }
  .section { margin-bottom: 25px; padding: 15px; background: rgba(255,255,255,0.02); border-radius: 8px; border: 1px solid #222; }
  .sec-head { color: var(--gold); font-size: 11px; text-transform: uppercase; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }

  /* –≠–õ–ï–ú–ï–ù–¢–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
  button { cursor: pointer; border: none; font-weight: 600; border-radius: 4px; transition: 0.2s; font-family: inherit; }
  .btn-gold { background: linear-gradient(135deg, #b8860b, #d4af37); color: #000; padding: 8px 16px; font-size: 12px; font-weight:bold; box-shadow: 0 0 15px var(--gold-glow); }
  .btn-gold:hover { filter: brightness(1.2); }
  .btn-add { background: rgba(212, 175, 55, 0.1); border: 1px dashed var(--gold); color: var(--gold); width: 100%; padding: 12px; margin-top: 5px; }
  .btn-add:hover { background: var(--gold); color: #000; }
  
  .icon-btn { background: transparent; color: #666; font-size: 16px; padding: 5px; }
  .icon-btn:hover { color: #fff; }
  .icon-btn.del:hover { color: #ef4444; }

  /* –§–û–ù */
  .upload-area { border: 1px dashed #444; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
  .file-label { font-size: 12px; color: #aaa; cursor: pointer; font-weight: bold; width: 100%; display: flex; align-items: center; gap: 10px; }
  .file-label:hover { color: var(--gold); }

  /* –í–û–ü–†–û–°–´ */
  .q-list { display: flex; flex-direction: column; gap: 8px; }
  .q-item { background: #1a1d26; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid transparent; }
  .q-item:hover { border-left-color: var(--gold); background: #252836; }
  .q-badge { font-size: 10px; background: #000; color: #888; padding: 2px 6px; border-radius: 4px; margin-right: 8px; border: 1px solid #333; }

  /* –ü–†–ï–í–¨–Æ (–°–ü–†–ê–í–ê) */
  .preview-col { flex: 1; background: #000; position: relative; display: flex; flex-direction: column; }
  .preview-bar { height: 24px; background: #111; color: #444; font-size: 10px; display: flex; align-items: center; justify-content: center; letter-spacing: 2px; }
  iframe { flex: 1; width: 100%; border: none; background: #000; }

  /* –ú–û–î–ê–õ–ö–ê */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 999; display: none; align-items: center; justify-content: center; }
  .modal { background: #0f1219; width: 550px; border: 1px solid var(--gold); border-radius: 12px; box-shadow: 0 0 60px rgba(212,175,55,0.2); display: flex; flex-direction: column; max-height: 90vh; }
  .modal-head { padding: 15px 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
  .modal-body { padding: 20px; overflow-y: auto; }
  .modal-foot { padding: 15px 20px; border-top: 1px solid #333; text-align: right; }

  input, select, textarea { width: 100%; background: #050505; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 4px; box-sizing: border-box; font-size: 14px; margin-bottom: 10px; }
  input:focus, select:focus, textarea:focus { border-color: var(--gold); outline: none; }
  
  .opt-row { display: flex; gap: 8px; align-items: center; margin-bottom: 5px; }
  .radio { width: 18px; height: 18px; accent-color: var(--gold); cursor: pointer; }
  .preview-media { max-height: 80px; display: block; margin: 5px auto; border: 1px solid #333; display:none; }

  .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--gold); color: #000; padding: 12px 30px; border-radius: 30px; font-weight: bold; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000; }
  .toast.show { opacity: 1; bottom: 50px; }
</style>
</head>
<body>

<div class="editor-col">
  <div class="header">
    <div class="logo">GOLD TOWER</div>
    <button class="btn-gold" onclick="generateCode()">–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î</button>
  </div>
  
  <div class="scroll-wrap">
    <div class="section">
      <div class="sec-head">–§–æ–Ω</div>
      <div class="upload-area">
        <label class="file-label">
          <span style="font-size:20px">üñºÔ∏è</span>
          <span id="bgStatus">–ó–ê–ì–†–£–ó–ò–¢–¨</span>
          <input type="file" accept="image/*" style="display:none" onchange="uploadBg(this)">
        </label>
        <button class="icon-btn" onclick="clearBg()" title="–°–±—Ä–æ—Å–∏—Ç—å">‚úï</button>
      </div>
    </div>

    <div class="section">
      <div class="sec-head">–í–æ–ø—Ä–æ—Å—ã (<span id="qCount">0</span>/9)</div>
      <div id="qList" class="q-list"></div>
      <button class="btn-add" onclick="openModal()">+ –î–û–ë–ê–í–ò–¢–¨ –í–û–ü–†–û–°</button>
      <button style="width:100%; background:transparent; color:#555; margin-top:8px; font-size:10px" onclick="resetQs()">–°–ë–†–û–°–ò–¢–¨ –°–ü–ò–°–û–ö</button>
    </div>
  </div>
</div>

<div class="preview-col">
  <div class="preview-bar">LIVE PREVIEW</div>
  <iframe id="previewFrame"></iframe>
</div>

<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-head">
      <h3 style="margin:0; color:var(--gold); font-size:14px">–†–ï–î–ê–ö–¢–û–† –í–û–ü–†–û–°–ê</h3>
      <button onclick="closeModal()" class="icon-btn">‚úï</button>
    </div>
    <div class="modal-body">
      <div style="display:flex; gap:15px">
        <div style="flex:1">
          <label style="font-size:10px; color:#888">–¢–ò–ü</label>
          <select id="mType" onchange="renderOpts()">
            <option value="choice">–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞</option>
            <option value="input">–í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞</option>
          </select>
        </div>
        <div style="flex:1">
          <label style="font-size:10px; color:#888">–¢–ê–ô–ú–ï–† (–°–ï–ö)</label>
          <div style="display:flex; align-items:center; gap:5px">
            <input type="checkbox" id="mTimerOn" onchange="toggleTimer()" style="width:20px; margin:0; accent-color:var(--gold)">
            <input type="number" id="mTimerVal" value="30" disabled style="margin:0">
          </div>
        </div>
      </div>

      <label style="font-size:10px; color:#888">–í–û–ü–†–û–°</label>
      <textarea id="mText" rows="2"></textarea>

      <label style="font-size:10px; color:#888">–ú–ï–î–ò–ê</label>
      <div class="upload-area" style="margin-bottom:10px">
        <label class="file-label" style="justify-content:center">
          <span id="mMediaStatus">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª...</span>
          <input type="file" accept="image/*,audio/*" style="display:none" onchange="uploadMedia(this)">
        </label>
        <button class="icon-btn" onclick="clearMedia()">‚úï</button>
      </div>
      <img id="mImgPrev" class="preview-media">

      <div id="mOptsArea" style="border-top:1px solid #333; padding-top:15px; margin-top:10px"></div>
    </div>
    <div class="modal-foot">
      <button class="btn-gold" onclick="saveQ()">–°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!</div>

<script id="gameTemplate" type="text/plain">
<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<style>
  :root{ --gold:#f59e0b; }
  body{margin:0;background:#050505;font-family:'Segoe UI',sans-serif;color:#fff;overflow:hidden;user-select:none;}
  
  #wrap{position:absolute;inset:0;}
  
  /* –≠–ö–†–ê–ù–´ */
  #startScreen, #endScreen { 
    position:absolute; inset:0; background:rgba(5,5,5,0.98); 
    display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:100; 
  }
  h1 { font-size:40px; color:var(--gold); margin-bottom:40px; letter-spacing:4px; }
  .big-btn { 
    padding:15px 50px; background:linear-gradient(135deg, #b8860b, #d4af37); 
    border:none; border-radius:50px; font-weight:900; font-size:24px; cursor:pointer; 
    box-shadow:0 0 30px rgba(245,158,11,0.4); 
  }
  .big-btn:hover { transform:scale(1.05); }

  /* –ò–ì–†–û–í–û–ï –ü–û–õ–ï */
  .bg { position:absolute; inset:0; background-size:cover; background-position:center; opacity:0.5; }
  .hud { position:absolute; top:15px; left:15px; right:15px; display:flex; justify-content:space-between; z-index:10; pointer-events:none; }
  .pill { background:rgba(0,0,0,0.8); border:1px solid var(--gold); padding:8px 15px; border-radius:20px; font-weight:bold; color:var(--gold); font-size:14px; }

  .tower-wrap { position:absolute; inset:0; display:flex; align-items:flex-end; justify-content:center; padding-bottom:100px; pointer-events:none; }
  .tower { position:relative; width:100%; height:100%; display:flex; flex-direction:column-reverse; align-items:center; transition: transform 0.5s; }
  
  .block { position:absolute; height:60px; background-size:100% 100%; filter:drop-shadow(0 5px 10px #000); }
  .fallback { background:var(--gold); border:2px solid #fff; } /* –ï—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –≥—Ä—É–∑–∏—Ç—Å—è */

  /* –ö–ê–†–¢–û–ß–ö–ê */
  #overlay { position:absolute; inset:0; background:rgba(0,0,0,0.9); display:none; align-items:center; justify-content:center; z-index:50; }
  #card { width:90%; max-width:400px; background:#111; border:2px solid var(--gold); border-radius:16px; padding:20px; text-align:center; position:relative; }
  
  #qImg { max-width:100%; max-height:150px; border-radius:8px; margin-bottom:10px; display:none; margin:0 auto 10px; }
  #qText { font-size:18px; margin-bottom:20px; line-height:1.4; font-weight:bold; }
  
  .ans-btn { display:block; width:100%; background:#222; border:1px solid #444; padding:14px; color:#fff; border-radius:8px; margin-bottom:8px; cursor:pointer; text-align:left; font-size:15px; }
  .ans-btn:hover { border-color:var(--gold); background:#333; }
  
  input.inp { width:100%; padding:14px; background:#000; border:1px solid #444; color:var(--gold); border-radius:8px; font-size:18px; text-align:center; margin-bottom:10px; outline:none; }
  
  #timerBar { height:4px; background:var(--gold); width:100%; margin-bottom:15px; display:none; transition:width 1s linear; }
  #msg { height:24px; font-weight:bold; margin-top:10px; font-size:18px; }

  /* –ê–ù–ò–ú–ê–¶–ò–ò */
  .falling { transition: none; } 
  .landed { transition: top 0.2s; }
</style>
</head>
<body>

<div id="startScreen">
  <h1>–ë–ê–®–ù–Ø</h1>
  <button class="big-btn" onclick="startGame()">–ù–ê–ß–ê–¢–¨</button>
</div>

<div id="endScreen" style="display:none">
  <h1 id="endTitle">–§–ò–ù–ê–õ</h1>
  <p style="font-size:24px; color:#fff; margin-bottom:40px">–°—á—ë—Ç: <span id="finalScore">0</span></p>
  <button class="big-btn" onclick="location.reload()">–ï–©–ï –†–ê–ó</button>
</div>

<div id="wrap">
  <div class="bg" id="bg"></div>
  <div class="hud">
    <div class="pill">–≠—Ç–∞–∂: <span id="hTxt">0</span></div>
    <div class="pill">–°—á—ë—Ç: <span id="sTxt">0</span></div>
  </div>
  
  <div class="tower-wrap">
    <div class="tower" id="tower">
      <div style="width:300px; height:20px; background:#444; border-radius:4px; margin-bottom:0;"></div>
    </div>
  </div>

  <div id="overlay">
    <div id="card">
      <div id="timerBar"></div>
      <img id="qImg"> <div id="audioBox"></div>
      <div id="qText"></div>
      <div id="ansArea"></div>
      <div id="msg"></div>
    </div>
  </div>
</div>

<script>
// === CONFIG ===
const CONFIG = {{CONFIG}};
const BLOCKS = ["3.png","4.png","5.png","6.png","7.png","8.png","9.png","10.png","11.png"];

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π –ø—É—Ç—å –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é
function getBaseUrl() {
  let url = window.location.href; 
  // –ï—Å–ª–∏ –º—ã –≤ iframe (blob), –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π repo url
  if(url.startsWith("blob:") && CONFIG.repo) return CONFIG.repo;
  // –ò–Ω–∞—á–µ –≤—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –ø—É—Ç—å
  return url.substring(0, url.lastIndexOf('/') + 1);
}
const BASE = getBaseUrl();

let state = { qIdx:0, score:0, tower:[], current:null, timer:null };

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
function getImgUrl(name) {
  return BASE + name;
}

// === MAIN FUNCTIONS ===

function startGame() {
  document.getElementById("startScreen").style.display = "none";
  
  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ–Ω–∞
  const bgUrl = CONFIG.bgUser || getImgUrl("1.png");
  document.getElementById("bg").style.backgroundImage = `url('${bgUrl}')`;
  
  spawn();
  loop();
}

function spawn() {
  if(state.qIdx >= CONFIG.qs.length) { win(); return; }
  
  // –í—ã–±–∏—Ä–∞–µ–º –±–ª–æ–∫
  const bName = BLOCKS[state.qIdx % BLOCKS.length];
  const bUrl = getImgUrl(bName);
  
  // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
  const el = document.createElement("div");
  el.className = "block falling";
  el.style.backgroundImage = `url('${bUrl}')`;
  
  // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –≥—Ä—É–∑–∏—Ç—Å—è - —Å—Ç–∞–≤–∏–º —Ü–≤–µ—Ç (—á—Ç–æ–±—ã –∏–≥—Ä–∞ –Ω–µ –ª–æ–º–∞–ª–∞—Å—å)
  const img = new Image();
  img.onerror = () => { el.classList.add("fallback"); };
  img.src = bUrl;

  // –†–∞–∑–º–µ—Ä—ã
  const w = state.tower.length ? state.tower[state.tower.length-1].w : 300;
  el.style.width = w + "px";
  el.style.bottom = "100%"; // –°—Ç–∞—Ä—Ç —Å–≤–µ—Ä—Ö—É
  
  document.getElementById("wrap").appendChild(el);
  
  state.current = {
    el: el,
    w: w,
    y: window.innerHeight, // –ü–∏–∫—Å–µ–ª–∏ —Å–≤–µ—Ä—Ö—É (–¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏)
    x: 0, // –°–º–µ—â–µ–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
    dir: 1,
    speed: 5 + (state.qIdx * 0.5)
  };
}

function loop() {
  if(!state.current) return;
  requestAnimationFrame(loop);
  
  const b = state.current;
  
  // –î–≤–∏–∂–µ–Ω–∏–µ –≤–ª–µ–≤–æ-–≤–ø—Ä–∞–≤–æ
  const limit = (window.innerWidth - b.w) / 2;
  b.x += b.speed * b.dir;
  if(b.x > limit || b.x < -limit) b.dir *= -1;
  
  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–æ–∑–∏—Ü–∏–∏
  b.el.style.transform = `translateX(${b.x}px)`;
  b.el.style.top = "100px"; // –í—ã—Å–æ—Ç–∞ –ø–æ–ª–µ—Ç–∞
}

// –ö–õ–ò–ö (–°–ë–†–û–°)
document.addEventListener("pointerdown", (e) => {
  if(e.target.tagName==="BUTTON" || e.target.tagName==="INPUT") return;
  if(state.current) {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ (–≤–∏–∑—É–∞–ª—å–Ω–æ)
    state.current.speed = 0; 
    showQuestion();
  }
});

function showQuestion() {
  const q = CONFIG.qs[state.qIdx];
  const card = document.getElementById("card");
  const overlay = document.getElementById("overlay");
  const area = document.getElementById("ansArea");
  
  // –°–±—Ä–æ—Å UI
  document.getElementById("qText").innerText = q.q;
  document.getElementById("msg").innerText = "";
  area.innerHTML = "";
  document.getElementById("qImg").style.display="none";
  document.getElementById("audioBox").innerHTML="";
  document.getElementById("timerBar").style.display="none";
  
  // Media
  if(q.media) {
    if(q.media.startsWith("data:audio")) document.getElementById("audioBox").innerHTML=`<audio controls autoplay src="${q.media}"></audio>`;
    else { let i = document.getElementById("qImg"); i.src=q.media; i.style.display="block"; }
  }
  
  // Timer
  if(q.timer) {
    let bar = document.getElementById("timerBar");
    bar.style.display="block"; bar.style.width="100%";
    let t = q.timer;
    state.timer = setInterval(() => {
      t--;
      bar.style.width = (t/q.timer*100)+"%";
      if(t<=0) { clearInterval(state.timer); fail("–í—Ä–µ–º—è –≤—ã—à–ª–æ!"); }
    }, 1000);
  }
  
  overlay.style.display = "flex";
  card.classList.add("show");
  
  if(q.type==='choice') {
    q.o.forEach(opt => {
      let btn = document.createElement("button");
      btn.className="ans-btn"; btn.innerText=opt;
      btn.onclick=()=>check(opt);
      area.appendChild(btn);
    });
  } else {
    let inp = document.createElement("input"); inp.className="inp"; 
    let btn = document.createElement("button"); btn.className="ans-btn"; btn.style.textAlign="center"; btn.innerText="–û–ö";
    btn.onclick=()=>check(inp.value);
    area.appendChild(inp); area.appendChild(btn);
  }
}

function check(val) {
  if(state.timer) clearInterval(state.timer);
  const q = CONFIG.qs[state.qIdx];
  let ok = false;
  
  if(Array.isArray(q.a)) ok = q.a.some(x => String(x).toLowerCase().trim() == String(val).toLowerCase().trim());
  else ok = String(q.a).toLowerCase().trim() == String(val).toLowerCase().trim();
  
  if(ok) {
    document.getElementById("msg").innerText="–í–ï–†–ù–û!";
    document.getElementById("msg").style.color="#4ade80";
    setTimeout(()=>{
      document.getElementById("overlay").style.display="none";
      land();
    }, 1000);
  } else {
    fail("–û—à–∏–±–∫–∞!");
  }
}

function land() {
  const b = state.current;
  const t = document.getElementById("tower");
  
  // –õ–æ–≥–∏–∫–∞ —à–∏—Ä–∏–Ω—ã (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)
  let prevW = state.tower.length ? state.tower[state.tower.length-1].w : 300;
  // –®—Ç—Ä–∞—Ñ –∑–∞ —Å–º–µ—â–µ–Ω–∏–µ (–ø—Ä–æ—Å—Ç–æ —É–º–µ–Ω—å—à–∞–µ–º —à–∏—Ä–∏–Ω—É)
  let diff = Math.abs(b.x); // –°–º–µ—â–µ–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
  let newW = prevW - (diff * 0.5); // –ù–µ–º–Ω–æ–≥–æ –ø—Ä–æ—â–∞–µ–º
  
  if(newW < 20) { fail("–ü—Ä–æ–º–∞—Ö!"); return; }
  
  // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –ø–∞–¥–∞—é—â–∏–π –±–ª–æ–∫ –≤ —á–∞—Å—Ç—å –±–∞—à–Ω–∏
  b.el.remove(); // –£–¥–∞–ª—è–µ–º –ª–µ—Ç–∞—é—â–∏–π
  
  let fixed = document.createElement("div");
  fixed.className = "block";
  if(b.el.classList.contains("fallback")) fixed.classList.add("fallback");
  fixed.style.backgroundImage = b.el.style.backgroundImage;
  fixed.style.width = newW + "px";
  fixed.style.height = "60px";
  // –°–¥–≤–∏–≥–∞–µ–º, —á—Ç–æ–±—ã –≤–∏–∑—É–∞–ª—å–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–æ
  fixed.style.transform = `translateX(${b.x}px)`; 
  
  t.appendChild(fixed);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
  state.tower.push({w: newW});
  state.score += 100;
  state.qIdx++;
  state.current = null;
  
  document.getElementById("sTxt").innerText = state.score;
  document.getElementById("hTxt").innerText = state.tower.length;
  
  // –°–∫—Ä–æ–ª–ª –±–∞—à–Ω–∏ –≤–Ω–∏–∑
  if(state.tower.length > 4) {
    t.style.transform = `translateY(${ (state.tower.length-4)*60 }px)`;
  }
  
  setTimeout(spawn, 500);
}

function fail(reason) {
  document.getElementById("overlay").style.display="none";
  document.getElementById("endScreen").style.display="flex";
  document.getElementById("endTitle").innerText = "–ù–ï–£–î–ê–ß–ê";
  document.getElementById("finalScore").innerText = state.score;
}

function win() {
  document.getElementById("overlay").style.display="none";
  document.getElementById("endScreen").style.display="flex";
  document.getElementById("endTitle").innerText = "–ü–û–ë–ï–î–ê!";
  document.getElementById("finalScore").innerText = state.score;
}

</script>
</body>
</html>
</script>

<script>
// ==========================================
// –õ–û–ì–ò–ö–ê –†–ï–î–ê–ö–¢–û–†–ê
// ==========================================
let config = { bgUser: null, qs: [], repo: "" };
let editId = null;
let tempMedia = null;

function init() {
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º REPO URL –¥–ª—è –ü—Ä–µ–≤—å—é
  let loc = window.location.href;
  config.repo = loc.substring(0, loc.lastIndexOf('/') + 1);
  renderList(); 
  updatePreview(); 
}

function updatePreview() {
  const tmpl = document.getElementById("gameTemplate").textContent;
  const html = tmpl.replace("{{CONFIG}}", JSON.stringify(config));
  const blob = new Blob([html], {type: 'text/html'});
  document.getElementById("previewFrame").src = URL.createObjectURL(blob);
}

function uploadBg(inp) {
  const f = inp.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = e => { config.bgUser = e.target.result; document.getElementById("bgStatus").innerText="–ó–∞–≥—Ä—É–∂–µ–Ω–æ: "+f.name; updatePreview(); };
  r.readAsDataURL(f);
}
function clearBg() { config.bgUser=null; document.getElementById("bgStatus").innerText="–ó–ê–ì–†–£–ó–ò–¢–¨"; updatePreview(); }

function renderList() {
  const l = document.getElementById("qList"); l.innerHTML="";
  document.getElementById("qCount").innerText = config.qs.length;
  if(!config.qs.length) { l.innerHTML="<div style='text-align:center;color:#666;font-size:12px;padding:10px'>–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤</div>"; return; }
  config.qs.forEach((q,i) => {
    let d = document.createElement("div"); d.className="q-item";
    d.innerHTML=`<div class="q-txt"><span class="q-badge">${i+1}</span> ${q.q}</div><div><button class="icon-btn" onclick="editQ(${i})">‚úèÔ∏è</button><button class="icon-btn del" onclick="delQ(${i})">üóë</button></div>`;
    l.appendChild(d);
  });
}

function openModal() { editId=null; document.getElementById("modal").style.display="flex"; document.getElementById("mText").value=""; tempMedia=null; document.getElementById("mTimerOn").checked=false; renderOpts(); clearMedia(); }
function closeModal() { document.getElementById("modal").style.display="none"; }

function uploadMedia(inp) {
  const f = inp.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = e => { tempMedia = e.target.result; document.getElementById("mMediaStatus").innerText="–§–∞–π–ª –≥–æ—Ç–æ–≤"; updatePreview(); };
  r.readAsDataURL(f);
}
function clearMedia() { tempMedia=null; document.getElementById("mMediaStatus").innerText="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª..."; }

function renderOpts() {
  const t = document.getElementById("mType").value;
  const c = document.getElementById("mOptsArea"); c.innerHTML="";
  if(t==="choice") {
    c.innerHTML = `<div style="display:flex;justify-content:space-between;margin-bottom:5px"><label>–í–ê–†–ò–ê–ù–¢–´</label><button onclick="addOpt()" style="background:none;color:var(--gold);font-size:10px">+ –î–û–ë–ê–í–ò–¢–¨</button></div><div id="optsList"></div>`;
    if(editId===null) { addOpt(); addOpt(); }
  } else c.innerHTML = `<label>–û—Ç–≤–µ—Ç (—Ç–µ–∫—Å—Ç)</label><input type="text" id="mInp">`;
}

function addOpt(val="", ok=false) {
  const l = document.getElementById("optsList"); if(!l) return;
  let d = document.createElement("div"); d.className="opt-row";
  d.innerHTML=`<input type="radio" name="ok" class="radio" ${ok?'checked':''}><input type="text" class="opt-val" value="${val}"><button class="icon-btn del" onclick="this.parentElement.remove()">‚úï</button>`;
  l.appendChild(d);
}

function editQ(i) {
  editId=i; const q=config.qs[i];
  document.getElementById("modal").style.display="flex";
  document.getElementById("mText").value=q.q;
  document.getElementById("mType").value=q.type;
  document.getElementById("mTimerOn").checked = !!q.timer;
  tempMedia=q.media;
  renderOpts();
  if(q.type==='choice') {
    document.getElementById("optsList").innerHTML="";
    q.o.forEach(opt => addOpt(opt, q.a.includes(opt)));
  } else document.getElementById("mInp").value = q.a.join(", ");
}

function saveQ() {
  const txt = document.getElementById("mText").value;
  const type = document.getElementById("mType").value;
  if(!txt) return;
  let o = {type:type, q:txt, a:[], media:tempMedia, timer:0};
  if(document.getElementById("mTimerOn").checked) o.timer = 30;
  
  if(type==='choice') {
    o.o=[];
    document.querySelectorAll(".opt-row").forEach(r=>{
      let v = r.querySelector(".opt-val").value;
      if(v) { o.o.push(v); if(r.querySelector(".radio").checked) o.a.push(v); }
    });
    if(!o.a.length) { alert("–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç!"); return; }
  } else o.a = document.getElementById("mInp").value.split(",").map(x=>x.trim()).filter(Boolean);
  
  if(editId!==null) config.qs[editId]=o; else config.qs.push(o);
  closeModal(); renderList(); updatePreview();
}

function delQ(i) { config.qs.splice(i,1); renderList(); updatePreview(); }
function resetQs() { config.qs=[]; renderList(); updatePreview(); }
function toggleTimer() { document.getElementById("mTimerVal").disabled = !document.getElementById("mTimerOn").checked; }

function generateCode() {
  const tmpl = document.getElementById("gameTemplate").textContent;
  const html = tmpl.replace("{{CONFIG}}", JSON.stringify(config));
  const b64 = btoa(unescape(encodeURIComponent(html)));
  const embed = `<iframe src="data:text/html;base64,${b64}" width="100%" height="600" style="border:0"></iframe>`;
  navigator.clipboard.writeText(embed).then(()=> {
    const t = document.getElementById("toast"); t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2000);
  });
}

init();
</script>
</body>
</html>
